<!doctype html>

<!--[if lt IE 7 ]> <html class="ie ie6 no-js" lang="ca"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie ie7 no-js" lang="ca"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie ie8 no-js" lang="ca"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie ie9 no-js" lang="ca"> <![endif]-->
<!--[if gt IE 9]><!--><html class="no-js" lang="ca"><!--<![endif]-->
<!-- the "no-js" class is for Modernizr. -->

<head id="www-sitename-com" data-template-set="html5-reset">

	<meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html">
        
	<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title>Programació bàsica (ASX) \ Programació (DAM i DAW)</title>
	
<!-- <meta name="title" content=""> --> 
	<meta name="description" content="">
	<!-- Google will often use this as its description of your page/site. Make it good. -->
	
	<meta name="google-site-verification" content="">
	<!-- Speaking of Google, don't forget to set your site up: http://google.com/webmasters -->
	
	<meta name="author" content="Institut Obert de Catalunya">
	<meta name="Copyright" content="Copyright Institut Obert de Catalunya 2011. All Rights Reserved.">

	<!-- Dublin Core Metadata : http://dublincore.org/ -->
	<meta name="DC.title" content="Programació bàsica (ASX) \ Programació (DAM i DAW)">
	<meta name="DC.subject" content="Informàtica i comunicacions">
	<meta name="DC.creator" content="Institut Obert de Catalunya">
	
	<!--  Mobile Viewport Fix
	j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag 
	device-width : Occupy full width of the screen in its current orientation
	initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
	maximum-scale = 1.0 retains dimensions instead of zooming in if page width < device width
	-->
	<!-- Uncomment to use � use thoughtfully!
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	-->

	<link rel="shortcut icon" href="../../../img/favicon.ico">
	<!-- This is the traditional favicon.
		 - size: 16x16 or 32x32
		 - transparency is OK
		 - see wikipedia for info on browser support: http://mky.be/favicon/ -->
		 
	<link rel="apple-touch-icon" href="../../../img/apple-touch-icon.png">
	<!-- The is the icon for iOS's Web Clip.
		 - size: 57x57 for older iPhones, 72x72 for iPads, 114x114 for iPhone4's retina display (IMHO, just go ahead and use the biggest one)
		 - To prevent iOS from applying its styles to the icon name it thusly: apple-touch-icon-precomposed.png
		 - Transparency is not recommended (iOS will put a black BG behind the icon) -->
	
	<!-- CSS: screen, mobile & print are all in the same file -->
	<link rel="stylesheet" href="../../../_/css/style.css">

	<!-- CSS: jQuery UI -->
	<link rel="stylesheet" href="../../../_/css/jquery-ui.css">
	
	<!-- all our JS is at the bottom of the page, except for Modernizr. -->
	<script src="../../../_/js/modernizr-1.7.min.js"></script>
	<script src="../../../_/js/Hyphenator.js" type="text/javascript"></script>
	<script type="text/javascript">
	   Hyphenator.config({
		minwordlength : 4
	   });
	   Hyphenator.run();
	</script>
    <script src="../../../_/js/build.js" type="text/javascript"></script>
</head>

<body class="style-newspaper">

<div class="wrapper"><!-- not needed? up to you: http://camendesign.com/code/developpeurs_sans_frontieres -->

	<header id="header">
		<div class="head"><a href="http://ioc.gencat.cat"><img src="../../../img/logo.png" alt="Institut Obert de Catalunya"/></a><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/es/deed.ca"><img src="../../../img/license.png" alt="Llic&egrave;ncia" class="license"/></a></div>
		<div class="headdocument"><a href="../../../index.html">Programació bàsica (ASX) \ Programació (DAM i DAW)</a></div>
        <div id="search" class="search" name="search">
         <form id="frmsearch" action="../../../search.html" method="get">
          <input type="text" name="q"/>
        </form>
        </div>
	</header>
   <div id="upbutton" class="upbutton" style="display:none;"><img src="../../../img/uparrow.png" alt="Pujar a l'inici de p&agrave;gina"/></div>
   <aside id="aside">
    <div id="menu">
      <ul>
       <li name="toc"><div><img src="../../../img/toc.png" alt="&Iacute;ndex"/></div></li>
       <li name="settings"><div><img src="../../../img/settings.png" alt="Configuraci&oacute;"/></div></li>
       <li name="printer"><div><img src="../../../img/printer.png" alt="Imprimir"/></div></li>
       <li name="favorites"><div><img src="../../../img/favorites.png" alt="Favorits"/></div></li>
       <li name="help_icon" class="help_icon"><div><img src="../../../img/help_icon.png" alt="Ajuda"/></div></li>
      </ul>
     </div>
   </aside>
   <div id="sidebar-hide" name="sidebar-hide"><img src="../../../img/arrows.png"/></div>
   <section>
     <div id="toc" class="hidden">
      <div class="menucontent">
        <ul>
        <li id="u6" class="parentnode"><p><a class="unit" href="../../../WebContent/u6/introduccio.html">6. Fitxers</a></p><ul class="expander"><li id="u6introduccio"><a href="../../../WebContent/u6/introduccio.html">Introducció</a></li><li id="u6resum"><a href="../../../WebContent/u6/resum.html">Resum</a></li><li id="u6resultats_d_aprenentatge"><a href="../../../WebContent/u6/resultats_d_aprenentatge.html">Resultats d'aprenentatge</a></li><li id="u6mapa"><a href="../../../WebContent/u6/mapa.html">Mapa conceptual</a></li><li id="u6referencies"><a href="../../../WebContent/u6/referencies.html">Referències</a></li><li id="u6a1" class="tocsection"><p id='u6a1continguts'><a class="section" href="../../../WebContent/u6/a1/continguts.html">Gestió de fitxers</a><span class="buttonexp"></span></p><ul><li id="u6a1activitats"><a href="../../../WebContent/u6/a1/activitats.html">Activitats</a></li><li id="u6a1exercicis"><a href="../../../WebContent/u6/a1/exercicis.html">Exercicis d'autoavaluació</a></li></ul></li><div data-parent-id='u6a1' class='tocssection hidden'><div class="toc"><ul><li><a href="../../../WebContent/u6/a1/continguts.html#la_classe_file">La classe File</a></li><li><a href="../../../WebContent/u6/a1/continguts.html#solucio_dels_reptes_proposats">Solució dels reptes proposats</a></li></ul></div></div><li id="u6a2" class="tocsection"><p id='u6a2continguts'><a class="section" href="../../../WebContent/u6/a2/continguts.html">Tractament bàsic de dades</a><span class="buttonexp"></span></p><ul><li id="u6a2activitats"><a href="../../../WebContent/u6/a2/activitats.html">Activitats</a></li><li id="u6a2exercicis"><a href="../../../WebContent/u6/a2/exercicis.html">Exercicis d'autoavaluació</a></li></ul></li><div data-parent-id='u6a2' class='tocssection hidden'><div class="toc"><ul><li><a href="../../../WebContent/u6/a2/continguts.html#acces_sequeencial_a_fitxers_orientats_a_caracter">Accés seqüencial a fitxers orientats a caràcter</a></li><li><a href="../../../WebContent/u6/a2/continguts.html#aspectes_importants_de_l_acces_sequeencial">Aspectes importants de l'accés seqüencial</a></li><li><a href="../../../WebContent/u6/a2/continguts.html#acces_sequeencial_a_fitxers_orientats_a_byte">Accés seqüencial a fitxers orientats a byte</a></li><li><a href="../../../WebContent/u6/a2/continguts.html#acces_relatiu_a_les_dades">Accés relatiu a les dades</a></li><li><a href="../../../WebContent/u6/a2/continguts.html#solucions_als_reptes_proposats">Solucions als reptes proposats</a></li></ul></div></div><li id="u6a3" class="tocsection"><p id='u6a3continguts'><a class="section" href="../../../WebContent/u6/a3/continguts.html">Tractament modular de dades. El joc de combats a l'arena</a><span class="buttonexp"></span></p><ul><li id="u6a3activitats"><a href="../../../WebContent/u6/a3/activitats.html">Activitats</a></li><li id="u6a3exercicis"><a href="../../../WebContent/u6/a3/exercicis.html">Exercicis d'autoavaluació</a></li><li id="u6a3annexos"><a href="../../../WebContent/u6/a3/annexos.html">Annexos</a></li></ul></li><div data-parent-id='u6a3' class='tocssection hidden'><div class="toc"><ul><li><a href="../../../WebContent/u6/a3/continguts.html#descripcio_del_problema">Descripció del problema</a></li><li><a href="../../../WebContent/u6/a3/continguts.html#criteris_d_eleccio_de_tipus_de_fitxer">Criteris d'elecció de tipus de fitxer</a></li><li><a href="../../../WebContent/u6/a3/continguts.html#la_biblioteca_jocarenafitxers">La biblioteca "joc.arena.fitxers"</a></li><li><a href="../../../WebContent/u6/a3/continguts.html#esmenes_als_moduls_originals">Esmenes als mòduls originals</a></li></ul></div></div></ul></li><li id="" class="indexnode"><p><a href="../../../index.html">Anar a l&#39;&iacute;ndex general</a></p></li>
        </ul>
      </div>
    </div>
   </section>
   <section>
   <div id="settings" class="hidden">
    <div class="menucontent">
     <div class="allsettings">
     <div class="settings">
      <label>Font i Color</label>
		<div class="setting-option">
	        <ul class="fontBackground">
				<li id="style-newspaper" title="Newspaper" class="appearance-style-newspaper"><span>Newspaper</span></li>
                <li id="style-novel" title="Novel" class="appearance-style-novel"><span>Novel</span></li>
                <li id="style-ebook" title="eBook" class="appearance-style-ebook"><span>eBook</span></li>
				<li id="style-inverse" title="Inverse" class="appearance-style-inverse active"><span>Inverse</span></li>
				<li id="style-athelas" title="Athelas" class="appearance-style-athelas"><span>Athelas</span></li>
			</ul>
		</div>
     </div>
	<div class="settings">
      <label>Amplada</label>
		<div class="setting-option">
	        <div id="slider-width"></div>
		</div>
     </div>
     <div class="settings">
      <label>Mida de la font</label>
		<div class="setting-option">
	        <div id="slider-font"></div>
		</div>
     </div>
     <div class="settings">
      <label>Mida de la font</label>
	  <div class="setting-option">
       <form action="" class="sett-options">
		<ul>
		    <li><input type="checkbox" id="secondary-content" /><label for="secondary-content">Mostra recursos complementaris</label></li>
		    <li><input type="checkbox" id="main-images" /><label for="main-images">Mostra imatges</label></li>
		    <li><input type="checkbox" id="text-alignment" /><label for="text-alignment">Text justificat</label></li>
			<li><input type="checkbox" id="text-hyphen" /><label for="text-hyphen">Partici&oacute; sil·l&agrave;bica</label></li>
		</ul>
       </form>
	  </div>
     </div>
     </div>
    </div>
   </div>
   </section>
 <section>
 <div id="favorites" class="hidden"></div>
 </section>   
 <div id="bridge" class="hidden"></div>
 <div id="help" class="hidden">
  <div class="helptitle">Dreceres del teclat<hr></div>
  <div class="helpsection"><span>General</span>
   <ul>
    <li><span class="shortcut">g</span>: Anar al men&uacute; de navegaci&oacute;</li>
    <li><span class="shortcut">o</span>: Anar a opcions</li>
    <li><span class="shortcut">s</span>: Guardar la p&agrave;gina actual a favorits</li>
    <li><span class="shortcut">p</span>: Imprimir la p&agrave;gina actual</li>
    <li><span class="shortcut">?</span>: Mostrar/Ocultar l&#39;ajuda</li>
   </ul>
  </div>
  <div class="helpsection"><span>Navegaci&oacute;</span>
   <ul>
    <li><span class="shortcut">i</span>: Anar a l&#39;&iacute;ndex general</li>
    <li><span class="shortcut">t</span>: Anar a l&#39;inici de p&agrave;gina</li>
    <li><span class="shortcut">b</span>: Anar al final de p&agrave;gina</li>
    <li><span class="shortcut">j</span>: Anar cap endavant dintre la p&agrave;gina</li>
    <li><span class="shortcut">k</span>: Anar cap enrere dintre la p&agrave;gina</li>
    <li><span class="shortcut">h</span>: Anar a la p&agrave;gina anterior:</li>
    <li><span class="shortcut">l</span>: Anar a la p&agrave;gina seg&uuml;ent:</li>
   </ul>
   </div>
 </div>
 <div id="favcounter" name="favcounter" class="hidden"><span></span></div>
 <div id="navmenu" class="navmenu"><ul class="webnav"><li><a href="../../../index.html" title="Anar a l&#39;&iacute;ndex general">Inici</a></li><li><a href="../introduccio.html">Fitxers</a></li><li>Tractament modular de dades. El joc de combats a l'arena</li></ul></div>
	<div id="content" lang="ca" class="hyphenate text">
     <article lang="ca" class="sheet">
        <h1><a id="tractament_modular_de_dades_el_joc_de_combats_a_l_arena"> Tractament modular de dades. El joc de combats a l'arena </a></h1>
    	
<p>
Els principis de la modularitat també són aplicables per resoldre problemes en els quals es duen a terme operacions amb fitxers. De fet, normalment dins de les aplicacions se solen generar mòduls clarament diferenciats vinculats a la gestió de totes les dades persistents.
</p>

<p>
En aquest apartat es planteja un exemple d’aplicació modular on es duu a terme el tractament de dades emmagatzemades en fitxers. Concretament, s’estudia com ampliar una aplicació ja existent, generada usant els principis de modularitat, de manera que aquests principis se segueixin mantenint en la nova versió amb noves funcionalitats.
</p>

<h2><a id="descripcio_del_problema" >Descripció del problema</a></h2>
<div class="level2">

<p>
El programa que serveix com a punt de partida és un joc on l’usuari, el jugador, es va enfrontant amb successius adversaris en una arena de combat. Tant el jugador com els seus adversaris són definits per un seguit de valors, que anomenaran els seus atributs, mitjançant els quals s’indica la seva perícia lluitant: resistència, nivell de poder, capacitat d’atacar o defensar, etc.
</p>

<p>
Cada combat es divideix en rondes, a l’inici de les quals el jugador i el seu adversari trien secretament una estratègia a seguir. En cada ronda es pot seguir una estratègia diferent. Segons les estratègies triades per cadascú, el combat s’anirà resolent més favorablement cap a un o cap a l’altre, fins que finalment es consideri que un dels dos ha estat derrotat. Si es derrota l’adversari, s’atorga una puntuació al jugador. Si el jugador és derrotat, acaba la partida. L’objectiu final del jugador és sobreviure deu combats, assolint la màxima puntuació possible en el procés.
</p>

</div>

<h3><a id="divisio_del_problema" >Divisió del problema</a></h3>
<div class="level3">

<p>
Si bé el procés de resoldre les rondes de combat segons els atributs dels lluitadors té les seves particularitats, per plantejar quin és el funcionament de l’aplicació, es deixarà en aquesta descripció general, sense entrar en més detall. De totes maneres, si voleu fer la idea més aclaridora, tot seguit s’exposa la descomposició del problema mitjançant disseny descendent:
</p>
<div class="iocreference"><div class="ioccontent">
<p>
A la secció “Annexos” del web disposeu del codi font complet de l’aplicació sobre la qual es treballa en aquest apartat. Estudieu-lo atentament.
</p>
</div></div>
<p>

</p>
<ol>
<li class="level1"><div class="li"> Generar els atributs del nou jugador.</div>
</li>
<li class="level1"><div class="li"> Anunciar inici del combat.</div>
<ol>
<li class="level2"><div class="li"> Mostrar estat del jugador.</div>
</li>
</ol>
</li>
<li class="level1"><div class="li"> Triar l’adversari.</div>
</li>
<li class="level1"><div class="li"> Combatre. </div>
<ol>
<li class="level2"><div class="li"> Mostrar estat dels lluitadors.</div>
<ol>
<li class="level3"><div class="li"> Mostrar estat del jugador.</div>
</li>
<li class="level3"><div class="li"> Mostrar estat de l’adversari.</div>
</li>
</ol>
</li>
<li class="level2"><div class="li"> Triar estratègia del jugador.</div>
</li>
<li class="level2"><div class="li"> Triar estratègia de l’adversari.</div>
</li>
<li class="level2"><div class="li"> Resoldre resultats d’estratègies.</div>
<ol>
<li class="level3"><div class="li"> Llançar monedes.</div>
</li>
<li class="level3"><div class="li"> Penalitzar lluitador.</div>
</li>
<li class="level3"><div class="li"> Danyar lluitador.</div>
</li>
<li class="level3"><div class="li"> Guarir lluitador.</div>
</li>
</ol>
</li>
<li class="level2"><div class="li"> Restaurar lluitador.</div>
</li>
</ol>
</li>
<li class="level1"><div class="li"> Resoldre resultat del combat.</div>
<ol>
<li class="level2"><div class="li"> Atorgar puntuació.</div>
</li>
<li class="level2"><div class="li"> Pujar de nivell.</div>
</li>
<li class="level2"><div class="li"> Finalització del joc.</div>
</li>
</ol>
</li>
</ol>

</div>

<h3><a id="moduls_del_programa" >Mòduls del programa</a></h3>
<div class="level3">

<p>
Partint de la divisió en subproblemes del joc de combats de l’arena, s’ha fet la divisió en mòduls següent. D’una banda, en el <em>package</em> <code>joc.arena.regles</code> hi haurà les classes:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Monedes:</strong> per a les tasques vinculades al llançament de monedes per resoldre una ronda.</div>
</li>
<li class="level1"><div class="li"> <strong>Lluitador:</strong> per a les tasques vinculades a la manipulació de les dades d’un lluitador (danyar, guarir, etc.).</div>
</li>
<li class="level1"><div class="li"> <strong>Bestiari:</strong> per a les tasques vinculades a la generació d’adversaris i el jugador.</div>
</li>
<li class="level1"><div class="li"> <strong>Combat:</strong> per a les tasques vinculades a la resolució d’estratègies enfrontades.</div>
</li>
</ul>

<p>

</p>

<p>
D’altra banda, en el <em>package</em> <code>joc.arena.interficie</code> es decideix dividir les classes que tracten la pantalla i el teclat, de manera que hi haurà:
</p>
<ul>
<li class="level1"><div class="li"> <strong>EntradaTeclat:</strong> s’encarrega de les tasques importants que són donades pel que escriu l’usuari usant el teclat.</div>
</li>
<li class="level1"><div class="li"> <strong>SortidaPantalla:</strong> com l’anterior, però per mostrar informació en pantalla.</div>
</li>
</ul>

<p>
La classe principal, <strong>JocArena</strong> és al <em>package</em> que engloba els anteriors, <code>joc.arena</code>, donada la jerarquia de noms. 
</p>

<p>
Partint d’aquesta descripció, es volen afegir dues funcionalitats noves:
</p>
<ul>
<li class="level1"><div class="li"> Mantenir un rànquing amb les deu millor puntuacions obtingudes. Aquestes es desen en un fitxer, de manera que es mantenen entre partides diferents. En finalitzar el joc, si un jugador ha obtingut una puntuació que mereix estar entre les deu primeres, pot indicar quines són les seves inicials (tres lletres), perquè hi constin associades a la puntuació.</div>
</li>
<li class="level1"><div class="li"> Ara mateix, els atributs dels adversaris estan escrits en el codi font del programa (a la classe <code>Bestiari</code>). Això impedeix afegir nous adversaris fàcilment. Caldria modificar el seu codi font i compilar de nou el programa. Estaria bé que les dades dels adversaris s’obtinguin d’un fitxer, de manera que, només modificant aquest fitxer, el programa ja incorpora sempre automàticament els adversaris continguts.</div>
</li>
</ul>

</div>

<h2><a id="criteris_d_eleccio_de_tipus_de_fitxer" >Criteris d&#039;elecció de tipus de fitxer</a></h2>
<div class="level2">

<p>
Una de les primeres decisions que cal prendre quan cal tractar fitxers és establir com s’hi emmagatzemaran les dades (en format caràcter o byte) i l’accés que es durà a terme (seqüencial o relatiu). En molts casos, sigui quin sigui el sistema triat, el problema es podrà resoldre igualment. L’única diferència serà la complexitat de l’algorisme que cal implementar i el nombre de vegades que s’ha de llegir el fitxer. En qualsevol cas, usar accés relatiu sempre implicarà que el fitxer serà orientat a byte. 
</p>

<p>

</p>

<p>
A la <span class="tabref"><a href="#Table6"><span>taula</span></a></span> es resumeixen alguns pros i contres de cada tipus, perquè els tingueu en compte.
</p>
<div class="ioctable ">
<div class="titletable"><a name="Table6"><span>Taula: </span></a>Avantatges i desavantatges segons el tipus de fitxers</div>
<div class="table"><table class="inline">
	<tr class="row0">
		<th class="col0"> Tipus de fitxer </th><th class="col1"> Avantatges </th><th class="col2"> Desavantatges </th>
	</tr>
	<tr class="row1">
		<td class="col0"> Orientat a caràcter </td><td class="col1"> Són fàcils de crear i editar amb eines externes (un editor de text simple). <br/>
Són fàcils de depurar (veure si el seu contingut és correcte. <br/>
En llegir-los, és fàcil comprovar mitjançant codi de tipus d’una dada dades abans de llegir-la (mètodes <code>hasNex…</code>). </td><td class="col2"> La mida que ocupa cada valor pot ser molt variable. <br/>
Cal controlar el nombre de valor en el fitxer, o alguna marca de finalització <br/>
Només permeten tractament seqüencial. <br/>
No es poden sobreescriure fragments concrets. Cal reescriure tot el fitxer al complet. </td>
	</tr>
	<tr class="row2">
		<td class="col0"> Orientat a byte </td><td class="col1"> La mida que ocupa cada valor es sempre la mateixa. <br/>
Lligat al punt anterior, es fàcil calcular quants valors contenen. <br/>
Permeten l’accés relatiu. <br/>
Permeten sobreescriptures parcials de les dades. </td><td class="col2"> El codi és més complicat. <br/>
No és fàcil veure què contenen. <br/>
No permeten comprovar els tipus dels valors abans de llegir-los. En cas d’error, és difícil de detectar. </td>
	</tr>
</table></div>
</div>
</div>

<h2><a id="la_biblioteca_jocarenafitxers" >La biblioteca &quot;joc.arena.fitxers&quot;</a></h2>
<div class="level2">

<p>
Normalment, el tractament de dades dins de fitxers se sol fer en un <em>package</em> diferenciat. Aquesta decisió és coherent amb la de disposar, per exemple, d’un altre vinculat a l’entrada / sortida de dades amb el teclat i la pantalla. A l’hora de triar el nom del <em>package</em>, és recomanable mantenir també en el seu nom la relació jeràrquica entre mòduls dins l’aplicació. Per tant, aquest <em>package</em> es pot dir <code>joc.arena.fitxers</code>.
</p>

<p>
Una aproximació assenyada per enfocar l’estructura d’aquesta biblioteca és fer-ho de manera que cada fitxer sigui tractat per una classe diferent. En aquest cas, doncs, caldrà dues classes noves, una per tractar el fitxer amb la llista de puntuacions i un altre per al tractament dels adversaris.
</p>

</div>

<h3><a id="la_classe_ranquing" >La classe Ranquing</a></h3>
<div class="level3">

<p>
Aquesta classe serà l’encarregada de gestionar el fitxer amb les màximes puntuacions. Ha de poder tant llegir-les per mostrar-les per pantalla com modificar-ho per escriure’n de noves.
</p>

<p>
<div class="iocfigurec">
<ul>
<li>
<img src="../media/ic10m3u6_16.png" class="imgB" title="Una llista de màximes puntuacions./-8" alt="Una llista de màximes puntuacions./-8" /></li><li><small>Una llista de màximes puntuacions.</small></li>
</ul></div>

</p>

<p>
Amb vista a tenir una idea clara de com ha de funcionar, cal decidir quin serà el funcionament exacte de la llista de puntuacions màximes. Aquesta llista tindrà sempre 10 entrades, i inicialment, quan encara no s’ha jugat cap partida, hi haurà un seguit de puntuacions per defecte.
</p>

</div>

<h4><a id="eleccio_de_tipus_de_fitxer_i_acces" >Elecció de tipus de fitxer i accés</a></h4>
<div class="level4">

<p>
Abans de començar cal escollir el nom del fitxer on mantenir les dades persistents, la seva ubicació al sistema de fitxers, i el seu tipus i com tractar-lo.
</p>

<p>
Pel que fa al nom, això ja és a gust del programador. En aquest cas, es pot anomenar “Ranquing”. Ara bé, per triar-ne la ubicació, el més assenyat normalment és que la ruta a un fitxer sigui relativa, per no imposar cap restricció sobre quines carpetes hi han d’haver en cada ordinador on es copiï el programa. En aquest cas es pot usar la pròpia carpeta de treball de l’aplicació.
</p>

<p>
Només queda decidir el tipus de fitxer. D’entrada, sempre val la pena preveure l’opció d’un fitxer de text seqüencial, ja que és el més senzill de processar i depurar. En aquest sentit, un llistat de 10 puntuacions és una informació que es pot tractar seqüencialment de manera simple, tant per mostrar-la per pantalla com per cercar on cal afegir nous elements. L’única part on no tot encaixa perfectament és per inserir puntuacions. Caldrà reescriure el fitxer des de zero. Però com és un fitxer molt petit, 10 línies, no és un gran problema i es considera assumible.
</p>

</div>

<h4><a id="propagacio_d_errors" >Propagació d&#039;errors</a></h4>
<div class="level4">

<p>
Quan es realitzen operacions sobre fitxer, poden succeir un seguit de situacions errònies. Per exemple, intentar llegir dades d’un fitxer inexistent, llegir dades quan ja s’ha arribat al final del fitxer o d’un tipus inesperat, en tenir el fitxer un format incorrecte. En Java, aquests errors s’anomenen excepcions, i cal controlar-los usant una sentència <code>try/catch</code>.
</p>

<p>
En el cas d’un programa modular amb fitxers, és molt important que, cada cop que s’invoca un mètode on dins el seu codi es tracten fitxers, el codi que ha dut a terme la invocació pugui establir si tot ha anat bé o no. Per tant, els mètodes que tracten dades en fitxers han de poder avisar si han fet totes les tasques correctament o no.
</p>
<div class="iocimportant"><div class="ioccontent">
<p>
La <strong>propagació d’errors</strong> és el mecanisme mitjançant el qual un mètode avisa al codi que l’ha invocat si ha pogut dur a terme la seva tasca correctament o no.
</p>
</div></div>
<p>
Hi ha diferents mecanismes per dur a terme la propagació d’errors. Per a aquesta classe s’ha usat el més simple, que és reservar un dels valors del paràmetre de sortida per indicar que ha succeït un error (sovint, s’usa el valor -1). Un cop s’ha avaluat el mètode invocat, cal comprovar si el resultat és el valor reservat o no. Si és així, és que hi ha hagut una excepció dins el mètode, i per tant aquest no ha pogut dur a terme la seva tasca correctament. Llavors, cal actuar en conseqüència. Per exemple, mostrant un missatge d’error per pantalla.
</p>

<p>
En el cas de mètodes que no disposen de cap paràmetre de sortida (tipus <code>void</code>), es força a què tinguin un paràmetre de sortida de tipus enter, que servirà exclusivament per establir si tot ha anat bé o no. Normalment, es fa que s’avaluïn a 0 si tot ha anat bé i -1 si hi ha hagut alguna excepció.
</p>

<p>
De moment, en el codi de la classe <code>Ranquing</code> només es pot veure la propagació d’errors pel que fa a la part de tractament d’excepcions i retorn del valor -1. Més endavant, quan es vegi com s’invoquen aquests mètodes des d’altres classes, us quedarà més clar com es controla la propagació per establir si el mètode ha funcionat correctament o no i actuar en conseqüència.
</p>

</div>

<h4><a id="codi_font_de_la_classe" >Codi font de la classe</a></h4>
<div class="level4">

<p>
Donades les necessitats exposades, el codi font de la classe pot ser el que es mostra tot seguit. Entre les seves particularitats, a part dels aspectes anteriors, hi ha les crides internes al mètode <code>generarFitxerInicial</code>, que comprova si el el fitxer de puntuacions existeix, i si no és el cas, el crea des de zero. Això és més eficient que no pas dir que hi ha un error i no poder fer-hi res. Sobretot en el cas que s’acaba de jugar una partida on s’ha obtingut una màxima puntuació, ja que aquesta es perdria! Sempre és millor corregir un error si és possible, en lloc de simplement anunciar-lo i no fer-hi res més.
</p>

<p>
També, donades les particularitats dels fitxers seqüencials, observeu en el mètode <code>entrarPuntuacio</code> com cal generar un fitxer temporal, ja que no es pot sobreescriure directament l’original.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">package joc.arena.fitxers;</div></li><li class="li1"><div class="de1">import java.io.File;</div></li><li class="li1"><div class="de1">import java.io.PrintStream;</div></li><li class="li1"><div class="de1">import java.util.Scanner;</div></li><li class="li1"><div class="de1">public class Ranquing {</div></li><li class="li1"><div class="de1">   //Nom fitxer com a constant</div></li><li class="li1"><div class="de1">   public static final String RANQUING = &quot;Ranquing&quot;;</div></li><li class="li1"><div class="de1">   /** Crea el fitxer de puntuacions inicial</div></li><li class="li1"><div class="de1">    * @return 0 si tot correcte, -1 si error</div></li><li class="li1"><div class="de1">    */</div></li><li class="li1"><div class="de1">   public int generarFitxerInicial() {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      File ranquing = new File(RANQUING);</div></li><li class="li1"><div class="de1">      if (ranquing.isFile() == false) {</div></li><li class="li1"><div class="de1">        PrintStream ps = new PrintStream(ranquing);</div></li><li class="li1"><div class="de1">        for (int i = 0; i &lt; 10; i++) {</div></li><li class="li1"><div class="de1">          ps.println(&quot;IOC &quot; + (10 - i)*10);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">        ps.close();</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      return 0;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      //Propagació d'error</div></li><li class="li1"><div class="de1">      return -1;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">   }</div></li><li class="li1"><div class="de1">  /** Donada una puntuació, estableix la seva posició al fitxer</div></li><li class="li1"><div class="de1">   * @param punts Punts que cal comprovar</div></li><li class="li1"><div class="de1">   * @return Posició per ala puntuació. -1 si error.</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public int cercarRanking(int punts) {</div></li><li class="li1"><div class="de1">    try {  </div></li><li class="li1"><div class="de1">      int err = generarFitxerInicial();</div></li><li class="li1"><div class="de1">      if (err == -1) {</div></li><li class="li1"><div class="de1">        return -1;    </div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      File ranquing = new File(RANQUING);</div></li><li class="li1"><div class="de1">      Scanner lector = new Scanner(ranquing);</div></li><li class="li1"><div class="de1">      int pos = 0;</div></li><li class="li1"><div class="de1">      while (pos &lt; 10) {</div></li><li class="li1"><div class="de1">        lector.next();</div></li><li class="li1"><div class="de1">        if (lector.hasNextInt()) {</div></li><li class="li1"><div class="de1">          int ranqPts = lector.nextInt();</div></li><li class="li1"><div class="de1">          if (punts &gt; ranqPts) {</div></li><li class="li1"><div class="de1">            return pos;</div></li><li class="li1"><div class="de1">          }</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">          //Error en el format del fitxer</div></li><li class="li1"><div class="de1">          return -1;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">        pos++;</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      lector.close();</div></li><li class="li1"><div class="de1">      return pos;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      return -1;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Insereix una puntuació al ranquing</div></li><li class="li1"><div class="de1">   * @param inicials Inicials del jugador</div></li><li class="li1"><div class="de1">   * @param punts Puntuació assolida</div></li><li class="li1"><div class="de1">   * @param pos Posició dins el ranquing</div></li><li class="li1"><div class="de1">   * @return 0 si tot correcte, -1 si error.</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public int entrarPuntuacio(String inicials, int punts, int pos) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      int err = generarFitxerInicial();</div></li><li class="li1"><div class="de1">      if (err == -1) {</div></li><li class="li1"><div class="de1">        return -1;    </div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      File ranquing = new File(RANQUING);</div></li><li class="li1"><div class="de1">      Scanner lector = new Scanner(ranquing);</div></li><li class="li1"><div class="de1">      File tmp = new File (RANQUING + &quot;.tmp&quot;);</div></li><li class="li1"><div class="de1">      PrintStream ps = new PrintStream(tmp);</div></li><li class="li1"><div class="de1">      //Reescriure anteriors a posicio</div></li><li class="li1"><div class="de1">      for(int i = 0; i &lt; pos; i++) {</div></li><li class="li1"><div class="de1">        String txt = lector.nextLine();</div></li><li class="li1"><div class="de1">        ps.println(txt);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      //Escriure nova puntuació</div></li><li class="li1"><div class="de1">      ps.println(inicials + &quot; &quot; + punts);</div></li><li class="li1"><div class="de1">      //Reescriure posteriors a posició</div></li><li class="li1"><div class="de1">      for(int i = pos + 1; i &lt; 10; i++) {</div></li><li class="li1"><div class="de1">        String txt = lector.nextLine();</div></li><li class="li1"><div class="de1">        ps.println(txt);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      ps.close();</div></li><li class="li1"><div class="de1">      lector.close();</div></li><li class="li1"><div class="de1">      //S'esborra fitxer antic i es posa el nou</div></li><li class="li1"><div class="de1">      ranquing.delete();</div></li><li class="li1"><div class="de1">      tmp.renameTo(ranquing);</div></li><li class="li1"><div class="de1">      return 0;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      return -1;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Llegeix les puntuacions i les formata com una cadena de text</div></li><li class="li1"><div class="de1">   * @return Cadena de text resultant. null si hi ha error</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public String llegirRanquing() {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      int err = generarFitxerInicial();</div></li><li class="li1"><div class="de1">      if (err == -1) {</div></li><li class="li1"><div class="de1">        return null;    </div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      String txtRanquing = &quot;Ranquing de puntuacions\n----------------------\n&quot;;</div></li><li class="li1"><div class="de1">      File ranquing = new File(RANQUING);</div></li><li class="li1"><div class="de1">      Scanner lector = new Scanner(ranquing);</div></li><li class="li1"><div class="de1">      for (int i = 0; i &lt; 10; i++) {</div></li><li class="li1"><div class="de1">        //Llegir inicials</div></li><li class="li1"><div class="de1">        txtRanquing = txtRanquing + lector.next();</div></li><li class="li1"><div class="de1">        //Llegir punts</div></li><li class="li1"><div class="de1">        if (lector.hasNextInt()) {</div></li><li class="li1"><div class="de1">          txtRanquing = txtRanquing + &quot;\t&quot; + lector.nextInt() + &quot;\n&quot;;</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">          //Error en el format del fitxer</div></li><li class="li1"><div class="de1">          return null;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      lector.close();</div></li><li class="li1"><div class="de1">      return txtRanquing;</div></li><li class="li1"><div class="de1">    }  catch (Exception e) {</div></li><li class="li1"><div class="de1">      return null;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</div>

<h3><a id="la_classe_bestiari" >La classe Bestiari</a></h3>
<div class="level3">

<p>
La classe <code>Bestiari</code> és l’encarregada de generar els lluitadors, tant el jugador a l’inici del joc com els successius adversaris. A la versió original tot està emmagatzemat en el codi font del programa. Ara es vol fer una nova versió, pertanyent a un <em>package</em> diferent, que obtingui tota la informació des d’un fitxer. D’aquesta manera, és possible usar diferents llistes d’adversaris, o afegir-ne de nous, sense haver de modificar el codi font del programa. Només cal canviar aquest fitxer.
</p>

</div>

<h4><a id="eleccio_de_tipus_de_fitxer_i_acces1" >Elecció de tipus de fitxer i accés</a></h4>
<div class="level4">

<p>
En aquest cas, el nom del fitxer on tenir desades les dades dels adversaris serà “Adversaris”, i també s’usarà una ruta relativa.
</p>

<p>
Abans de poder escriure el codi font cal tenir ben clar quin serà el format del fitxer i la seva estructura. En aquest cas, us trobeu que heu d’adaptar una classe en la qual tot s’estructura dins un <em>array</em> originalment, i el que es vol és treballar sobre un fitxer. El tipus de fitxer que s’assembla més a un <em>array</em> en la seva manera de treballar, per poder accedir a les seves posicions de manera directa, és un fitxer d’accés relatiu. Per tant, s’usarà aquest sistema de tractament de dades, cosa que implica que cal usar un fitxer orientat a byte.
</p>

<p>
Cal definir detalladament l’estructura del fitxer i com s’agrupen els conjunts de valors emmagatzemats (els atributs dels adversaris). El més sensat és proposar una adaptació més o menys directa de l’<em>array</em> usat en la versió original. Ara bé, per poder treballar amb un fitxer orientat a byte de manera relativa, com si fos un <em>array</em>, és important que cada conjunt de dades tingui una mida fixa (en aquest cas, cada adversari). Això vol dir que cal fitar la mida del nom. No pot ser de qualsevol llargària. Per a aquest programa, la mida es fitarà a 15 caràcters. En el cas de noms amb menys de 15 caràcters, la resta de bytes s’omplen tots a 0 fins a arribar als 15 caràcters (30 bytes).
</p>
<div class="iocnote"><div class="ioccontent">
<p>
Amb un fitxer relatiu orientat a byte, fins i tot és possible plantejar cerques dicotòmiques directament sobre aquest.
</p>
</div></div>
<p>
D’aquesta manera, cada adversari ocupa sempre 50 bytes: 15*2 (nom, compost de 15 caràcters de 2 bytes) + 5*4 (els 5 atributs, que són enters de 4 bytes). La <span class="tabref"><a href="#Table7"><span>taula</span></a></span> mostra un resum de l’estructura.
</p>
<div class="ioctable ">
<div class="titletable"><a name="Table7"><span>Taula: </span></a>Estructura de les dades associades a un adversari</div>
<div class="table"><table class="inline">
	<tr class="row0">
		<th class="col0">Bytes 0-29 </th><th class="col1">Bytes 30-33 </th><th class="col2">Bytes 34-37 </th><th class="col3">Bytes 38-41 </th><th class="col4">Bytes 42-45 </th><th class="col5">Bytes 46-49 </th>
	</tr>
	<tr class="row1">
		<td class="col0"> Nom (caràcters) </td><td class="col1"> Nivell (enter) </td><td class="col2"> Punts (enter) </td><td class="col3"> Vida Màx (enter) </td><td class="col4"> Atac (enter) </td><td class="col5"> Defensa (enter) </td>
	</tr>
</table></div>
</div>
<p>

</p>

<p>
Donada aquesta estructura, la <span class="figref"><a href="#Figure13"><span>figura</span></a></span> mostraria un exemple de visualització del fitxer mitjançant un editor hexadecimal. Les dades relatives al primer adversari (de nom “Nan”) estan ombrejades. Fixeu-vos com els primers 34 bytes corresponen al nom. Els 6 primers són els caràcters del nom pròpiament i la resta són a 0. A partir del byte número 30, hi ha cinc enters, cadascun de 4 bytes, associats als seus atributs, de manera que:
</p>
<ul>
<li class="level1"><div class="li"> Nivell = 0x00000001</div>
</li>
<li class="level1"><div class="li"> Punts = 0x00000019 (25 en decimal)</div>
</li>
<li class="level1"><div class="li"> Vida = 0x00000008</div>
</li>
<li class="level1"><div class="li"> Atac = 0x00000003</div>
</li>
<li class="level1"><div class="li"> Defensa = 0x00000003</div>
</li>
</ul>
<div class="iocfigure"><a name="Figure13"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Contingut del fitxer d’adversaris visualitzat amb un editor hexadecimal

</figcaption><img src="../media/ic10m3u6_17.png" alt="" /></figure>
</div>
</div>

<h4><a id="codi_font_de_la_classe1" >Codi font de la classe</a></h4>
<div class="level4">

<p>
Aquest cas és una mica diferent del rànquing de puntuacions, ja que no es tracta d’afegir un mòdul nou. Es tracta de reemplaçar un mòdul amb unes funcions concretes (gestionar adversaris a partir d’unes variables globals) per un amb unes altres (que aquesta gestió es faci usant un fitxer). Això és una situació molt interessant, ja que si s’apliquen els principis de modularitat correctament, les modificacions a la resta del programa haurien de ser mínimes. 
</p>

<p>
<div class="iocfigurec">
<ul>
<li>
<img src="../media/ic10m3u6_18.png" class="imgB" title="Canviar un mòdul d&#039;un programa hauria de ser com canviar un moble modular. Font: Bercik/-29" alt="Canviar un mòdul d&#039;un programa hauria de ser com canviar un moble modular. Font: Bercik/-29" /></li><li><small>Canviar un mòdul d&#039;un programa hauria de ser com canviar un moble modular. Font: Bercik</small></li>
</ul></div>

</p>

<p>
Aquest és, precisament, el sentit de la modularitat. Poder canviar un mòdul (en aquest cas, una classe), per un altre sense haver de tocar res més. Tal com es faria quan es canvia una calaixera modular o un mòdul de memòria de l’ordinador. Treieu l’antic, poseu el nou, i tot continua funcionant sense haver de tocar res més. Si s’assoleix això, tot s’ha fet perfectament.
</p>

<p>
L’estratègia per assolir aquesta fita sempre és la mateixa. Intentar mantenir els mateixos mètodes, amb els mateixos paràmetres, que hi havia a la classe original, i només modificar el bloc de codi que contenen. D’aquesta manera, no cal esmenar el codi on hi ha invocacions en qualsevol dels mètodes originals, ja que la seva definició serà la mateixa a la classe nova que a l’antiga. Si és necessari, es poden afegir nous mètodes, però és imprescindible mantenir el format dels que ja hi havia abans del canvi.
</p>

<p>
Per tant, fixeu-vos com, a la nova classe, els mètodes que hi ha són exactament els mateixos que hi havia inicialment, mantenint el seu format (nom i paràmetres). Tot i així, s’han creat alguns mètodes nous per tal reutilitzar codi (per exemple, <code>crearAdversari</code> o <code>llegirNom</code>).
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">package joc.arena.fitxers;</div></li><li class="li1"><div class="de1">import java.io.File;</div></li><li class="li1"><div class="de1">import java.io.RandomAccessFile;</div></li><li class="li1"><div class="de1">import java.util.Random;</div></li><li class="li1"><div class="de1">import joc.arena.regles.Lluitador;</div></li><li class="li1"><div class="de1">public class Bestiari {</div></li><li class="li1"><div class="de1">  //Constant amb el nom del fitxer d'adversaris</div></li><li class="li1"><div class="de1">  private static final File ADVERSARIS = new File(&quot;Adversaris&quot;);</div></li><li class="li1"><div class="de1">  //Jugador: ID = 0</div></li><li class="li1"><div class="de1">  private int[] jugador = {0,  1,  0, 10, 10, 3, 3, 3, 3};</div></li><li class="li1"><div class="de1">  private Lluitador lluitador = new Lluitador();</div></li><li class="li1"><div class="de1">  //Tots els mètodes mantenen la seva declaració (nom i paràmetres)</div></li><li class="li1"><div class="de1">  /** Genera un nou jugador</div></li><li class="li1"><div class="de1">   *</div></li><li class="li1"><div class="de1">   * @return Un array amb les dades d'un jugador inicial</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public int[] generarJugador() {</div></li><li class="li1"><div class="de1">    lluitador.renovar(jugador);</div></li><li class="li1"><div class="de1">    return jugador;</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Donat un nom, genera l'adversari corresponent. Si aquest nom no existeix,</div></li><li class="li1"><div class="de1">   * es genera a l'atzar.</div></li><li class="li1"><div class="de1">   *</div></li><li class="li1"><div class="de1">   * @param nomAdv Nom de l'adversari a obtenir</div></li><li class="li1"><div class="de1">   * @return El Lluitador amb aquest nom, o null si no existeix</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public int[] cercarAdversari(String nomAdv) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      int[] adversari = null;    </div></li><li class="li1"><div class="de1">      RandomAccessFile raf = new RandomAccessFile(ADVERSARIS, &quot;r&quot;);</div></li><li class="li1"><div class="de1">      long numAdv = ADVERSARIS.length()/50;</div></li><li class="li1"><div class="de1">      for (int i = 0; i &lt; numAdv; i++) {</div></li><li class="li1"><div class="de1">        raf.seek(50*i);  </div></li><li class="li1"><div class="de1">        String nom = llegirNom(raf);</div></li><li class="li1"><div class="de1">        if (nom.equalsIgnoreCase(nomAdv)) {</div></li><li class="li1"><div class="de1">          adversari = crearAdversari(raf,i);    </div></li><li class="li1"><div class="de1">        }        </div></li><li class="li1"><div class="de1">      }      </div></li><li class="li1"><div class="de1">      raf.close();</div></li><li class="li1"><div class="de1">      return adversari;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      return null;    </div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Obté l'adversari que hi ha en un ordre concret del fitxer, </div></li><li class="li1"><div class="de1">   * en fomat array.</div></li><li class="li1"><div class="de1">   * </div></li><li class="li1"><div class="de1">   * @param raf Fitxer relatiu d'on llegir-lo</div></li><li class="li1"><div class="de1">   * @param pos Posició de l'adversari dins del fitxer</div></li><li class="li1"><div class="de1">   * @return LLuitador llegit</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public int[] crearAdversari(RandomAccessFile raf, int pos) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      int[] adversari = new int[9];</div></li><li class="li1"><div class="de1">      raf.seek(pos*50 + 30);</div></li><li class="li1"><div class="de1">      adversari[0] = pos + 1;</div></li><li class="li1"><div class="de1">      adversari[1] = raf.readInt();</div></li><li class="li1"><div class="de1">      adversari[2] = raf.readInt();</div></li><li class="li1"><div class="de1">      adversari[3] = raf.readInt();</div></li><li class="li1"><div class="de1">      adversari[4] = adversari[3];</div></li><li class="li1"><div class="de1">      adversari[5] = raf.readInt();</div></li><li class="li1"><div class="de1">      adversari[6] = adversari[5];</div></li><li class="li1"><div class="de1">      adversari[7] = raf.readInt();</div></li><li class="li1"><div class="de1">      adversari[8] = adversari[7];</div></li><li class="li1"><div class="de1">      return adversari;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      return null;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Donat un fitxer relatiu orientat a byte, correctament posicionat,</div></li><li class="li1"><div class="de1">   * llegeix el nom de l'adversari.</div></li><li class="li1"><div class="de1">   *</div></li><li class="li1"><div class="de1">   * @param raf Fitxer a tractar</div></li><li class="li1"><div class="de1">   * @return Nom llegit, o null si hi ha error</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public String llegirNom(RandomAccessFile raf) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      String nom = &quot;&quot;;</div></li><li class="li1"><div class="de1">      char c = raf.readChar();</div></li><li class="li1"><div class="de1">      while (c != 0x0000) {</div></li><li class="li1"><div class="de1">        nom = nom + c;</div></li><li class="li1"><div class="de1">        c = raf.readChar();</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      return nom;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      return null;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1"> /**Donat un nivell, genera l'adversari corresponent a l'atzar. Es tracta</div></li><li class="li1"><div class="de1">   * d'un adversari que sigui almenys d'aquest nivell </div></li><li class="li1"><div class="de1">   *</div></li><li class="li1"><div class="de1">   * @param nivell Nivell proper al de l'adversari a obtenir</div></li><li class="li1"><div class="de1">   * @return Un adversari</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public int[] triarAdversariAtzar(int nivell) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      RandomAccessFile raf = new RandomAccessFile(ADVERSARIS,&quot;r&quot;);</div></li><li class="li1"><div class="de1">      Random rnd = new Random();</div></li><li class="li1"><div class="de1">      int numAdv = (int)raf.length()/50;</div></li><li class="li1"><div class="de1">      int[] adversari = null;</div></li><li class="li1"><div class="de1">      boolean cercar = true;</div></li><li class="li1"><div class="de1">      while (cercar) {</div></li><li class="li1"><div class="de1">        int i = rnd.nextInt(numAdv);</div></li><li class="li1"><div class="de1">        adversari = crearAdversari(raf, i);;</div></li><li class="li1"><div class="de1">        int nivellAdv = lluitador.llegirNivell(adversari);</div></li><li class="li1"><div class="de1">        int dif = nivell - nivellAdv;</div></li><li class="li1"><div class="de1">        if ((dif &gt;= -1)&amp;&amp;(dif &lt;= 1)) {</div></li><li class="li1"><div class="de1">          cercar = false;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      raf.close();</div></li><li class="li1"><div class="de1">      return adversari;</div></li><li class="li1"><div class="de1">    } catch (Exception e)  {</div></li><li class="li1"><div class="de1">      return null;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Transforma un identificador de Lluitador al seu nom.</div></li><li class="li1"><div class="de1">   *</div></li><li class="li1"><div class="de1">   * @param id Identificador</div></li><li class="li1"><div class="de1">   * @return La cadena de text amb el nom.</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public String traduirIDANom(int id) {</div></li><li class="li1"><div class="de1">    if (id == 0)  {</div></li><li class="li1"><div class="de1">      return &quot;Aventurer&quot;;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">    id--;</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      RandomAccessFile raf = new RandomAccessFile(ADVERSARIS, &quot;r&quot;);</div></li><li class="li1"><div class="de1">      int pos = 50*id;</div></li><li class="li1"><div class="de1">      String nom = &quot;DESCONEGUT&quot;;</div></li><li class="li1"><div class="de1">      if (pos &lt; raf.length()) {</div></li><li class="li1"><div class="de1">        raf.seek(pos);</div></li><li class="li1"><div class="de1">        nom = llegirNom(raf);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      raf.close();</div></li><li class="li1"><div class="de1">      return nom;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      return &quot;DESCONEGUT&quot;;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Diu si hi ha el fitxer d'adversaris</div></li><li class="li1"><div class="de1">   * </div></li><li class="li1"><div class="de1">   * @return Si existeix (true) o no (false)</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public boolean existeixFitxer() {</div></li><li class="li1"><div class="de1">    return ADVERSARIS.isFile();</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</div>

<h3><a id="la_classe_auxiliar_editorbestiari" >La classe auxiliar EditorBestiari</a></h3>
<div class="level3">

<p>
El problema dels fitxers orientats a byte és que no resulten fàcils d’editar. Per això, per a aquest cas, pot resultar útil disposar d’un programa auxiliar que serveixi d’editor de la llista d’adversaris, de manera que sigui fàcil manipular-la. Aquest pot visualitzar, afegir i esborrar entrades al fitxer binari.
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">Eines de desenvolupament de jocs</p>
<p>
És molt habitual que els programadors de videojocs tinguin eines auxiliars per generar els fitxers de dades dels jocs que estan creant. Aquestes s’anomenen <a href="http://en.wikipedia.org/wiki/Game_development_tool" class="urlextern" title="http://en.wikipedia.org/wiki/Game_development_tool"  rel="nofollow">eines de desenvolupament de jocs</a>.
</p>
</div></div>
</div>

<h4><a id="codi_font_de_la_classe2" >Codi font de la classe</a></h4>
<div class="level4">

<p>
Tot seguit es mostra el codi font d’aquest programa auxiliar, creat monolíticament en una sola classe, però aplicant disseny descendent. El fitxer d’adversaris es pot editar partint des de zero, o bé des d’un ja existent. Per simplificar el seu codi, totes les operacions d’afegir o eliminar treballen sobre el final del fitxer del fitxer.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">package joc.arena.fitxers;</div></li><li class="li1"><div class="de1">import java.io.File;</div></li><li class="li1"><div class="de1">import java.io.RandomAccessFile;</div></li><li class="li1"><div class="de1">import java.util.Scanner;</div></li><li class="li1"><div class="de1">public class EditorBestiari {</div></li><li class="li1"><div class="de1">  public static final int MAX_CHAR_NOM = 15;</div></li><li class="li1"><div class="de1">  public static final int MIDA_BYTES_ADV = 50;</div></li><li class="li1"><div class="de1">  public static void main (String[] args) {</div></li><li class="li1"><div class="de1">    EditorBestiari programa = new EditorBestiari();</div></li><li class="li1"><div class="de1">    programa.inici();</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  public void inici() {</div></li><li class="li1"><div class="de1">    File fitxer = preguntarFitxer();</div></li><li class="li1"><div class="de1">    boolean executar = true;</div></li><li class="li1"><div class="de1">    while (executar) {</div></li><li class="li1"><div class="de1">      executar = tractarMenu(fitxer);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Pregunta a l'usuari el nom del fitxer a editar.</div></li><li class="li1"><div class="de1">   * @return Ruta al fitxer a editar.</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public File preguntarFitxer() {</div></li><li class="li1"><div class="de1">    Scanner lector = new Scanner(System.in);</div></li><li class="li1"><div class="de1">    System.out.print(&quot;Nom del fitxer a editar: &quot;);</div></li><li class="li1"><div class="de1">    String nom = lector.nextLine();</div></li><li class="li1"><div class="de1">    File fitxer = new File(nom);</div></li><li class="li1"><div class="de1">    return fitxer;</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Fa el tractament del menú de l'usuari.</div></li><li class="li1"><div class="de1">   * @param fitxer Fitxer que cal tractar</div></li><li class="li1"><div class="de1">   * @return Si cal seguir executant del programa (true) o encara no (false)</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public boolean tractarMenu(File fitxer) {</div></li><li class="li1"><div class="de1">    mostrarFitxer(fitxer);</div></li><li class="li1"><div class="de1">    System.out.println(&quot;------------------------------&quot;);</div></li><li class="li1"><div class="de1">    System.out.println(&quot;[A]fegir\t[E]liminar darrer\t[S]ortir&quot;);</div></li><li class="li1"><div class="de1">    boolean preguntar = true;</div></li><li class="li1"><div class="de1">    Scanner lector = new Scanner(System.in);</div></li><li class="li1"><div class="de1">    while (preguntar) {</div></li><li class="li1"><div class="de1">      System.out.print(&quot;Accio: &quot;);</div></li><li class="li1"><div class="de1">      String resposta = lector.nextLine();</div></li><li class="li1"><div class="de1">      if (&quot;A&quot;.equalsIgnoreCase(resposta)) {</div></li><li class="li1"><div class="de1">        afegirAdversari(fitxer);</div></li><li class="li1"><div class="de1">        preguntar = false;</div></li><li class="li1"><div class="de1">      } else if (&quot;E&quot;.equalsIgnoreCase(resposta)) {</div></li><li class="li1"><div class="de1">        eliminarAdversari(fitxer);</div></li><li class="li1"><div class="de1">        preguntar = false;</div></li><li class="li1"><div class="de1">      } else if (&quot;S&quot;.equalsIgnoreCase(resposta)) {</div></li><li class="li1"><div class="de1">        return false;</div></li><li class="li1"><div class="de1">      } else {</div></li><li class="li1"><div class="de1">        System.out.print(&quot;Accio incorrecta...&quot;);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">    return true;</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Mostra el contingut del fitxer per pantalla</div></li><li class="li1"><div class="de1">   * @param fitxer Ruta al fitxer a mostrar</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public void mostrarFitxer(File fitxer) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      if (fitxer.isFile() == false) {</div></li><li class="li1"><div class="de1">        System.out.println(&quot;Encara no s'ha creat el fitxer.&quot;);</div></li><li class="li1"><div class="de1">      } else {</div></li><li class="li1"><div class="de1">        RandomAccessFile raf = new RandomAccessFile(fitxer, &quot;r&quot;);</div></li><li class="li1"><div class="de1">        long numAdversaris = fitxer.length()/MIDA_BYTES_ADV;</div></li><li class="li1"><div class="de1">        if (numAdversaris == 0) {</div></li><li class="li1"><div class="de1">          System.out.println(&quot;El fitxer és buit.&quot;);</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">          for (int i = 0; i &lt;numAdversaris; i++) {</div></li><li class="li1"><div class="de1">            String nom = llegirNom(raf);</div></li><li class="li1"><div class="de1">            System.out.print(nom);</div></li><li class="li1"><div class="de1">            for (int z = 0; z &lt; (MAX_CHAR_NOM - nom.length()); z++) {</div></li><li class="li1"><div class="de1">              System.out.print(&quot; &quot;);</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">            //Cada adversari coupa 50 bytes. El tros del nom n'ocupa 15*2</div></li><li class="li1"><div class="de1">            raf.seek(i*MIDA_BYTES_ADV + MAX_CHAR_NOM*2);</div></li><li class="li1"><div class="de1">            System.out.print(&quot;: \tNivell: &quot; + raf.readInt());</div></li><li class="li1"><div class="de1">            System.out.print(&quot; (punts: &quot; + raf.readInt() + &quot;)&quot;);</div></li><li class="li1"><div class="de1">            System.out.print(&quot;\tVIDA: &quot; + raf.readInt());</div></li><li class="li1"><div class="de1">            System.out.print(&quot;\tATAC: &quot; + raf.readInt());</div></li><li class="li1"><div class="de1">            System.out.println(&quot;\tDEFENSA: &quot; + raf.readInt());</div></li><li class="li1"><div class="de1">          }</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">        raf.close();</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      System.out.println(&quot;Error accedint al fitxer!&quot;);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Donat un fitxer relatiu orientat a byte, correctament posicionat,</div></li><li class="li1"><div class="de1">   * llegeix el nom de l'adversari.</div></li><li class="li1"><div class="de1">   * @param raf Fitxer a tractar</div></li><li class="li1"><div class="de1">   * @return Nom llegit, o null si hi ha error</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public String llegirNom(RandomAccessFile raf) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      String nom = &quot;&quot;;</div></li><li class="li1"><div class="de1">      char c = raf.readChar();</div></li><li class="li1"><div class="de1">      while (c != 0x0000) {</div></li><li class="li1"><div class="de1">        nom = nom + c;</div></li><li class="li1"><div class="de1">        c = raf.readChar();</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      return nom;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      return null;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Escriu un nou adversari al final del fitxer, preguntant tot el que calgui</div></li><li class="li1"><div class="de1">   * a l'usuari.</div></li><li class="li1"><div class="de1">   * @param fitxer Ruta al fitxer on cal afegir l'adversari.</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public void afegirAdversari(File fitxer) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      RandomAccessFile raf = new RandomAccessFile(fitxer, &quot;rw&quot;);</div></li><li class="li1"><div class="de1">      //Es posa al final de tot</div></li><li class="li1"><div class="de1">      raf.seek(fitxer.length());</div></li><li class="li1"><div class="de1">      System.out.println(&quot;Escriu el nom de l'adversari (màx. 12 lletres): &quot;);</div></li><li class="li1"><div class="de1">      Scanner lector = new Scanner(System.in);</div></li><li class="li1"><div class="de1">      String nom = lector.nextLine();</div></li><li class="li1"><div class="de1">      //Escriure el nom (màx. 15 caràcters)</div></li><li class="li1"><div class="de1">      int err = escriureNom(nom, raf);</div></li><li class="li1"><div class="de1">      if (err == -1) {</div></li><li class="li1"><div class="de1">        System.out.println(&quot;Error escrivint dades al fitxer &quot; + fitxer);</div></li><li class="li1"><div class="de1">      } else {</div></li><li class="li1"><div class="de1">        //Escriure valors - Nivell:XP:PV:Max PV:Atac:Max Atac:max Defensa</div></li><li class="li1"><div class="de1">        System.out.print(&quot;Escriu els seus atributs, separats per espais. &quot;);</div></li><li class="li1"><div class="de1">        System.out.println (&quot;(5 enters = Nivell Punts PV Atac Defensa):&quot;);</div></li><li class="li1"><div class="de1">        int[] valors = llegirValors(lector);</div></li><li class="li1"><div class="de1">        for (int i = 0; i &lt; valors.length; i++) {</div></li><li class="li1"><div class="de1">          raf.writeInt(valors[i]);    </div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      raf.close();</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      System.out.println(&quot;Error escrivint dades al fitxer &quot; + fitxer);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Llegeix cinc valors de tipus enter des del teclat.</div></li><li class="li1"><div class="de1">   * @param lector Scanner que llegeix del teclat</div></li><li class="li1"><div class="de1">   * @return Els cinc valors llegits, ordenadament</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public int[] llegirValors(Scanner lector) {</div></li><li class="li1"><div class="de1">    int[] valors = new int[5];</div></li><li class="li1"><div class="de1">    boolean preguntar = true;</div></li><li class="li1"><div class="de1">    while(preguntar) {</div></li><li class="li1"><div class="de1">      int numLlegits = 0;</div></li><li class="li1"><div class="de1">      for (int i = 0; i &lt; valors.length; i++) {</div></li><li class="li1"><div class="de1">        if (lector.hasNextInt()) {</div></li><li class="li1"><div class="de1">          valors[i] = lector.nextInt();</div></li><li class="li1"><div class="de1">          numLlegits++;</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">          lector.next();</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      if (numLlegits == 5) {</div></li><li class="li1"><div class="de1">        preguntar = false;</div></li><li class="li1"><div class="de1">      } else {</div></li><li class="li1"><div class="de1">        System.out.println(&quot;Els 5 valors no han estat correctes.&quot;);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">    lector.nextLine();</div></li><li class="li1"><div class="de1">    return valors;</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Donat un nom en forma de cadena de text, l'escriu a un fitxer orientat a</div></li><li class="li1"><div class="de1">   * byte. Com a màxim el nom pot tenir 15 caràcters. La resta, s'omple a 0.</div></li><li class="li1"><div class="de1">   * @param nom Nom a escriure</div></li><li class="li1"><div class="de1">   * @param raf Fitxer relatiu correctament posicionat per a l'escriptura</div></li><li class="li1"><div class="de1">   * @return Si ha funcionat (0) o no (-1)</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public int escriureNom(String nom, RandomAccessFile raf) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      int numChars = nom.length();</div></li><li class="li1"><div class="de1">      if (numChars &gt; MAX_CHAR_NOM) {</div></li><li class="li1"><div class="de1">        numChars = MAX_CHAR_NOM;</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      for (int i = 0; i &lt; numChars; i++) {</div></li><li class="li1"><div class="de1">        raf.writeChar(nom.charAt(i));</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      char blank = 0x0000;</div></li><li class="li1"><div class="de1">      for (int i = 0; i &lt; (MAX_CHAR_NOM - numChars); i++) {</div></li><li class="li1"><div class="de1">        raf.writeChar(blank);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      return 0;</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      return -1;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">  /** Elimina el darrer adversari en un fitxer.</div></li><li class="li1"><div class="de1">   * @param fitxer Ruta del fitxer a modificar</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public void eliminarAdversari(File fitxer) {</div></li><li class="li1"><div class="de1">    try {</div></li><li class="li1"><div class="de1">      RandomAccessFile raf = new RandomAccessFile(fitxer,&quot;rw&quot;);</div></li><li class="li1"><div class="de1">      long novaMida = fitxer.length() - MIDA_BYTES_ADV;</div></li><li class="li1"><div class="de1">      //Eliminar el darrer adversari és esborrar els darrers 50 bytes...</div></li><li class="li1"><div class="de1">      if (novaMida &gt;= 0) {</div></li><li class="li1"><div class="de1">        raf.setLength(fitxer.length() - MIDA_BYTES_ADV);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      raf.close();</div></li><li class="li1"><div class="de1">    } catch (Exception e) {</div></li><li class="li1"><div class="de1">      System.out.println(&quot;Error esborrant dades al fitxer &quot; + fitxer);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</div>

<h2><a id="esmenes_als_moduls_originals" >Esmenes als mòduls originals</a></h2>
<div class="level2">

<p>
Un cop s’han generat els nous mòduls que amplien el programa original de manera que algunes de les seves tasques depenguin de la lectura o escriptura de fitxers, cal modificar el codi original per tal que s’usin els nous mòduls. Una correcta aplicació de la modularitat hauria de minimitzar el nombre de canvis al codi i fer que aquests estiguin molt ben localitzats. De fet, el cas ideal seria que només cal afegir nou codi, però no modificar, o fins i tot eliminar, codi ja existent.
</p>

</div>

<h3><a id="a_la_classe_entradateclat" >A la classe EntradaTeclat</a></h3>
<div class="level3">

<p>

</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">El mètode &#039;&#039;trim&#039;&#039; elimina els espais a dreta i esquerra d&#039;un text.</p>
<p>
La introducció d’una màxima puntuació al rànquing implica poder demanar a l’usuari, si es compleixen les condicions necessàries, que introdueixi les seves inicials. Si es vol seguir estrictament el plantejament modular de l’aplicació, això vol dir que cal un nou mètode a la classe <code>EntradaTeclat</code>. Aquest ha de comprovar que, efectivament, es tracta d’unes inicials (en aquest cas, es considera que tres lletres).
</p>
</div></div>
<p>
Noteu que el canvi de la classe <code>Bestiari</code> no afecta en absolut aquesta classe, tot i que la fa servir. Això vol dir que s’ha aplicat correctament la modularitat.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">  //Ara cal importar la nova versió</div></li><li class="li1"><div class="de1">  import joc.arena.fitxers.Bestiari;</div></li><li class="li1"><div class="de1">  //Nou mètode</div></li><li class="li1"><div class="de1">  /** Pregunta les inicials del jugador si assoleix una màxima puntuació.</div></li><li class="li1"><div class="de1">   * @return Inicials (cadena de text amb 3 caràcters)</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public String preguntarInicials() {</div></li><li class="li1"><div class="de1">    Scanner lector = new Scanner(System.in);</div></li><li class="li1"><div class="de1">    System.out.println(&quot;has assolit una màxima puntuació!!&quot;);</div></li><li class="li1"><div class="de1">    String inicials = &quot;&quot;;</div></li><li class="li1"><div class="de1">    boolean llegir = true;</div></li><li class="li1"><div class="de1">    while (llegir) {</div></li><li class="li1"><div class="de1">      System.out.print(&quot;Escriu les teves inicials: &quot;);</div></li><li class="li1"><div class="de1">      inicials = lector.nextLine();</div></li><li class="li1"><div class="de1">      //Aquest mètode elimina espais laterals</div></li><li class="li1"><div class="de1">      inicials = inicials.trim();</div></li><li class="li1"><div class="de1">      if (inicials.length() == 3) {</div></li><li class="li1"><div class="de1">        llegir = false;</div></li><li class="li1"><div class="de1">      } else {</div></li><li class="li1"><div class="de1">        System.out.print(&quot;Entrada incorrecta. &quot;);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">    return inicials.toUpperCase();    //Sempre es posaran en majúscula</div></li><li class="li1"><div class="de1">  }</div></li></ol></pre>

</div>

<h3><a id="a_la_classe_sortidapantalla" >A la classe SortidaPantalla</a></h3>
<div class="level3">

<p>
Un altre nou aspecte del programa és que cal mostrar el rànquing de puntuacions en acabar el joc. Donat el plantejament de la classe <code>Ranquing</code>, aquesta tasca és molt simple i es podria dur a terme directament a <code>JocArena</code>. Tot i així, per ser coherents amb el fet que els mètodes que mostren diverses línies de text per pantalla, com l’estat del lluitador, són a aquesta classe, se serà estricte en l’aplicació de la modularitat tal com s’ha plantejat a l’aplicació originalment. 
</p>

<p>
Com abans, noteu que el canvi de la classe <code>Bestiari</code> no afecta en absolut a aquesta classe, tot i que la fa servir. També observeu ara com es comprova la propagació d’errors des del mètode <code>llegirRanquing</code>, mirant si s’ha avaluat <code>null</code> o no.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">  //Ara cal importar la nova versió</div></li><li class="li1"><div class="de1">  import joc.arena.fitxers.Bestiari;</div></li><li class="li1"><div class="de1">  //Nou mètode</div></li><li class="li1"><div class="de1">  /** Mostra per pantalla la llista de puntuacions</div></li><li class="li1"><div class="de1">   */</div></li><li class="li1"><div class="de1">  public void mostrarRanking() {</div></li><li class="li1"><div class="de1">    Ranquing rnk = new Ranquing();</div></li><li class="li1"><div class="de1">    String s = rnk.llegirRanquing();</div></li><li class="li1"><div class="de1">    if (s == null) {</div></li><li class="li1"><div class="de1">      System.out.println(&quot;Hi ha un error en els fitxers de puntuacions!&quot;);  </div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">      System.out.println(s);    </div></li><li class="li1"><div class="de1">    }    </div></li><li class="li1"><div class="de1">  }</div></li></ol></pre>

</div>

<h3><a id="a_la_classe_jocarena" >A la classe JocArena</a></h3>
<div class="level3">

<p>
En aquesta classe, només cal modificar el mètode <code>inici</code> per tal que, el programa prevegi les noves funcionalitats. D’una banda, ara cal garantir que s’inicialitzen els valors dels adversaris a partir d’un fitxer. D’altra banda, en acabar la partida, cal que es comprovi si pertoca afegir una nova màxima puntuació al fitxer i realitzar les operacions corresponents al teclat i la pantalla (entrar inicials i mostrar rànquing actual). 
</p>
<div class="iocreference"><div class="ioccontent">
<p>
A l’apartat d’annexos dels materials disposeu del codi font complet amb la solució final d’aquest exemple.
</p>
</div></div>
<p>
Tot i que s’ha intentat minimitzar el nombre de canvis necessaris a causa de la nova classe <code>Bestiari</code>, cal alguna modificació, ja que almenys cal controlar si el fitxer d’adversaris existeix abans de fer res. A part d’això, el canvi de classe no afecta en res més.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">  //Ara cal importar la nova versió</div></li><li class="li1"><div class="de1">  import joc.arena.fitxers.Bestiari;</div></li><li class="li1"><div class="de1">  public void inici() {</div></li><li class="li1"><div class="de1">    //Mirar si hi ha fitxer d'adversaris</div></li><li class="li1"><div class="de1">    if (bestiari.existeixFitxer() == false) {</div></li><li class="li1"><div class="de1">      System.out.println(&quot;No hi ha el fitxer d'adversaris!&quot;);</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">      //Codi original</div></li><li class="li1"><div class="de1">      sortida.mostarBenvinguda();</div></li><li class="li1"><div class="de1">      int[] jugador = bestiari.generarJugador();</div></li><li class="li1"><div class="de1">      int numCombat = 0;</div></li><li class="li1"><div class="de1">      boolean jugar = true;</div></li><li class="li1"><div class="de1">       while (jugar) {</div></li><li class="li1"><div class="de1">        numCombat++;</div></li><li class="li1"><div class="de1">        //Abans de cada combat es restaura el jugador</div></li><li class="li1"><div class="de1">        lluitador.restaurar(jugador);</div></li><li class="li1"><div class="de1">        //Inici d'un combat</div></li><li class="li1"><div class="de1">        System.out.println(&quot;*** COMBAT &quot; + numCombat);</div></li><li class="li1"><div class="de1">        System.out.print(&quot;Estat actual del jugador: &quot;);</div></li><li class="li1"><div class="de1">        sortida.mostrarLluitador(jugador);</div></li><li class="li1"><div class="de1">        System.out.println(&quot;**************************&quot;);</div></li><li class="li1"><div class="de1">        //S'obté l'adversari</div></li><li class="li1"><div class="de1">        int[] adversari = entrada.triarAdversari(lluitador.llegirNivell(jugador));</div></li><li class="li1"><div class="de1">        //Combat</div></li><li class="li1"><div class="de1">        combatre(jugador, adversari);</div></li><li class="li1"><div class="de1">        //Fi</div></li><li class="li1"><div class="de1">        jugar = fiCombat(jugador, adversari);</div></li><li class="li1"><div class="de1">        if (numCombat == MAX_COMBAT) {</div></li><li class="li1"><div class="de1">          System.out.println(&quot;Has sobreviscut a tots els combats. Enhorabona!!&quot;);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">      System.out.print(&quot;Estat final del jugador: &quot;);</div></li><li class="li1"><div class="de1">      sortida.mostrarLluitador(jugador);</div></li><li class="li1"><div class="de1">      //Nou: comprovar si entra al rànquing (10 posicions)</div></li><li class="li1"><div class="de1">      Ranquing rnk = new Ranquing();</div></li><li class="li1"><div class="de1">      int punts = lluitador.llegirPunts(jugador);</div></li><li class="li1"><div class="de1">      int pos = rnk.cercarRanking(punts);</div></li><li class="li1"><div class="de1">      if (pos != -1) {</div></li><li class="li1"><div class="de1">        if (pos &lt; 10) {</div></li><li class="li1"><div class="de1">          String inicials = entrada.preguntarInicials();</div></li><li class="li1"><div class="de1">          err = rnk.entrarPuntuacio(inicials, punts, pos);</div></li><li class="li1"><div class="de1">          if (err == -1) {</div></li><li class="li1"><div class="de1">            System.out.println(&quot;Error accedint al fitxer de puntuacions.&quot;);</div></li><li class="li1"><div class="de1">          }</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">        sortida.mostrarRanking();</div></li><li class="li1"><div class="de1">      } else {</div></li><li class="li1"><div class="de1">        System.out.println(&quot;Error accedint al fitxer de puntuacions.&quot;);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  }</div></li></ol></pre>

</div>

	 </article>
     <div class="pnpage">
      <div class="left-corner"></div>
      <div id="prevpage">Anar a la p&agrave;gina anterior:<br /><a href="../../../WebContent/u6/a2/exercicis.html">Exercicis d'autoavaluació</a></div>
      <div id="nextpage">Anar a la p&agrave;gina seg&uuml;ent:<br /><a href="../../../WebContent/u6/a3/activitats.html">Activitats</a></div>
      <div class="right-corner"></div>
     </div>
    </div>
    <footer class="footer">
      <div><small>Aquest document està subjecte a una llicència oberta de Creative Commons, es reserva el dret de reconeixement de l'autoria, d'exigir que no se'n faci cap mena d'ús comercial. Si altereu o transformeu aquesta obra, o en genereu obres derivades, només podeu distribuir l'obra generada amb una llicència idèntica a aquesta.</small></div>
    </footer>
 </div>
 <div id="back_preview" class="hidden"></div>
 <div id="preview" class="hidden">
  <div class="prevcontent"></div>
 </div>
 <div id="help-tooltips">
  <div id="help-toc" class="hidden tooltip"><span>Taula de continguts:</span> Ofereix una vista general de l&#39;estructura del m&ograve;dul, que us facilitar&agrave; la navegaci&oacute; a trav&eacute;s dels seus continguts.<span class="arrow-left"></span></div> 
  <div id="help-settings" class="hidden tooltip"><span>Opcions de format:</span> Permet configurar el format de lectura a partir de les vostres prefer&egrave;ncies, modificant la mida de la lletra, el color del fons, l&#39;amplada de la p&agrave;gina o l&#39;ocultaci&oacute; dels continguts complementaris, entre d&#39;altres.<span class="arrow-left"></span></div>
  <div id="help-printer" class="hidden tooltip"><span>Imprimir:</span>  Envia el contingut seleccionat a la impressora.<span class="arrow-left"></span></div>
  <div id="help-favorites" class="hidden tooltip"><span>Prefereits:</span> Permet desar aquelles parts del contingut a les que us interessi accedir en un moment posterior; us permetr&agrave; anar creant un repositori personalitzat de les seccions que considereu m&eacute;s rellevants. Un cop l&#39;hageu començat a fer servir se us mostrar&agrave; a sota un comptador que us informar&agrave; del nombre de preferits que s&#39;hagin emmagatzemat fins al moment.<span class="arrow-left"></span></div>
  <div id="help-favcounter" class="hidden tooltip"><span>Comptador i llistat de preferits:</span> Indica el nombre de preferits que s&#39;han desat fins el moment; clicant damunt seu accedireu al llistat de preferits, i a trav&eacute;s d&#39;aquest podreu accedir directament als continguts que hageu emmagatzemat.<span class="arrow-left"></span></div>
  <div id="help-help_icon" class="hidden tooltip"><span>Ajuda:</span> Aquesta opci&oacute; activa la informaci&oacute; de les funcionalitats del web tot situant el punter del ratol&iacute; al damunt dels diferents &iacute;tems.<span class="arrow-left"></span></div>
  <div id="help-sidebar-hide" class="hidden tooltip"><span>Mostrar/Ocultar barra lateral:</span>  Deshabilita la barra d&#39;opcions, permetent la seva recuperaci&oacute; quan es desitgi.<span class="arrow-left"></span></div>
  <div id="help-search" class="hidden tooltip"><span>Cerca:</span>  Introdu&iuml;u les paraules clau sobre aquells conceptes que desitgeu localitzar en els continguts del m&ograve;dul. Tamb&eacute; podeu excloure un terme de la cerca tot afegint-hi el signe &#8220;-&#8221; al davant.<span class="arrow-top"></span></div>
  <div id="help-header" class="hidden tooltip"><span>Cap&ccedil;alera:</span>  Indica l&#39;apartat o secci&oacute; que es mostra en pantalla. Tingueu present que les capçaleres de segon, tercer i quart nivell tamb&eacute; es poden desar com a marcadors.<span class="arrow-left"></span></div>
</div> 
</body>
</html>
