<!doctype html>

<!--[if lt IE 7 ]> <html class="ie ie6 no-js" lang="ca"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie ie7 no-js" lang="ca"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie ie8 no-js" lang="ca"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie ie9 no-js" lang="ca"> <![endif]-->
<!--[if gt IE 9]><!--><html class="no-js" lang="ca"><!--<![endif]-->
<!-- the "no-js" class is for Modernizr. -->

<head id="www-sitename-com" data-template-set="html5-reset">

	<meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html">
        
	<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title>Desenvolupament web en l'entorn client</title>
	
<!-- <meta name="title" content=""> --> 
	<meta name="description" content="">
	<!-- Google will often use this as its description of your page/site. Make it good. -->
	
	<meta name="google-site-verification" content="">
	<!-- Speaking of Google, don't forget to set your site up: http://google.com/webmasters -->
	
	<meta name="author" content="Institut Obert de Catalunya">
	<meta name="Copyright" content="Copyright Institut Obert de Catalunya 2011. All Rights Reserved.">

	<!-- Dublin Core Metadata : http://dublincore.org/ -->
	<meta name="DC.title" content="Desenvolupament web en l'entorn client">
	<meta name="DC.subject" content="Informàtica i comunicacions">
	<meta name="DC.creator" content="Institut Obert de Catalunya">
	
	<!--  Mobile Viewport Fix
	j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag 
	device-width : Occupy full width of the screen in its current orientation
	initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
	maximum-scale = 1.0 retains dimensions instead of zooming in if page width < device width
	-->
	<!-- Uncomment to use � use thoughtfully!
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	-->

	<link rel="shortcut icon" href="../../../img/favicon.ico">
	<!-- This is the traditional favicon.
		 - size: 16x16 or 32x32
		 - transparency is OK
		 - see wikipedia for info on browser support: http://mky.be/favicon/ -->
		 
	<link rel="apple-touch-icon" href="../../../img/apple-touch-icon.png">
	<!-- The is the icon for iOS's Web Clip.
		 - size: 57x57 for older iPhones, 72x72 for iPads, 114x114 for iPhone4's retina display (IMHO, just go ahead and use the biggest one)
		 - To prevent iOS from applying its styles to the icon name it thusly: apple-touch-icon-precomposed.png
		 - Transparency is not recommended (iOS will put a black BG behind the icon) -->
	
	<!-- CSS: screen, mobile & print are all in the same file -->
	<link rel="stylesheet" href="../../../_/css/style.css">

	<!-- CSS: jQuery UI -->
	<link rel="stylesheet" href="../../../_/css/jquery-ui.css">
	
	<!-- all our JS is at the bottom of the page, except for Modernizr. -->
	<script src="../../../_/js/modernizr-1.7.min.js"></script>
	<script src="../../../_/js/Hyphenator.js" type="text/javascript"></script>
	<script type="text/javascript">
	   Hyphenator.config({
		minwordlength : 4
	   });
	   Hyphenator.run();
	</script>
    <script src="../../../_/js/build.js" type="text/javascript"></script>
</head>

<body class="style-newspaper">

<div class="wrapper"><!-- not needed? up to you: http://camendesign.com/code/developpeurs_sans_frontieres -->

	<header id="header">
		<div class="head"><a href="http://ioc.gencat.cat"><img src="../../../img/logo.png" alt="Institut Obert de Catalunya"/></a><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/es/deed.ca"><img src="../../../img/license.png" alt="Llic&egrave;ncia" class="license"/></a></div>
		<div class="headdocument"><a href="../../../index.html">Desenvolupament web en l'entorn client</a></div>
        <div id="search" class="search" name="search">
         <form id="frmsearch" action="../../../search.html" method="get">
          <input type="text" name="q"/>
        </form>
        </div>
	</header>
   <div id="upbutton" class="upbutton" style="display:none;"><img src="../../../img/uparrow.png" alt="Pujar a l'inici de p&agrave;gina"/></div>
   <aside id="aside">
    <div id="menu">
      <ul>
       <li name="toc"><div><img src="../../../img/toc.png" alt="&Iacute;ndex"/></div></li>
       <li name="settings"><div><img src="../../../img/settings.png" alt="Configuraci&oacute;"/></div></li>
       <li name="printer"><div><img src="../../../img/printer.png" alt="Imprimir"/></div></li>
       <li name="favorites"><div><img src="../../../img/favorites.png" alt="Favorits"/></div></li>
       <li name="help_icon" class="help_icon"><div><img src="../../../img/help_icon.png" alt="Ajuda"/></div></li>
      </ul>
     </div>
   </aside>
   <div id="sidebar-hide" name="sidebar-hide"><img src="../../../img/arrows.png"/></div>
   <section>
     <div id="toc" class="hidden">
      <div class="menucontent">
        <ul>
        <li id="u7" class="parentnode"><p><a class="unit" href="../../../WebContent/u7/introduccio.html">7. Desenvolupament de casos pràctics</a></p><ul class="expander"><li id="u7introduccio"><a href="../../../WebContent/u7/introduccio.html">Introducció</a></li><li id="u7resum"><a href="../../../WebContent/u7/resum.html">Resum</a></li><li id="u7resultats"><a href="../../../WebContent/u7/resultats.html">Resultats d'aprenentatge</a></li><li id="u7referencies"><a href="../../../WebContent/u7/referencies.html">Referències</a></li><li id="u7a1" class="tocsection"><p id='u7a1continguts'><a class="section" href="../../../WebContent/u7/a1/continguts.html">Desenvolupament de casos pràctics</a><span class="buttonexp"></span></p><ul><li id="u7a1activitats"><a href="../../../WebContent/u7/a1/activitats.html">Activitats</a></li><li id="u7a1exercicis"><a href="../../../WebContent/u7/a1/exercicis.html">Exercicis d'autoavaluació</a></li></ul></li><div data-parent-id='u7a1' class='tocssection hidden'><div class="toc"><ul><li><a href="../../../WebContent/u7/a1/continguts.html#desenvolupament_amb_nodejs">Desenvolupament amb Node.js</a></li><li><a href="../../../WebContent/u7/a1/continguts.html#aplicacions_amb_la_biblioteca_leaflet">Aplicacions amb la biblioteca Leaflet</a></li><li><a href="../../../WebContent/u7/a1/continguts.html#desenvolupament_de_jocs_amb_html5">Desenvolupament de jocs amb HTML5</a></li></ul></div></div></ul></li><li id="" class="indexnode"><p><a href="../../../index.html">Anar a l&#39;&iacute;ndex general</a></p></li>
        </ul>
      </div>
    </div>
   </section>
   <section>
   <div id="settings" class="hidden">
    <div class="menucontent">
     <div class="allsettings">
     <div class="settings">
      <label>Font i Color</label>
		<div class="setting-option">
	        <ul class="fontBackground">
				<li id="style-newspaper" title="Newspaper" class="appearance-style-newspaper"><span>Newspaper</span></li>
                <li id="style-novel" title="Novel" class="appearance-style-novel"><span>Novel</span></li>
                <li id="style-ebook" title="eBook" class="appearance-style-ebook"><span>eBook</span></li>
				<li id="style-inverse" title="Inverse" class="appearance-style-inverse active"><span>Inverse</span></li>
				<li id="style-athelas" title="Athelas" class="appearance-style-athelas"><span>Athelas</span></li>
			</ul>
		</div>
     </div>
	<div class="settings">
      <label>Amplada</label>
		<div class="setting-option">
	        <div id="slider-width"></div>
		</div>
     </div>
     <div class="settings">
      <label>Mida de la font</label>
		<div class="setting-option">
	        <div id="slider-font"></div>
		</div>
     </div>
     <div class="settings">
      <label>Mida de la font</label>
	  <div class="setting-option">
       <form action="" class="sett-options">
		<ul>
		    <li><input type="checkbox" id="secondary-content" /><label for="secondary-content">Mostra recursos complementaris</label></li>
		    <li><input type="checkbox" id="main-images" /><label for="main-images">Mostra imatges</label></li>
		    <li><input type="checkbox" id="text-alignment" /><label for="text-alignment">Text justificat</label></li>
			<li><input type="checkbox" id="text-hyphen" /><label for="text-hyphen">Partici&oacute; sil·l&agrave;bica</label></li>
		</ul>
       </form>
	  </div>
     </div>
     </div>
    </div>
   </div>
   </section>
 <section>
 <div id="favorites" class="hidden"></div>
 </section>   
 <div id="bridge" class="hidden"></div>
 <div id="help" class="hidden">
  <div class="helptitle">Dreceres del teclat<hr></div>
  <div class="helpsection"><span>General</span>
   <ul>
    <li><span class="shortcut">g</span>: Anar al men&uacute; de navegaci&oacute;</li>
    <li><span class="shortcut">o</span>: Anar a opcions</li>
    <li><span class="shortcut">s</span>: Guardar la p&agrave;gina actual a favorits</li>
    <li><span class="shortcut">p</span>: Imprimir la p&agrave;gina actual</li>
    <li><span class="shortcut">?</span>: Mostrar/Ocultar l&#39;ajuda</li>
   </ul>
  </div>
  <div class="helpsection"><span>Navegaci&oacute;</span>
   <ul>
    <li><span class="shortcut">i</span>: Anar a l&#39;&iacute;ndex general</li>
    <li><span class="shortcut">t</span>: Anar a l&#39;inici de p&agrave;gina</li>
    <li><span class="shortcut">b</span>: Anar al final de p&agrave;gina</li>
    <li><span class="shortcut">j</span>: Anar cap endavant dintre la p&agrave;gina</li>
    <li><span class="shortcut">k</span>: Anar cap enrere dintre la p&agrave;gina</li>
    <li><span class="shortcut">h</span>: Anar a la p&agrave;gina anterior:</li>
    <li><span class="shortcut">l</span>: Anar a la p&agrave;gina seg&uuml;ent:</li>
   </ul>
   </div>
 </div>
 <div id="favcounter" name="favcounter" class="hidden"><span></span></div>
 <div id="navmenu" class="navmenu"><ul class="webnav"><li><a href="../../../index.html" title="Anar a l&#39;&iacute;ndex general">Inici</a></li><li><a href="../introduccio.html">Desenvolupament de casos pràctics</a></li><li>Desenvolupament de casos pràctics</li></ul></div>
	<div id="content" lang="ca" class="hyphenate text">
     <article lang="ca" class="sheet">
        <h1><a id="desenvolupament_de_casos_practics"> Desenvolupament de casos pràctics </a></h1>
    	
<p>
Tenir una bona base dels coneixements teòrics és fonamental, però practicar aplicant aquests coneixements és el que us permetrà desenvolupar les vostres pròpies aplicacions per molt complicades que arribin a ser.
</p>

<p>
S’ha de tenir en compte també que, en programació, és indispensable saber cercar informació a internet, tant documentació sobre el llenguatge com sobre una biblioteca o <acronym title="Application Programming Interface">API</acronym> concreta o alguna tecnologia amb la qual hàgiu de treballar (com sensors o realitat virtual, per exemple).
</p>

<p>
Tenir uns coneixements amplis en programació us permetrà entendre com es poden adaptar fàcilment les biblioteques i les noves tecnologies a les vostres aplicacions, per crear un programa de xat, una guia turística amb mapes o un joc en HTML5.
</p>

<p>
Convé destacar que en el dia a dia dels desenvolupadors d’aplicacions és habitual haver d’utilitzar eines mitjançant la línia d’ordres (compiladors o preprocessadors de <acronym title="Cascading Style Sheets">CSS</acronym>) i que moltes d’aquestes eines estan desenvolupades en Node.js. És a dir, estan desenvolupades en JavaScript, però a la banda del servidor.
</p>

<p>
Conèixer el funcionament de Node.js permet als desenvolupadors crear les seves pròpies eines per a la línia d’ordres, així com desenvolupar servidors tan simples o complexos com sigui necessari per comprovar el funcionament tant d’aplicacions web com dels programes de xat o dels jocs multijugador.
</p>

<p>
També és molt habitual haver d’utilitzar biblioteques i <acronym title="Application Programming Interface">API</acronym> de tercers, com per exemple Leaflet o l’<acronym title="Application Programming Interface">API</acronym> de Google Maps o fonts de dades externes. Sovint, per accedir a aquestes <acronym title="Application Programming Interface">API</acronym> s’ha de crear un compte al lloc web dels proveïdors i per fer-lo servir poden requerir algun tipus de pagament. En el cas de Google molts dels seus serveis són gratuïts fins a un cert punt, però per superar la quota cal activar els pagament. Leaflet, per contra, és una biblioteca gratuïta i de codi obert.
</p>

<p>
Les dades obertes són accessibles per a tothom i l’únic inconvenient per implementar una aplicació que les utilitzi és que la documentació sigui disponible i que admetin CORS o JSONP.
</p>

<p>
Cal no oblidar el desenvolupament de jocs en HTML5, ja que amb la desaparició de Flash i Java dels navegadors tots els jocs del web han passat a estar desenvolupats en JavaScript. A més a més, amb les millores en la potència dels equips és possible desenvolupar jocs força complexos que utilitzen gràfics en 3D i, fins i tot, preparats per a realitat virtual.
</p>

<h2><a id="desenvolupament_amb_nodejs" >Desenvolupament amb Node.js</a></h2>
<div class="level2">

<p>
Node.js (<a href="https://nodejs.org/" class="urlextern" title="https://nodejs.org/"  rel="nofollow">nodejs.org</a>) està basat en el motor V8 de JavaScript de Google i permet desenvolupar aplicacions en JavaScript que són executades al servidor. Gràcies a això es poden reaprofitar molts dels coneixements adquirits com a desenvolupadors d’aplicacions a la banda del client.
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">Realitat virtual al navegador</p>
<p>
WebXR (<a href="https://www.w3.org/TR/webxr/" class="urlextern" title="https://www.w3.org/TR/webxr/"  rel="nofollow">w3.org/TR/webxr</a>) és una <acronym title="Application Programming Interface">API</acronym> de JavaScript que permet utilitzar dispositius de realitat virtual al navegador.
</p>
</div></div>
<p>
Cal destacar que Node.js és una tecnologia relativament recent, però amb molta demanda. Entre les aplicacions més habituals desenvolupades amb Node.js es troben els servidors webs, servidors de xat, jocs multijugador i eines per a la línia d’ordres (com per exemple els preprocessadors de <acronym title="Cascading Style Sheets">CSS</acronym>).
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar la documentació de Node.js a l’enllaç següent: <a href="https://goo.gl/40ZGhQ" class="urlextern" title="https://goo.gl/40ZGhQ"  rel="nofollow">goo.gl/40ZGhQ</a>.
</p>
</div></div>
</div>

<h3><a id="introduccio_a_nodejs" >Introducció a Node.js</a></h3>
<div class="level3">

<p>
Per desenvolupar una aplicació amb Node.js només cal tenir-lo instal·lat i un editor de text pla. Cal tenir en compte que les aplicacions programades són executades a servidors remots, per posar en marxa un servei o com a línia d’ordres; per consegüent, els missatges que a JavaScript es mostren a la consola de les eines de desenvolupador es mostraran per la terminal. És a dir, els missatges d’error o els missatges que utilitzeu per depurar amb el mètode <code>console.log()</code> es mostraran a la vostra terminal.
</p>

<p>
S’ha de tenir en compte que a Node.js es programa amb JavaScript, però hi ha algunes diferències:
</p>
<ul>
<li class="level1"><div class="li"> No hi ha disponible cap de les funcions dels navegadors ni del DOM.</div>
</li>
<li class="level1"><div class="li"> El sistema de mòduls i requeriments és similar al d’ES6 (ES5 no té sistema de mòduls).</div>
</li>
<li class="level1"><div class="li"> Cada fitxer que es carrega amb <code>require</code> és un mòdul que encapsula totes les seves funcionalitats i només exposen alguns mètodes o propietats; no és el mateix que carregar múltiples fitxers JavaScript al navegador.</div>
</li>
</ul>

<p>
Hi ha prou similituds per desenvolupar algunes aplicacions senzilles, però es recomana consultar la documentació oficial de Node.js i els tutorials si voleu aprofundir en les seves possibilitats.
</p>

</div>

<h4><a id="instal_lacio_de_nodejs" >Instal·lació de Node.js</a></h4>
<div class="level4">

<p>
Abans de poder desenvolupar qualsevol aplicació amb Node.js cal instal·lar-lo. El procés és molt senzill en totes les plataformes, tot i que s’ha d’anar amb compte amb la versió que necessiteu: en alguns sistemes operatius, per defecte, s’instal·len versions molt desactualitzades.
</p>

<p>
Per instal·lar Node.js per a Windows s’han de seguir els passos següents:
</p>
<ul>
<li class="level1"><div class="li"> Entreu a la pàgina de descàrregues de Node.js: <a href="https://nodejs.org/en/download" class="urlextern" title="https://nodejs.org/en/download"  rel="nofollow">nodejs.org/en/download</a>.</div>
</li>
<li class="level1"><div class="li"> Seleccioneu el vostre sistema operatiu: a la banda superior us apareixerà per defecte la darrera versió de l’instal·lable per a Windows 64 bits i Mac. En cas que vulgueu algun altre format, el podeu trobar a sota.</div>
</li>
<li class="level1"><div class="li"> Una vegada descarregat l’instal·lable per a Windows heu de fer doble clic sobre el fitxer i s’obrirà l’instal·lador, que es mostra a la <span class="figref"><a href="#figura u7-01"><span>figura</span></a></span>.</div>
</li>
</ul>
<div class="iocfigure"><a name="figura u7-01"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Instal·lador de Node.js per a Windows

</figcaption><img src="../media/01-install.png" alt="" /></figure>
</div><ul>
<li class="level1"><div class="li"> S’ha d’acceptar la llicència d’ús, com es mostra a la <span class="figref"><a href="#figura u7-02"><span>figura</span></a></span>.</div>
</li>
</ul>
<div class="iocfigure"><a name="figura u7-02"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Llicència de Node.js per a Windows

</figcaption><img src="../media/02-install.png" alt="" /></figure>
</div><ul>
<li class="level1"><div class="li"> Seguidament s’ha de seleccionar la carpeta de destí, com es mostra a la <span class="figref"><a href="#figura u7-03"><span>figura</span></a></span>.</div>
</li>
</ul>
<div class="iocfigure"><a name="figura u7-03"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Selecció de la carpeta d’instal·lació de Node.js

</figcaption><img src="../media/03-install.png" alt="" /></figure>
</div><ul>
<li class="level1"><div class="li"> El següent pas és seleccionar les característiques a instal·lar. L’instal·lador inclou el mateix Node.js, accessos directes a la documentació, l’instal·lador de paquets npm i la configuració automàtica de la ruta, tal com es mostra a la <span class="figref"><a href="#figura u7-04"><span>figura</span></a></span>.</div>
</li>
</ul>
<div class="iocfigure"><a name="figura u7-04"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Selecció de característiques d’instal·lació de Node.js

</figcaption><img src="../media/04-install.png" alt="" /></figure>
</div><ul>
<li class="level1"><div class="li"> A la següent finestra no fa falta que seleccionem la casella de les instal·lacions addicionals i, clicant el botó “següent”, passarem a l’últim pas, que és confirmar la instal·lació, com es mostra a la <span class="figref"><a href="#figura u7-05"><span>figura</span></a></span>.</div>
</li>
</ul>
<div class="iocfigure"><a name="figura u7-05"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Confirmació d’instal·lació

</figcaption><img src="../media/05-install.png" alt="" /></figure>
</div><ul>
<li class="level1"><div class="li"> Una vegada finalitzada la instal·lació rebreu la confirmació d’èxit, que es pot veure a la <span class="figref"><a href="#figura u7-06"><span>figura</span></a></span>.</div>
</li>
</ul>
<div class="iocfigure"><a name="figura u7-06"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Finalització d’instal·lació

</figcaption><img src="../media/06-install.png" alt="" /></figure>
</div>
<p>
Per comprovar que s’ha instal·lat correctament heu d’accedir al símbol del sistema, com es pot apreciar a la <span class="figref"><a href="#figura u7-07"><span>figura</span></a></span>, o a la terminal millorada de Windows (anomenada PowerShell).
</p>
<div class="iocfigure"><a name="figura u7-07"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Comprovació de la versió de Node.js al símbol del sistema

</figcaption><img src="../media/07-install.png" alt="" /></figure>
</div>
<p>
En tots dos casos amb l’ordre <code>node -v</code> se us ha de mostrar el número de la versió. En cas contrari s’haurà produït un error a la instal·lació o a la configuració; proveu de reinstal·lar-lo amb totes les opcions per defecte i pareu atenció a qualsevol possible missatge d’error.
</p>

<p>
Addicionalment s’haurà instal·lat el gestor de paquets npm. Per comprovar-ho podeu escriure a la terminal <code>npm -v</code> i us n’ha de mostrar la versió. Aquest gestor us permetrà instal·lar nous mòduls i actualitzar la versió de node i del mateix gestor de paquets.
</p>

<p>
Els usuaris de Mac, una vegada finalitzada la instal·lació, poden comprovar que s’ha instal·lat correctament escrivint a la terminal:
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">npm</p>
<p>
<em>npm</em> (<a href="https://www.npmjs.com/" class="urlextern" title="https://www.npmjs.com/"  rel="nofollow">www.npmjs.com</a>) és, per defecte, el gestor de paquets per a Node.js. Alguns ho interpreten com a un acrònim de <em>Node Package Manager</em>.
</p>
</div></div><pre class="code bash"><ol><li class="li1"><div class="de1">~ $ node -v</div></li></ol></pre>

<p>
La instal·lació amb la distribució de Linux Ubuntu es pot fer utilitzant el gestor de paquets APT des de la terminal:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">sudo apt-get update</div></li><li class="li1"><div class="de1">sudo apt-get install nodejs</div></li></ol></pre>

<p>
Cal destacar que a Ubuntu l’executable de node es diu <code>nodejs</code> per evitar conflictes amb altres paquets, en canvi, a Mac i Windows (o altres distribucions de Linux) el nom de l’executable és <code>node</code>.
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">APT</p>
<p>
<em>APT</em>, acrònim d’<em>Advanced Packaging Tool</em> (Eina Avançada d’Empaquetat), és un sistema de gestió de paquets creat pel projecte Debian (inclòs a Ubuntu) que permet instal·lar i eliminar programes mitjançant la línia d’ordres. 
</p>
</div></div><div class="ioctext"><div class="ioccontent"><p class="ioctitle">Altres versions de Node.js a Ubuntu</p>
<p>
La versió de node que s’instal·la utilitzant el gestor de paquets d’Ubuntu acostuma a estar molt desactualitzada. Si necessiteu fer servir una versió més recent, podeu seguir els passos descrits a l’enllaç següent: <a href="https://goo.gl/oXkiu9" class="urlextern" title="https://goo.gl/oXkiu9"  rel="nofollow">goo.gl/oXkiu9</a>.
</p>
</div></div><pre class="code bash"><ol><li class="li1"><div class="de1">nodejs -v</div></li></ol></pre>

<p>
Fixeu-vos que la instal·lació de Node.js mitjançant el gestor de paquets també inclou la instal·lació d’npm:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">npm -v</div></li></ol></pre>

</div>

<h3><a id="primer_programa_amb_nodejshola_mon" >Primer programa amb Node.js: Hola món</a></h3>
<div class="level3">

<p>
Els programes desenvolupats amb Node.js s’anomenen <em>mòduls</em> i en desenvolupar-los s’utilitzen altres mòduls que formen part de Node.js; com per exemple el mòdul <code>http</code>, per crear servidors que processin peticions HTTP.
</p>

<p>
Per altra banda, és habitual haver d’utilitzar codi de tercers, siguin mòduls simples, biblioteques senceres o <em>frameworks</em> (entorns de treball). En aquest cas, es parla de <em>dependències</em>, ja que el mòdul principal depèn d’aquests mòduls per funcionar.
</p>

<p>
Creeu un fitxer anomenat <code>hola-mon.js</code>, dins d’un directori propi que servirà de contenidor per al vostre mòdul, amb el contingut següent:
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">&#039;Framework&#039; o entorn de treball</p>
<p>
Un <em>framework</em>, en català ‘entorn o marc de treball’, és una infraestructura de programari que, en la programació orientada a objectes, facilita la concepció de les aplicacions mitjançant la utilització de biblioteques de classes o generadors de programes. 
</p>
</div></div><pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">http.createServer(function(peticio, resposta) {</div></li><li class="li1"><div class="de1">        resposta.writeHead(200, {'Content-Type':'text/plain;charset=utf-8'});</div></li><li class="li1"><div class="de1">        resposta.end('Hola món');</div></li><li class="li1"><div class="de1">}).listen(8080, '127.0.0.1');</div></li><li class="li1"><div class="de1">console.log('Servidor executant-se a http://127.0.0.1:8080/');</div></li></ol></pre>

<p>
Tingueu en compte que, en cas que treballeu amb un servidor remot, en lloc de la IP 127.0.0.1 heu de posar la IP del vostre servidor.
</p>

<p>
Per posar-lo en marxa, haureu d’escriure al terminal del sistema operatiu, dintre del directori corresponent, <code>node hola-mon.js</code> si treballeu amb MS Windows o, si treballeu amb Ubuntu, <code>nodejs hola-mon.js</code>.
</p>

<p>
Si entreu amb el navegador a l’adreça del servidor especificant el port 8080, veureu el missatge <em>Hola Món</em>.
</p>

<p>

<p>
 Tingueu en compte que si ho feu en local, l’adreça que haureu de posar al navegador és: http://localhost:8080/.
</p>

</p>

<p>
A la primera línia es demana carregar el mòdul <code>http</code>. Aquest mòdul exposa el mètode <code>createServer()</code>, que serveix per crear un nou servidor HTTP. Aquest servidor gestionarà les peticions rebudes.
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">Aplicacions web complexes</p>
<p>
Per al desenvolupament d’aplicacions web complexes amb Node.js es recomana utilitzar el <em>framework</em> Express (<a href="http://expressjs.com" class="urlextern" title="http://expressjs.com"  rel="nofollow">expressjs.com</a>).
</p>
</div></div>
<p>
Aquesta funció rebrà dos objectes com a paràmetres: la petició que s’ha enviat des del navegador (<code>http.ClientRequest</code>) i la resposta (<code>http.ServerResponse</code>), que serà retornada al client.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar tota la documentació del mòdul <code>HTTP</code> a l’enllaç següent: <a href="https://goo.gl/C9GPNk" class="urlextern" title="https://goo.gl/C9GPNk"  rel="nofollow">goo.gl/C9GPNk</a>.
</p>
</div></div>
<p>
En aquest cas, s’utilitza el mètode <code>writeHead()</code> de la resposta per escriure el codi de retorn a la capçalera i s’informa que s’ha processat correctament (<code>200</code>) i el tipus de contingut: un text pla codificat com a UTF-8. Això permet que els signes d’accentuació es mostrin correctament.
</p>

<p>
Seguidament, s’afegeix el cos de la resposta a enviar, les dades, que en aquest cas només inclouen la cadena “Hola món\n”. Si accediu a la pàgina des del navegador, probablement s’haurà afegit automàticament un codi <acronym title="HyperText Markup Language">HTML</acronym> similar al següent:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">  &lt;head&gt;</div></li><li class="li1"><div class="de1">    &lt;link rel=&quot;alternate stylesheet&quot; type=&quot;text/css&quot; href=&quot;resource://gre-resources/plaintext.css&quot; title=&quot;Ajusta les línies llargues&quot;&gt;</div></li><li class="li1"><div class="de1">  &lt;/head&gt;</div></li><li class="li1"><div class="de1">  &lt;body&gt;</div></li><li class="li1"><div class="de1">    &lt;pre&gt;Hola Món&lt;/pre&gt;</div></li><li class="li1"><div class="de1">  &lt;/body&gt;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
En canvi, si inspeccioneu la resposta, veureu que el seu contingut és “Hola Món”. Això es deu al fet que els navegadors, en rebre determinats tipus de continguts (en aquest cas text pla), el representen de la forma que consideren més adient.
</p>

<p>
Cal destacar que la funció <code>createServer()</code> retorna un objecte de tipus <code>http.Server</code>, i és a partir d’aquest que s’invoca el mètode <code>listen()</code>, que indica que s’han d’escoltar les peticions de l’adreça <code>127.0.0.1</code> pel port <code>8080</code>.
</p>

<p>
Un mètode alternatiu d’implementar el mateix exemple seria el següent:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">let server = http.createServer();</div></li><li class="li1"><div class="de1">server.on('request', function(peticio, resposta) {</div></li><li class="li1"><div class="de1">        resposta.writeHead(200, {'Content-Type':'text/plain;charset=utf-8'});</div></li><li class="li1"><div class="de1">        resposta.end('Adeu Món');</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">server.listen(8080,&quot;127.0.0.1&quot;);</div></li></ol></pre>

<p>
Fixeu-vos que en aquest cas primer s’ha creat el servidor sense passar cap paràmetre. Seguidament s’ha cridat el mètode <code>on()</code> del servidor, que permet detectar diferents <em>events</em>; concretament es demana detectar l’<em>event</em> <code>request</code> (que és disparat en rebre una petició) i que es cridi la funció passada com a argument. Finalment s’indica que s’han d’escoltar les peticions pel port <code>8080</code> a l’adreça IP <code>127.0.0.1</code>.
</p>

</div>

<h3><a id="gestor_de_paquets_npm" >Gestor de paquets npm</a></h3>
<div class="level3">

<p>
Node.js treballa amb un gestor de paquets que permet instal·lar nous mòduls molt fàcilment. A més a més, permet enregistrar els vostres mòduls al seu repositori públic, de manera que altres usuaris puguin trobar-los i utilitzar-los (si es vol restringir-los a determinats usuaris, cal un compte de pagament).
</p>

<p>
El gestor de paquets npm s’instal·la automàticament amb l’instal·lador de Node per a Windows i Mac; en canvi, a Linux cal instal·lar-lo individualment:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">sudo apt-get install npm</div></li></ol></pre>

<p>
Una vegada instal·lat, es pot actualitzar així mateix, com si es tractés de qualsevol altre mòdul. Per exemple, a Windows i Mac es pot actualitzar així:
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar el cercador de mòduls d’npm a la seva pàgina principal: <a href="https://www.npmjs.com/" class="urlextern" title="https://www.npmjs.com/"  rel="nofollow">www.npmjs.com</a>.
</p>
</div></div><pre class="code bash"><ol><li class="li1"><div class="de1">npm install npm -g</div></li></ol></pre>

<p>
Mentre que a Linux s’han de demanar permisos d’administrador:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">sudo npm install npm -g</div></li></ol></pre>

<p>
En tots dos casos, l’opció <code>-g</code> indica que l’actualització s’ha d’aplicar globalment.
</p>

<p>
De la mateixa manera, per instal·lar qualsevol mòdul es fa servir la mateixa ordre. Per exemple, per instal·lar el mòdul <code>express</code> es faria de la manera següent:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">npm install express</div></li></ol></pre>

<p>
Si no s’especifica el nom del mòdul i es troba el fitxer <code>package.json</code>, s’instal·laran les dependències indicades en aquest fitxer. Gràcies a aquesta característica no heu d’incloure els mòduls i dependències externes (és a dir, la carpeta <code>node-modules</code>) al vostre sistema de control de versions.
</p>

<p>
De la mateixa manera, si descarregueu un programa de tercers, només haureu d’utilitzar l’ordre <code>npm install</code> perquè totes les dependències necessàries  es descarreguin i s’instal·lin.
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle"> Sistemes de control de versions</p>
<p>
Els sistemes de control de versions, com GIT o Mercurial, permeten gestionar tots els canvis realitzats en un projecte. Podeu trobar més informació en l’enllaç següent: <a href="https://ca.wikipedia.org/wiki/CVS" class="urlextern" title="https://ca.wikipedia.org/wiki/CVS"  rel="nofollow">goo.gl/fo2T51</a>.
</p>
</div></div>
<p>
Per altra banda, quan es vol actualitzar un mòdul s’ha de fer servir l’ordre <code>update</code>. Per exemple, per actualitzar el mòdul <code>express</code> s’utilitzaria l’ordre següent:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">npm update express</div></li></ol></pre>

<p>
En cas de no especificar el nom del mòdul, s’actualitzaran tots els mòduls.
</p>

<p>
L’ordre que cal utilitzar per eliminar un mòdul és <code>remove</code>; aquesta ordre elimina tant el mòdul indicat com les seves dependències.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">npm remove express</div></li></ol></pre>

<p>
Cal destacar que, si s’utilitza sense indicar el mòdul que s’ha d’eliminar, es demanaran permisos d’administrador.
</p>

<p>
Per resumir, les ordres més importants del gestor de paquets npm són les següents:
</p>
<ul>
<li class="level1"><div class="li"> <strong>install</strong>: per instal·lar nous mòduls o actualitzar el mateix npm.</div>
</li>
<li class="level1"><div class="li"> <strong>update</strong>: per actualitzar mòduls.</div>
</li>
<li class="level1"><div class="li"> <strong>remove</strong>: per eliminar un mòdul instal·lat.</div>
</li>
<li class="level1"><div class="li"> <strong>ls</strong>: llista tots els mòduls.</div>
</li>
<li class="level1"><div class="li"> <strong>-g</strong>: per indicar que l’ordre s’aplica a l’entorn global.</div>
</li>
</ul>

</div>

<h4><a id="instal_lacio_global_i_local_de_moduls" >Instal·lació global i local de mòduls</a></h4>
<div class="level4">

<p>
El gestor de paquets npm permet instal·lar els mòduls de forma global o local. La diferència és que si es fa localment, es copiarà dins del directori <code>node_modules</code> del mòdul i serà utilitzable només per aquest mòdul concret. En canvi, si s’utilitza l’opció <code>-g</code>, s’afegirà dins del directori <code>node_modules</code> del directori d’instal·lació de node i serà accessible globalment, és a dir, per a tots els projectes.
</p>

<p>
Com que el gestor de paquets npm s’ha d’utilitzar globalment, a l’hora d’actualitzar-lo sempre s’haurà de fer globalment. En canvi, quan requeriu un mòdul per un projecte específic només cal afegir-lo a l’entorn local del projecte (per exemple, el mòdul <code>express</code>).
</p>

<p>
Altres mòduls que s’acostumen a instal·lar globalment són els preprocessadors de <acronym title="Cascading Style Sheets">CSS</acronym>, que converteixen el codi LESS o SASS en <acronym title="Cascading Style Sheets">CSS</acronym>, els automatitzadors com gulp i grunt o els compiladors d’ES6, que compilen el codi ES6 en ES5 (JavaScript 5), admès pràcticament per tots els navegadors.
</p>

<p>
Per llistar tots els mòduls instal·lats en un projecte es pot utilitzar l’ordre <code>node ls</code>, afegint la opció <code>-g</code> si es volen llistar els mòduls globals.
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">gulp i grunt</p>
<p>
gulp i grunt són dues eines que permeten automatitzar l’assemblatge d’una aplicació web: compilació d’ES6, precompilació de LESS o SAAS, optimització de fitxers <acronym title="Cascading Style Sheets">CSS</acronym> i JS.
</p>
</div></div>
</div>

<h4><a id="descripcio_del_modulpackagejson" >Descripció del mòdul: &#039;package.json&#039;</a></h4>
<div class="level4">

<p>
Proveu d’afegir el mòdul <code>express</code> dins del directori on esteu treballant amb Node.js amb l’ordre següent:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">npm install express</div></li></ol></pre>

<p>
En acabar la instal·lació veureu els següents missatges d’advertència (lleugerament diferents segons el sistema operatiu utilitzat):
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">npm WARN enoent ENOENT: no such file or directory, open '/home/eduard/hola-mon/package.json'</div></li><li class="li1"><div class="de1">npm WARN helloworld No description</div></li><li class="li1"><div class="de1">npm WARN helloworld No repository field.</div></li><li class="li1"><div class="de1">npm WARN helloworld No README data</div></li><li class="li1"><div class="de1">npm WARN helloworld No license field.</div></li></ol></pre>

<p>
La primera advertència es produeix perquè s’espera que el mòdul inclogui un fitxer anomenat <code>package.json</code> amb la informació del mòdul, i no l’hem afegit. La resta d’avisos es produeixen per la mateixa raó: com que no troba el fitxer, no pot llegir cap dels camps que es requereixen.
</p>

<p>
Aquest fitxer es pot generar manualment amb qualsevol editor de text pla o es pot inicialitzar amb l’ordre <code>npm init</code> (si premeu enter, agafarà el valor mostrat entre parèntesis):
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">eduard@Ubuntu-Node:~/hola-mon$ npm init</div></li><li class="li1"><div class="de1">This utility will walk you through creating a package.json file.</div></li><li class="li1"><div class="de1">It only covers the most common items, and tries to guess sensible defaults.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">See `npm help json` for definitive documentation on these fields</div></li><li class="li1"><div class="de1">and exactly what they do.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Use `npm install &lt;pkg&gt; --save` afterwards to install a package and</div></li><li class="li1"><div class="de1">save it as a dependency in the package.json file.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Press ^C at any time to quit.</div></li><li class="li1"><div class="de1">name: (hola-mon)</div></li><li class="li1"><div class="de1">version: (1.0.0)</div></li><li class="li1"><div class="de1">description: Primer programa amb Node.js</div></li><li class="li1"><div class="de1">entry point: (hola-mon.js)</div></li><li class="li1"><div class="de1">test command:</div></li><li class="li1"><div class="de1">git repository:</div></li><li class="li1"><div class="de1">keywords:</div></li><li class="li1"><div class="de1">author: Eduard Sorita</div></li><li class="li1"><div class="de1">license: (ISC)</div></li><li class="li1"><div class="de1">About to write to /home/eduard/hola-mon/package.json:</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">{</div></li><li class="li1"><div class="de1">  &quot;name&quot;: &quot;hola-mon&quot;,</div></li><li class="li1"><div class="de1">  &quot;version&quot;: &quot;1.0.0&quot;,</div></li><li class="li1"><div class="de1">  &quot;description&quot;: &quot;Primer programa amb Node.js&quot;,</div></li><li class="li1"><div class="de1">  &quot;main&quot;: &quot;hola-mon.js&quot;,</div></li><li class="li1"><div class="de1">  &quot;dependencies&quot;: {</div></li><li class="li1"><div class="de1">    &quot;express&quot;: &quot;^4.17.1&quot;</div></li><li class="li1"><div class="de1">  },</div></li><li class="li1"><div class="de1">  &quot;devDependencies&quot;: {},</div></li><li class="li1"><div class="de1">  &quot;scripts&quot;: {</div></li><li class="li1"><div class="de1">    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</div></li><li class="li1"><div class="de1">  },</div></li><li class="li1"><div class="de1">  &quot;author&quot;: &quot;el vostre nom&quot;,</div></li><li class="li1"><div class="de1">  &quot;license&quot;: &quot;ISC&quot;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Is this ok? (yes)</div></li></ol></pre>

<p>
El resultat és el mateix que si creeu un fitxer manualment amb el contingut en format JSON:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">{</div></li><li class="li1"><div class="de1">  &quot;name&quot;: &quot;hola-mon&quot;,</div></li><li class="li1"><div class="de1">  &quot;version&quot;: &quot;1.0.0&quot;,</div></li><li class="li1"><div class="de1">  &quot;description&quot;: &quot;Primer programa amb Node.js&quot;,</div></li><li class="li1"><div class="de1">  &quot;main&quot;: &quot;hola-mon.js&quot;,</div></li><li class="li1"><div class="de1">  &quot;dependencies&quot;: {</div></li><li class="li1"><div class="de1">    &quot;express&quot;: &quot;^4.17.1&quot;</div></li><li class="li1"><div class="de1">  },</div></li><li class="li1"><div class="de1">  &quot;devDependencies&quot;: {},</div></li><li class="li1"><div class="de1">  &quot;scripts&quot;: {</div></li><li class="li1"><div class="de1">    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</div></li><li class="li1"><div class="de1">  },</div></li><li class="li1"><div class="de1">  &quot;author&quot;: &quot;el vostre nom&quot;,</div></li><li class="li1"><div class="de1">  &quot;license&quot;: &quot;ISC&quot;</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Si proveu d’instal·lar el mòdul <code>express</code> (tot i que ja es troba instal·lat), veureu que han desaparegut tots els avisos, excepte un que indica que no s’ha especificat cap camp per al repositori. Aquest avís el podeu ignorar perquè només és rellevant si publiqueu el vostre codi i feu servir un sistema de control de versions.
</p>

<p>
Com es pot veure, en el fitxer generat s’hi afegeix la següent informació del mòdul:
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle"> El fitxer &#039;package.json&#039;</p>
<p>
Podeu trobar tota la documentació sobre el fitxer <code>package.json</code> a l’enllaç següent: <a href="https://goo.gl/Q0HlTj" class="urlextern" title="https://goo.gl/Q0HlTj"  rel="nofollow">goo.gl/Q0HlTj</a>.
</p>
</div></div><ul>
<li class="level1"><div class="li"> <strong>name</strong>: nom del mòdul.</div>
</li>
<li class="level1"><div class="li"> <strong>version</strong>: número de la versió.</div>
</li>
<li class="level1"><div class="li"> <strong>description</strong>: descripció del mòdul.</div>
</li>
<li class="level1"><div class="li"> <strong>main</strong>: fitxer principal del mòdul.</div>
</li>
<li class="level1"><div class="li"> <strong>dependencies</strong>: llista de mòduls amb la corresponent versió que utilitza aquest mòdul. Aquesta informació permet instal·lar un mòdul mitjançant npm i, alhora, que es descarreguin les seves dependències en la versió apropiada.</div>
</li>
<li class="level1"><div class="li"> <strong>scripts</strong>: aquesta és una propietat especial que permet afegir scripts specials; en aquest cas l’escript s’executaria en cridar l’ordre <code>npm test</code>. Podeu trobar-ne més informació a l’enllaç següent: <a href="https://goo.gl/QmpQ0s" class="urlextern" title="https://goo.gl/QmpQ0s"  rel="nofollow">goo.gl/QmpQ0s</a>.</div>
</li>
<li class="level1"><div class="li"> <strong>license</strong>: llicència que s’aplica al vostre mòdul.</div>
</li>
<li class="level1"><div class="li"> <strong>author</strong>: nom del desenvolupador o desenvolupadors. Aquest camp admet més informació: per exemple, es pot utilitzar el format següent per indicar el nom i el correu electrònic del desenvolupador:</div>
</li>
</ul>
<pre class="code java"><ol><li class="li1"><div class="de1">{</div></li><li class="li1"><div class="de1">  &quot;name&quot;: &quot;el vostre nom&quot;,</div></li><li class="li1"><div class="de1">  &quot;email&quot;: &quot;el vostre correu electrònic&quot;</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Cal tenir en compte que en eliminar un mòdul amb <code>npm remove</code>, no s’elimina del llistat de dependències, sinó que s’ha d’editar el fitxer <code>package.json</code> i eliminar manualment la línia que correspongui.
</p>

</div>

<h3><a id="exemples_avancats" >Exemples avançats</a></h3>
<div class="level3">

<p>
Com us podeu imaginar, crear un servidor que mostri sempre el mateix missatge a l’usuari no és gaire útil, normalment serà necessari analitzar quin és l’<acronym title="Uniform Resource Locator">URL</acronym> demanat al servidor i el mètode emprat per fer la petició (<code>GET</code>, <code>POST</code>, <code>PUT</code>…).
</p>

<p>
Combinant l’<acronym title="Uniform Resource Locator">URL</acronym>, el mètode d’enviament i els paràmetres es pot implementar un encaminador (<em>router</em>, en anglès), un component que s’encarregui de gestionar quin component generarà la resposta de la petició.
</p>

<p>
Cal tenir en compte que Node.js, al contrari que el JavaScript executat al navegador, sí que pot llegir i escriure del disc del servidor. Així doncs, es poden realitzar operacions de lectura i escriptura, per exemple, per generar un registre d’errors o d’usuaris connectats.
</p>

</div>

<h4><a id="obtencio_de_l_url_i_el_metode" >Obtenció de l&#039;URL i el mètode</a></h4>
<div class="level4">

<p>
Obtenir l’<acronym title="Uniform Resource Locator">URL</acronym> i el mètode de la petició és molt senzill. Quan es dispara l’<em>event</em> <code>request</code> al servidor, s’invoca la funció associada a la detecció de l’<em>event</em>, que rep com a primer paràmetre un objecte. Aquest conté la informació de la petició i, com a segon paràmetre, un altre objecte que permet gestionar la resposta. A partir de l’objecte que conté la informació de la petició es pot extreure tant el mètode utilitzat com l’<acronym title="Uniform Resource Locator">URL</acronym> de la petició. A continuació podeu veure un exemple:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">let server = http.createServer();</div></li><li class="li1"><div class="de1">server.on('request', function(peticio, resposta) {</div></li><li class="li1"><div class="de1">  let metode = peticio.method;</div></li><li class="li1"><div class="de1">  let url = peticio.url;</div></li><li class="li1"><div class="de1">  resposta.writeHead(200, {'Content-Type':'text/plain;charset=utf-8'});</div></li><li class="li1"><div class="de1">  resposta.end('Rebuda petició per l\'URL ' + url + ' i el mètode ' + metode);</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">server.listen(8080,&quot;127.0.0.1&quot;);</div></li></ol></pre>

<p>
Si proveu d’accedir des del vostre navegador a l’adreça <code>127.0.0.1:8080/hola</code> veureu per pantalla el missatge següent:
</p>
<pre class="code">Rebuda petició per l&#039;URL /hola i el mètode GET</pre>

<p>
Com es pot apreciar, l’objecte <code>peticio</code> (que és una instància d<code>‘http.ClientRequest</code>) permet accedir tant al mètode d’enviament com a l’<acronym title="Uniform Resource Locator">URL</acronym> a través dels mètodes <code>method()</code> i <code>url()</code> respectivament.
</p>

<p>
A partir d’aquests dos paràmetres es podria implementar un servei web REST molt simple, ja que només cal discriminar l’<acronym title="Uniform Resource Locator">URL</acronym> i el mètode de la petició per portar a terme una acció o una altra.
</p>

<p>
Per comprovar el funcionament amb el mètode <code>POST</code>, podeu crear un fitxer nou anomenat <code>formulari-node.html</code> amb el codi següent:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">	&lt;select id=&quot;metode&quot;&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;GET&quot; selected&gt;GET&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;POST&quot;&gt;POST&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;PATCH&quot;&gt;PATCH&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;DELETE&quot;&gt;DELETE&lt;/option&gt;</div></li><li class="li1"><div class="de1">	&lt;/select&gt;</div></li><li class="li1"><div class="de1">	&lt;button id=&quot;peticio&quot;&gt;Enviar Petició&lt;/button&gt;</div></li><li class="li1"><div class="de1">	&lt;p&gt;Resposta:&lt;/p&gt;</div></li><li class="li1"><div class="de1">	&lt;div id=&quot;resposta&quot;&gt;&lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	&lt;script&gt;</div></li><li class="li1"><div class="de1">		let boto = document.getElementById('peticio');</div></li><li class="li1"><div class="de1">		let resposta = document.getElementById('resposta');</div></li><li class="li1"><div class="de1">		let metode = document.getElementById('metode');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">		boto.addEventListener(&quot;click&quot;, function() {</div></li><li class="li1"><div class="de1">			let httpRequest = new XMLHttpRequest();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  		httpRequest.open(metode.value, 'http://127.0.0.1:8080/prova', true);</div></li><li class="li1"><div class="de1">			httpRequest.send(null);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">			httpRequest.onload = function () {	</div></li><li class="li1"><div class="de1">				resposta.innerHTML = httpRequest.responseText;</div></li><li class="li1"><div class="de1">			}</div></li><li class="li1"><div class="de1">  	});</div></li><li class="li1"><div class="de1">	&lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>

<p>
Recordeu que quan feu canvis en el fitxer <code>hola-mon.js</code>, perquè aquests tinguin efecte, haureu d’apagar (<code>Crtl+C</code> a la línia d’ordres) i tornar a activar el servidor (amb <code>node hola-mon.js</code> o <code>nodejs hola-mon.js</code>, segons quin sigui el vostre sistema operatiu, a la línia d’ordres). 
</p>

</p>

<p>
Com es pot apreciar, s’ha creat una llista desplegable amb <acronym title="HyperText Markup Language">HTML</acronym> que permet seleccionar el mètode d’enviament i un botó per realitzar la petició. Una vegada es fa clic al botó s’envia una petició AJAX, utilitzant el mètode seleccionat a la llista, a l’adreça <code>127.0.0.1</code>, port <code>8080</code> i <acronym title="Uniform Resource Locator">URL</acronym> <code>prova</code>.
</p>

<p>
Una vegada arriba la resposta es dispara l’<em>event</em> <code>load</code> i es crida la funció assignada a <code>onload</code>. Aquesta funció estableix com a contingut <acronym title="HyperText Markup Language">HTML</acronym> la resposta en mode text. Fixeu-vos que no cal sobreescriure el tipus de contingut perquè el servidor l’enviarà correctament.
</p>

<p>
Malauradament, en molts casos aquest exemple no funcionarà a causa de la ‘política del mateix origen’ (<em>same-origin policy</em>). Com que en aquest cas teniu accés directament a l’aplicació del servidor, només cal incloure els mecanismes CORS adequats per permetre l’accés des de qualsevol adreça i utilitzant qualsevol mètode:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">let server = http.createServer();</div></li><li class="li1"><div class="de1">server.on('request', function(peticio, resposta) {</div></li><li class="li1"><div class="de1">  let metode = peticio.method;</div></li><li class="li1"><div class="de1">  let url = peticio.url;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Origin', '*');</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');</div></li><li class="li1"><div class="de1">  resposta.writeHead(200, {'Content-Type':'text/plain;charset=utf-8'});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  resposta.end('Rebuda petició per l\'URL ' + url + ' i el mètode ' + metode);</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">server.listen(8080,&quot;127.0.0.1&quot;);</div></li></ol></pre>

<p>
En aquesta versió, el servidor afegeix a la capçalera de la resposta el paràmetre <code>Access-Control-Allow-Origin=*</code>, fet que permet realitzar peticions AJAX des de qualsevol servidor; i el paràmetre <code>Access-Control-Allow-Mehtods=GET, POST, OPTIONS, PUT, PATCH, DELETE</code>, de manera que permet fer servir directament tots els mètodes HTTP.
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle"> Política del mateix origen</p>
<p>
Es tracta d’una normativa que implementen tots els navegadors; podeu trobar-ne més informació a l’enllaç següent: <a href="https://www.goo.gl/KgoIFn" class="urlextern" title="https://www.goo.gl/KgoIFn"  rel="nofollow">goo.gl/qMDYhF</a>.
</p>
</div></div>
<p>
Fixeu-vos en una diferència important: s’ha fet servir el mètode <code>setHeader()</code> en lloc de <code>writeHead()</code>. Aquest últim el que fa és escriure la capçalera amb el codi de resposta i el contingut passat com a paràmetre (opcionalment), de manera que no es pot modificar; en canvi, el mètode <code>setHeader()</code> permet afegir paràmetres a la capçalera sense escriure-la, de manera que es poden afegir tants paràmetres com sigui necessari (per exemple, pot ser que algunes capçaleres només calgui enviar-les en alguns casos concrets).
</p>

</div>

<h4><a id="obtencio_de_parametres" >Obtenció de paràmetres</a></h4>
<div class="level4">

<p>
Per obtenir els paràmetres de la petició teniu dues opcions: realitzar una implementació pròpia per dividir la cadena formada pels paràmetres o utilitzar mòduls de Node.js <code>url</code> i <code>querystring</code>. El primer d’aquests mòduls permet descompondre un <acronym title="Uniform Resource Locator">URL</acronym> en fragments i el segon converteix una cadena de consulta en un objecte de JavaScript.
</p>

<p>
En l’exemple següent podeu veure com s’han afegit dos paràmetres a la petició i com es fa el tractament dels dos casos possibles: l’enviament utilitzant el mètode <code>GET</code> (paràmetres codificats en l’<acronym title="Uniform Resource Locator">URL</acronym>) o els altres mètodes (paràmetres integrats al cos de la petició).
</p>

<p>
Primerament s’afegeixen dos camps de text per enviar la informació al servidor. Fixeu-vos que s’ha de fer un tractament especial en el cas del mètode <code>GET</code>, ja que les dades s’envien afegint-les a l’<acronym title="Uniform Resource Locator">URL</acronym> i no pas com a dades:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">  &lt;h1&gt;Petició&lt;/h1&gt;</div></li><li class="li1"><div class="de1">  &lt;select id=&quot;metode&quot;&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;GET&quot;&gt;GET&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;POST&quot; selected&gt;POST&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;PATCH&quot;&gt;PATCH&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;DELETE&quot;&gt;DELETE&lt;/option&gt;</div></li><li class="li1"><div class="de1">	&lt;/select&gt;</div></li><li class="li1"><div class="de1">  &lt;label&gt;Nom:&lt;input type=&quot;text&quot; id=&quot;nom&quot; /&gt;&lt;/label&gt;</div></li><li class="li1"><div class="de1">  &lt;label&gt;Cognom:&lt;input type=&quot;text&quot; id=&quot;cognom&quot; /&gt;&lt;/label&gt;</div></li><li class="li1"><div class="de1">  &lt;button id=&quot;peticio&quot;&gt;Enviar Petició&lt;/button&gt;</div></li><li class="li1"><div class="de1">  &lt;h1&gt;Resposta&lt;/h1&gt;</div></li><li class="li1"><div class="de1">  &lt;div id=&quot;resposta&quot;&gt;&lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;script&gt;</div></li><li class="li1"><div class="de1">    let boto = document.getElementById('peticio');</div></li><li class="li1"><div class="de1">    let resposta = document.getElementById('resposta');</div></li><li class="li1"><div class="de1">    let metode = document.getElementById('metode');</div></li><li class="li1"><div class="de1">    let nom = document.getElementById('nom');</div></li><li class="li1"><div class="de1">    let cognom = document.getElementById('cognom');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    boto.addEventListener(&quot;click&quot;, function(e) {</div></li><li class="li1"><div class="de1">    	let url = &quot;http://127.0.0.1:8080/proves&quot;;</div></li><li class="li1"><div class="de1">    	let dades = &quot;nom=&quot; + encodeURI(nom.value);</div></li><li class="li1"><div class="de1">      dades += &quot;&amp;cognom=&quot; + encodeURI(cognom.value);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    	if (metode.value == &quot;GET&quot;) {</div></li><li class="li1"><div class="de1">    	  url +=&quot;?&quot; + dades;</div></li><li class="li1"><div class="de1">    		dades = null;</div></li><li class="li1"><div class="de1">    	}		</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    	let httpRequest = new XMLHttpRequest();</div></li><li class="li1"><div class="de1">      httpRequest.open(metode.value, url, true);</div></li><li class="li1"><div class="de1">    	httpRequest.send(dades);</div></li><li class="li1"><div class="de1">      httpRequest.onload = function (e) {	</div></li><li class="li1"><div class="de1">    	  resposta.innerHTML = httpRequest.responseText;</div></li><li class="li1"><div class="de1">    	}</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">  &lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
Pel que fa al codi del servidor cal afegir-hi més canvis. Per una banda, s’han carregat els mòduls <code>url</code> i <code>querystring</code> per analitzar els <acronym title="Uniform Resource Locator">URL</acronym> i les cadenes de consulta respectivament; i per altra, s’ha de processar el cos del missatge per obtenir els paràmetres en el cas dels mètodes diferents de <code>GET</code>.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">let queryString = require('querystring');</div></li><li class="li1"><div class="de1">let url = require('url');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let server = http.createServer();</div></li><li class="li1"><div class="de1">server.on('request', function(peticio, resposta) {</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Origin', '*');</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');</div></li><li class="li1"><div class="de1">  resposta.writeHead(200, {'Content-Type':'text/html;charset=utf-8'});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  let cos = '';</div></li><li class="li1"><div class="de1">  peticio.on('data', function(dades) {</div></li><li class="li1"><div class="de1">    if (cos.length&gt;1e6) { // Limita la mida a 1.000.000 de bytes = 1e6</div></li><li class="li1"><div class="de1">      peticio.connection.destroy();</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">      cos += dades;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  }).on('end', function() {</div></li><li class="li1"><div class="de1">    let params;</div></li><li class="li1"><div class="de1">    let dades;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (peticio.method === 'GET') {</div></li><li class="li1"><div class="de1">      dades = url.parse(peticio.url).query;</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">      dades = cos;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    params = queryString.parse(dades);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    resposta.write('Rebuda petició per l\'URL ' + peticio.url + ' i el mètode ' + peticio.method +&quot;&lt;br&gt;&quot;);</div></li><li class="li1"><div class="de1">    resposta.write(&quot;&lt;b&gt;Nom:&lt;/b&gt; &quot; + decodeURI(params.nom) + &quot;&lt;br&gt;&quot;);</div></li><li class="li1"><div class="de1">    resposta.write(&quot;&lt;b&gt;Cognom:&lt;/b&gt; &quot; + decodeURI(params.cognom) + &quot;&lt;br&gt;&quot;);</div></li><li class="li1"><div class="de1">    resposta.end();</div></li><li class="li1"><div class="de1">  });</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">server.listen(8080,&quot;127.0.0.1&quot;);</div></li></ol></pre>

<p>
S’ha de tenir en compte que el cos de la petició s’obté d’un flux de dades, ja que la petició pot incloure elements molt pesats (per exemple, la pujada de fitxers o imatges) i no es llegeix d’una tacada. Per aquesta raó cal detectar l’<em>event</em> <code>data</code> de la petició, que indica que han arribat noves dades, i concatenar-la per obtenir el cos complet i l’<em>event</em> <code>end</code>, que indica que s’ha llegit completament la petició.
</p>

<p>
En aquest exemple s’ha afegit una mesura de seguretat extra: es comprova la mida del cos actual i, si supera el milió de bytes, interromp la connexió. En cas contrari, concatena el nou fragment al cos fins que es detecta l’<em>event</em> <code>end</code>, que indica que ha finalitzat la recepció de la petició.
</p>
<div class="iocnote"><div class="ioccontent">
<p>
Quan la resposta conté codi <acronym title="HyperText Markup Language">HTML</acronym>, és més adient utilitzar com a <code>Content-Type</code> el tipus <code>text/html</code>.
</p>
</div></div>
<p>
Una vegada s’han obtingut totes les dades cal processar-les perquè els paràmetres arriben com una cadena de consulta. En aquest cas també cal distingir entre el mètode <code>GET</code> i la resta, ja que el mètode GET inclou la cadena de consulta a l’<acronym title="Uniform Resource Locator">URL</acronym>. Per obtenir-la s’ha d’analitzar i accedir a la propietat <code>query</code>, com es pot veure en aquest exemple: <code>url.parse(peticio.url).query</code>.
</p>

<p>
Per altra banda, en el cas dels mètodes <code>POST</code>, <code>PATCH</code>, <code>DELETE</code>, etc., la cadena de consulta és el cos del missatge. Una vegada s’ha obtingut la cadena de consulta, d’una manera o altra, cal analitzar-la utilitzant el mòdul <code>querystring</code>, com es pot veure a l’exemple següent: <code>params = queryString.parse(dades)</code>.
</p>

<p>
Una vegada obtinguts els paràmetres com un objecte de JavaScript, ja s’hi pot treballar accedint als valors i utilitzant la notació de claudàtors o la notació de punts (per exemple: <code>params.nom</code>).
</p>

<p>
Cal destacar que, tant en el fitxer del client com del servidor, s’han codificat i descodificat els paràmetres utilitzant les funcions <code>encodeURI()</code> i <code>decodeURI()</code> respectivament; cal fer-ho així per evitar problemes en incloure caràcters que poden corrompre la informació.
</p>

<p>
Fixeu-vos que, en aquest exemple, en lloc d’enviar el contingut de la resposta utilitzant el mètode <code>end()</code>, s’ha afegit per parts utilitzant el mètode <code>write()</code>. La diferència principal entre l’un i l’altre (com passa amb <code>setHeader()</code> i <code>writeHead()</code>) és que una vegada s’ha invocat el mètode <code>end()</code> ja no es pot afegir res més al cos de la resposta; en canvi, es pot invocar el mètode <code>write()</code> tantes vegades com sigui necessari per construir la resposta.
</p>

</div>

<h4><a id="encaminament_routing" >Encaminament (&#039;routing&#039;)</a></h4>
<div class="level4">

<p>
En aquest context, el terme <em>encaminament</em> es refereix a l’acció que s’ha de realitzar (o pàgina que s’ha de carregar) segons l’<acronym title="Uniform Resource Locator">URL</acronym> i el mètode d’enviament d’una petició. Per realitzar aquest encaminament, en els casos més simples es pot implementar una solució pròpia, tot i que és recomanable fer servir un <em>framework</em> com Express o el mòdul de tercers <code>router</code>.
</p>

<p>
A continuació podeu veure un exemple, amb una implementació pròpia, que retorna diferents respostes segons l’<acronym title="Uniform Resource Locator">URL</acronym> seleccionat del menú desplegable. Per una banda, s’ha de generar un fitxer <acronym title="HyperText Markup Language">HTML</acronym> que s’executa al navegador del client, i per altra, el codi del servidor HTPP de Node.js.
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">	&lt;h1&gt;Petició&lt;/h1&gt;</div></li><li class="li1"><div class="de1">	&lt;select id=&quot;metode&quot;&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;GET&quot;&gt;GET&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;POST&quot; selected&gt;POST&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;PATCH&quot;&gt;PATCH&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;DELETE&quot;&gt;DELETE&lt;/option&gt;</div></li><li class="li1"><div class="de1">	&lt;/select&gt;</div></li><li class="li1"><div class="de1">&lt;select id=&quot;provincia&quot;&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;Barcelona&quot; selected&gt;Barcelona&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;Girona&quot; selected&gt;Girona&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;Lleida&quot;&gt;Lleida&lt;/option&gt;</div></li><li class="li1"><div class="de1">		&lt;option value=&quot;Tarragona&quot;&gt;Tarragona&lt;/option&gt;</div></li><li class="li1"><div class="de1">	&lt;/select&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	&lt;button id=&quot;peticio&quot;&gt;Enviar Petició&lt;/button&gt;</div></li><li class="li1"><div class="de1">	&lt;h1&gt;Resposta&lt;/h1&gt;</div></li><li class="li1"><div class="de1">	&lt;div id=&quot;resposta&quot;&gt;&lt;/div&gt;</div></li><li class="li1"><div class="de1">	&lt;script&gt;</div></li><li class="li1"><div class="de1">		let boto = document.getElementById('peticio');</div></li><li class="li1"><div class="de1">		let resposta = document.getElementById('resposta');</div></li><li class="li1"><div class="de1">		let metode = document.getElementById('metode');</div></li><li class="li1"><div class="de1">		let provincia = document.getElementById('provincia');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">		boto.addEventListener(&quot;click&quot;, function(e) {</div></li><li class="li1"><div class="de1">			let url = &quot;http://127.0.0.1:8080/&quot; + provincia.value;</div></li><li class="li1"><div class="de1">			let httpRequest = new XMLHttpRequest();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  		httpRequest.open(metode.value, url, true);</div></li><li class="li1"><div class="de1">			httpRequest.send(null);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">			httpRequest.onload = function (e) {	</div></li><li class="li1"><div class="de1">				resposta.innerHTML = httpRequest.responseText;</div></li><li class="li1"><div class="de1">			}</div></li><li class="li1"><div class="de1">  		});</div></li><li class="li1"><div class="de1">	&lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
En aquest cas, com que no s’utilitzaran paràmetres, només cal especificar el mètode i l’<acronym title="Uniform Resource Locator">URL</acronym> de destí. Per aquest mateix motiu no cal carregar el mòdul <code>querystring</code>, però sí que és necessari carregar el mòdul <code>url</code> per obtenir la ruta que s’ha de processar.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">let url = require('url');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let server = http.createServer();</div></li><li class="li1"><div class="de1">server.on('request', function(peticio, resposta) {</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Origin', '*');</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');</div></li><li class="li1"><div class="de1">  resposta.writeHead(200, {'Content-Type':'text/html;charset=utf-8'});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  let urlEncaminament = url.parse(peticio.url).path;</div></li><li class="li1"><div class="de1">  encaminar(urlEncaminament, peticio.method, resposta);</div></li><li class="li1"><div class="de1">  resposta.end();</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">server.listen(8080,&quot;127.0.0.1&quot;);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function encaminar(url, metode, resposta) {</div></li><li class="li1"><div class="de1">  let vista;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  switch (url) {</div></li><li class="li1"><div class="de1">    case '/Barcelona':</div></li><li class="li1"><div class="de1">      vista = controladorBarcelona(metode);</div></li><li class="li1"><div class="de1">      break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    case '/Girona':</div></li><li class="li1"><div class="de1">      vista = controladorGirona(metode);</div></li><li class="li1"><div class="de1">      break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    case '/Lleida':</div></li><li class="li1"><div class="de1">      vista =  controladorLleida(metode);</div></li><li class="li1"><div class="de1">      break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    case '/Tarragona':</div></li><li class="li1"><div class="de1">      vista = controladorTarragona(metode);</div></li><li class="li1"><div class="de1">      break;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    resposta.write(vista);</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function controladorBarcelona(metode) {</div></li><li class="li1"><div class="de1">  let vista = &quot;&lt;h2&gt;Barcelona&lt;/h2&gt;&quot;;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    switch (metode) {</div></li><li class="li1"><div class="de1">      case 'GET':</div></li><li class="li1"><div class="de1">        vista += &quot;Simulació: dades de Barcelona obtingudes&quot;;</div></li><li class="li1"><div class="de1">        break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      case 'POST':</div></li><li class="li1"><div class="de1">        vista += &quot;Simulació: dades de Barcelona afegides&quot;;</div></li><li class="li1"><div class="de1">        break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      case 'DELETE':</div></li><li class="li1"><div class="de1">        vista += &quot;Simulació: dades de Barcelona eliminades&quot;;</div></li><li class="li1"><div class="de1">        break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      case 'PATCH':</div></li><li class="li1"><div class="de1">        vista += &quot;Simulació: dades de Barcelona actualitzades&quot;;</div></li><li class="li1"><div class="de1">        break;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    return vista;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function controladorGirona(metode) {</div></li><li class="li1"><div class="de1">        return &quot;&lt;h2&gt;Girona&lt;/h2&gt;No hi ha cap acció especial per a &lt;b&gt;Girona&lt;/b&gt;&quot;;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function controladorLleida(metode) {</div></li><li class="li1"><div class="de1">        let vista = &quot;&lt;h2&gt;Lleida&lt;/h2&gt;&quot;;</div></li><li class="li1"><div class="de1">        if (metode === 'GET') {</div></li><li class="li1"><div class="de1">                vista += &quot;A Lleida s'envia un missatge específic si s'utilitza el mètode GET&quot;;</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">                vista += &quot;A Lleida tots els mètodes excepte GET retornen un missatge genèric&quot;;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        return vista;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function controladorTarragona(metode)  {</div></li><li class="li1"><div class="de1">        return &quot;&lt;h2&gt;Tarragona&lt;/h2&gt;Tampoc s'ha implementat cap acció especial per a &lt;b&gt;Tarragona&lt;/b&gt;&quot;;</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Una vegada rebuda la petició, s’invoca la funció <code>encaminar()</code>, passant com a paràmetres el mètode, la resposta i la ruta de l’<acronym title="Uniform Resource Locator">URL</acronym>. Dintre de la funció, segons el valor de la ruta, s’invocarà una funció o una altra, que farà el paper de controlador. Aquests controladors s’encarreguen de generar una vista (en aquest cas es tracta simplement d’una cadena de text formatat com a <acronym title="HyperText Markup Language">HTML</acronym>) que s’escriu a la resposta.
</p>

<p>
S’ha fet servir <code>controlador</code> com a nom de les funcions, perquè és el funcionament habitual d’aquest tipus d’aplicacions. L’encaminador invoca els mètodes corresponents segons el mètode i ruta rebuts, i retorna o envia la vista generada. En aquest cas, com que no existeix cap model, la vista es genera directament fent servir textos estàtics.
</p>

<p>
Habitualment els sistemes d’encaminament accepten paràmetres com a cadena de consulta (tant al cos del missatge com incrustats a l’<acronym title="Uniform Resource Locator">URL</acronym>) i com a fragments de l’<acronym title="Uniform Resource Locator">URL</acronym>. Per exemple en el <em>framework</em> Express es pot definir una ruta de la manera següent:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">aplicacio.get('/provincies/:provincia/poblacions/:poblacio', function (peticio, resposta) {</div></li><li class="li1"><div class="de1">  resposta.send(peticio.params)</div></li><li class="li1"><div class="de1">})</div></li></ol></pre>

<p>
Aquest encaminament acceptaria un <acronym title="Uniform Resource Locator">URL</acronym> com <em>/provincies/Barcelona/poblacions/Martorell</em>, que generaria com a paràmetres l’objecte que podeu veure a continuació. És a dir, tant <code>:provincia</code> com <code>:població</code> són interpretats com a paràmetres d’encaminament:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">{</div></li><li class="li1"><div class="de1">  provincia: Barcelona,</div></li><li class="li1"><div class="de1">  poblacio: Martorell</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Una característica comuna a tots els sistemes d’encaminament és que també permeten utilitzar expressions regulars, de manera que es poden encaminar les rutes que comencin, acabin o continguin una combinació concreta de caràcters, per exemple.
</p>

<p>
Els sistemes d’encaminament més avançats també inclouen l’opció d’afegir <code>middleware</code>, funcions que són cridades amb la resposta i la petició i que permeten modificar-la abans (o després) de passar-les als controladors. D’aquesta manera es poden afegir sistemes d’autenticació, validacions de dades, adaptació de les dades, etc.
</p>

<p>
Com es pot comprovar, les implementacions pròpies dels sistemes d’encaminament acostumen a ser molt enrevessades i limitades en comparació amb els mòduls i <em>frameworks</em> especialitzats. Per aquesta raó només és recomanable utilitzar-les en els casos més simples.
</p>

</div>

<h4><a id="lectura_i_escriptura_de_fitxers" >Lectura i escriptura de fitxers</a></h4>
<div class="level4">

<p>
Les aplicacions desenvolupades amb Node.js, al contrari que les desenvolupades pel navegador, poden llegir i escriure fitxers al disc. Això permet utilitzar sistemes de persistència propis o guardar un registre d’esdeveniments.
</p>

<p>
Vegeu a continuació un exemple que permet afegir el nom i el cognom d’un usuari a un fitxer que més endavant serà recuperat per poder realitzar cerques i mostrar llistats. A la banda del client només es necessita el codi per realitzar l’enviament utilitzant el mètode <code>POST</code> i afegir les dades <code>nom</code> i <code>cognom</code>:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">	&lt;h1&gt;Petició&lt;/h1&gt;</div></li><li class="li1"><div class="de1">	&lt;label&gt;Nom:&lt;input id=&quot;nom&quot; /&gt;&lt;/label&gt;</div></li><li class="li1"><div class="de1">	&lt;label&gt;Cognom:&lt;input id=&quot;cognom&quot; /&gt;&lt;/label&gt;</div></li><li class="li1"><div class="de1">	&lt;button id=&quot;afegir_boto&quot;&gt;Afegir nom&lt;/button&gt;</div></li><li class="li1"><div class="de1">	&lt;h1&gt;Resposta&lt;/h1&gt;</div></li><li class="li1"><div class="de1">	&lt;div id=&quot;resposta&quot;&gt;&lt;/div&gt;</div></li><li class="li1"><div class="de1">	&lt;script&gt;</div></li><li class="li1"><div class="de1">		let afegirBoto = document.getElementById('afegir_boto');</div></li><li class="li1"><div class="de1">		let resposta = document.getElementById('resposta');</div></li><li class="li1"><div class="de1">		let metode = &quot;POST&quot;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">		let nom = document.getElementById('nom');</div></li><li class="li1"><div class="de1">		let cognom = document.getElementById('cognom');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">		afegirBoto.addEventListener(&quot;click&quot;, function(e) {</div></li><li class="li1"><div class="de1">			let url = 'http://127.0.0.1:8080';</div></li><li class="li1"><div class="de1">			let dades = 'nom=' + encodeURI(nom.value);</div></li><li class="li1"><div class="de1">				dades += '&amp;cognom=' + encodeURI(cognom.value);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">			let httpRequest = new XMLHttpRequest();</div></li><li class="li1"><div class="de1">  		httpRequest.open('POST', url, true);</div></li><li class="li1"><div class="de1">			httpRequest.send(dades);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">			httpRequest.onload = function (e) {	</div></li><li class="li1"><div class="de1">				resposta.innerHTML = httpRequest.responseText;</div></li><li class="li1"><div class="de1">			}</div></li><li class="li1"><div class="de1">  	});</div></li><li class="li1"><div class="de1">	&lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
A la banda del servidor, cal carregar el mòdul <code>fs</code> (sigles de <em>file system</em>, ‘sistema de fitxers’ en anglès). Per guardar la informació s’ha optat per utilitzar un fitxer de text pla en el qual el nom i el cognom estaran separats per una barra vertical <code>|</code>, mentre que cada parell de <code>nom</code> i <code>cognom</code> estarà separat per un asterisc <code>*</code>.
</p>

<p>
Com que només s’accepten peticions de tipus <code>POST</code>  no cal cercar la cadena de consulta a l’<acronym title="Uniform Resource Locator">URL</acronym>, sempre es trobarà al cos de la petició. Per aquest mateix motiu s’ha restringit l’accés a aquest servei només a les peticions <code>POST</code>, i s’estableix la limitació a la capçalera de la resposta.
</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle"> El mòdul &#039;FileSystem&#039;</p>
<p>
Podeu trobar tota la documentació sobre el mòdul <code>FileSystem</code> a l’enllaç següent: <a href="https://goo.gl/tpurw0" class="urlextern" title="https://goo.gl/tpurw0"  rel="nofollow">goo.gl/tpurw0</a>.
</p>
</div></div><pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">let queryString = require('querystring');</div></li><li class="li1"><div class="de1">let fs = require('fs');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let server = http.createServer();</div></li><li class="li1"><div class="de1">server.on('request', function(peticio, resposta) {</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Origin', '*');</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Methods', 'POST');</div></li><li class="li1"><div class="de1">  resposta.setHeader('Content-Type', 'text/plain;charset=utf-8');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  let cos = '';</div></li><li class="li1"><div class="de1">  peticio.on('data', function(dades) {</div></li><li class="li1"><div class="de1">    if (cos.length &gt; 1e6) {</div></li><li class="li1"><div class="de1">      peticio.connection.destroy();</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">      cos += dades;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  }).on('end', function() {</div></li><li class="li1"><div class="de1">    let params = queryString.parse(cos);</div></li><li class="li1"><div class="de1">    let nom = decodeURI(params.nom);</div></li><li class="li1"><div class="de1">    let cognom = decodeURI(params.cognom);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let data = Math.floor(Date.now() / 1000);</div></li><li class="li1"><div class="de1">    fs.appendFile('noms.txt', nom + &quot;|&quot; + cognom + &quot;*&quot;, function(error) {</div></li><li class="li1"><div class="de1">      let missatge;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      if (error) {</div></li><li class="li1"><div class="de1">        throw error; // No continuarà l'execució</div></li><li class="li1"><div class="de1">      } </div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      resposta.statusCode = 200;</div></li><li class="li1"><div class="de1">      missatge = 'Dades afegides al fitxer correctament: ' + nom + ' ' + cognom;</div></li><li class="li1"><div class="de1">      resposta.write(missatge);</div></li><li class="li1"><div class="de1">      console.log(missatge);</div></li><li class="li1"><div class="de1">      resposta.end();</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">  });</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">server.listen(8080, '127.0.0.1');</div></li></ol></pre>

<p>
Fixeu-vos que en lloc d’utilitzar <code>writeHead()</code> per establir el codi d’estat, s’ha modificat directament la propietat, ja que aquest valor variarà segons si s’ha produït o no un error, i en el seu lloc s’ha establert el tipus de contingut utilitzant el mètode <code>setHeader()</code>.
</p>

<p>
En aquest cas, no es considera l’opció d’acceptar altres mètodes, així que s’ha restringit l’accés al servei web de manera que només accepta peticions enviades mitjançant el mètode <code>POST</code>.
</p>

<p>
Com es pot apreciar, per afegir nou contingut al fitxer, s’utilitza el mètode <code>fs.appendFile()</code> passant com a paràmetres el nom del fitxer (en aquest cas <code>noms.txt</code>), el contingut que s’ha d’afegir i una funció que es cridarà en acabar d’escriure les dades.
</p>

<p>
Aquesta funció pot rebre un error com a argument si s’ha produït en desar el fitxer (per exemple, per manca de permisos d’escriptura o si el disc fos ple). Per aquesta raó, es comprova si s’ha rebut un error i es genera el codi de la resposta i un missatge adient que es mostrarà per la consola.
</p>

<p>
Si proveu d’enviar dades a través del navegador, veureu que a la consola apareixeran els continguts de les variables <code>nom</code> i <code>cognom</code> que s’han afegit al client, i es crearà el fitxer amb el format especificat: parells de <code>nom</code> i <code>cognom</code> separats per una barra vertical, i aquests separats d’altres parells per un asterisc.
</p>

<p>
Cal tenir en compte que el mètode <code>appendFile()</code> permet afegir dades a un fitxer existent, però en cas que aquest no existeixi en crearà un de nou. Un mètode similar del mòdul <code>FileSystem</code>, anomenat <code>writeFile</code>, permet escriure dades al disc, però en aquest cas sempre se sobreescriu el fitxer.
</p>

<p>
Aquesta última opció pot interessar si es treballa amb altre tipus de continguts. Per exemple, si en lloc de desar el fitxer com a text pla el guardem com a JSON, s’haurà de guardar l’objecte complet, que contindrà tota la informació. Això obligarà a llegir el fitxer en arrencar el servidor (si no, s’esborraria tota la informació anterior). Vegeu com es podria implementar en l’exemple següent:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">let queryString = require('querystring');</div></li><li class="li1"><div class="de1">let fs = require('fs');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let dadesAplicacio;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">const NOM_FITXER = 'noms.json';</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">carregarDadesJSON(NOM_FITXER);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let server = http.createServer();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">server.on('request', function(peticio, resposta) {</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Origin', '*');</div></li><li class="li1"><div class="de1">  resposta.setHeader('Access-Control-Allow-Methods', 'POST');</div></li><li class="li1"><div class="de1">  resposta.setHeader('Content-Type', 'text/plain;charset=utf-8');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  let cos = '';</div></li><li class="li1"><div class="de1">  peticio.on('data', function(dades) {</div></li><li class="li1"><div class="de1">    if (cos.length &gt; 1e6) {</div></li><li class="li1"><div class="de1">      peticio.connection.destroy();</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">      cos += dades;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  }).on('end', function() {</div></li><li class="li1"><div class="de1">    let params = queryString.parse(cos);</div></li><li class="li1"><div class="de1">    let nom = decodeURI(params.nom);</div></li><li class="li1"><div class="de1">    let cognom = decodeURI(params.cognom);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    dadesAplicacio[dadesAplicacio.length] = {</div></li><li class="li1"><div class="de1">      nom: nom,</div></li><li class="li1"><div class="de1">      cognom: cognom</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">    desarDadesJSON(NOM_FITXER, dadesAplicacio);</div></li><li class="li1"><div class="de1">    missatge = 'Afegit ' + nom + ' ' + cognom + ' al fitxer';</div></li><li class="li1"><div class="de1">    resposta.write(missatge);</div></li><li class="li1"><div class="de1">    console.log(missatge);</div></li><li class="li1"><div class="de1">    resposta.end();</div></li><li class="li1"><div class="de1">  });</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function desarDadesJSON(fitxer, dades) {</div></li><li class="li1"><div class="de1">  fs.writeFile(fitxer, JSON.stringify(dades), function(error) {</div></li><li class="li1"><div class="de1">    if (error) {</div></li><li class="li1"><div class="de1">      console('Error en desar el fitxer');</div></li><li class="li1"><div class="de1">      throw err;</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">      console.log('Dades desades');</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  });</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function carregarDadesJSON(fitxer) {</div></li><li class="li1"><div class="de1">  fs.readFile(fitxer, 'utf8', function(err, dades) {</div></li><li class="li1"><div class="de1">    if (err) {</div></li><li class="li1"><div class="de1">      console.log('No existeix el fitxer, creant nou conjunt de dades');</div></li><li class="li1"><div class="de1">      dadesAplicacio = [];</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">      console.log('Dades carregades:', dades);</div></li><li class="li1"><div class="de1">      dadesAplicacio = JSON.parse(dades);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  });</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">server.listen(8080, '127.0.0.1');  </div></li></ol></pre>

<p>
Fixeu-vos que s’ha definit una variable global per al mòdul anomenada <code>dadesAplicacio</code>. Aquesta variable contindrà l’<em>array</em> amb les dades. Cal destacar que mentre el servidor continuï funcionant, aquestes dades continuaran en memòria, és a dir, no es perden entre peticions. Per aquesta raó, només cal llegir el fitxer en iniciar el servidor, ja que cada vegada que es rep una nova petició s’afegeix un nou element a l’<em>array</em> amb aquesta informació i es desa al fitxer.
</p>

<p>
Com es pot apreciar, a diferència de JavaScript, Node.js sí que disposa de constants; en aquest cas s’ha definit la constant <code>NOM_FITXER</code> amb el nom del fitxer que contindrà les dades.
</p>

<p>
Cal destacar que la lectura i l’escriptura de dades utilitzant els mètodes <code>readFile()</code>, <code>appendFile()</code> i <code>writeFile()</code> és asíncrona: això vol dir que mentre s’estan realitzant les operacions, el programa continua executant-se. Per aquesta raó no es pot retornar el contingut del fitxer en carregar-lo, ja que el valor de retorn és <code>undefined</code> en aquell moment. Per aquesta raó, el que s’ha fet és establir el valor de la variable global <code>dadesAplicacio</code> dintre de la funció que és cridada en finalitzar la lectura.
</p>

<p>
Com que s’ha utilitzat el format JSON només cal fer servir els mètodes <code>JSON.stringify()</code> per convertir les dades en una cadena de text per desar i <code>JSON.parse</code> per convertir la cadena de text en un objecte de JavaScript. Aquest format simplifica molt la manipulació de dades, ja que no cal que implementeu els vostres propis analitzadors i permet treballar directament amb les dades llegides.
</p>

</div>

<h3><a id="cas_practicimplementacio_d_un_servei_web_rest" >Cas pràctic: implementació d&#039;un servei web REST</a></h3>
<div class="level3">

<p>
Una vegada ja se sap com fer l’encaminament dels <acronym title="Uniform Resource Locator">URL</acronym>, com es llegeixen i s’escriuen els fitxers i com es generen les respostes, implementar un servei web és relativament simple. Com a exemple s’implementarà un servei web per gestionar esdeveniments que inclourà l’opció de filtratge (podeu trobar el codi a l’enllaç següent: <a href="https://goo.gl/tZMFpu" class="urlextern" title="https://goo.gl/tZMFpu"  rel="nofollow">goo.gl/tZMFpu</a>). Al llarg d’aquest exemple es practicaran les competències següents:
</p>
<ul>
<li class="level1"><div class="li"> Creació d’un servei web REST amb Node.js que permet realitzar el conjunt d’operacions CRUD (creació, lectura, actualització i eliminació).</div>
<ul>
<li class="level2"><div class="li"> Generació d’una resposta aplicant mecanismes CORS per permetre l’accés dels mètodes acceptats des de qualsevol domini.</div>
</li>
<li class="level2"><div class="li"> Obtenció dels paràmetres de la petició sigui quin sigui el mètode emprat (<code>POST</code>, <code>GET</code>, <code>PUT</code> o <code>DELETE</code>).</div>
</li>
<li class="level2"><div class="li"> Encaminament de la petició al controlador de recurs adequat segons l’<acronym title="Uniform Resource Locator">URL</acronym>.</div>
</li>
<li class="level2"><div class="li"> Gestió de les operacions sobre el recurs.</div>
</li>
<li class="level2"><div class="li"> Lectura i escriptura de fitxers en format JSON.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Creació d’una aplicació d’una sola pàgina que permet veure el llistat d’esdeveniments, filtrar els resultats, afegir nous esdeveniments, actualitzar-los i eliminar-los.</div>
<ul>
<li class="level2"><div class="li"> Utilització de la biblioteca jQuery per simplificar el codi.</div>
</li>
<li class="level2"><div class="li"> Utilització de formularis.</div>
</li>
<li class="level2"><div class="li"> Utilització d’atributs propis (HTML5).</div>
</li>
<li class="level2"><div class="li"> Enviament de peticions AJAX.</div>
</li>
<li class="level2"><div class="li"> Manipulació del DOM per crear nous elements i modificar-ne la visibilitat mitjançant <acronym title="Cascading Style Sheets">CSS</acronym>.</div>
</li>
<li class="level2"><div class="li"> Aplicació del patró mòdul per encapsular l’aplicació.</div>
</li>
</ul>
</li>
</ul>

<p>
Tot i que en aquest exemple només es farà servir un fitxer <acronym title="Cascading Style Sheets">CSS</acronym> i un fitxer JavaScript, és recomanable crear una carpeta per a cada tipus, ja que és una bona pràctica a l’hora de desenvolupar aplicacions més complexes.
</p>
<div class="iocnote"><div class="ioccontent">
<p>
En anglès, les sigles CRUD es corresponen amb les inicials de <em>create, read, update, delete</em>.
</p>
</div></div>
<p>
El contingut del fitxer <acronym title="Cascading Style Sheets">CSS</acronym> és força simple; podeu crear un fitxer anomenat <em>principal.css</em> amb el codi que trobareu a continuació i desar-lo al directori <code>css</code>. A banda de donar estil a la pàgina, s’han afegit les classes <code>error</code>, <code>info</code>, <code>exit</code> i <code>alerta</code>, que es fan servir per donar diferents colors a les notificacions segons el seu tipus, i la classe <code>amaga</code>, per ocultar els continguts.
</p>
<pre class="code">body {
    width: 700px;
    margin: 0 auto;
}

h1, h2 {
    text-align: center;
}

label {
    display: block;
    font-weight: bold;
}

input, select, button, textarea {
    display: block;
    width: 100%;
}

table {
    border: 1px solid black;
    width: 100%;
    margin-top: 15px;
    margin-bottom: 15px;
}

table button {
    width: 33%;
    display: inline-block;
    overflow: hidden;
}

.columna-doble {
    display: inline-block;
    width: 49%;
}

.amaga {
    display: none;
}

.buit {
    text-align: center;
    font-style: italic;
}

#notificacions {
    border: 0;
    padding: 5px;
}

#notificacions.error {
    color: #D8000C;
    background-color: #FFBABA;
    border-color: #D8000C;
    border: 1px solid;
}

#notificacions.info {
    color: #00529B;
    background-color: #BDE5F8;
    border-color: #00529B;
    border: 1px solid;
}

#notificacions.exit {
    color: #4f8A10;
    background-color: #DFF2BF;
    border-color: #4f8A10;
    border: 1px solid;
}

#notificacions.alerta {
    color: #9F6000;
    background-color: #FEEFB3;
    border-color: #9F6000;
    border: 1px solid;
}</pre>

<p>
El codi <acronym title="HyperText Markup Language">HTML</acronym> inclou la càrrega del full d’estil, la biblioteca jQuery i el fitxer amb el codi JavaScript. Cal destacar que es divideix en dues parts importants. Per una banda, la capçalera (etiqueta <code>header</code>), que inclou el títol de l’aplicació i l’àrea on es mostraran les notificacions i, per altra, la zona principal (etiqueta <code>main</code>), que mostrarà els diferents continguts.
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;!DOCTYPE html&gt;</div></li><li class="li1"><div class="de1">&lt;html lang=&quot;ca&quot;&gt;</div></li><li class="li1"><div class="de1">&lt;head&gt;</div></li><li class="li1"><div class="de1">    &lt;meta charset=&quot;UTF-8&quot;&gt;</div></li><li class="li1"><div class="de1">    &lt;title&gt;Gestor d'esdeveniments&lt;/title&gt;</div></li><li class="li1"><div class="de1">    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/principal.css&quot;&gt;</div></li><li class="li1"><div class="de1">&lt;/head&gt;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;header&gt;</div></li><li class="li1"><div class="de1">    &lt;h1&gt;Gestor d'esdeveniments&lt;/h1&gt;</div></li><li class="li1"><div class="de1">    &lt;div id=&quot;notificacions&quot;&gt;&lt;/div&gt;</div></li><li class="li1"><div class="de1">&lt;/header&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;main&gt;</div></li><li class="li1"><div class="de1">    &lt;div id=&quot;paginaLlistat&quot;&gt;</div></li><li class="li1"><div class="de1">        &lt;h2&gt;Llistat d'esdeveniments&lt;/h2&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        &lt;input class=&quot;columna-doble&quot; type=&quot;text&quot;</div></li><li class="li1"><div class="de1">               placeholder=&quot;Introdueix una paraula o deixa-ho buit per eliminar el filtre&quot;</div></li><li class="li1"><div class="de1">               name=&quot;filtre&quot;/&gt;</div></li><li class="li1"><div class="de1">        &lt;button class=&quot;columna-doble&quot; data-accio=&quot;filtrar&quot;&gt;Filtrar&lt;/button&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        &lt;table&gt;</div></li><li class="li1"><div class="de1">            &lt;thead&gt;</div></li><li class="li1"><div class="de1">            &lt;tr&gt;</div></li><li class="li1"><div class="de1">                &lt;th&gt;Nom&lt;/th&gt;</div></li><li class="li1"><div class="de1">                &lt;th&gt;Data&lt;/th&gt;</div></li><li class="li1"><div class="de1">                &lt;th&gt;Organitzador&lt;/th&gt;</div></li><li class="li1"><div class="de1">                &lt;th&gt;Accions&lt;/th&gt;</div></li><li class="li1"><div class="de1">            &lt;/tr&gt;</div></li><li class="li1"><div class="de1">            &lt;/thead&gt;</div></li><li class="li1"><div class="de1">            &lt;tbody&gt;</div></li><li class="li1"><div class="de1">            &lt;tr&gt;</div></li><li class="li1"><div class="de1">                &lt;td colspan=&quot;4&quot; class=&quot;buit&quot;&gt;No s'ha trobat cap esdeveniment&lt;/td&gt;</div></li><li class="li1"><div class="de1">            &lt;/tr&gt;</div></li><li class="li1"><div class="de1">            &lt;/tbody&gt;</div></li><li class="li1"><div class="de1">        &lt;/table&gt;</div></li><li class="li1"><div class="de1">        &lt;button data-accio=&quot;mostrar-alta&quot;&gt;Afegir nou esdeveniment&lt;/button&gt;</div></li><li class="li1"><div class="de1">    &lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    &lt;div id=&quot;paginaAlta&quot; class=&quot;amaga&quot;&gt;</div></li><li class="li1"><div class="de1">        &lt;h2&gt;Alta d'esdeveniment&lt;/h2&gt;</div></li><li class="li1"><div class="de1">        &lt;form id=&quot;formulariAlta&quot;&gt;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Nom&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;input type=&quot;text&quot; name=&quot;nom&quot; placeholder=&quot;Nom de l'esdeveniment...&quot; required/&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Descripció&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;textarea name=&quot;descripcio&quot; placeholder=&quot;Descripció de l'esdeveniment...&quot;&gt;&lt;/textarea&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Data&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;input type=&quot;date&quot; name=&quot;data&quot;/&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Organitzador&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;select name=&quot;organitzador&quot;&gt;</div></li><li class="li1"><div class="de1">                &lt;option value=&quot;Ajuntament de Barcelona&quot; selected&gt;Ajuntament de Barcelona&lt;/option&gt;</div></li><li class="li1"><div class="de1">                &lt;option value=&quot;Associació Cultural&quot;&gt;Associació Cultural&lt;/option&gt;</div></li><li class="li1"><div class="de1">                &lt;option value=&quot;Associació de Botiguers&quot;&gt;Associació de Botiguers&lt;/option&gt;</div></li><li class="li1"><div class="de1">                &lt;option value=&quot;Organitzador privat&quot;&gt;Organitzador privat&lt;/option&gt;</div></li><li class="li1"><div class="de1">            &lt;/select&gt;</div></li><li class="li1"><div class="de1">            &lt;button class=&quot;columna-doble&quot; data-accio=&quot;alta&quot;&gt;Alta&lt;/button&gt;</div></li><li class="li1"><div class="de1">            &lt;button class=&quot;columna-doble&quot; data-accio=&quot;mostrar-llistat&quot;&gt;Tornar al llistat&lt;/button&gt;</div></li><li class="li1"><div class="de1">        &lt;/form&gt;</div></li><li class="li1"><div class="de1">    &lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    &lt;div id=&quot;paginaActualitzar&quot; class=&quot;amaga&quot;&gt;</div></li><li class="li1"><div class="de1">        &lt;h2&gt;Modificació d'esdeveniment&lt;/h2&gt;</div></li><li class="li1"><div class="de1">        &lt;form id=&quot;formulariActualitzar&quot;&gt;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Nom&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;input type=&quot;text&quot; name=&quot;nom&quot; placeholder=&quot;Nom de l'esdeveniment...&quot; required/&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Descripció&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;textarea name=&quot;descripcio&quot; placeholder=&quot;Descripció de l'esdeveniment...&quot;&gt;&lt;/textarea&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Data&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;input type=&quot;date&quot; name=&quot;data&quot;/&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Organitzador&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;select name=&quot;organitzador&quot;&gt;</div></li><li class="li1"><div class="de1">                &lt;option selected&gt;Ajuntament de Barcelona&lt;/option&gt;</div></li><li class="li1"><div class="de1">                &lt;option&gt;Associació Cultural&lt;/option&gt;</div></li><li class="li1"><div class="de1">                &lt;option&gt;Associació de Botiguers&lt;/option&gt;</div></li><li class="li1"><div class="de1">                &lt;option&gt;Organitzador privat&lt;/option&gt;</div></li><li class="li1"><div class="de1">            &lt;/select&gt;</div></li><li class="li1"><div class="de1">            &lt;button class=&quot;columna-doble&quot; data-accio=&quot;actualitzar&quot;&gt;Actualitzar&lt;/button&gt;</div></li><li class="li1"><div class="de1">            &lt;button class=&quot;columna-doble&quot; data-accio=&quot;mostrar-llistat&quot;&gt;Tornar al llistat&lt;/button&gt;</div></li><li class="li1"><div class="de1">        &lt;/form&gt;</div></li><li class="li1"><div class="de1">    &lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    &lt;div id=&quot;paginaDetall&quot; class=&quot;amaga&quot;&gt;</div></li><li class="li1"><div class="de1">        &lt;h2&gt;Detall d'esdeveniment&lt;/h2&gt;</div></li><li class="li1"><div class="de1">        &lt;div&gt;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Nom&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;span id=&quot;detallNom&quot;&gt;xx&lt;/span&gt;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Descripció&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;span id=&quot;detallDescripcio&quot;&gt;xx&lt;/span&gt;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Data&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;span id=&quot;detallData&quot;&gt;xx&lt;/span&gt;</div></li><li class="li1"><div class="de1">            &lt;label&gt;Organitzador&lt;/label&gt;</div></li><li class="li1"><div class="de1">            &lt;span id=&quot;detallOrganitzador&quot;&gt;xx&lt;/span&gt;</div></li><li class="li1"><div class="de1">        &lt;/div&gt;</div></li><li class="li1"><div class="de1">        &lt;button class=&quot;columna-doble&quot; data-accio=&quot;mostrar-actualitzar&quot;&gt;Actualitzar&lt;/button&gt;</div></li><li class="li1"><div class="de1">        &lt;button class=&quot;columna-doble&quot; data-accio=&quot;mostrar-llistat&quot;&gt;Tornar al llistat&lt;/button&gt;</div></li><li class="li1"><div class="de1">    &lt;/div&gt;</div></li><li class="li1"><div class="de1">&lt;/main&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;script src=&quot;https://code.jquery.com/jquery-3.1.1.min.js&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;script src=&quot;js/gestor-esdeveniments.js&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
Fixeu-vos que la zona principal conté quatre contenidors <code>div</code>: <code>paginaLlistat</code>, <code>paginaAlta</code>, <code>paginaActualitzar</code>, <code>paginaDetall</code>. Aquests contenidors representen les diferents pantalles de l’aplicació i, inicialment, la classe <code>amaga</code> s’aplica a totes excepte a <code>paginaLlistat</code>. Mitjançant JavaScript es fa la transició entre pantalles afegint aquesta classe a la pàgina anterior i eliminant-la de la pàgina nova.
</p>

<p>
Cal destacar que als botons s’ha aplicat l’atribut personalitzat <code>data-accio</code> i en alguns casos, mitjançant JavaScript, l’atribut <code>data-id</code>. Això permet processar tots els botons amb el mateix detector d’<em>events</em> i segons el valor que tinguin aquests atributs es realitzarà una acció o una altra. Per exemple, en fer clic sobre el botó <em>Detall</em> es processarà l’acció <code>mostrar-detall</code> amb l’identificador corresponent a l’esdeveniment (indicat per <code>data-id</code>).
</p>

<p>
Com es pot apreciar, la taula és buida en el codi <acronym title="HyperText Markup Language">HTML</acronym> i les files es generen mitjançant JavaScript una vegada es rep el llistat d’esdeveniments del servidor.
</p>

<p>
Un detall a tenir en compte és que el tipus de dades <code>date</code> no forma part de l’especificació d’HTML5, sinó que es tracta d’una implementació pròpia de Google Chrome i, per tant, no és disponible en altres navegadors (com Mozilla Firefox). En aquests casos es tractarà com un camp de text normal.
</p>

<p>
El codi del client el podeu guardar en un fitxer anomenat <code>gestor-esdeveniments</code> dintre del directori <code>js</code>. Com podeu veure a continuació, s’ha aplicat el patró mòdul per encapsular-lo, de manera que tota l’aplicació es troba a la variable <code>GESTOR_ESDEVENIMENTS</code> i només és accessible externament el mètode <code>iniciarAplicació()</code>. D’aquesta manera es pot assegurar que no interferirà amb altres aplicacións ni serà manipulada externament.
</p>

<p>
S’ha de tenir en compte que a <code>GESTOR_ESDEVENIMENTS</code> no s’assigna una funció, sinó que <strong>se n’assigna el retorn</strong>, ja que és una funció autoinvocada i, per consegüent, el contingut de <code>GESTOR_ESDEVENIMENTS</code> és un objecte amb un únic mètode (<code>iniciarAplicació()</code>) que té accés a l’aplicació gràcies a la clausura.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let GESTOR_ESDEVENIMENTS = (function () {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let paginaMostradaActualment;</div></li><li class="li1"><div class="de1">    let llistatEsdeveniments;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function enviarPeticio(metode, url, params) {</div></li><li class="li1"><div class="de1">        $.ajax({</div></li><li class="li1"><div class="de1">            url: url,</div></li><li class="li1"><div class="de1">            data: params,</div></li><li class="li1"><div class="de1">            dataType: 'json',</div></li><li class="li1"><div class="de1">            type: metode,</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            error: function () {</div></li><li class="li1"><div class="de1">                accioMostrarNotificacio('error', 'S\'ha produït un error en fer la petició al servidor');</div></li><li class="li1"><div class="de1">            },</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            success: function (dades) {</div></li><li class="li1"><div class="de1">                processarResposta(dades);</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">        });</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function processarAccio(accio, dades) {</div></li><li class="li1"><div class="de1">        switch (accio) {</div></li><li class="li1"><div class="de1">            case 'establir-llistat':</div></li><li class="li1"><div class="de1">                accioEstablirLlistat(dades.esdeveniments);</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'mostrar-notificacio':</div></li><li class="li1"><div class="de1">                accioMostrarNotificacio(dades.notificacio.tipus, dades.notificacio.missatge);</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'mostrar-pagina':</div></li><li class="li1"><div class="de1">                accioMostrarPagina(dades.pagina);</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'mostrar-actualitzar':</div></li><li class="li1"><div class="de1">                establirEsdevenimentActualitzar(llistatEsdeveniments[dades.id], 'actualitzar');</div></li><li class="li1"><div class="de1">                accioMostrarPagina('paginaActualitzar');</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'mostrar-detall':</div></li><li class="li1"><div class="de1">                establirEsdevenimentDetall(llistatEsdeveniments[dades.id], 'detall');</div></li><li class="li1"><div class="de1">                accioMostrarPagina('paginaDetall');</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'mostrar-llistat':</div></li><li class="li1"><div class="de1">                netejarFormularis();</div></li><li class="li1"><div class="de1">                accioMostrarPagina('paginaLlistat');</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'mostrar-alta':</div></li><li class="li1"><div class="de1">                netejarFormularis();</div></li><li class="li1"><div class="de1">                accioMostrarPagina('paginaAlta');</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'eliminar':</div></li><li class="li1"><div class="de1">                enviarPeticio('DELETE', 'http://127.0.0.1:8080/esdeveniments/' + dades.id);</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'actualitzar':</div></li><li class="li1"><div class="de1">                dades.esdeveniment = obtenirEsdevenimentDelFormulari('formulariActualitzar');</div></li><li class="li1"><div class="de1">                dades.esdeveniment.id = dades.id;</div></li><li class="li1"><div class="de1">                enviarPeticio('PUT', 'http://127.0.0.1:8080/esdeveniments/' + dades.id, dades.esdeveniment);</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'alta':</div></li><li class="li1"><div class="de1">                dades.esdeveniment = obtenirEsdevenimentDelFormulari('formulariAlta');</div></li><li class="li1"><div class="de1">                enviarPeticio('POST', 'http://127.0.0.1:8080/esdeveniments', dades.esdeveniment);</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case 'filtrar':</div></li><li class="li1"><div class="de1">                accioFiltrar();</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            default:</div></li><li class="li1"><div class="de1">                console.error('Acció desconeguda: ', accio);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function processarResposta(dades) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; dades.accions.length; i++) {</div></li><li class="li1"><div class="de1">            processarAccio(dades.accions[i].accio, dades.accions[i])</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function processarBoto(e) {</div></li><li class="li1"><div class="de1">        e.preventDefault();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        let $boto = $(this);</div></li><li class="li1"><div class="de1">        let accio = $boto.attr('data-accio');</div></li><li class="li1"><div class="de1">        let id = $boto.attr('data-id');</div></li><li class="li1"><div class="de1">        let dades = {</div></li><li class="li1"><div class="de1">            $boto: $boto,</div></li><li class="li1"><div class="de1">            id: id</div></li><li class="li1"><div class="de1">        };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        processarAccio(accio, dades);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function accioMostrarNotificacio(tipus, missatge) {</div></li><li class="li1"><div class="de1">        let $notificacions = $('#notificacions');</div></li><li class="li1"><div class="de1">        $notificacions.removeClass();</div></li><li class="li1"><div class="de1">        $notificacions.addClass(tipus);</div></li><li class="li1"><div class="de1">        $notificacions.html(missatge);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function accioMostrarPagina(novaPagina) {</div></li><li class="li1"><div class="de1">        $('#' + paginaMostradaActualment).addClass('amaga');</div></li><li class="li1"><div class="de1">        paginaMostradaActualment = novaPagina;</div></li><li class="li1"><div class="de1">        $('#' + paginaMostradaActualment).removeClass('amaga');</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function accioEstablirLlistat(dades) {</div></li><li class="li1"><div class="de1">        llistatEsdeveniments = dades;</div></li><li class="li1"><div class="de1">        omplirTaulaLlistat(dades);</div></li><li class="li1"><div class="de1">        accioMostrarPagina('paginaLlistat');</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function accioFiltrar() {</div></li><li class="li1"><div class="de1">        let $filtre = $('input[name=&quot;filtre&quot;]');</div></li><li class="li1"><div class="de1">        let terme = $filtre.val();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (terme.indexOf(' ') !== -1) {</div></li><li class="li1"><div class="de1">            accioMostrarNotificacio('error', 'Només es pot introduir una paraula per filtrar');</div></li><li class="li1"><div class="de1">        } else if (!terme) {</div></li><li class="li1"><div class="de1">            accioMostrarNotificacio('info', 'Desactivat el filtre');</div></li><li class="li1"><div class="de1">            omplirTaulaLlistat(llistatEsdeveniments);</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">            filtrarEsdeveniments(terme);</div></li><li class="li1"><div class="de1">            $filtre.val('');</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function omplirTaulaLlistat(dades) {</div></li><li class="li1"><div class="de1">        let $cosTaula = $('tbody');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Es neteja el cos del llistat</div></li><li class="li1"><div class="de1">        $cosTaula.empty();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Es recorren les dades</div></li><li class="li1"><div class="de1">        for (let i in dades) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            // Es genera la fila i les columnes</div></li><li class="li1"><div class="de1">            let $fila = $('&lt;tr&gt;');</div></li><li class="li1"><div class="de1">            let $col1 = $('&lt;td&gt;');</div></li><li class="li1"><div class="de1">            let $col2 = $('&lt;td&gt;');</div></li><li class="li1"><div class="de1">            let $col3 = $('&lt;td&gt;');</div></li><li class="li1"><div class="de1">            let $col4 = $('&lt;td&gt;');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            // S'afegeix el contingut a cada columna a partir de la informació del llistat de dades</div></li><li class="li1"><div class="de1">            $col1.html(dades[i].nom);</div></li><li class="li1"><div class="de1">            $col2.html(dades[i].data);</div></li><li class="li1"><div class="de1">            $col3.html(dades[i].organitzador);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            let $botoDetall = $('&lt;button&gt;Detall&lt;/button&gt;');</div></li><li class="li1"><div class="de1">            $botoDetall.attr('data-id', dades[i].id);</div></li><li class="li1"><div class="de1">            $botoDetall.attr('data-accio', 'mostrar-detall');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            let $botoActualitzar = $('&lt;button&gt;Actualitzar&lt;/button&gt;');</div></li><li class="li1"><div class="de1">            $botoActualitzar.attr('data-id', dades[i].id);</div></li><li class="li1"><div class="de1">            $botoActualitzar.attr('data-accio', 'mostrar-actualitzar');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            let $botoEliminar = $('&lt;button&gt;Eliminar&lt;/button&gt;');</div></li><li class="li1"><div class="de1">            $botoEliminar.attr('data-id', dades[i].id);</div></li><li class="li1"><div class="de1">            $botoEliminar.attr('data-accio', 'eliminar');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            $col4.append($botoDetall);</div></li><li class="li1"><div class="de1">            $col4.append($botoActualitzar);</div></li><li class="li1"><div class="de1">            $col4.append($botoEliminar);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            // S'afegeixen les columnes a la fila</div></li><li class="li1"><div class="de1">            $fila.append($col1);</div></li><li class="li1"><div class="de1">            $fila.append($col2);</div></li><li class="li1"><div class="de1">            $fila.append($col3);</div></li><li class="li1"><div class="de1">            $fila.append($col4);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            // S'afegeix la fila al cos de la taula</div></li><li class="li1"><div class="de1">            $cosTaula.append($fila);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // S'afegeix un detector d'events a tots els botons</div></li><li class="li1"><div class="de1">        $('table button').on('click', processarBoto);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function filtrarEsdeveniments(terme) {</div></li><li class="li1"><div class="de1">        let llistatFiltrat = [];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        for (let i in llistatEsdeveniments) {</div></li><li class="li1"><div class="de1">            if (llistatEsdeveniments[i].nom.indexOf(terme) !== -1</div></li><li class="li1"><div class="de1">                || llistatEsdeveniments[i].descripcio.indexOf(terme) !== -1</div></li><li class="li1"><div class="de1">                || llistatEsdeveniments[i].organitzador.indexOf(terme) !== -1</div></li><li class="li1"><div class="de1">            ) {</div></li><li class="li1"><div class="de1">                llistatFiltrat.push(llistatEsdeveniments[i]);</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        omplirTaulaLlistat(llistatFiltrat);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (llistatFiltrat.length === 0) {</div></li><li class="li1"><div class="de1">            accioMostrarNotificacio('alerta', 'No s\'ha trobat cap resultat');</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">            accioMostrarNotificacio('exit', 'Llistat filtrat pel terme &quot;' + terme + '&quot;.');</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function obtenirEsdevenimentDelFormulari(idFormulari) {</div></li><li class="li1"><div class="de1">        let $form = $('form#' + idFormulari);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        return {</div></li><li class="li1"><div class="de1">            nom: $form.find('input[name=&quot;nom&quot;]').val(),</div></li><li class="li1"><div class="de1">            descripcio: $form.find('textarea').val(),</div></li><li class="li1"><div class="de1">            data: $form.find('input[name=&quot;data&quot;]').val(),</div></li><li class="li1"><div class="de1">            organitzador: $form.find('select').val()</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function establirEsdevenimentActualitzar(esdeveniment) {</div></li><li class="li1"><div class="de1">        let $form = $('form');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        $form.find('input[name=&quot;nom&quot;]').val(esdeveniment.nom);</div></li><li class="li1"><div class="de1">        $form.find('textarea').val(esdeveniment.descripcio);</div></li><li class="li1"><div class="de1">        $form.find('input[name=&quot;data&quot;]').val(esdeveniment.data);</div></li><li class="li1"><div class="de1">        $form.find('select').val(esdeveniment.organitzador);</div></li><li class="li1"><div class="de1">        $form.find('[data-accio=&quot;actualitzar&quot;]').attr('data-id', esdeveniment.id);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function establirEsdevenimentDetall(esdeveniment) {</div></li><li class="li1"><div class="de1">        $('#detallNom').html(esdeveniment.nom);</div></li><li class="li1"><div class="de1">        $('#detallDescripcio').html(esdeveniment.descripcio);</div></li><li class="li1"><div class="de1">        $('#detallData').html(esdeveniment.data);</div></li><li class="li1"><div class="de1">        $('#detallOrganitzador').html(esdeveniment.organitzador);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        $('[data-accio=&quot;mostrar-actualitzar&quot;]').attr('data-id', esdeveniment.id);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    function netejarFormularis() {</div></li><li class="li1"><div class="de1">        $('form').trigger('reset');</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    return {</div></li><li class="li1"><div class="de1">        iniciarAplicacio: function () {</div></li><li class="li1"><div class="de1">            $('button').on('click', processarBoto);</div></li><li class="li1"><div class="de1">            enviarPeticio('GET', 'http://127.0.0.1:8080/esdeveniments');</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">})();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">$(document).ready(function () {</div></li><li class="li1"><div class="de1">    GESTOR_ESDEVENIMENTS.iniciarAplicacio();</div></li><li class="li1"><div class="de1">});</div></li></ol></pre>

<p>
Fixeu-vos que s’ha centralitzat el processament d’accions en la funció <code>processarAccio()</code>, que rep el nom de l’acció que cal portar a terme i un objecte amb les dades que s’han de processar. Aquesta funció és cridada tant pel processament de les respostes que arriben del servidor com pel processament dels botons, de manera que aquestes funcions només s’han d’encarregar d’enviar les dades correctes per realitzar el processament.
</p>

<p>
Les accions en conjunt es poden dividir en dos grups: les responsables d’enviar peticions al servidor i les responsables de modificar-ne la vista (la representació de les dades a la pantalla). Cal tenir en compte que, per simplificar, no s’ha creat una acció per a cada cas, ja que moltes només requereixen un parell de línies de codi. En projectes més complexos, però, és una bona pràctica (o fins i tot utilitzar diferents objectes).
</p>

<p>
La funció <code>processarResposta()</code> és l’encarregada de processar les respostes a les peticions AJAX. Aquestes respostes han de ser en format JSON i han de contenir un <em>array</em> amb el nom <code>accions</code>, que contindrà una o més accions per processar. D’aquesta manera una resposta pot contenir múltiples accions, com poden ser afegir una notificació, actualitzar el llistat i mostrar una pàgina diferent, i són portades a terme per la funció <code>processarAcció()</code>.
</p>

<p>
Per simplificar l’enviament de peticions AJAX s’ha creat una funció anomenada <code>enviarPeticio()</code>, que és l’encarregada de crear-la, ja que el codi d’aquestes peticions és idèntic en tots els casos i només canvia el mètode d’enviament, l’<acronym title="Uniform Resource Locator">URL</acronym> i els paràmetres. Si es produeix cap error, es mostrarà una notificació i en cas d’èxit es processarà la resposta invocant la funció <code>processarResposta()</code>.
</p>

<p>
Per altra banda, la funció <code>processarBoto()</code> és invocada quan es fa clic sobre qualsevol dels botons, tant els inclosos en el codi <acronym title="HyperText Markup Language">HTML</acronym> com els creats dinàmicament en generar la taula. Aquesta funció s’encarrega d’obtenir la informació necessària i passar-la a la funció <code>processarAcció()</code>.
</p>

<p>

</p>

<p>
Les funcions <code>accioMostrarNotificacio()</code> i <code>accioMostrarPagina()</code> s’encarreguen de modificar la vista. La primera reemplaça l’estil i contingut de la notificació activa amb la nova, de manera que serà de color verd en cas d’èxit, blau en cas de ser una notificació informativa, groc en cas d’alerta i vermell en cas d’error. La segona amaga la pàgina anterior i en mostra la nova, afegint i eliminant la classe <acronym title="Cascading Style Sheets">CSS</acronym> <code>amaga</code>, respectivament.
</p>

<p>
Les funcions <code>accioFiltrar()</code> i <code>filtrarEsdeveniments()</code> són les encarregades de filtrar els resultats. La primera comprova que només s’hagi utilitzat una paraula i discrimina entre aplicar el filtratge o eliminar el filtre (omplint la taula amb tots els esdeveniments). La segona és l’encarregada de realitzar l’acció, recorrent tots els esdeveniments i creant una llista amb els que continguin el terme a les propietats <code>nom</code>, <code>descripcio</code> o <code>organitzador</code>.
</p>

<p>
Per gestionar els formularis i recopilar-ne les dades es fan servir les funcions <code>obtenirEsdevenimentDelFormulari()</code>, <code>establirEsdevenimentActualitzar()</code> i <code>netejarFormularis()</code>. El primer es fa servir tant en actualitzar un esdeveniment com en donar-ne d’alta un de nou i serveix per obtenir un esdeveniment a partir de les dades del formulari. El segon es fa servir per establir les dades de l’esdeveniment per actualitzar al formulari d’actualització. Finalment, el tercer és una funció auxiliar utilitzada per netejar tota la informació de tots els formularis de la pàgina.
</p>

<p>
La funció <code>omplirTaulaLlistat()</code> és l’encarregada de generar la taula amb la informació resumida dels esdeveniments. El primer pas és buidar-la utilitzant el mètode <code>empty()</code> de jQuery; seguidament es recorren les dades (que corresponen a un objecte contenidor d’esdeveniments), es crea una fila amb 4 columnes i s’afegeix la informació de l’esdeveniment a les 3 primeres i els botons d’acció a l’última.
</p>

<p>
Una vegada s’ha generat la taula, s’afegeix un detector d’<em>events</em> a tots els botons de la taula per invocar el mètode <code>processarBoto()</code> en detectar-se l’<em>event</em> <code>click</code>.
</p>

<p>
Cal tenir en compte un detall important. Fixeu-vos que el llistat d’esdeveniments i les dades no és un <em>array</em>, sinó un objecte de JavaScript. Aquesta decisió s’ha pres per simplificar la gestió d’esdeveniments, perquè una vegada s’elimina un element de l’<em>array</em>, l’índex dels elements ja no es correspon amb el seu identificador (que s’ha decidit fer seqüencial, començant pel 0). D’aquesta manera, l’identificador de l’esdeveniment s’utilitza com a nom de la propietat a l’objecte i l’eliminació no l’afecta perquè es guarda sempre la referència del pròxim identificador a assignat (gestionat pel servidor).
</p>

<p>
És a dir, l’estructura de dades que es guarda al servidor és similar a la següent (en format JSON):
</p>

<p>

</p>
<pre class="code java"><ol><li class="li1"><div class="de1">{</div></li><li class="li1"><div class="de1">  &quot;proximIdentificador&quot;:9,</div></li><li class="li1"><div class="de1">  &quot;llistatEsdeveniments&quot;:{</div></li><li class="li1"><div class="de1">    &quot;5&quot;:{</div></li><li class="li1"><div class="de1">      &quot;nom&quot;:&quot;Primer esdeveniment&quot;,</div></li><li class="li1"><div class="de1">      &quot;descripcio&quot;:&quot;Aquesta es la descripció del primer esdeveniment.&quot;,</div></li><li class="li1"><div class="de1">      &quot;data&quot;:&quot;2016-12-15&quot;,</div></li><li class="li1"><div class="de1">      &quot;organitzador&quot;:&quot;Associació de Botiguers&quot;,</div></li><li class="li1"><div class="de1">      &quot;id&quot;:5</div></li><li class="li1"><div class="de1">    },</div></li><li class="li1"><div class="de1">    &quot;8&quot;:{</div></li><li class="li1"><div class="de1">      &quot;nom&quot;:&quot;Segon esdeveniment&quot;,</div></li><li class="li1"><div class="de1">      &quot;descripcio&quot;:&quot;Aquest esdeveniment es realitzarà en una data posterior al primer&quot;,</div></li><li class="li1"><div class="de1">      &quot;data&quot;:&quot;2017-12-20&quot;,</div></li><li class="li1"><div class="de1">      &quot;organitzador&quot;:&quot;Ajuntament de Barcelona&quot;,</div></li><li class="li1"><div class="de1">      &quot;id&quot;:8}</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
A continuació podeu trobar el codi del servidor, que fa servir els mòduls de Node.js <code>http</code> per crear el servidor, <code>url</code> per tractar els <acronym title="Uniform Resource Locator">URL</acronym>, <code>querystring</code> per gestionar els paràmetres i <code>fs</code> per treballar amb el sistema de fitxers.
</p>

<p>

</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let http = require('http');</div></li><li class="li1"><div class="de1">let url = require('url');</div></li><li class="li1"><div class="de1">let queryString = require('querystring');</div></li><li class="li1"><div class="de1">let fs = require('fs');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">const NOM_FITXER = 'esdeveniments.json';</div></li><li class="li1"><div class="de1">const INDEX_RECURS = 0;</div></li><li class="li1"><div class="de1">const INDEX_IDENTIFICADOR = 1;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let server = http.createServer();</div></li><li class="li1"><div class="de1">let dadesAplicacio;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">inicialitzar();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function inicialitzar() {</div></li><li class="li1"><div class="de1">    carregarDadesJSON(NOM_FITXER);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    server.on('request', function (peticio, resposta) {</div></li><li class="li1"><div class="de1">        resposta.setHeader('Access-Control-Allow-Origin', '*');</div></li><li class="li1"><div class="de1">        resposta.setHeader('Access-Control-Allow-Methods', 'GET, PUT, POST, DELETE');</div></li><li class="li1"><div class="de1">        resposta.writeHead(200, {'Content-Type': 'application/json;charset=utf-8'});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        let cos = '';</div></li><li class="li1"><div class="de1">        peticio.on('data', function (dades) {</div></li><li class="li1"><div class="de1">            cos += dades;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        }).on('end', function () {</div></li><li class="li1"><div class="de1">            let params;</div></li><li class="li1"><div class="de1">            let dades;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            if (peticio.method === 'GET') {</div></li><li class="li1"><div class="de1">                dades = url.parse(peticio.url).query;</div></li><li class="li1"><div class="de1">            } else {</div></li><li class="li1"><div class="de1">                dades = cos;</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">            params = queryString.parse(dades);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            let urlEncaminament = (url.parse(peticio.url).path).substr(1);</div></li><li class="li1"><div class="de1">            encaminar(urlEncaminament, peticio.method, resposta, params);</div></li><li class="li1"><div class="de1">            resposta.end();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        });</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    server.listen(8080, &quot;127.0.0.1&quot;);</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function encaminar(url, metode, resposta, params) {</div></li><li class="li1"><div class="de1">    let contingutResposta = {};</div></li><li class="li1"><div class="de1">    let fragmentsUrl = url.split('/');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    switch (fragmentsUrl[INDEX_RECURS]) {</div></li><li class="li1"><div class="de1">        case 'esdeveniments':</div></li><li class="li1"><div class="de1">            contingutResposta.accions = controladorEsdeveniments(metode, fragmentsUrl[INDEX_IDENTIFICADOR], params);</div></li><li class="li1"><div class="de1">            break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        default:</div></li><li class="li1"><div class="de1">            contingutResposta.accions = [];</div></li><li class="li1"><div class="de1">            afegirNotificacio(contingutResposta.accions, 'error', 'No es reconeix el recurs ' + fragmentsUrl[INDEX_RECURS]);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    resposta.write(JSON.stringify(contingutResposta));</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function controladorEsdeveniments(metode, id, params) {</div></li><li class="li1"><div class="de1">    let accions = [];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    switch (metode) {</div></li><li class="li1"><div class="de1">        case 'GET':</div></li><li class="li1"><div class="de1">            afegirNotificacio(accions, 'info', 'Carregat llistat d\'esdeveniments.');f</div></li><li class="li1"><div class="de1">            afegirLlistat(accions);</div></li><li class="li1"><div class="de1">            break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        case 'POST':</div></li><li class="li1"><div class="de1">            params.id = dadesAplicacio.proximIdentificador;</div></li><li class="li1"><div class="de1">            dadesAplicacio.llistatEsdeveniments[dadesAplicacio.proximIdentificador++] = params;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            desarDadesJSON('esdeveniments.json', dadesAplicacio);</div></li><li class="li1"><div class="de1">            afegirNotificacio(accions, 'exit', 'Nou esdeveniment afegit.');</div></li><li class="li1"><div class="de1">            afegirLlistat(accions);</div></li><li class="li1"><div class="de1">            break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        case 'DELETE':</div></li><li class="li1"><div class="de1">            delete(dadesAplicacio.llistatEsdeveniments[id]);</div></li><li class="li1"><div class="de1">            desarDadesJSON('esdeveniments.json', dadesAplicacio);</div></li><li class="li1"><div class="de1">            afegirNotificacio(accions, 'info', 'Esdeveniment eliminat.');</div></li><li class="li1"><div class="de1">            afegirLlistat(accions);</div></li><li class="li1"><div class="de1">            break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        case 'PUT':</div></li><li class="li1"><div class="de1">            dadesAplicacio.llistatEsdeveniments[id] = params;</div></li><li class="li1"><div class="de1">            desarDadesJSON('esdeveniments.json', dadesAplicacio);</div></li><li class="li1"><div class="de1">            afegirNotificacio(accions, 'exit', 'Esdeveniment actualitzat.');</div></li><li class="li1"><div class="de1">            afegirLlistat(accions);</div></li><li class="li1"><div class="de1">            break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        default:</div></li><li class="li1"><div class="de1">            afegirNotificacio(accions, 'error', 'No es reconeix el mètode ' + metode);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    return accions;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function afegirNotificacio(contingutResposta, tipus, missatge) {</div></li><li class="li1"><div class="de1">    contingutResposta.push({</div></li><li class="li1"><div class="de1">        accio: 'mostrar-notificacio',</div></li><li class="li1"><div class="de1">        notificacio: {</div></li><li class="li1"><div class="de1">            tipus: tipus,</div></li><li class="li1"><div class="de1">            missatge: missatge</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    })</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function afegirLlistat(contingutResposta) {</div></li><li class="li1"><div class="de1">    contingutResposta.push({</div></li><li class="li1"><div class="de1">        accio: 'establir-llistat',</div></li><li class="li1"><div class="de1">        esdeveniments: dadesAplicacio.llistatEsdeveniments</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function desarDadesJSON(fitxer, dades) {</div></li><li class="li1"><div class="de1">    fs.writeFile(fitxer, JSON.stringify(dades), function (error) {</div></li><li class="li1"><div class="de1">        if (error) {</div></li><li class="li1"><div class="de1">            console.error('Error en desar el fitxer');</div></li><li class="li1"><div class="de1">            throw err;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function carregarDadesJSON(fitxer) {</div></li><li class="li1"><div class="de1">    fs.readFile(fitxer, 'utf8', function (err, dades) {</div></li><li class="li1"><div class="de1">        if (err) {</div></li><li class="li1"><div class="de1">            console.log('No existeix el fitxer de dades, creant nou conjunt de dades...');</div></li><li class="li1"><div class="de1">            dadesAplicacio = {</div></li><li class="li1"><div class="de1">                proximIdentificador: 0,</div></li><li class="li1"><div class="de1">                llistatEsdeveniments: {}</div></li><li class="li1"><div class="de1">            };</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">            dadesAplicacio = JSON.parse(dades);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Cal recordar que a Node.js, al contrari que a JavaScript, el concepte de constant sí que existeix i, per consegüent, s’ha utilitzat per definir el nom del fitxer de dades i la correspondència dels índexs en dividir l’<acronym title="Uniform Resource Locator">URL</acronym> (el primer correspondrà al tipus de recurs i el segon, si n’hi ha, a l’identificador).
</p>

<p>
Una vegada s’han importat els mòduls necessaris i s’han definit les constants i variables globals del mòdul, s’invoca la funció <code>inicialitzar()</code>. Aquesta funció és l’encarregada de carregar les dades i afegir el detector d’<em>events</em>, que es dispararà quan el servidor rebi una petició (<em>event</em> <code>request</code>).
</p>

<p>
Quan es detecta la petició, la funció executada és l’encarregada d’analitzar l’<acronym title="Uniform Resource Locator">URL</acronym> i els paràmetres, i de passar-los a l’encaminador, definit com la funció <code>encaminar()</code>, que escriurà una resposta o una altra segons les dades de la petició.
</p>

<p>
Dintre d’aquesta funció, l’<acronym title="Uniform Resource Locator">URL</acronym> es divideix en fragments. El primer fragment (amb índex 0) correspon al nom del recurs i el segon fragment (si n’hi ha) correspon a l’identificador. En aquest exemple només es treballa amb un tipus de recurs i, per tant, només hi ha un cas vàlid.
</p>

<p>
Per generar la resposta, s’ha decidit utilitzar un objecte amb una propietat anomenada <code>accions</code>, que contindrà un <em>array</em> d’accions per realitzar en el client. Aquestes accions són generades i retornades pel controlador, anomenat <code>controladorEsdeveniments()</code>, i seran determinades a partir dels paràmetres passats (mètode, identificador i paràmetres).
</p>

<p>

</p>

<p>
La funció <code>controladorEsdeveniments()</code> sempre retornarà un <em>array</em> d’accions que, com a mínim, contindrà una notificació d’error. A banda de la resposta, segons el mètode emprat es realitzaran diferents accions sobre les dades:
</p>
<ul>
<li class="level1"><div class="li"> <strong>GET</strong>: cap acció al servidor, es retorna el llistat complet i una notificació.</div>
</li>
<li class="level1"><div class="li"> <strong>POST</strong>: s’afegeix l’identificador a les dades rebudes com a paràmetre i s’afegeix una nova notificació (incrementant posteriorment el valor de <code>proximIdentificador</code>). Seguidament es desen les dades en format JSON, s’afegeix una notificació d’èxit i es retorna el llistat.</div>
</li>
<li class="level1"><div class="li"> <strong>DELETE</strong>: s’elimina l’esdeveniment del conjunt de dades amb l’identificador passat com a paràmetre, a continuació es desen les dades, s’afegeix una notificació informativa i es retorna el nou llistat (que no inclou l’element eliminat).</div>
</li>
<li class="level1"><div class="li"> <strong>PUT</strong>: actualitza el conjunt de dades amb la informació de l’esdeveniment, desa les dades i finalment afegeix una notificació.</div>
</li>
</ul>

<p>
Fixeu-vos que s’ha fet servir <code>PUT</code> per a l’actualització, ja que les dades són completament reemplaçades. En canvi, si l’actualització fos només de determinats valors, llavors seria més apropiat utilitzar el mètode <code>PATCH</code>.
</p>

<p>
Cal destacar que els mètodes <code>afegirNotificacio()</code> i <code>afegirLlistat()</code> no retornen res, manipulen directament l’<em>array</em> passat com a argument: com que es tracta d’un <em>array</em>, es passa per referència i no pas per valor. És a dir, qualsevol canvi realitzat a l’<em>array</em> dintre de les funcions <code>afegirNotificacio()</code> i <code>afegirLlistat()</code> afecta l’<em>array</em> original.
</p>

<p>
Les funcions <code>afegirNotificacio()</code> i <code>afegirLlistat()</code> s’encarreguen de generar correctament l’acció pertinent i d’afegir-la al contingut de la resposta. La primera funció afegeix el tipus de missatge (que afectarà l’estil <acronym title="Cascading Style Sheets">CSS</acronym> a aplicar) i el missatge a mostrar, mentre que la segona afegeix el llistat complet d’esdeveniments.
</p>

<p>
Per acabar, hi ha les funcions <code>desarDadesJSON()</code> i <code>carregarDadesJSON()</code>, que són les responsables de carregar el fitxer de dades i desar-lo. En cas de detectar un error en carregar les dades, es genera una nova estructura de dades que serà desada quan es rebi una nova alta d’esdeveniments. Per exemple, en cas de produir-se un error la primera vegada que s’inicia el servidor, es retornarà una estructura de dades buida, que serà desada quan es rebi una petició <code>POST</code>; en cas contrari, retornarà l’estructura de dades carregada.
</p>

<p>
Recordeu que les invocacions a <code>fs.writeFile()</code> i <code>fse.readFile()</code> són asíncrones i, per tant, no es bloqueja l’execució mentre es carreguen o es desen les dades (tot i que si és necessari, hi ha una versió síncrona de totes dues).
</p>

</div>

<h3><a id="cas_practiccreacio_d_una_aplicacio_de_xat_amb_socols" >Cas pràctic: creació d&#039;una aplicació de xat amb sòcols</a></h3>
<div class="level3">

<p>
Aquest exemple mostra com es pot crear una aplicació de xat utilitzant els <em>frameworks</em> Express i Socket.io de Node.js (està basat en un dels exemples de la documentació oficial de Socket.io). Podeu trobar el codi complet a l’enllaç següent: <a href="https://goo.gl/jWh4Sb" class="urlextern" title="https://goo.gl/jWh4Sb"  rel="nofollow">goo.gl/jWh4Sb</a>.
</p>

<p>
El <em>framework</em> Express és utilitzat per simplificar les operacions habituals d’un servidor web, com és l’encaminament i l’enviament de fitxers; mentre que Socket.io s’encarrega de la gestió dels sòcols de connexió tant al servidor com al client.
</p>

<p>

</p>

<p>
La biblioteca Socket.io utilitza internament l’<acronym title="Application Programming Interface">API</acronym> WebSockets a la banda del client per realitzar aquestes connexions, facilitant la utilització d’un sistema d’<em>events</em> propis que són enviats i gestionats pels sòcols.
</p>

<p>
En aquest exemple es tractaran els punts següents:
</p>
<ul>
<li class="level1"><div class="li"> Instal·lació de <em>frameworks</em> de tercers amb Node.js (Express i Socket.io).</div>
</li>
<li class="level1"><div class="li"> Utilització de <em>frameworks</em> per simplificar l’encaminament (Express).</div>
</li>
<li class="level1"><div class="li"> Encaminament de la petició de fitxers (Express).</div>
</li>
<li class="level1"><div class="li"> Creació d’un servidor de connexions de sòcols (Socket.io).</div>
</li>
<li class="level1"><div class="li"> Enviament i detecció d’<em>events</em> mitjançant sòcols (Socket.io).</div>
</li>
</ul>

<p>
Per reproduir aquest exemple en el vostre entorn, cal crear l’estructura de directoris que es pot veure a la <span class="figref"><a href="#figura u7a1-09"><span>figura</span></a></span>, ja que s’utilitzarà Express per servir els fitxers.
</p>
<div class="iocfigure"><a name="figura u7a1-09"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Estructura de fitxers del xat amb Socket.io

</figcaption><img src="../media/daw_m06_u7_01_grafisme.png" alt="" /></figure>
</div>
<p>
El directori <code>node_modules</code> es crearà automàticament en instal·lar els mòduls necessaris utilitzant el gestor de paquets npm.
</p>

<p>
El primer pas és crear un fitxer anomenat <code>package.json</code> amb el següent contingut dintre del directori <code>Servidor</code>, que contindrà el servidor de xat:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">{</div></li><li class="li1"><div class="de1">  &quot;name&quot;: &quot;exemple-web-sockets&quot;,</div></li><li class="li1"><div class="de1">  &quot;version&quot;: &quot;0.0.1&quot;,</div></li><li class="li1"><div class="de1">  &quot;description&quot;: &quot;Exemple de Xat amb Express i Socket.io&quot;,</div></li><li class="li1"><div class="de1">  &quot;dependencies&quot;: {}</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Seguidament, per instal·lar el <em>framework</em> Express utilitzant el gestor de paquets npm executeu la següent instrucció:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">npm install --save express</div></li></ol></pre>

<p>
L’opció <code>–save</code> fa que la dependència s’afegeixi automàticament al fitxer <code>package.json</code> de l’aplicació.
</p>

<p>
La integració amb el <em>framework</em> <code>Socket.IO</code> s’ha de fer tant en el client (afegint la biblioteca <code>socket.io-client</code>) com en el servidor (carregant el mòdul <code>socket.io</code>).
</p>

<p>
Per afegir el mòdul al servidor s’ha d’executar la comanda següent a la terminal:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">npm install --save socket.io</div></li></ol></pre>

<p>
Una vegada instal·lats els <em>frameworks</em> Express i Socket.io, es pot crear dintre de la mateixa carpeta <code>Servidor</code> el fitxer <code>servidor-xat.js</code>, que contindrà la implementació del servidor de xat.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let app = require('express')();</div></li><li class="li1"><div class="de1">let http = require('http').Server(app);</div></li><li class="li1"><div class="de1">let io = require('socket.io')(http);</div></li><li class="li1"><div class="de1">let path = require('path');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">// Encaminament</div></li><li class="li1"><div class="de1">app.get('/', function(peticio, resposta){</div></li><li class="li1"><div class="de1">    resposta.sendFile(path.resolve(__dirname + '/../Client/index.html'));</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">app.get('/css/:fitxer', function(peticio, resposta){</div></li><li class="li1"><div class="de1">    resposta.sendFile(path.resolve(__dirname + '/../Client/css/'+ peticio.params.fitxer));</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">app.get('/js/:fitxer', function(peticio, resposta){</div></li><li class="li1"><div class="de1">    resposta.sendFile(path.resolve(__dirname + '/../Client/js/' + peticio.params.fitxer));</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">// Gestió de les connexions</div></li><li class="li1"><div class="de1">io.on('connection', function(socol){</div></li><li class="li1"><div class="de1">    socol.broadcast.emit('missatge xat', 'Un nou usuari s\'ha connectat');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    console.log('Un usuari connectat');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    socol.on('disconnect', function(){</div></li><li class="li1"><div class="de1">        socol.broadcast.emit('missatge xat', 'Un usuari s\'ha desconnectat');</div></li><li class="li1"><div class="de1">        console.log('usuari desconnectat');</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    socol.on('missatge xat', function(msg){</div></li><li class="li1"><div class="de1">        console.log('missatge: ' + msg);</div></li><li class="li1"><div class="de1">        io.emit('missatge xat', msg);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">// S'inicia l'escolta del servidor pel port 3000</div></li><li class="li1"><div class="de1">http.listen(3000, function(){</div></li><li class="li1"><div class="de1">    console.log('Escoltant a *:3000');</div></li><li class="li1"><div class="de1">});</div></li></ol></pre>

<p>
Primerament, cal importar els mòduls necessaris per a l’aplicació: <code>express</code>, <code>http</code>, <code>socket.io</code> i <code>path</code>. Fixeu-vos que en el cas d<code>‘express</code> i <code>io</code> no es carrega el mòdul, sinó que s’invoca com una funció, sense passar cap paràmetre en el cas d<code>‘express</code> i passant el servidor <code>http</code> en el cas de <code>socket.io</code>.
</p>

<p>
Com que <code>express</code> no permet utilitzar directament els dos punts per accedir a un directori anterior perquè el considera codi maliciós, per construir la ruta s’ha d’utilitzar el mòdul <code>path</code>.
</p>

<p>
A continuació es pot veure com funciona l’encaminament d<code>‘Express</code>, molt més simple que les implementacions manuals. A partir del mètode <code>get()</code> es passen com a arguments una ruta i la funció que serà cridada en detectar-la.
</p>
<div class="iocnote"><div class="ioccontent">
<p>
El mòdul <code>Routing</code> conté la implementació de l’encaminament d’Express adaptada per funcionar amb el mòdul <code>Http</code>.
</p>
</div></div>
<p>
Aquests encaminaments també faciliten treballar amb paràmetres de ruta, prefixats amb el símbol dels dos punts (<code>:</code>), als quals es pot accedir com a propietats a partir de l’objecte <code>peticio.params</code>. És a dir, quan es demana el fitxer corresponent a la ruta <code>/js/client-xat.js</code> el valor de <code>peticio.params.fitxer</code> és <code>client-xat.js</code>.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Es pot trobar més informació sobre els encaminaments d’Express a l’enllaç següent: <a href="https://goo.gl/pgXQuq" class="urlextern" title="https://goo.gl/pgXQuq"  rel="nofollow">goo.gl/pgXQuq</a>.
</p>
</div></div>
<p>
Les respostes d’Express ofereixen la possibilitat d’enviar un fitxer directament com a resposta utilitzant el mètode <code>sendFile()</code>, d’aquesta manera se serveix el fitxer <acronym title="HyperText Markup Language">HTML</acronym>, el fitxer JavaScript i el fitxer <acronym title="Cascading Style Sheets">CSS</acronym> corresponent.
</p>

<p>
Com es pot apreciar, Express reemplaça completament la funcionalitat del mòdul <code>http</code>, i fa que la implementació sigui molt més simple i entenedora.
</p>

<p>
Seguidament es pot veure la implementació de la gestió de connexions. Primerament s’afegeix un detector per a l’<em>event</em> <code>connection</code> per detectar quan s’ha establert una nova connexió mitjançant l’<em>event</em> <code>connection</code> del <em>framework</em> Socket.io.
</p>

<p>
Una vegada s’ha rebut una connexió es crida una funció (que rep com a paràmetre el sòcol) perquè realitzi les acions següents:
</p>
<ul>
<li class="level1"><div class="li"> S’envia el missatge <em>Un nou usuari s’ha connectat</em> a tots els usuaris, excepte al que ha connectat, mitjançant el mètode <code>socol.broadcast.emit()</code>.</div>
</li>
<li class="level1"><div class="li"> S’afegeix al sòcol un detector per a l’event <code>disconnect</code>, que avisarà els altres usuaris quan un usuari s’hagi desconnectat.</div>
</li>
<li class="level1"><div class="li"> S’afegeix un detector per a l’<em>event</em> <code>missatge xat</code> (un <em>event</em> propi) que envia a tots els usuaris connectats al servidor (emissor inclòs) el missatge rebut.</div>
</li>
<li class="level1"><div class="li"> Per facilitar la depuració s’ha afegit un missatge a la consola que permet determinar el moment en què un usuari s’uneix o abandona la sala de xat.</div>
</li>
</ul>

<p>
Cal destacar que l’enviament de missatges es tracta, en realitat, d’una emissió d’<em>events</em> que farà que l’<em>event</em> <code>missatge xat</code> es dispari al client amb el missatge enviat com a dades.
</p>

<p>
Fixeu-vos en les diferències dels dos tipus d’enviament mostrat. Per una banda, hi ha missatges globals que són rebuts per tots els usuaris, i emesos pel servidor (<code>io.emit</code>) i, per altra, hi ha els <em>events</em> que no ha de rebre l’emissor (com la connexió i la desconnexió) i que són emesos a partir del sòcol (socol.broadcast.emit).
</p>
<div class="ioctextl"><div class="ioccontent"><p class="ioctitle">Port de connexió dels sòcols</p>
<p>
El port que s’utilitza per connectar amb l’aplicació mitjançant sòcols és el mateix port pel qual s’escolten les peticions HTTP. Així doncs, si es vol canviar aquest port, s’haurà de canviar al servidor modificant la invocació al mètode <code>http.listen()</code>.
</p>

<p>
Cal tenir en compte que, per defecte, el client de Socket.io farà servir el mateix port utilitzat per obrir la pàgina, de manera que si la pàgina s’ha obert al port 3000, la connexió dels sòcols es realitzarà a través d’aquest port.
</p>
</div></div>
<p>
El codi <acronym title="HyperText Markup Language">HTML</acronym> del client ha d’anar en un fitxer anomenat <code>index.html</code> dins del directori <code>Client</code> amb el contingut següent:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;!doctype html&gt;</div></li><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">&lt;head&gt;</div></li><li class="li1"><div class="de1">    &lt;meta charset=&quot;UTF-8&quot;&gt;</div></li><li class="li1"><div class="de1">    &lt;title&gt;Client Xat amb Socket.io&lt;/title&gt;</div></li><li class="li1"><div class="de1">    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/principal.css&quot;&gt;</div></li><li class="li1"><div class="de1">&lt;/head&gt;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">&lt;h1&gt;Client Xat&lt;/h1&gt;</div></li><li class="li1"><div class="de1">&lt;ul id=&quot;missatges&quot;&gt;&lt;/ul&gt;</div></li><li class="li1"><div class="de1">&lt;form action=&quot;&quot;&gt;</div></li><li class="li1"><div class="de1">    &lt;input id=&quot;missatge&quot; autocomplete=&quot;off&quot; /&gt;&lt;button&gt;Enviar&lt;/button&gt;</div></li><li class="li1"><div class="de1">&lt;/form&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;script src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;script src=&quot;https://code.jquery.com/jquery-3.1.1.min.js&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;script src=&quot;/js/client-xat.js&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
Com es pot apreciar, només es tracta d’una llista en què es mostraran els missatges, un formulari per entrar el text per enviar al servidor i la càrrega dels fitxers amb el codi JavaScript i les biblioteques necessàries.
</p>

<p>
Cal destacar que el fitxer <code>socket.io.js</code> no es troba realment al servidor, sinó que és generat pel <em>framework</em> i, per consegüent, sempre serà servit utilitzant la ruta <code>/socket.io/socket.io.js</code>.
</p>

<p>
Dintre del directori <code>css</code> heu de crear un fitxer amb el nom <code>principal.css</code> i el codi següent:
</p>
<pre class="code">* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Arial, &quot;Helvetica Neue&quot;, Helvetica, sans-serif
}

h1 {
    text-align: center;
}

form {
    padding: 3px;
    position: fixed;
    bottom: 0;
    width: 100%;
}

form, h1 {
    background: #ccc;
}

form, ul {
    border-top: 1px solid black;
}

form input {
    border: 1px solid black;
    border-radius: 5px;
    padding: 10px;
    width: 90%;
    margin-right: .5%;
}

form button {
    width: 9%;
    font-weight: bold;
    background: #1b95e0;
    border-radius: 5px;
    border: 1px solid black;
    padding: 10px;
}

#missatges {
    font-family: &quot;Courier New&quot;, Courier, &quot;Lucida Sans Typewriter&quot;, &quot;Lucida Typewriter&quot;, monospace    list-style-type: none;
    margin: 0;
    padding: 0;

}

#missatges li {
    padding: 5px;
}

#missatges li:nth-child(odd) {
    background: #eee;
}

.estat {
    color:blue;
}</pre>

<p>
En aquest cas, el codi <acronym title="Cascading Style Sheets">CSS</acronym> compleix una funció estrictament decorativa, ja que la funcionalitat de l’aplicació seria la mateixa si no s’hi apliqués cap estil.
</p>

<p>
Finalment, creeu un fitxer anomenat <code>client-xat.js</code> dintre del directori <code>js</code> amb el contingut següent per habilitar la connexió del client al servidor:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let socol = io();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">$('form').submit(function(){</div></li><li class="li1"><div class="de1">    socol.emit('missatge xat', $('#missatge').val());</div></li><li class="li1"><div class="de1">    $('#missatge').val('');</div></li><li class="li1"><div class="de1">    return false;</div></li><li class="li1"><div class="de1">});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">socol.on('missatge xat', function(msg){</div></li><li class="li1"><div class="de1">    $('#missatges').append($('&lt;li&gt;').text(msg));</div></li><li class="li1"><div class="de1">});</div></li></ol></pre>

<p>
Per iniciar la connexió amb el servidor a través d’un sòcol només cal invocar la funció <code>io()</code> (o <code>io.connect</code>), que pertany a la biblioteca <code>socket.io.js</code>. En cas que el client i el servidor es trobessin en diferents dominis o ports caldria especificar l’<acronym title="Uniform Resource Locator">URL</acronym> i el port com a paràmetres, però en aquest cas no és necessari.
</p>

<p>
Una vegada creat el sòcol s’afegeix un detector per a l’<em>event</em> <code>submit</code> del formulari que detectarà quan s’ha premut el botó d’enviament i, en lloc d’enviar el formulari, emetrà un <em>event</em> de tipus <code>missatge xat</code> amb el contingut del quadre de text amb l’identificador <code>missatge</code> mitjançant el sòcol (que serà rebut pel servidor). Seguidament s’establirà el contingut d’aquest quadre com a buit, a l’espera que s’introdueixi un text nou.
</p>

<p>
Per altra banda, s’afegeix un detector per a l’<em>event</em> <code>missatge xat</code> al sòcol, de manera que quan es rep un <em>event</em> d’aquest tipus s’executa la funció que s’ha passat com a paràmetre, afegint un nou element de tipus <code>li</code> al llistat <code>missatges</code> amb el contingut de l’<em>event</em>.
</p>

<p>
A la <span class="figref"><a href="#figura u7-10"><span>figura</span></a></span> es mostra l’aspecte del client funcionant en dues pestanyes diferents.
</p>
<div class="iocfigure"><a name="figura u7-10"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Client xat amb dues pestanyes

</figcaption><img src="../media/10-client-xat-v1.png" alt="" /></figure>
</div>
<p>
Fixeu-vos que és molt fàcil crear un protocol propi de comunicació per utilitzar en aplicacions més complexes. Per exemple, es podria discriminar entre els missatges d’estat del sistema i els missatges dels usuaris fent que l’<em>event</em> enviat fos diferent, i utilitzar un altre detector per gestionar-los.
</p>

<p>
Per comprovar-ho substituïu el contingut de la gestió de connexions del fitxer <code>servidor-xat.js</code> pel següent:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">// Gestió de les connexions</div></li><li class="li1"><div class="de1">io.on('connection', function(socol){</div></li><li class="li1"><div class="de1">    socol.broadcast.emit('missatge estat', 'Un nou usuari s\'ha connectat');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    console.log('Un usuari connectat');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    socol.on('disconnect', function(){</div></li><li class="li1"><div class="de1">        socol.broadcast.emit('missatge estat', 'Un usuari s\'ha desconnectat');</div></li><li class="li1"><div class="de1">        console.log('usuari desconnectat');</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    socol.on('missatge xat', function(msg){</div></li><li class="li1"><div class="de1">        console.log('missatge: ' + msg);</div></li><li class="li1"><div class="de1">        io.emit('missatge xat', msg);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">});</div></li></ol></pre>

<p>
I afegiu el següent detector el contingut del fitxer <code>client-xat.js</code>:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">socol.on('missatge estat', function(msg){</div></li><li class="li1"><div class="de1">    $('#missatges').append($('&lt;li class=&quot;estat&quot;&gt;').text(msg));</div></li><li class="li1"><div class="de1">});</div></li></ol></pre>

<p>
Amb aquest canvi, quan es rep un <em>event</em> de tipus <code>missatge estat</code> s’afegeix un element de tipus <code>li</code> amb la classe <code>estat</code>, que fa que el missatge es mostri de color blau, tal com podeu veure a la <span class="figref"><a href="#figura u7-11"><span>figura</span></a></span>.
</p>
<div class="iocfigure"><a name="figura u7-11"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Client xat ampliat amb missatges d’estat

</figcaption><img src="../media/10-client-xat-v2.png" alt="" /></figure>
</div>
<p>
Utilitzant aquest sistema, es podria ampliar l’aplicació per gestionar un llistat d’usuaris o distingir entre missatges globals i missatges privats entre usuaris, per exemple.
</p>

<p>
Com s’ha pogut comprovar, utilitzant els <em>frameworks</em> Express i Socket.io és molt senzill implementar aplicacions, tant a la banda del client com del servidor, que utilitzin sòcols per mantenir una connexió oberta.
</p>

<p>

<h2><a id="aplicacions_amb_la_biblioteca_leaflet" >Aplicacions amb la biblioteca Leaflet</a></h2>
<div class="level2">

<p>
Leaflet és una biblioteca de codi obert de JavaScript amb la qual podem afegir a la nostra pàgina web mapes interactius.
Leaflet permet mostrar en forma de mapa la informació proporcionada per diferents proveïdors de dades geogràfiques. En aquest material s’utilitza el proveïdor OpenStreetMap. És un proveïdor que ofereix dades obertes i gratuïtes. Només requereix atribució per a poder-les utilitzar.
</p>
<div class="ioctextl"><div class="ioccontent"><p class="ioctitle"> API de Google Maps</p>
<p>
Tot i que l’<acronym title="Application Programming Interface">API</acronym> de Google Maps és molt utilitzada, treballarem amb Leaflet i OpenMaps perquè són eines obertes i no requereixen la introducció de cap targeta de crèdit (a diferència de l’<acronym title="Application Programming Interface">API</acronym> de Google Maps).
</p>
</div></div><div class="iocreference"><div class="ioccontent">
<p>
A l’annex podeu trobar una rèplica d’aquest apartat, però realitzada amb Google Maps. 
</p>
</div></div>
</div>

<h3><a id="creacio_d_un_mapa_simple" >Creació d&#039;un mapa simple</a></h3>
<div class="level3">

<p>
Per començar a desenvolupar una aplicació amb Leaflet, primerament haureu d’afegir els CDN dels fitxers <acronym title="Cascading Style Sheets">CSS</acronym> i JavaScript de Leaflet a la capçalera del fitxer <acronym title="HyperText Markup Language">HTML</acronym>:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.css&quot;</div></li><li class="li1"><div class="de1">   integrity=&quot;sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==&quot;</div></li><li class="li1"><div class="de1">   crossorigin=&quot;&quot;/&gt;</div></li><li class="li1"><div class="de1">  &lt;!-- Assegureu-vos de posar aquest script desrprés del CSS de Leaflet --&gt;</div></li><li class="li1"><div class="de1"> &lt;script src=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.js&quot;</div></li><li class="li1"><div class="de1">   integrity=&quot;sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==&quot;</div></li><li class="li1"><div class="de1">   crossorigin=&quot;&quot;&gt;&lt;/script&gt;</div></li></ol></pre>
<div class="iocimportant"><div class="ioccontent">
<p>
El CDN de <code>leaflet.js</code> s’ha de carregar després del de <code>leaflet.css</code>.
</p>
</div></div>
<p>
Després afegirem al codi JavaScript la funció que serà l’encarregada de generar el mapa. Aquesta funció serà cridada automàticament en carregar-se la biblioteca de Leaflet.
</p>

<p>
Perquè aquesta funció s’executi correctament, haurem de crear un element <acronym title="HyperText Markup Language">HTML</acronym> on afegir el mapa (per exemple:<code>&lt;div id=“mapaid”&gt;&lt;/div&gt;</code>). És important que li donem unes dimensions determinades mitjançant <acronym title="Cascading Style Sheets">CSS</acronym> (per exemple: <code>#mapaid{height: 500px;}</code>).
</p>

<p>
A continuació es pot trobar un exemple de funció d’inicialització que generaria un nou mapa dins de l’element anterior. El mapa estarà centrat a la ciutat de Barcelona (que correspon a les coordenades especificades en el codi) i tindrà un <em>zoom</em> mitjà. Cal tenir present que el valor màxim per a la propietat <code>zoom</code> varia segons el tipus de la tessel·la -<em>tile</em> en anglès- que s’utilitzi, però el seu valor màxim sol ser de 19.
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">  let elMeuMapa = L.map('mapaid').setView([41.390205, 2.154007], 11);</div></li></ol></pre>

<p>
Com es pot apreciar, el constructor rep com a argument l’identificador de l’element on es vol dibuixar el mapa i a aquest se li aplica el mètode <code>setView()</code> amb l’<em>array</em> de coordenades i el <em>zoom</em> desitjat. De tota manera, si ho visualitzem a un navegador, veurem que, de moment, solament es mostra una finestra amb fons gris, ja que ens falta carregar el tipus de tessel·les que desitgem.
</p>

<p>
Hi ha diferents proveïdors de tessel·les i, per a poder-les usar, alguns d’ells requereixen un token d’accés que s’aconsegueix després d’un registre previ a la pàgina corresponent (com és el cas de Mapbox: <a href="https://www.mapbox.com/" class="urlextern" title="https://www.mapbox.com/"  rel="nofollow">mapbox.com</a>). També hi ha altres proveïdors que no requereixen aquest token d’accés, però en aquest cas ens haurem de descarregar un fitxer JavaScript (<code>leaflet-provider.js</code>, que podeu trobar aquí: <a href="http://ow.ly/svSa30rrXl9" class="urlextern" title="http://ow.ly/svSa30rrXl9"  rel="nofollow">ow.ly/svSa30rrXl9</a>) per a poder usar-los i carregar-lo a la nostra pàgina (podem veure exemples d’aquests proveïdors a <a href="http://ow.ly/8DTe30rrXeJ" class="urlextern" title="http://ow.ly/8DTe30rrXeJ"  rel="nofollow">ow.ly/8DTe30rrXeJ</a>), o directament usar el següent CDN:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.11.0/leaflet-providers.min.js&quot; integrity=&quot;sha512-TO+Wd5hbpDsACTmvzSqAZL83jMQCXGRFNoS4WZxcxrlJBTdgMYaT7g5uX49C5+Kbuxzlg2A+TFJ6UqdsXuOKLw==&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</div></li></ol></pre>

<p>
Una vegada triat el proveïdor desitjat, copiarem el codi corresponent al nostre fitxer JavaScript per aplicar la tessel·la corresponent al nostre mapa. Veiem el codi d’una d’elles al següent exemple:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">  let OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {</div></li><li class="li1"><div class="de1">		maxZoom: 19,</div></li><li class="li1"><div class="de1">		attribution: '&amp;copy; &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors'</div></li><li class="li1"><div class="de1">	});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	OpenStreetMap_Mapnik.addTo(elMeuMapa);</div></li></ol></pre>

<p>
Fixeu-vos que una vegada carregades les tessel·les a la variable corresponent, hem d’afegir-les al nostre mapa amb el mètode <code>addTo()</code>.
</p>

<p>
En l’exemple següent es mostra un mapa centrat a la ciutat de Barcelona:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;!doctype html&gt;</div></li><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;head&gt;</div></li><li class="li1"><div class="de1">  &lt;meta charset=&quot;UTF-8&quot;&gt;</div></li><li class="li1"><div class="de1">  &lt;title&gt;Aplicació amb Leaflet&lt;/title&gt;</div></li><li class="li1"><div class="de1">  &lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.css&quot;</div></li><li class="li1"><div class="de1">   integrity=&quot;sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==&quot;</div></li><li class="li1"><div class="de1">   crossorigin=&quot;&quot;/&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1"> &lt;script src=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.js&quot;</div></li><li class="li1"><div class="de1">   integrity=&quot;sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==&quot;</div></li><li class="li1"><div class="de1">   crossorigin=&quot;&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.11.0/leaflet-providers.min.js&quot; integrity=&quot;sha512-TO+Wd5hbpDsACTmvzSqAZL83jMQCXGRFNoS4WZxcxrlJBTdgMYaT7g5uX49C5+Kbuxzlg2A+TFJ6UqdsXuOKLw==&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;style&gt;</div></li><li class="li1"><div class="de1">    #mapaid {</div></li><li class="li1"><div class="de1">      height: 500px;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  &lt;/style&gt;</div></li><li class="li1"><div class="de1">&lt;/head&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;div id=&quot;mapaid&quot;&gt;&lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;script&gt;</div></li><li class="li1"><div class="de1">    let elMeuMapa = L.map('mapaid').setView([41.390205, 2.154007], 11);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	  let OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {</div></li><li class="li1"><div class="de1">		  maxZoom: 19,</div></li><li class="li1"><div class="de1">		  attribution: '&amp;copy; &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors'</div></li><li class="li1"><div class="de1">	  });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	  OpenStreetMap_Mapnik.addTo(elMeuMapa);</div></li><li class="li1"><div class="de1">  &lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
Podeu veure aquest exemple en l’enllaç següent: <a href="https://codepen.io/ioc-daw-m06/pen/apQvKa" class="urlextern" title="https://codepen.io/ioc-daw-m06/pen/apQvKa"  rel="nofollow">codepen.io/ioc-daw-m06/pen/apQvKa</a>.
</p>

</div>

<h3><a id="marcadors" >Marcadors</a></h3>
<div class="level3">

<p>
Una de les accions més habituals en els mapes és afegir-hi marcadors.
</p>

<p>
A continuació podeu veure un exemple de creació d’un marcador en què s’ha especificat la posició del marcador, el títol del marcador que apareixerà quan passem el ratolí per sobre i el mapa on s’ha de visualitzar:
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Es pot trobar més informació sobre els marcadors a l’enllaç següent: <a href="https://leafletjs.com/reference-1.7.1.html#marker" class="urlextern" title="https://leafletjs.com/reference-1.7.1.html#marker"  rel="nofollow">leafletjs.com/reference-1.7.1.html#marker</a>.
</p>
</div></div><pre class="code java"><ol><li class="li1"><div class="de1">  let marcador = L.marker([41.390205, 2.154007],{title:&quot;Barcelona&quot;}).addTo(elMeuMapa);</div></li></ol></pre>

<p>
Podeu veure aquest exemple a l’enllaç següent: <a href="https://codepen.io/ioc-daw-m06/pen/bgQEoY" class="urlextern" title="https://codepen.io/ioc-daw-m06/pen/bgQEoY"  rel="nofollow">codepen.io/ioc-daw-m06/pen/bgQEoY</a>.
</p>

<p>
Una altra opció és crear primer els marcadors i assignar el mapa només en el moment en què es vulguin mostrar. Aquesta és l’opció utilitzada en el següent exemple, en el qual s’ha aplicat el disseny descendent per dividir l’aplicació en diferents funcions. Per una banda es crea el mapa i, per l’altra, un conjunt de marcadors que són emmagatzemats en un <em>array</em>. Una vegada s’acaben de generar es recorre l’<em>array</em> i s’afegeixen al mapa:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;!doctype html&gt;</div></li><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;head&gt;</div></li><li class="li1"><div class="de1">  &lt;meta charset=&quot;UTF-8&quot;&gt;</div></li><li class="li1"><div class="de1">  &lt;title&gt;Exemple Leaflet&lt;/title&gt;</div></li><li class="li1"><div class="de1">	&lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.css&quot;</div></li><li class="li1"><div class="de1">   integrity=&quot;sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==&quot;</div></li><li class="li1"><div class="de1">   crossorigin=&quot;&quot;/&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1"> &lt;script src=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.js&quot;</div></li><li class="li1"><div class="de1">   integrity=&quot;sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==&quot;</div></li><li class="li1"><div class="de1">   crossorigin=&quot;&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.11.0/leaflet-providers.min.js&quot; integrity=&quot;sha512-TO+Wd5hbpDsACTmvzSqAZL83jMQCXGRFNoS4WZxcxrlJBTdgMYaT7g5uX49C5+Kbuxzlg2A+TFJ6UqdsXuOKLw==&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;style&gt;</div></li><li class="li1"><div class="de1">    #mapaid {</div></li><li class="li1"><div class="de1">      height: 500px;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  &lt;/style&gt;</div></li><li class="li1"><div class="de1">&lt;/head&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;div id=&quot;mapaid&quot;&gt;&lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;script&gt;</div></li><li class="li1"><div class="de1">    let marcadors = [];</div></li><li class="li1"><div class="de1">    let elMeuMapa;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    window.onload = function(){</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	    elMeuMapa = L.map('mapaid').setView([41.390205, 2.154007], 8);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	    let OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {</div></li><li class="li1"><div class="de1">		    maxZoom: 19,</div></li><li class="li1"><div class="de1">		    attribution: '&amp;copy; &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors'</div></li><li class="li1"><div class="de1">	    });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	    OpenStreetMap_Mapnik.addTo(elMeuMapa);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	    crearMarcadors();</div></li><li class="li1"><div class="de1">	    afegirMarcadors();</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let crearMarcadors = function() {</div></li><li class="li1"><div class="de1">      marcadors.push(crearMarcador(&quot;IOC - Seu central&quot;, 41.375106, 2.168342));</div></li><li class="li1"><div class="de1">      marcadors.push(crearMarcador(&quot;Proves Barcelona&quot;, 41.3860669, 2.1145104));</div></li><li class="li1"><div class="de1">      marcadors.push(crearMarcador(&quot;Proves Girona&quot;, 41.961293, 2.829387));</div></li><li class="li1"><div class="de1">      marcadors.push(crearMarcador(&quot;Proves Lleida&quot;, 41.623023, 0.6236748));</div></li><li class="li1"><div class="de1">      marcadors.push(crearMarcador(&quot;Proves Tarragona&quot;, 41.120293, 1.247892));</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let crearMarcador = function(titol, latitud, longitud) {</div></li><li class="li1"><div class="de1">      let marcador = L.marker([latitud, longitud],{title:titol});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      return marcador;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let afegirMarcadors = function() {</div></li><li class="li1"><div class="de1">     for (let i = 0; i &lt; marcadors.length; i++) {</div></li><li class="li1"><div class="de1">       console.log(&quot;Afegir marcador: &quot; + i);</div></li><li class="li1"><div class="de1">       afegirMarcador(marcadors[i]);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let afegirMarcador = function(marcador) {</div></li><li class="li1"><div class="de1">      marcador.addTo(elMeuMapa);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  &lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
Podeu veure aquest exemple en l’enllaç següent: <a href="https://codepen.io/ioc-daw-m06/pen/KarMag" class="urlextern" title="https://codepen.io/ioc-daw-m06/pen/KarMag"  rel="nofollow">codepen.io/ioc-daw-m06/pen/KarMag</a>.
</p>

<p>
Com es pot apreciar, una vegada es carrega el mapa, s’invoquen les funcions <code>crearMarcadors()</code>, per generar els marcadors que s’emmagatzemmen a l’<em>array</em> <code>marcadors</code>, i, finalment, <code>afegirMarcadors</code>, que els afegeix a la pàgina.
</p>

<p>
S’ha embolcallat la creació de marcadors dins de la funció <code>crearMarcador()</code>, que espera com a paràmetres un títol, la latitud i la longitud. D’aquesta manera es pot invocar la funció passant només aquests tres arguments per generar-lo (per exemple: <code>crearMarcador(“IOC - Seu central”, 41.375106, 2.168342)</code>.
</p>

<p>
Fixeu-vos que, partint d’aquesta implementació, és força senzill modificar-la per generar els marcadors a partir d’una estructura de dades, tal com es pot apreciar en l’exemple següent, en el qual s’ha modificat la funció <code>crearMarcadors()</code> per utilitzar l’<em>array</em> <code>dades</code>, que conté la informació necessària.
</p>

<p>

</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let dades = [{</div></li><li class="li1"><div class="de1">  seu: &quot;IOC - Seu Central&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.375106,</div></li><li class="li1"><div class="de1">  lon: 2.168342</div></li><li class="li1"><div class="de1">}, {</div></li><li class="li1"><div class="de1">  seu: &quot;Proves Barcelona&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.3860669,</div></li><li class="li1"><div class="de1">  lon: 2.1145104</div></li><li class="li1"><div class="de1">}, {</div></li><li class="li1"><div class="de1">  seu: &quot;Proves Girona&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.961293,</div></li><li class="li1"><div class="de1">  lon: 2.829387</div></li><li class="li1"><div class="de1">}, {</div></li><li class="li1"><div class="de1">  seu: &quot;Proves Lleida&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.623023,</div></li><li class="li1"><div class="de1">  lon: 0.6236748</div></li><li class="li1"><div class="de1">}, {</div></li><li class="li1"><div class="de1">  seu: &quot;Proves Tarragona&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.120293,</div></li><li class="li1"><div class="de1">  lon: 1.247892</div></li><li class="li1"><div class="de1">}];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let crearMarcadors = function() {</div></li><li class="li1"><div class="de1">  for (let i = 0; i &lt; dades.length; i++) {</div></li><li class="li1"><div class="de1">    marcadors.push(crearMarcador(dades[i].seu, dades[i].lat, dades[i].lon));</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Podeu veure aquest exemple en l’enllaç següent: <a href="https://codepen.io/ioc-daw-m06/pen/egQzPV?editors=1111" class="urlextern" title="https://codepen.io/ioc-daw-m06/pen/egQzPV?editors=1111"  rel="nofollow">codepen.io/ioc-daw-m06/pen/egQzPV?editors=1111</a>.
</p>

<p>
Cal tenir en compte que en aquest cas l’origen de les dades és un <em>array</em> d’objectes JavaScript que s’ha assignat directament al codi, però el funcionament de l’aplicació seria el mateix si les dades s’obtinguessin d’una altra font, per exemple, com a resposta d’una petició AJAX.
</p>

</div>

<h3><a id="finestres_d_informacio" >Finestres d&#039;informació</a></h3>
<div class="level3">

<p>
Habitualment els marcadors mostren informació ampliada quan s’hi clica.
</p>

<p>
La creació de les finestres d’informació és força simple, només cal especificar-ne el contingut: una cadena de text en format <acronym title="HyperText Markup Language">HTML</acronym>. És a dir, una finestra d’informació pot contenir enllaços, imatges i qualsevol tipus de contingut <acronym title="HyperText Markup Language">HTML</acronym>.
</p>

<p>
En cas de treballar amb un únic marcador (emmagatzemat a la variable <code>marcador</code>), n’hi hauria prou amb un codi com el següent:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">  marcador.bindPopup('&lt;h3&gt;' + dada.seu + '&lt;/h3&gt;&lt;p&gt;&lt;b&gt;Adreça:&lt;/b&gt;' + dada.adreca + '&lt;/p&gt;').openPopup();</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Fixeu-vos que amb el mètode <code>openPopup()</code> fem que la finestra estigui oberta per defecte. Si no ho posem, la finestra estaria inicialment oculta i apareixeria al fer clic sobre el marcador.
</p>

<p>
Vegeu a continuació com s’ha afegit l’adreça al conjunt de dades:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">let elMeuMapa;</div></li><li class="li1"><div class="de1">let dades = [{</div></li><li class="li1"><div class="de1">  seu: &quot;IOC - Seu Central&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.375106,</div></li><li class="li1"><div class="de1">  lon: 2.168342,</div></li><li class="li1"><div class="de1">  adreca: &quot;Avinguda del Paral·lel, 71. Barcelona&quot;</div></li><li class="li1"><div class="de1">}, {</div></li><li class="li1"><div class="de1">  seu: &quot;Proves Barcelona&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.3860669,</div></li><li class="li1"><div class="de1">  lon: 2.1145104,</div></li><li class="li1"><div class="de1">  adreca: &quot;C/ John M. Keynes, 1-11. Barcelona&quot;</div></li><li class="li1"><div class="de1">}, {</div></li><li class="li1"><div class="de1">  seu: &quot;Proves Girona&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.961293,</div></li><li class="li1"><div class="de1">  lon: 2.829387,</div></li><li class="li1"><div class="de1">  adreca: &quot;Carrer de la Universitat de Girona, 10. Girona&quot;,</div></li><li class="li1"><div class="de1">}, {</div></li><li class="li1"><div class="de1">  seu: &quot;Proves Lleida&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.623023,</div></li><li class="li1"><div class="de1">  lon: 0.6236748,</div></li><li class="li1"><div class="de1">  adreca: &quot;Pi i Margall, 51. Lleida&quot;,</div></li><li class="li1"><div class="de1">}, {</div></li><li class="li1"><div class="de1">  seu: &quot;Proves Tarragona&quot;,</div></li><li class="li1"><div class="de1">  lat: 41.120293,</div></li><li class="li1"><div class="de1">  lon: 1.247892,</div></li><li class="li1"><div class="de1">  adreca: &quot;Av. de Catalunya, 35. Tarragona&quot;,</div></li><li class="li1"><div class="de1">}];</div></li><li class="li1"><div class="de1">let marcadors = [];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">window.onload = function(){</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	elMeuMapa = L.map('mapaid').setView([41.390205, 2.154007], 8);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	let OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {</div></li><li class="li1"><div class="de1">		maxZoom: 19,</div></li><li class="li1"><div class="de1">		attribution: '&amp;copy; &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors'</div></li><li class="li1"><div class="de1">	});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	OpenStreetMap_Mapnik.addTo(elMeuMapa);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	crearMarcadors();</div></li><li class="li1"><div class="de1">	afegirMarcadors();</div></li><li class="li1"><div class="de1">};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let crearMarcadors = function() {</div></li><li class="li1"><div class="de1">  for (let i = 0; i &lt; dades.length; i++) {</div></li><li class="li1"><div class="de1">    marcadors.push(crearMarcador(dades[i]));</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let crearMarcador = function(dada) {</div></li><li class="li1"><div class="de1">  let marcador = L.marker([dada.lat, dada.lon],{title:dada.seu});</div></li><li class="li1"><div class="de1">  marcador.bindPopup('&lt;h3&gt;' + dada.seu + '&lt;/h3&gt;&lt;p&gt;&lt;b&gt;Adreça:&lt;/b&gt;' + dada.adreca + '&lt;/p&gt;');</div></li><li class="li1"><div class="de1">  return marcador;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let afegirMarcadors = function() {</div></li><li class="li1"><div class="de1">  for (let i = 0; i &lt; marcadors.length; i++) {</div></li><li class="li1"><div class="de1">    console.log(&quot;Afegir marcador: &quot; + i);</div></li><li class="li1"><div class="de1">    afegirMarcador(marcadors[i]);</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let afegirMarcador = function(marcador) {</div></li><li class="li1"><div class="de1">  marcador.addTo(elMeuMapa);</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Podeu veure aquest exemple en l’enllaç següent: <a href="https://codepen.io/ioc-daw-m06/pen/apQmgO?editors=1111" class="urlextern" title="https://codepen.io/ioc-daw-m06/pen/apQmgO?editors=1111"  rel="nofollow">codepen.io/ioc-daw-m06/pen/apQmgO?editors=1111</a>.
</p>

</div>

<h3><a id="cas_practicintegrar_una_font_de_dades_obertes_amb_leaflet" >Cas pràctic: integrar una font de dades obertes amb Leaflet</a></h3>
<div class="level3">

<p>
En aquest exemple es treballaran els punts següents:
</p>
<ul>
<li class="level1"><div class="li"> Ús de la biblioteca jQuery.</div>
</li>
<li class="level1"><div class="li"> Ús de la biblioteca Leaflet.</div>
</li>
<li class="level1"><div class="li"> Cerca de serveis Open Data.</div>
</li>
<li class="level1"><div class="li"> Realització de consultes AJAX.</div>
</li>
<li class="level1"><div class="li"> Càrrega d’un mapa d’OpenStreetMap.</div>
</li>
<li class="level1"><div class="li"> Creació de marcadors.</div>
</li>
<li class="level1"><div class="li"> Creació de finestres d’informació.</div>
</li>
</ul>

<p>
Quan es necessita treballar amb mapes, el més habitual és que la informació que s’hagi de mostrar s’obtingui d’una font de dades externa, com per exemple un servei web propi o dades obertes ofertes per tercers mitjançant AJAX.
</p>

<p>
Cal recordar que en el cas de dades de tercers, només seran accessibles si el servidor implementa mecanismes CORS o JSONP, ja que en cas contrari els navegadors bloquejaran la petició AJAX.
</p>

<p>
Una d’aquestes fonts de dades obertes es troba a la pàgina de l’Observatori de dades culturals de Barcelona (<a href="http://barcelonadadescultura.bcn.cat/dades-obertes" class="urlextern" title="http://barcelonadadescultura.bcn.cat/dades-obertes"  rel="nofollow">barcelonadadescultura.bcn.cat/dades-obertes</a>), on podeu trobar la documentació de l’<acronym title="Application Programming Interface">API</acronym> (<a href="http://dades.eicub.net/doc" class="urlextern" title="http://dades.eicub.net/doc"  rel="nofollow">dades.eicub.net/doc</a>).
</p>

<p>
A partir de la informació que es troba en aquests enllaços, és possible realitzar consultes a l’<acronym title="Application Programming Interface">API</acronym> per obtenir diferents llistats d’informació; per exemple, per obtenir informació sobre els cinemes només cal cercar a la documentació en format XML (<a href="http://dades.eicub.net/doc" class="urlextern" title="http://dades.eicub.net/doc"  rel="nofollow">dades.eicub.net/doc</a>) la paraula <em>cinemes</em> i trobareu les dades següents:
</p>
<pre class="code xml"><ol><li class="li1"><div class="de1">&lt;dataset&gt;</div></li><li class="li1"><div class="de1">  &lt;name&gt;cinemes-dadesglobals&lt;/name&gt;</div></li><li class="li1"><div class="de1">  &lt;url&gt;http://dades.eicub.net/api/1/cinemes-dadesglobals&lt;/url&gt;</div></li><li class="li1"><div class="de1">  &lt;title&gt;Dades globals dels cinemes&lt;/title&gt;</div></li><li class="li1"><div class="de1">  &lt;description&gt;Dades globals dels cinemes de la ciutat&lt;/description&gt;</div></li><li class="li1"><div class="de1">  &lt;columns&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Any&lt;/column&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Dada&lt;/column&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Valor&lt;/column&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Nota&lt;/column&gt;</div></li><li class="li1"><div class="de1">  &lt;/columns&gt;</div></li><li class="li1"><div class="de1">&lt;/dataset&gt;</div></li><li class="li1"><div class="de1">&lt;dataset&gt;</div></li><li class="li1"><div class="de1">  &lt;name&gt;cinemes-inventari&lt;/name&gt;</div></li><li class="li1"><div class="de1">  &lt;url&gt;http://dades.eicub.net/api/1/cinemes-inventari&lt;/url&gt;</div></li><li class="li1"><div class="de1">  &lt;title&gt;Inventari Cinemes&lt;/title&gt;</div></li><li class="li1"><div class="de1">  &lt;description&gt;Inventari de les sales de cinema&lt;/description&gt;</div></li><li class="li1"><div class="de1">  &lt;columns&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Districte&lt;/column&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Equipament&lt;/column&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Titularitat&lt;/column&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Latitud&lt;/column&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Longitud&lt;/column&gt;</div></li><li class="li1"><div class="de1">    &lt;column&gt;Web&lt;/column&gt;</div></li><li class="li1"><div class="de1">  &lt;/columns&gt;</div></li><li class="li1"><div class="de1">&lt;/dataset&gt;</div></li></ol></pre>

<p>
És a dir, hi ha dos conjunts de dades referents a cinemes: un que mostra les dades globals de cada cinema de la ciutat i un altre que mostra el llistat de sales de cinema. Com es pot apreciar, per accedir a aquestes dades cal utilitzar l’<acronym title="Uniform Resource Locator">URL</acronym> que s’indica, que per al llistat de cinemes és <code><a href="http://dades.eicub.net/api/1/cinemes-inventari" class="urlextern" title="http://dades.eicub.net/api/1/cinemes-inventari"  rel="nofollow">http://dades.eicub.net/api/1/cinemes-inventari</a></code>.
</p>

<p>
Fixeu-vos que a la documentació s’indica una sèrie de columnes per a cada conjunt de dades. Aquestes dades es corresponen amb la informació proporcionada pel llistat corresponent per a cadascun dels cinemes. Així doncs, a l’“Inventari Cinemes” es poden trobar les coordenades per localitzar els cinemes sobre el mapa.
</p>

<p>
A partir d’aquesta informació es podria decidir implementar una aplicació que mostrés a un mapa els punts on es troben tots els cinemes de Barcelona, utilitzant la informació proporcionada de la manera següent:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Equipament</strong>: com a títol del marcador i capçalera de la finestra d’informació.</div>
</li>
<li class="level1"><div class="li"> <strong>Districte</strong>, <strong>Titularitat</strong> i <strong>Web</strong>: llistada a la finestra d’informació.</div>
</li>
<li class="level1"><div class="li"> <strong>Latitud</strong> i <strong>Longitud</strong>: utilitzades per crear el marcador.</div>
</li>
</ul>

<p>
Així doncs, una possible implementació d’aquest mapa seria la que es troba a continuació. Les dades es carreguen mitjançant AJAX des de l’<acronym title="Uniform Resource Locator">URL</acronym> <a href="http://dades.eicub.net/api/1/cinemes-inventari" class="urlextern" title="http://dades.eicub.net/api/1/cinemes-inventari"  rel="nofollow">dades.eicub.net/api/1/cinemes-inventari</a> i una vegada descarregades es creen els marcadors i finestres d’informació:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;!doctype html&gt;</div></li><li class="li1"><div class="de1">&lt;html&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;head&gt;</div></li><li class="li1"><div class="de1">  &lt;meta charset=&quot;UTF-8&quot;&gt;</div></li><li class="li1"><div class="de1">  &lt;title&gt;Localització de cinemes a la ciutat de Barcelona&lt;/title&gt;</div></li><li class="li1"><div class="de1">	&lt;link rel=&quot;stylesheet&quot; href=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.css&quot;</div></li><li class="li1"><div class="de1">   integrity=&quot;sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==&quot;</div></li><li class="li1"><div class="de1">   crossorigin=&quot;&quot;/&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1"> &lt;script src=&quot;https://unpkg.com/leaflet@1.7.1/dist/leaflet.js&quot;</div></li><li class="li1"><div class="de1">   integrity=&quot;sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==&quot;</div></li><li class="li1"><div class="de1">   crossorigin=&quot;&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.11.0/leaflet-providers.min.js&quot; integrity=&quot;sha512-TO+Wd5hbpDsACTmvzSqAZL83jMQCXGRFNoS4WZxcxrlJBTdgMYaT7g5uX49C5+Kbuxzlg2A+TFJ6UqdsXuOKLw==&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;style&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  #mapaCinema {</div></li><li class="li1"><div class="de1">    height: 500px;</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  ul {</div></li><li class="li1"><div class="de1">    list-style-type: none;</div></li><li class="li1"><div class="de1">    padding: 0;</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  li b {</div></li><li class="li1"><div class="de1">    display: inline-block;</div></li><li class="li1"><div class="de1">    width: 75px;</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">&lt;/style&gt;</div></li><li class="li1"><div class="de1">&lt;/head&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;div id=&quot;mapaCinema&quot;&gt;&lt;/div&gt;</div></li><li class="li1"><div class="de1">    &lt;script src=&quot;https://code.jquery.com/jquery-3.5.1.js&quot; integrity=&quot;sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">  &lt;script&gt;</div></li><li class="li1"><div class="de1">    let mapa;</div></li><li class="li1"><div class="de1">    let dades;</div></li><li class="li1"><div class="de1">    let marcadors = [];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    $(document).ready(function(){</div></li><li class="li1"><div class="de1">      iniciarAplicacio();</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let iniciarMapa = function() {</div></li><li class="li1"><div class="de1">      elMeuMapa = L.map('mapaCinema').setView([41.390205, 2.154007], 12);</div></li><li class="li1"><div class="de1">      let OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {</div></li><li class="li1"><div class="de1">		    maxZoom: 19,</div></li><li class="li1"><div class="de1">		    attribution: '&amp;copy; &lt;a href=&quot;https://www.openstreetmap.org/copyright&quot;&gt;OpenStreetMap&lt;/a&gt; contributors'</div></li><li class="li1"><div class="de1">	    }).addTo(elMeuMapa);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let crearMarcadors = function() {</div></li><li class="li1"><div class="de1">      for (let i = 0; i &lt; dades.length; i++) {</div></li><li class="li1"><div class="de1">        let marcador = crearMarcador(dades[i]);</div></li><li class="li1"><div class="de1">        marcadors.push(marcador);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let crearMarcador = function(dada) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      let marcador = L.marker([dada.Latitud, dada.Longitud],{title:dada.Equipament});</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      marcador.bindPopup('&lt;h3&gt;' + dada.Equipament + '&lt;/h3&gt;' +</div></li><li class="li1"><div class="de1">          '&lt;ul&gt;' +</div></li><li class="li1"><div class="de1">          '&lt;li&gt;&lt;b&gt;Districte:&lt;/b&gt;' + dada.Districte + '&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">          '&lt;li&gt;&lt;b&gt;Titularitat:&lt;/b&gt;' + dada.Titularitat + '&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">          '&lt;li&gt;&lt;b&gt;Web:&lt;/b&gt;&lt;a href=&quot;' + dada.Web + '&quot;&gt;' + dada.Web + '&lt;/a&gt;&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">          '&lt;/ul&gt;');</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">      return marcador;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let afegirMarcadors = function() {</div></li><li class="li1"><div class="de1">      for (let i = 0; i &lt; marcadors.length; i++) {</div></li><li class="li1"><div class="de1">        afegirMarcador(marcadors[i]);</div></li><li class="li1"><div class="de1">      }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let afegirMarcador = function(marcador) {</div></li><li class="li1"><div class="de1">      marcador.addTo(elMeuMapa);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let iniciarMarcadors = function() {</div></li><li class="li1"><div class="de1">      crearMarcadors();</div></li><li class="li1"><div class="de1">      afegirMarcadors();</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let iniciarAplicacio = function() {</div></li><li class="li1"><div class="de1">      iniciarMapa();</div></li><li class="li1"><div class="de1">      carregarDades();</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let carregarDades = function() {</div></li><li class="li1"><div class="de1">      $.ajax('https://dades.eicub.net/api/1/cinemes-inventari', {</div></li><li class="li1"><div class="de1">        dataType: 'json',</div></li><li class="li1"><div class="de1">        success: function(resposta) {</div></li><li class="li1"><div class="de1">          dades = resposta;</div></li><li class="li1"><div class="de1">          iniciarMarcadors();</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      });</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">  &lt;/script&gt;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
Podeu veure aquest exemple a l’enllaç següent: <a href="https://codepen.io/ioc-daw-m06/pen/rjQpjQ" class="urlextern" title="https://codepen.io/ioc-daw-m06/pen/rjQpjQ"  rel="nofollow">codepen.io/ioc-daw-m06/pen/rjQpjQ</a>.
</p>

<p>
Fixeu-vos que aquesta aplicació té unes fortes dependències i si es canviés l’ordre d’execució, l’aplicació no funcionaria. Per una banda, la biblioteca jQuery s’ha de carregar abans que s’iniciï l’aplicació, perquè la càrrega de dades en depèn, ja que s’ha utilitzat per simplificar la crida AJAX. Per altra banda, la funció <code>iniciarAplicació()</code> ha d’estar disponible abans que acabi de carregar la biblioteca Leaflet, ja que per a inicialitzar els mapes cridarà aquesta funció.
</p>

<p>
Les dades han de ser carregades abans de poder inicialitzar els marcadors i després que s’hagi carregat la biblioteca de Leaflet. Per aquesta raó, s’invoca <code>carregarDades()</code> dintre de la funció <code>iniciarAplicació()</code> i, una vegada es rep la resposta a la crida AJAX, els marcadors s’inicialitzen invocant la funció <code>iniciarMarcadors()</code>.
</p>

<p>
Quant a l’aspecte de l’aplicació, s’ha modificat el codi <acronym title="Cascading Style Sheets">CSS</acronym> per estendre el mapa a tota la pantalla i donar un format més atractiu a les finestres d’informació. Tingueu en compte que les finestres accepten tot tipus de codi <acronym title="HyperText Markup Language">HTML</acronym> i, per tant, és possible afegir altres elements com, per exemple, imatges.
</p>

<p>
Les possibilitats que ofereix la biblioteca Leaflet és molt extensa i es recomana consultar els tutorials i la documentació oficial que podeu trobar a <a href="https://leafletjs.com" class="urlextern" title="https://leafletjs.com"  rel="nofollow">leafletjs.com</a> en cas de necessitar funcionalitats més complexes, com per exemple afegir altres controls al mapa o personalitzar la icona del marcador.
</p>

</div>

</p>

</div>

<h2><a id="desenvolupament_de_jocs_amb_html5" >Desenvolupament de jocs amb HTML5</a></h2>
<div class="level2">

<p>
A finals de l’any 2016 la majoria de fabricants de navegadors (Google i Mozilla entre altres) van deixar d’admetre la utilització de connectors per a Flash o per a les miniaplicacions (<em>applets</em>) de Java als navegadors. Per una banda, no es podia garantir la seguretat d’aquests connectors i, per l’altra, amb les característiques afegides a HTML5 ja no eren necessaris.
</p>
<div class="iocimportant"><div class="ioccontent">
<p>
S’ha de tenir en compte que quan es parla d’<strong>HTML5</strong> no només es tracta del llenguatge de marques <acronym title="HyperText Markup Language">HTML</acronym>, sinó que engloba també <acronym title="Cascading Style Sheets">CSS</acronym>, JavaScript i les noves Web <acronym title="Application Programming Interface">API</acronym> afegides al llenguatge (com per exemple els elements <code>àudio</code>, <code>vídeo</code>, <code>canvas</code>, <code><acronym title="Application Programming Interface">API</acronym> WebSockets</code>…).
</p>
</div></div><div class="ioctext"><div class="ioccontent"><p class="ioctitle">&#039;Applet&#039; o miniaplicació</p>
<p>
Un <em>applet</em>, en català ‘miniaplicació’, és un petit programa desenvolupat en Java perquè s’executi al navegador.
</p>
</div></div>
<p>
Quant al desenvolupament de jocs amb HTML5, l’element clau va ser la inclusió de l’element <code>canvas</code> i, en menor mesura, els elements <code>àudio</code> i <code>vídeo</code>. El primer permet dibuixar formes i imatges dintre de l’element, mentre que els altres dos permeten reproduir àudio i vídeo directament al navegador.
</p>

<p>

<p>
Tot i que hi ha motors molt populars per desenvolupar jocs amb HTML5, com Construct 3 (<a href="https://www.construct.net/" class="urlextern" title="https://www.construct.net/"  rel="nofollow">www.construct.net</a>), Phaser(<a href="https://github.com/photonstorm/phaser" class="urlextern" title="https://github.com/photonstorm/phaser"  rel="nofollow">|github.com/photonstorm/phaser</a>) o ImpactJs (<a href="http://impactjs.com" class="urlextern" title="http://impactjs.com"  rel="nofollow">impactjs.com</a>), és relativament senzill desenvolupar un joc només utilitzant JavaScript, <acronym title="HyperText Markup Language">HTML</acronym> i <acronym title="Cascading Style Sheets">CSS</acronym>.
</p>

</p>

<p>
Cal destacar que molts d’aquests motors prometen exportar els jocs a diferents plataformes (Android, iOS, tvOS, etc.); en realitat, el que fan és generar una aplicació que conté una finestra de navegador sense cap botó, on executen el joc en JavaScript.
</p>

<p>

<p>
Per altra banda, hi ha altres motors de joc multiplataforma que es programen en altres llenguatges (o variants de JavaScript com TypeScript) però exporten a JavaScript. Per exemple, el motor Unity (<a href="https://unity3d.com/es" class="urlextern" title="https://unity3d.com/es"  rel="nofollow">unity3d.com/es</a>) permet desenvolupar jocs amb C# i exportar-los a HTML5 mitjançant un reproductor que utilitza l’<acronym title="Application Programming Interface">API</acronym> WebGL per renderitzar gràfics en 2D o 3D, i WebAssembly per optimitzar el rendiment.
</p>

</p>
<div class="iocnote"><div class="ioccontent">
<p>
Actualment els navegadors poden interpretar codi JavaScript i WebAssemply, un tipus de codi de baix nivell amb un major rendiment.
</p>
</div></div>
</div>

<h3><a id="introduccio" >Introducció</a></h3>
<div class="level3">

<p>

<p>
Un exemple relativament senzill de com desenvolupar un joc amb JavaScript és l’<em>IOC Invaders</em> (vegeu la <span class="figref"><a href="#figura u7-17"><span>figura</span></a></span>). Aquest joc permet il·lustrar com es pot estructurar el codi i aprofitar els elements d’<acronym title="HyperText Markup Language">HTML</acronym> (concretament els elements <code>canvas</code> i <code>àudio</code>) per crear un joc de naus amb múltiples nivells, tipus d’enemics i armes.
</p>

</p>
<div class="iocfigure"><a name="figura u7-17"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Joc “IOC Invaders” en funcionament

</figcaption><img src="../media/17-ioc-invaders-full-screen.png" alt="" /></figure>
</div>
<p>

<p>
Podeu trobar el codi complet d’aquest joc a l’enllaç següent: <a href="https://github.com/XavierGaro/ioc-invaders" class="urlextern" title="https://github.com/XavierGaro/ioc-invaders"  rel="nofollow">github.com/XavierGaro/ioc-invaders</a> i podeu provar-lo al següent enllaç: <a href="https://xaviergaro.github.io/ioc-invaders" class="urlextern" title="https://xaviergaro.github.io/ioc-invaders"  rel="nofollow">xaviergaro.github.io/ioc-invaders/</a>. Tots els recursos són lliures, tant el codi com els recursos gràfics i d’àudio, però si els utilitzeu en els vostres projectes, heu d’incloure els enllaços a les fonts i mencionar-ne els autors.
</p>

<p>
Cal destacar la utilització del <code>canvas</code> tant per dibuixar la nau del jugador, els enemics, les bales i les explosions com per simular un desplaçament horitzontal (<em>scroll</em>, en anglès) amb quatre nivells de profunditat. Tot i que en aquest exemple es fa servir contínuament la mateixa imatge, aquest sistema es podria millorar per utilitzar un <em>array</em> d’imatges per concatenar.
</p>

</p>

<p>
Un punt a tenir molt en compte quan es desenvolupen jocs és que s’han d’optimitzar per obtenir-ne el millor rendiment possible. Per exemple, en altres tipus d’aplicacions gestionar la creació i destrucció d’objectes no és crític perquè l’execució del recol·lector de brossa és inapreciable. En canvi, quan s’han de gestionar centenars de naus, bales, efectes de fons i control del jugador, l’execució del recol·lector provoca una baixada de rendiment crítica i molt evident.
</p>

<p>
A <em>IOC Invaders</em>, per optimitzar l’ús de la memòria i reduir les crides al recol·lector de brossa, s’ha utilitzat una tècnica coneguda com a <em>pool</em>, que consisteix a reutilitzar els mateixos elements en lloc de destruir-los i crear-ne de nous. Això permet mantenir 60 FPS (<em>frames</em> o fotogrames per segon), és a dir, l’element <code>canvas</code> es redibuixa 60 vegades per segon.
</p>

<p>
Quant a la gestió de nivells i recursos s’han utilitzat fitxers de configuració en format JSON que es carreguen mitjançant AJAX. D’aquesta manera, sense modificar el codi del joc es poden modificar els nivells i els enemics, afegir-ne de nous o actualitzar-ne els recursos (imatges i sons).
</p>

</div>

<h4><a id="regles_del_joc" >Regles del joc</a></h4>
<div class="level4">

<p>
Abans de començar a programar cal tenir clares quines seran les regles del joc. Quan s’acaba la partida? Com s’arriba al final del nivell? Què passa si s’arriba al final del joc?
</p>

<p>
En el cas de l’<em>IOC Invaders</em> s’ha decidit utilitzar el següent conjunt de regles:
</p>
<ul>
<li class="level1"><div class="li"> Tant les naus de l’enemic com la del jugador són destruïdes si xoquen amb l’adversari.</div>
</li>
<li class="level1"><div class="li"> Tant les bales de l’enemic com les del jugador són destruïdes si impacten en un adversari.</div>
</li>
<li class="level1"><div class="li"> Qualsevol nau impactada per una bala de l’adversari és destruïda.</div>
</li>
<li class="level1"><div class="li"> Quan la nau del jugador és destruïda el joc s’acaba.</div>
</li>
<li class="level1"><div class="li"> Quan la nau d’un enemic és destruïda augmenta la puntuació del jugador.</div>
</li>
<li class="level1"><div class="li"> Els enemics apareixen quan s’ha recorregut una distància determinada del mapa que s’estableix per a cada nivell.</div>
</li>
<li class="level1"><div class="li"> El nivell es considera per finalitzat quan s’arriba a una distància determinada i no és visible cap enemic.</div>
</li>
<li class="level1"><div class="li"> Quan es finalitza l’últim nivell es torna al primer (conservant la puntuació).</div>
</li>
</ul>

</div>

<h4><a id="presentacio_del_joc" >Presentació del joc</a></h4>
<div class="level4">

<p>
Tot i que l’acció de qualsevol joc es trobarà representada dins del <code>canvas</code>, cal recordar que l’entorn d’execució és el navegador i, per consegüent, es té accés tant a <acronym title="HyperText Markup Language">HTML</acronym> com a <acronym title="Cascading Style Sheets">CSS</acronym>. Això permet, per exemple, mostrar el títol del joc a la capçalera, els crèdits i les instruccions sota del joc i fins i tot utilitzar les puntuacions com etiquetes <acronym title="HyperText Markup Language">HTML</acronym> sobre el <code>canvas</code>.
</p>

<p>
Per descomptat, es poden utilitzar efectes i animacions de <acronym title="Cascading Style Sheets">CSS</acronym>, per exemple, per mostrar un efecte de <em>fade out</em> (fos a negre) o desplaçament de lletres o nombres (puntuació actual, vides restants, missatges de felicitació, etc.).
</p>

<p>
A <em>IOC Invaders</em> s’ha aprofitat el fitxer <acronym title="HyperText Markup Language">HTML</acronym> per afegir la capçalera del joc, els crèdits corresponents als recursos gràfics i d’àudio emprats i la llicència corresponent al peu, com es pot veure en el codi corresponent al fitxer <code>index.html</code>:
</p>
<pre class="code html4strict"><ol><li class="li1"><div class="de1">&lt;!DOCTYPE html&gt;</div></li><li class="li1"><div class="de1">&lt;html lang=&quot;ca&quot;&gt;</div></li><li class="li1"><div class="de1">&lt;head&gt;</div></li><li class="li1"><div class="de1">    &lt;meta charset=&quot;UTF-8&quot;&gt;</div></li><li class="li1"><div class="de1">    &lt;title&gt;IOC Invaders&lt;/title&gt;</div></li><li class="li1"><div class="de1">    &lt;link href=&quot;https://fonts.googleapis.com/css?family=Russo+One&quot; rel=&quot;stylesheet&quot;&gt;</div></li><li class="li1"><div class="de1">    &lt;link href=&quot;https://fonts.googleapis.com/css?family=Exo&quot; rel=&quot;stylesheet&quot;&gt;</div></li><li class="li1"><div class="de1">    &lt;link href=&quot;css/style.css&quot; rel=&quot;stylesheet&quot;&gt;</div></li><li class="li1"><div class="de1">&lt;/head&gt;</div></li><li class="li1"><div class="de1">&lt;body&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;h1&gt;IOC INVADERS&lt;/h1&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;div id=&quot;game-background&quot;&gt;</div></li><li class="li1"><div class="de1">&lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;div class=&quot;credits&quot;&gt;</div></li><li class="li1"><div class="de1">    &lt;h2&gt;CRÈDITS&lt;/h2&gt;</div></li><li class="li1"><div class="de1">    &lt;div&gt;</div></li><li class="li1"><div class="de1">        &lt;h3&gt;Música&lt;/h3&gt;</div></li><li class="li1"><div class="de1">        &lt;ul&gt;</div></li><li class="li1"><div class="de1">            &lt;li&gt;Defense Line: &lt;a target=&quot;_blank&quot; href=&quot;https://www.dl-sounds.com/royalty-free/defense-line/&quot;&gt;Background</div></li><li class="li1"><div class="de1">                Loop&lt;/a&gt;&lt;/li&gt;</div></li><li class="li1"><div class="de1">            &lt;li&gt;Star Commander1(&lt;a target=&quot;_blank&quot; href=&quot;https://www.dl-sounds.com/royalty-free/star-commander1/&quot;&gt; DL</div></li><li class="li1"><div class="de1">                Sounds&lt;/a&gt;)</div></li><li class="li1"><div class="de1">            &lt;/li&gt;</div></li><li class="li1"><div class="de1">        &lt;/ul&gt;</div></li><li class="li1"><div class="de1">    &lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    &lt;div&gt;</div></li><li class="li1"><div class="de1">        &lt;h3&gt;Efectes de so&lt;/h3&gt;</div></li><li class="li1"><div class="de1">        &lt;ul&gt;</div></li><li class="li1"><div class="de1">            &lt;li&gt;Laser: &lt;a target=&quot;_blank&quot; href=&quot;http://soundbible.com/1087-Laser.html&quot;&gt; SoundBible.com&lt;/a&gt;&lt;/li&gt;</div></li><li class="li1"><div class="de1">            &lt;li&gt;Explosions: inferno (&lt;a target=&quot;_blank&quot; href=&quot;http://www.freesound.org/people/inferno/sounds/18384/&quot;&gt;</div></li><li class="li1"><div class="de1">                freesound.org&lt;/a&gt;)</div></li><li class="li1"><div class="de1">            &lt;/li&gt;</div></li><li class="li1"><div class="de1">            &lt;li&gt;Altres - Xavier Garcia Rogríguez&lt;/li&gt;</div></li><li class="li1"><div class="de1">        &lt;/ul&gt;</div></li><li class="li1"><div class="de1">    &lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    &lt;div&gt;</div></li><li class="li1"><div class="de1">        &lt;h3&gt;Gràfics&lt;/h3&gt;</div></li><li class="li1"><div class="de1">        &lt;ul&gt;</div></li><li class="li1"><div class="de1">            &lt;li&gt;Naus: sujit1717 (&lt;a target=&quot;_blank&quot;</div></li><li class="li1"><div class="de1">                                    href=&quot;http://opengameart.org/content/complete-spaceship-game-art-pack&quot;&gt;Space Odyssey</div></li><li class="li1"><div class="de1">                Pack&lt;/a&gt;)</div></li><li class="li1"><div class="de1">            &lt;/li&gt;</div></li><li class="li1"><div class="de1">            &lt;li&gt;Fons i trets: Xavier Garcia Rogríguez&lt;/li&gt;</div></li><li class="li1"><div class="de1">        &lt;/ul&gt;</div></li><li class="li1"><div class="de1">    &lt;/div&gt;</div></li><li class="li1"><div class="de1">&lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;div class=&quot;footer&quot;&gt;</div></li><li class="li1"><div class="de1">    Xavier Garcia Rodríguez 2021. &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; target=&quot;_blank&quot;&gt;Llicencia Apache</div></li><li class="li1"><div class="de1">    2.0&lt;/a&gt;. Podeu trobar el codi font d'aquest joc a &lt;a target=&quot;_blank&quot; href=&quot;https://github.com/XavierGaro/ioc-invaders&quot;&gt;GitHub&lt;/a&gt;.</div></li><li class="li1"><div class="de1">&lt;/div&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;script type=&quot;module&quot; src=&quot;js/modules/ioc-invaders.js&quot;&gt;&lt;/script&gt;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&lt;/body&gt;</div></li><li class="li1"><div class="de1">&lt;/html&gt;</div></li></ol></pre>

<p>
També s’han aprofitat les característiques de <acronym title="Cascading Style Sheets">CSS</acronym> per afegir alguns efectes de transició que són activats pel joc, i s’han utilitzat dues fonts externes:
</p>
<ul>
<li class="level1"><div class="li"> Vora negra al voltant de tot el text.</div>
</li>
<li class="level1"><div class="li"> Ombra al voltant del <code>canvas</code>.</div>
</li>
<li class="level1"><div class="li"> Missatges que es fan visibles i s’esvaeixen, així com pantalles de transició (classe <code>fadeable</code>).</div>
</li>
<li class="level1"><div class="li"> Utilització de les fonts Russo One i Exo facilitades per Google Fonts.</div>
</li>
<li class="level1"><div class="li"> Utilització de diferents colors per a diferents elements.</div>
</li>
</ul>

<p>
A continuació podeu trobar el codi corresponent al fitxer “css/style.css” que inclou tots els estils emprats:
</p>
<pre class="code">body {
    color: white;
    background-color: gray;
    text-align: center;
    font-family: &#039;Russo One&#039;, sans-serif;
    text-shadow: 1px 0 0 #000, 0 -1px 0 #000, 0 1px 0 #000, -1px 0 0 #000;
}

canvas {
    margin: 0 auto;
    background: transparent;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
}

h1, h2, h3 {
    margin: 0;
    line-height: 1;
}

h1 {
    font-size: 64px;
}

h2 {
    color: red;
    padding: 15px;
    font-size: 50px;
}

h3 {
    font-size: 40px;
    color: #FFD700;
}

ul {
    list-style: none;
    padding: 0;
    text-align: center;
    color: white;
}

li {
    font-family: &#039;Exo&#039;, sans-serif;
}

a {
    color: cornflowerblue;
    text-decoration: none;
    border-bottom: 1px dotted;
}

#game-background {
    position: relative;
    margin: 0 auto;
    width: 1024px;
    height: 512px;
    border: 1px solid black;
    -webkit-box-shadow: 3px 5px 10px 2px rgba(0, 0, 0, 0.39);
    -moz-box-shadow: 3px 5px 10px 2px rgba(0, 0, 0, 0.39);
    box-shadow: 3px 5px 10px 2px rgba(0, 0, 0, 0.39);
    background-color: black;
}

#background {
    z-index: -2;
}

.ui {
    margin: 0 auto;
    width: 1024px;
    position: relative;
    top: 0;
}

.score, .distance, .fpsCounter {
    position: absolute;
    top: 5px;
    left: 5px;
    color: #FFF;
    cursor: default;
    width: 150px;
    text-align: left;
    font-family: &#039;Exo&#039;, sans-serif;
}

#loading-info {
    position: absolute;
    bottom: 5px;
    left: 5px;
    color: #FFF;
    cursor: default;
    text-align: left;
    font-family: &#039;Exo&#039;, sans-serif;
}

.score span, .distance span, .fpsCounter span{
    float: right;
}

.distance {
    top: 20px;
}

.fpsCounter {
    top: 40px;
}

.game-over, .messages {
    position: absolute;
    top: 180px;
    left: 0;
    right: 0;
    color: red;
    font-size: 40px;
    cursor: default;
}

.game-over span, .messages span {
    font-size: 20px;
    position: relative;
}

.game-over span {
    cursor: pointer;
}

.game-over {
    z-index: 100;
    display: none;
    cursor: default;
}

.game-over span:hover, .messages {
    color: #FFD700;
}

#start.game-over {
    display: block;
}

.fadeable {
    -webkit-transition: opacity 3s ease-in-out;
    -moz-transition: opacity 3s ease-in-out;
    -o-transition: opacity 3s ease-in-out;
    opacity: 0;
}

.credits {
    margin: 0 auto;
    width: 1024px;
}

.credits div {
    width: 33%;
    float: left;
}

.footer {
    font-size: smaller;
    font-family: &#039;Exo&#039;, sans-serif;
    position: fixed;
    bottom: 0;
    width: 100%;
    text-align: center;
}</pre>

<p>
El resultat d’aplicar aquesta estructura <acronym title="HyperText Markup Language">HTML</acronym> i els estils la podeu veure a la <span class="figref"><a href="#figura u7-18"><span>figura</span></a></span>.
</p>
<div class="iocfigure"><a name="figura u7-18"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Representació de l’estructura <acronym title="HyperText Markup Language">HTML</acronym> i <acronym title="Cascading Style Sheets">CSS</acronym> del joc “IOC Invaders”

</figcaption><img src="../media/18-ioc-invaders-html-i-css.png" alt="" /></figure>
</div>
<p>
Per facilitar la portabilitat del joc és recomanable que tots els elements imprescindibles per al seu funcionament es creïn mitjançant JavaScript. Així només cal comprovar que l’identificador del contenidor en el qual s’afegirà el joc és correcte. Per exemple, en el joc <em>IOC Invaders</em> només cal afegir un element amb l’identificador <code>game-background</code> i la resta d’elements es generaran automàticament.
</p>

<p>
Concretament, els elements necessaris per al funcionament de l’<em>IOC Invaders</em> s’afegeixen en finalitzar la càrrega de la pàgina mitjançant el codi següent, corresponent al final del mòdul <code>ioc-invader</code>:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">window.onload = function () {</div></li><li class="li1"><div class="de1">    let gameContainer = document.getElementById('game-background'),</div></li><li class="li1"><div class="de1">        canvas;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    gameContainer.innerHTML = '' +</div></li><li class="li1"><div class="de1">        '&lt;canvas id=&quot;game-canvas&quot; width=&quot;1024&quot; height=&quot;512&quot; class=&quot;fadeable&quot;&gt;' +</div></li><li class="li1"><div class="de1">        'El teu navegador no admet canvas. Si us plau, prova amb un altre navegador.' +</div></li><li class="li1"><div class="de1">        '&lt;/canvas&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;ul class=&quot;ui&quot;&gt;' +</div></li><li class="li1"><div class="de1">        '   &lt;li class=&quot;score&quot;&gt;PUNTUACIÓ: &lt;span id=&quot;score&quot;&gt;0&lt;/span&gt;&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">        '   &lt;li class=&quot;distance&quot;&gt;DISTÀNCIA: &lt;span id=&quot;distance&quot;&gt;0&lt;/span&gt;&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">        '   &lt;li class=&quot;fpsCounter&quot;&gt;FPS: &lt;span id=&quot;fps&quot;&gt;0&lt;/span&gt;&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;/ul&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;div class=&quot;game-over&quot; id=&quot;game-over&quot;&gt;GAME OVER&lt;p&gt;&lt;span&gt;TORNAR A JUGAR&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;div class=&quot;game-over&quot; id=&quot;start&quot;&gt;PREM JUGAR PER COMENÇAR&lt;p&gt;&lt;span&gt;JUGAR&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;div class=&quot;messages fadeable&quot; id=&quot;messages&quot;&gt;&lt;/div&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;div id=&quot;loading-info&quot;&gt; &lt;/div&gt;';</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    document.getElementById('game-over').addEventListener('click', restart);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let startNode = document.getElementById('start');</div></li><li class="li1"><div class="de1">    startNode.addEventListener('click', ()  =&gt; {</div></li><li class="li1"><div class="de1">        startNode.remove();</div></li><li class="li1"><div class="de1">        canvas = document.getElementById('game-canvas');</div></li><li class="li1"><div class="de1">        start({</div></li><li class="li1"><div class="de1">            &quot;asset_data_url&quot;: &quot;asset-data.json&quot;,</div></li><li class="li1"><div class="de1">            &quot;entity_data_url&quot;: &quot;entity-data.json&quot;,</div></li><li class="li1"><div class="de1">            &quot;levels_data_url&quot;: &quot;level-data.json&quot;</div></li><li class="li1"><div class="de1">        }, canvas);</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">};</div></li></ol></pre>

</p>

<p>
Com es pot apreciar, s’obté la referència a l’element <code>game-background</code> i s’estableix com a contingut intern d’aquest element el codi <acronym title="HyperText Markup Language">HTML</acronym> que conté el <code>canvas</code> i els elements que mostraran les puntuacions i els missatges.
</p>

<p>

<p>
A més a més s’obté la referència al <code>canvas</code> amb el qual s’inicialitza el joc, juntament amb la ruta de les dades corresponents als recursos i les entitats i els nivells que formaran part del joc. Per acabar, s’afegeix un detector de l’<em>event</em> <code>click</code> als elements <code>start</code> i <code>game-over</code> per començar i reinicialitzar el joc respectivament.
::text:
La majoria dels navegadors no permeten la reproducció automàtica de sons abans que l’usuari hagi interactuat amb el lloc web, per aquest motiu s’obliga a fer clic a l’usuari al botó de jugar abans de començar. En cas contrari es produiria un error en intentar reproduir la música de fons.
</p>

</p>

</div>

<h3><a id="carrega_de_fitxers_json_i_moduls_en_entorn_local" >Carrega de fitxers JSON i mòduls en entorn local</a></h3>
<div class="level3">

<p>

<p>
Cal tenir en compte que, a l’hora de treballar amb mòduls i peticions AJAX, és imprescindible utilitzar un servidor web, ja que els navegadors bloquegen la càrrega d’aquests tipus de fitxers de forma local perquè el mecanisme CORS no permet utilitzar el protocol FILE (que és l’utilitzat pels fitxers locals).
</p>

<p>
En cas d’haver de treballar localment, la solució més simple és instal·lar el paquet http-server mitjançant el gestor de paquets npm. Aquest servidor no requereix cap configuració.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar més informació sobre el mecanisme CORS a l’enllaç següent: <a href="https://tiny.cc/4ziauz" class="urlextern" title="https://tiny.cc/4ziauz"  rel="nofollow">tiny.cc/4ziauz</a>. 
</p>
</div></div>
<p>
Des de la terminal, dintre la carpeta del projecte (al mateix lloc que es trobi el fitxer index.html), introduïu:
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar la documentació del paquet <code>http-server</code> a l’enllaç següent: <a href="http://tiny.cc/5yiauz" class="urlextern" title="http://tiny.cc/5yiauz"  rel="nofollow">tiny.cc/5yiauz</a>.
</p>
</div></div><pre class="code">npm install http-server -g</pre>

<p>
Un cop instal·lat per posar-lo en marxa només heu d’introduir a la línia d’ordres:
</p>
<pre class="code">&#039;&#039;http-server&#039;&#039;</pre>

<p>
Per accedir al lloc web podeu utilitzar qualsevol navegador introduint com url: <code><a href="http://localhost:8080/" class="urlextern" title="http://localhost:8080/"  rel="nofollow">http://localhost:8080/</a></code>
</p>

</p>

</div>

<h3><a id="encapsulament_del_joc" >Encapsulament del joc</a></h3>
<div class="level3">

<p>

<p>
Per encapsular la informació hem utilitzat diferents mòduls, encapsulant les funcionalitats i exposant només els elements necessaris. D’aquesta manera el joc no interfereix amb altres aplicacions i totes les seves funcions, mètodes i objectes queden aïllats de l’usuari, que no podrà manipular-lo, ja que només tindrà accés a les funcions exposades pel mòdul <code>ioc-invaders</code>: <code>start()</code> i <code>restart()</code>.
</p>

<p>
S’ha estructurat l’aplicació en els següents mòduls:
</p>
<ul>
<li class="level1"><div class="li"> <strong>ioc-invaders</strong>: aquest mòdul és el responsable d’iniciar i reiniciar el joc quan s’interactua. Crea la instància de l’objecte GameEngine que conté la lògica del joc.</div>
</li>
<li class="level1"><div class="li"> <strong>gameEngine</strong>: aquest mòdul exposa la classe GameEngine i inclou la classe UserInterface (interna) per gestionar la interfície d’usuari.</div>
</li>
<li class="level1"><div class="li"> <strong>assetManager</strong>: aquest mòdul és el responsable de descarregar els recursos necessaris i preparar-los per ser utilitzats.</div>
</li>
<li class="level1"><div class="li"> <strong>inputController</strong>: gestiona l’entrada de l’usuari per teclat, exposant només un objecte per consultar l’estat de les tecles.</div>
</li>
<li class="level1"><div class="li"> <strong>gameObjectPool</strong>: exposa només la classe <code>GameObjectPool</code>, però s’ha optat per separar-la d’altres classes perquè la seva utilitat és genèrica i podria ser reutilitzat.</div>
</li>
<li class="level1"><div class="li"> <strong>gameObjects</strong>: aquest mòdul exposa totes les classes utilitzades per instanciar elements del joc: el jugador, enemics, bales, explosions i fons del joc.</div>
</li>
<li class="level1"><div class="li"> <strong>entityRepository</strong>: mòdul responsable de gestionar les entitats.</div>
</li>
<li class="level1"><div class="li"> <strong>strategiesRepository</strong>: mòdul responsable de gestionar les estratègies utilitzades per les entitats (naus i bales).</div>
</li>
</ul>

<p>
 A continuació, podeu trobar el codi del mòdul <code>ioc-invaders</code> (sense incloure la funció <code>window.onload()</code>):
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">import {GameEngine} from &quot;./gameEngine.js&quot;;</div></li><li class="li1"><div class="de1">import * as assetManager from &quot;./assetManager.js&quot;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Number.prototype.clamp = function (min, max) {</div></li><li class="li1"><div class="de1">    return Math.min(Math.max(this, min), max);</div></li><li class="li1"><div class="de1">};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let gameCanvas,</div></li><li class="li1"><div class="de1">    config,</div></li><li class="li1"><div class="de1">    gameEngine;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function start(conf, canvas) {</div></li><li class="li1"><div class="de1">    config = conf;</div></li><li class="li1"><div class="de1">    gameCanvas = canvas;</div></li><li class="li1"><div class="de1">    gameEngine = new GameEngine(conf, canvas);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    assetManager.subscribe((current, total) =&gt; {</div></li><li class="li1"><div class="de1">        let node = document.getElementById('loading-info');</div></li><li class="li1"><div class="de1">        node.innerHTML = `RECURSOS CARREGATS: ${current}/${total}`;</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    gameEngine.init();</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function restart() {</div></li><li class="li1"><div class="de1">    gameEngine.restart();</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">window.onload = function () {</div></li><li class="li1"><div class="de1">    let gameContainer = document.getElementById('game-background'),</div></li><li class="li1"><div class="de1">        canvas;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    gameContainer.innerHTML = '' +</div></li><li class="li1"><div class="de1">        '&lt;canvas id=&quot;game-canvas&quot; width=&quot;1024&quot; height=&quot;512&quot; class=&quot;fadeable&quot;&gt;' +</div></li><li class="li1"><div class="de1">        'El teu navegador no admet canvas. Si us plau, prova amb un altre navegador.' +</div></li><li class="li1"><div class="de1">        '&lt;/canvas&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;ul class=&quot;ui&quot;&gt;' +</div></li><li class="li1"><div class="de1">        '   &lt;li class=&quot;score&quot;&gt;PUNTUACIÓ: &lt;span id=&quot;score&quot;&gt;0&lt;/span&gt;&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">        '   &lt;li class=&quot;distance&quot;&gt;DISTÀNCIA: &lt;span id=&quot;distance&quot;&gt;0&lt;/span&gt;&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">        '   &lt;li class=&quot;fpsCounter&quot;&gt;FPS: &lt;span id=&quot;fps&quot;&gt;0&lt;/span&gt;&lt;/li&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;/ul&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;div class=&quot;game-over&quot; id=&quot;game-over&quot;&gt;GAME OVER&lt;p&gt;&lt;span&gt;TORNAR A JUGAR&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;div class=&quot;game-over&quot; id=&quot;start&quot;&gt;PREM JUGAR PER COMENÇAR&lt;p&gt;&lt;span&gt;JUGAR&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;div class=&quot;messages fadeable&quot; id=&quot;messages&quot;&gt;&lt;/div&gt;' +</div></li><li class="li1"><div class="de1">        '&lt;div id=&quot;loading-info&quot;&gt; &lt;/div&gt;';</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    document.getElementById('game-over').addEventListener('click', restart);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let startNode = document.getElementById('start');</div></li><li class="li1"><div class="de1">    startNode.addEventListener('click', ()  =&gt; {</div></li><li class="li1"><div class="de1">        startNode.remove();</div></li><li class="li1"><div class="de1">        canvas = document.getElementById('game-canvas');</div></li><li class="li1"><div class="de1">        start({</div></li><li class="li1"><div class="de1">            &quot;asset_data_url&quot;: &quot;asset-data.json&quot;,</div></li><li class="li1"><div class="de1">            &quot;entity_data_url&quot;: &quot;entity-data.json&quot;,</div></li><li class="li1"><div class="de1">            &quot;levels_data_url&quot;: &quot;level-data.json&quot;</div></li><li class="li1"><div class="de1">        }, canvas);</div></li><li class="li1"><div class="de1">    });</div></li><li class="li1"><div class="de1">};</div></li></ol></pre>

<p>
Com es pot apreciar, s’importen la classe <code>GameEngine</code> del mòdul <code>gameEngine</code> i tots els elements del mòdul <code>assetManager</code>. Normalment no es recomana la utilització de l’asterisc per importar-ho tot, però en aquest cas ens interessa fer-ho per mantenir el mateix format a tot el codi i assegurar-nos que no hi ha cap conflicte entre els noms de les funcions importades del mòdul.
</p>

<p>
Aquest mòdul exporta les funcions <code>start()</code> i <code>restart()</code>. La primera crea una instància de la classe <code>GameEngine</code>, que controlarà la lògica del joc i la inicialitza, mentre que la segona reinicia una partida.
</p>

<p>
En algunes ocasions ens pot interessar estendre objectes propis de JavaScript per afegir funcionalitats que no es troben en el llenguatge.
</p>

</p>

<p>
Això és el que s’ha fet amb la funció <code>clamp()</code> (disponible en altres llenguatges), estenent el prototip dels nombres per permetre <em>encaixonar</em> un valor entre un mínim i un màxim, de manera que el resultat estigui sempre dintre d’aquests límits:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">/**</div></li><li class="li1"><div class="de1"> * @param {number} min - valor mínim</div></li><li class="li1"><div class="de1"> * @param {number} max - valor máxim</div></li><li class="li1"><div class="de1"> * @returns {number} - El nombre si està dins del limit o el valor corresponent al limit</div></li><li class="li1"><div class="de1"> */</div></li><li class="li1"><div class="de1">Number.prototype.clamp = function (min, max) {</div></li><li class="li1"><div class="de1">    return Math.min(Math.max(this, min), max);</div></li><li class="li1"><div class="de1">};</div></li></ol></pre>

</p>

<p>
Un exemple d’utilització d’aquesta funció es troba a la classe <code>player</code>, on es fa servir per evitar que la nau del jugador surti de la pantalla:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">this.position.x = this.position.x.clamp(0, this.gameWidth - this.sprite.size.width);</div></li><li class="li1"><div class="de1">        this.position.y = this.position.y.clamp(0, this.gameHeight - this.sprite.size.height);</div></li></ol></pre>

</p>

<p>
Ara compareu-lo amb el codi sense utilitzar el mètode <code>clamp()</code>; s’entén fàcilment però és molt llarga:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">if (this.position.x &lt;0) {</div></li><li class="li1"><div class="de1">  this.position.x = 0;</div></li><li class="li1"><div class="de1">} else if (this.position.x &gt; this.gameWidth - this.sprite.size.width) {</div></li><li class="li1"><div class="de1">  this.position.x = this.gameWidth - this.sprite.size.width;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">if (this.position.y &lt; 0) {</div></li><li class="li1"><div class="de1">  this.position.y = 0;</div></li><li class="li1"><div class="de1">} else if (this.position.y &gt; gameHeight - this.sprite.size.height) {</div></li><li class="li1"><div class="de1">  this.position.y = gameHeight - this.sprite.size.height;</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</p>

<p>
I, finalment, compareu-lo amb la implementació fent servir els mètodes <code>Math.max()</code> i <code>Math.min()</code>, no és tan curta com amb el mètode <code>clamp()</code> i és més complicada d’entendre:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">this.position.x = Math.min(Math.max(this.position.x, 0), gameWidth - this.sprite.size.width);</div></li><li class="li1"><div class="de1">this.position.y = Math.min(Math.max(this.position.y, 0), gameHeight - this.sprite.size.height);</div></li></ol></pre>

</p>

<p>
S’ha de tenir en compte que habitualment no es recomana modificar el prototipus dels objectes del llenguatge, però hi ha ocasions en què és molt útil i permet escriure un codi més concís i més entenedor.
</p>

</div>

<h3><a id="gestio_de_les_dades" >Gestió de les dades</a></h3>
<div class="level3">

<p>
Habitualment, quan es desenvolupa un joc s’ha de treballar amb dades que han de ser manipulades i reutilitzades. Per exemple, la informació sobre els tipus d’enemics o els tipus d’armes que es poden trobar, la informació sobre les peces d’un puzle… Aquesta informació es pot tractar com un catàleg només de consulta: a partir d’aquesta informació es generen els elements del joc i no s’ha de modificar.
</p>

<p>
Aquestes dades poden provenir de fonts externes (per exemple, carregades mitjançant AJAX) o poden estar incrustades al codi. Es pot considerar que aquestes dades són un dipòsit o un catàleg, a partir del qual es construeixen els objectes que s’utilitzaran en el joc.
</p>

<p>
En molts casos un dipòsit de dades no es limita a emmagatzemar dades, sinó que n’acostuma a realitzar algun tipus de tractament abans d’afegir-les o recuperar-les. El seu funcionament és molt similar al del patró de disseny factoria, però amb una implementació més simple.
</p>

<p>
Per exemple, a <em>IOC Invaders</em> s’han implementat dos dipòsits de dades (<em>repository</em>, en anglès) diferents. Per una banda, s’ha creat un dipòsit d’entitats que s’encarrega de gestionar les dades de les entitats que formen el joc (naus, bales, explosions…) i, per l’altra, un dipòsit d’estratègies que permet assignar diferents funcions de moviment a les entitats (concretament a les bales i les naus enemigues).
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar més informació sobre el patró de disseny factoria a l’enllaç següent: <a href="https://ca.wikipedia.org/wiki/Factory_method" class="urlextern" title="https://ca.wikipedia.org/wiki/Factory_method"  rel="nofollow">goo.gl/r3sBkz</a>.
</p>
</div></div>
<p>

<p>
A continuació podeu veure com s’ha implementat el mòdul corresponent al dipòsit d’<em>entitats</em> (es tracta d’un nom escollit arbitràriament que fa referència a les dades que s’utilitzen per crear instàncies d’objectes al joc, vegeu la <span class="figref"><a href="#figura u7-20"><span>figura</span></a></span>), que pot rebre un <em>array</em> d’entitats (per exemple, carregades des d’un fitxer d’entitats) i en cas necessari assigna la funció <code>move()</code> obtinguda del dipòsit d’estratègies:
</p>

<p>
&lt;newcontent&gt;
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">import {getStrategy} from &quot;./strategiesRepository.js&quot;;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let entities = {};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function add(name, data) {</div></li><li class="li1"><div class="de1">    let entity = data;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (data.move) {</div></li><li class="li1"><div class="de1">        entity.move = getStrategy(data.move);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    entities[name] = entity;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function addEntity(entity) {</div></li><li class="li1"><div class="de1">    if (Array.isArray(entity)) {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; entity.length; i++) {</div></li><li class="li1"><div class="de1">            add(entity[i].name, entity[i].data);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">        add(entity.name, entity.data);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">// Retorna un nou objecte amb les propietats originals més les mesclades</div></li><li class="li1"><div class="de1">export function getEntity(name, position, speed) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let entity = entities[name];</div></li><li class="li1"><div class="de1">    if (!entity) {</div></li><li class="li1"><div class="de1">        console.error(&quot;No es troba la entitat: &quot;, entity);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    entity.position = position;</div></li><li class="li1"><div class="de1">    entity.speed = speed;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    return entity;</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</p>
<div class="iocfigure"><a name="figura u7-20"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

 Diagrama UML dipòsit d’entitats

</figcaption><img src="../media/daw_m06_u7_03_grafisme.png" alt="" /></figure>
</div>
<p>

<p>
Fixeu-vos que es tracta d’un mòdul i, per consegüent, només exposa els mètodes <code>addEntity()</code> i <code>getEntity()</code> que s’han declarat amb <code>export</code>
</p>

</p>

<p>
. Així s’encapsulen les dades dintre del dipòsit i s’assegura que només s’accedirà als elements de la forma prevista.
</p>

<p>
Al contrari que en el dipòsit anterior, el dipòsit d’estratègies no obté les dades d’una font externa, sinó que conté un diccionari de funcions que correspon a les diverses estratègies que poden assignar-se a les entitats, com es pot veure a continuació:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">let strategies = {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    movement_pattern_a: function (deltaTime) {</div></li><li class="li1"><div class="de1">        const maxOffset = 30;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (!this.extra.ready) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            this.extra.speed = Math.max(Math.abs(this.speed.x), Math.abs(this.speed.y));</div></li><li class="li1"><div class="de1">            this.extra.leftEdge = this.position.x - maxOffset;</div></li><li class="li1"><div class="de1">            this.extra.rightEdge = this.position.x + maxOffset;</div></li><li class="li1"><div class="de1">            this.extra.topEdge = this.position.y + maxOffset;</div></li><li class="li1"><div class="de1">            this.extra.bottomEdge = this.position.y - maxOffset;</div></li><li class="li1"><div class="de1">            this.extra.direction = {x: this.speed.x &lt;= 0 ? -1 : 1, y: 1};</div></li><li class="li1"><div class="de1">            this.extra.ready = true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.position.y &gt;= this.extra.topEdge || this.position.y &lt;= this.extra.bottomEdge) {</div></li><li class="li1"><div class="de1">            this.speed.x = this.extra.direction.x &gt;= 0 ? this.extra.speed : -this.extra.speed;</div></li><li class="li1"><div class="de1">            this.speed.y = 0;</div></li><li class="li1"><div class="de1">            this.extra.direction.y = -this.extra.direction.y;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.position.x &lt;= this.extra.leftEdge) {</div></li><li class="li1"><div class="de1">            this.speed.x = 0;</div></li><li class="li1"><div class="de1">            this.speed.y = this.extra.speed;</div></li><li class="li1"><div class="de1">            this.extra.leftEdge = this.position.x - maxOffset;</div></li><li class="li1"><div class="de1">        } else if (this.position.x &gt;= this.extra.rightEdge) {</div></li><li class="li1"><div class="de1">            this.speed.x = 0;</div></li><li class="li1"><div class="de1">            this.speed.y = this.extra.speed;</div></li><li class="li1"><div class="de1">            this.extra.rightEdge = this.position.x + maxOffset;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.position.x += this.speed.x * deltaTime;</div></li><li class="li1"><div class="de1">        this.position.y += this.speed.y * this.extra.direction.y * deltaTime;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.position.y = this.position.y.clamp(this.extra.bottomEdge, this.extra.topEdge);</div></li><li class="li1"><div class="de1">    },</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    movement_pattern_b: function (deltaTime) {</div></li><li class="li1"><div class="de1">        this.position.x += this.speed.x * deltaTime;</div></li><li class="li1"><div class="de1">        this.position.y += this.speed.y * deltaTime;</div></li><li class="li1"><div class="de1">    },</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    movement_pattern_c: function (deltaTime) {</div></li><li class="li1"><div class="de1">        if (!this.extra.ready) {</div></li><li class="li1"><div class="de1">            this.extra.age = 0;</div></li><li class="li1"><div class="de1">            this.extra.speed = Math.max(Math.abs(this.speed.x), Math.abs(this.speed.y));</div></li><li class="li1"><div class="de1">            this.extra.ready = true;</div></li><li class="li1"><div class="de1">            this.extra.vertical = this.speed.x &gt; this.speed.y;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.extra.direction === 1) {</div></li><li class="li1"><div class="de1">            this.speed.x = this.extra.speed * Math.cos(-this.extra.age * Math.PI / 64);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">            this.speed.y = this.extra.speed * Math.sin(this.extra.age * Math.PI / 64);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.extra.age += deltaTime;</div></li><li class="li1"><div class="de1">        this.position.x += this.speed.x * deltaTime;</div></li><li class="li1"><div class="de1">        this.position.y += this.speed.y * deltaTime;</div></li><li class="li1"><div class="de1">    },</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    movement_pattern_d: function (deltaTime) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (!this.extra.ready) {</div></li><li class="li1"><div class="de1">            this.extra.age = 0;</div></li><li class="li1"><div class="de1">            this.extra.speed = Math.max(Math.abs(this.speed.x), Math.abs(this.speed.y));</div></li><li class="li1"><div class="de1">            this.extra.ready = true;</div></li><li class="li1"><div class="de1">            this.extra.vertical = this.speed.x &gt; this.speed.y;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.extra.direction === 1) {</div></li><li class="li1"><div class="de1">            this.speed.x = this.extra.speed * Math.cos(this.extra.age * Math.PI / 64);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">            this.speed.y = this.extra.speed * Math.cos(this.extra.age * Math.PI / 64);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.extra.age++;</div></li><li class="li1"><div class="de1">        this.position.x += this.speed.x * deltaTime;</div></li><li class="li1"><div class="de1">        this.position.y += this.speed.y * deltaTime;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function getStrategy(strategy) {</div></li><li class="li1"><div class="de1">    return strategies[strategy];</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</p>

<p>
Tot i que el codi pot intimidar una mica, fixeu-vos que només consisteix en un diccionari de dades al qual corresponen funcions que determinen una nova posició.
</p>

<p>

<p>
 Com és d’esperar, es tracta d’un mòdul i per tant només exposa la funció <code>getStrategy()</code>, que permet obtenir la funció corresponent a l’estratègia de moviment amb aquest nom (vegeu la <span class="figref"><a href="#figura u7-21"><span>figura</span></a></span>).
</p>

</p>
<div class="iocfigure"><a name="figura u7-21"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

 Diagrama UML dipòsit d’estratègies

</figcaption><img src="../media/daw_m06_u7_04_grafisme2.png" alt="" /></figure>
</div>
<p>

<p>
Fixeu-vos que tots dos dipòsits disposen d’un diccionari de dades que no és accesible externament(objecte de JavaScript que fa servir una cadena de text com a clau) per emmagatzemar les dades i un mètode públic per recuperar-les.
</p>

</p>

</div>

<h3><a id="interaccio_amb_l_aplicacio" >Interacció amb l&#039;aplicació</a></h3>
<div class="level3">

<p>
Els dos dispositius més habituals per interactuar amb una aplicació són el ratolí i el teclat. Per estrany que pugui semblar, tots dos poden ser problemàtics a l’hora de treballar amb ells donades les discrepàncies que es poden trobar entre els navegadors.
</p>

<p>
En el cas del ratolí, la dificultat més gran que es presenta en treballar amb l’element <code>canvas</code> és determinar sobre quin punt es troba realment el cursor, ja que no hi ha cap mètode 100% fiable per accedir a aquesta informació i cada navegador implementa diferents solucions.
</p>

<p>
El més recomanable és treballar amb les propietats <code>offsetX</code> i <code>offsetY</code>, ja que tot i que són experimentals formen part de les recomanacions del <acronym title="World Wide Web Consortium">W3C</acronym>. Aquestes propietats retornen la posició del cursor respecte a l’element clicat, que correspondrà al <code>canvas</code>.
</p>

<p>
Quant a l’ús del teclat, hi ha problemes similars. Cada navegador ha realitzat la implementació d’una manera diferent i no es garanteix que totes les tecles responguin de la mateixa manera als <em>events</em> <code>keydown</code>, <code>keyup</code> i <code>keypress</code>.
</p>

<p>
Tampoc no es retornen les mateixes propietats amb l’<em>event</em>, de manera que alguns navegadors retornen el codi a la propietat <code>keyCode</code> mentre que d’altres utilitzen <code>charCode</code>.
</p>

<p>

<p>
Per altra banda, l’especificació oficial dels <em>events</em> de teclat indica que s’han d’utilitzar les propietats <code>key</code> i <code>code</code>, encara que aquestes no van ser admeses pels navegadors durant un temps.
</p>

</p>

<p>
Per unificar aquestes entrades, la solució és crear un objecte que centralitzi l’entrada dels dispositius i que l’aplicació consulti a aquest objecte en lloc de gestionar directament els <em>events</em>. Aquest objecte també pot encarregar-se de gestionar les diferències entre navegadors, de manera que tots els canvis que calgui fer sobre aquest aspecte es poden fer des d’un mateix punt.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar més informació sobre les propietats dels <em>events</em> disparats pel ratolí a l’enllaç següent: <a href="https://goo.gl/t0ijCe" class="urlextern" title="https://goo.gl/t0ijCe"  rel="nofollow">goo.gl/t0ijCe</a>.
</p>
</div></div>
<p>

</p>

<p>

<p>
Per exemple, a <em>IOC Invaders</em> això s’aconsegueix a través del mòdul <code>inputController</code>, que encapsula la complexitat de detectar quines tecles s’han premut i exposa només un objecte que permet consultar l’estat de les tecles fent servir cadenes de text: <code>Space</code>, <code>ArrowLeft</code>, <code>ArrowUp</code>, <code>ArrowRight</code> i <code>ArrowDown</code>:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">export const KEY_CODES = {</div></li><li class="li1"><div class="de1">    32: 'Space',</div></li><li class="li1"><div class="de1">    37: 'ArrowLeft',</div></li><li class="li1"><div class="de1">    38: 'ArrowUp',</div></li><li class="li1"><div class="de1">    39: 'ArrowRight',</div></li><li class="li1"><div class="de1">    40: 'ArrowDown'</div></li><li class="li1"><div class="de1">};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export let KEY_STATUS = {};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">for (let code in KEY_CODES) {</div></li><li class="li1"><div class="de1">    KEY_STATUS[KEY_CODES[code]] = false;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function getCode(event) {</div></li><li class="li1"><div class="de1">    let code;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (event.code !== undefined) {</div></li><li class="li1"><div class="de1">        code = event.code;</div></li><li class="li1"><div class="de1">    } else if (event.keyIdentifier !== undefined) {</div></li><li class="li1"><div class="de1">        code = event.keyIdentifier;</div></li><li class="li1"><div class="de1">    } else if (event.keyCode !== undefined) {</div></li><li class="li1"><div class="de1">        code = KEY_STATUS[event.keyCode];</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    return code;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">document.onkeydown = function (e) {</div></li><li class="li1"><div class="de1">    let code = getCode(e);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (code) {</div></li><li class="li1"><div class="de1">        e.preventDefault();</div></li><li class="li1"><div class="de1">        KEY_STATUS[code] = true;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">document.onkeyup = function (e) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    let code = getCode(e);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (code) {</div></li><li class="li1"><div class="de1">        e.preventDefault();</div></li><li class="li1"><div class="de1">        KEY_STATUS[code] = false;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">};</div></li></ol></pre>

<p>
Com es pot apreciar, només s’exporta l’objecte <code>KEY_STATUS</code>, que inicialment es troba buit i només inclourà les tecles polsades corresponents als codis de <code>KEY_CODES</code>.
</p>

<p>
Per consultar l’estat concret d’un botó, només cal consultar el valor de <code>KEY_STATUS</code>. Per exemple, per saber l’estat de la tecla corresponent a la fletxa esquerra (anomenada <code>ArrowLeft</code> en el codi), només cal consultar l’estat de la manera següent: <code>KEY_STATUS.left</code>. Aquesta consulta retornarà <code>true</code> o <code>false</code> (o <code>undefined</code> si no s’ha premut mai, que és equivalent a <code>false</code>) segons si s’ha premut el botó o no.
</p>

</p>

</div>

<h3><a id="elements_representables_al_joc" >Elements representables al joc</a></h3>
<div class="level3">

<p>
Tots els jocs tenen elements que han de ser representats a la pantalla: fons del joc, jugadors, peces d’un puzle, enemics, bales, efectes… Tots aquests elements tenen una característica en comú: han de poder mostrar-se a la pantalla i han de poder-se eliminar.
</p>

<p>
Per simplificar la implementació pot utilitzar-se una interfície (vegeu la <span class="figref"><a href="#figura u7-22"><span>figura</span></a></span>), que serà implementada per cadascun d’aquests elements. S’ha de disposar d’un mètode d’actualització (<em>update</em> en anglès), que serà cridat cada vegada que es redibuixa el <code>canvas</code>, un mètode per inicialitzar l’element (<em>start</em> en anglès) i un mètode per netejar (<em>clear</em> en anglès) quan calgui eliminar-lo.
</p>
<div class="iocfigure"><a name="figura u7-22"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML interfície RepresentableObject

</figcaption><img src="../media/daw_m06_u7_05_grafisme.png" alt="" /></figure>
</div>
<p>
Cal destacar que JavaScript no admet l’ús d’interfícies i, per tant, <code>RepresentableObject</code> no es troba definit al codi del joc, però forma part del disseny de l’aplicació.
</p>

<p>

<p>
Totes les classes representables es troben al mòdul <code>gameObjects</code>, encara que no totes són exportades:
</p>
<ul>
<li class="level1"><div class="li"> <strong><code>Background</code></strong> (exportada): classe per gestionar el desplaçament del fons.</div>
</li>
<li class="level1"><div class="li"> <strong><code>Sprite</code></strong> (exportada): classe per gestionar les imatges dibuixades i simular l’animació de les naus, bales i explosions.</div>
</li>
<li class="level1"><div class="li"> <strong><code>GameObject</code></strong>: classe base pels objectes que es representen al joc.</div>
</li>
<li class="level1"><div class="li"> <strong><code>MovingGameObject</code></strong>: classe base per als objectes dinàmics representats al joc (els objectes estàtics hereten directament de <code>GameObject</code>).</div>
</li>
<li class="level1"><div class="li"> <strong><code>Explosion</code></strong> (exportada, <code>GameObject</code>): classe per mostrar explosions.</div>
</li>
<li class="level1"><div class="li"> <strong><code>Shot</code></strong> (exportada,<code>MovingGameObject</code>): classe per mostrar una bala.</div>
</li>
<li class="level1"><div class="li"> <strong><code>Spaceship</code></strong> (exportada, <code>MovingGameObject</code>) classe per mostrar les naus.</div>
</li>
<li class="level1"><div class="li"> <strong><code>Player</code></strong> (exportada, <code>Spaceship</code>) classe per representar la nau del jugador.</div>
</li>
</ul>

</p>

</div>

<h4><a id="fons_del_jocbackground" >Fons del joc: Background</a></h4>
<div class="level4">

<p>

<p>
L’element <code>canvas</code> permet dibuixar tant gràfics en 2D com en 3D mitjançant l’<acronym title="Application Programming Interface">API</acronym> WebGL, tot i que aquest últim sistema no es fa servir directament perquè és molt més complex. Tot i així, hi ha motors de jocs com Unity que permeten exportar jocs en 3D i sí que aprofiten aquesta <acronym title="Application Programming Interface">API</acronym>.
</p>

</p>

<p>
El context 2D del <code>canvas</code> permet escriure textos i dibuixar formes  o imatges completes carregades a la memòria (fitxers d’imatge, per exemple). S’ha de tenir en compte que el contingut és estàtic, és a dir, els continguts no són animats, es crea aquesta il·lusió reescrivint-los en diferents posicions o canviant la imatge dibuixada.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar més informació sobre la utilització de l’element <code>canvas</code> a l’enllaç següent: <a href="https://goo.gl/GV9awc" class="urlextern" title="https://goo.gl/GV9awc"  rel="nofollow">goo.gl/GV9awc</a>.
</p>
</div></div>
<p>

<p>
Per exemple, per dibuixar el fons del joc <em>IOC Invaders</em>, s’utilitza una instancia de la classe <code>Background</code>, que emmagatzema la informació sobre 4 imatges que es dibuixen en ordre com si fossin capes (vegeu la <span class="figref"><a href="#figura u7-23"><span>figura</span></a></span>). La primera capa que es dibuixa queda al fons de la pila, la segona capa es dibuixa a sobre, i així contínuament.
</p>

</p>
<div class="iocfigure"><a name="figura u7-23"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML de la classe Background i les seves associacions

</figcaption><img src="../media/daw_m06_u7_06_grafisme.png" alt="" /></figure>
</div>
<p>

<p>
A continuació podeu veure el codi de la classe <code>Background</code> que es troba al mòdul <code>gameObjects</code>, utilitzat a <em>IOC Invaders</em> i que inclou un fons amb desplaçament infinit amb 4 nivells de profunditat:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">export class Background {</div></li><li class="li1"><div class="de1">    layers = {};</div></li><li class="li1"><div class="de1">    gameContext = null;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(gameContext) {</div></li><li class="li1"><div class="de1">        this.gameContext = gameContext;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    move(layer, deltaTime) {</div></li><li class="li1"><div class="de1">        layer.position.x += layer.speed.x * deltaTime;</div></li><li class="li1"><div class="de1">        layer.position.y += layer.speed.y * deltaTime;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (layer.position.x &lt; -layer.image.width || layer.position.x &gt; layer.image.width) {</div></li><li class="li1"><div class="de1">            layer.position.x = 0;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (layer.position.y &lt; -layer.image.height || layer.position.y &gt; layer.image.height) {</div></li><li class="li1"><div class="de1">            layer.position.y = 0;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    render(layer) {</div></li><li class="li1"><div class="de1">        // Imatge actual</div></li><li class="li1"><div class="de1">        this.gameContext.drawImage(</div></li><li class="li1"><div class="de1">            layer.image, layer.position.x, layer.position.y, layer.image.width, layer.image.height);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Següent imatge</div></li><li class="li1"><div class="de1">        this.gameContext.drawImage(</div></li><li class="li1"><div class="de1">            layer.image, layer.position.x + layer.image.width - 1,</div></li><li class="li1"><div class="de1">            layer.position.y, layer.image.width, layer.image.height);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(deltaTime) {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; this.layers.length; i++) {</div></li><li class="li1"><div class="de1">            this.move(this.layers[i], deltaTime);</div></li><li class="li1"><div class="de1">            this.render(this.layers[i]);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    start(data) {</div></li><li class="li1"><div class="de1">        this.layers = data.layers;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; this.layers.length; i++) {</div></li><li class="li1"><div class="de1">            this.layers[i].image = assetManager.getImage(this.layers[i].id);</div></li><li class="li1"><div class="de1">            this.layers[i].position = {x: 0, y: 0}</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
En tractar-se d’una classe, tots els mètodes i propietats són públics; en cas de requerir que fossin privats, caldria utilitzar alguna altra tècnica com l’aplicació de <em>clausures</em>, la instanciació d’objectes mitjançant un patró funcional o utilitzar funcions i variables del mòdul en lloc d’afegir-les dintre de la classe.
</p>

</p>
<div class="iocnote"><div class="ioccontent">
<p>
<code>Vector2</code> és una estructura de dades que representa un vector de dues dimensions amb les propietats: <code>x</code> i <code>y</code>.
</p>
</div></div>
<p>

</p>

<p>

<p>
Cal destacar que el mètode <code>update()</code> ha de rebre el paràmetre <code>deltaTime</code>, que és el temps que ha passat d’ençà que es va dibuixar per darrera vegada en mil·lisegons. Aquest valor ens permet ajustar la posició independentment de les capacitats de renderització del dispositiu, ja que en cas contrari en dispositius més potents el joc s’executaria més de pressa i en dispositius més lents el joc aniria més lentament.
</p>

<p>
Cada vegada que s’invoca el mètode <code>update()</code>, primer s’invoca el mètode <code>move()</code>, que desplaça la posició de cada capa segons la velocitat establerta modificada pel <code>deltaTime</code> i, seguidament, s’invoca el mètode <code>render()</code>, que les redibuixa en la nova posició mitjançant el mètode del context <code>drawImage()</code> i que requereix unes coordenades, la mida i la imatge a dibuixar.
</p>

</p>
<div class="ioctext"><div class="ioccontent"><p class="ioctitle">Exposar una propietat o mètode</p>
<p>
En programació orientada a objectes, <em>exposar</em> fa referència a mètodes o propietats a les quals es pot accedir des d’altres punts del programari, i la resta de la implementació queda inaccessible.
</p>
</div></div>
<p>
Fixeu-vos que es dibuixa la mateixa imatge dos cops, una a continuació de l’altra. D’aquesta manera s’aconsegueix un efecte de bucle, ja que no es pot apreciar on acaba una i on comença la següent. Aquest efecte es podria millorar incloent imatges més llargues o fent servir un <em>array</em> d’imatges que anés alternant-se.
</p>

<p>
En aquest cas, com que la imatge de fons ocupa tot el <code>canvas</code> no cal netejar-lo, però hi ha casos en què és convenient utilitzar el mètode <code>clearRect()</code> del context per eliminar el contingut anterior (totalment o parcialment).
</p>

<p>

<p>
Cal destacar que les imatges utilitzades s’obtenen d’un gestor de recursos (el mòdul <code>assetManager</code>) mitjançant el mètode <code>getImage()</code>.
</p>

</p>

<p>
 D’aquesta manera, l’instància de <code>Background</code> no necessita saber com ni on s’ha generat, només ha de passar al mètode l’identificador de la imatge que necessita.
</p>

</div>

<h4><a id="sprites" >Sprites</a></h4>
<div class="level4">

<p>
Un altre element clau per representar a la pantalla són els <em>sprites</em>. S’acostuma a utilitzar el mateix terme, sigui una sola imatge o un conjunt que forma una animació. En el cas de constar de múltiples imatges, poden dibuixar-se seqüencialment per simular diferents moviments. Per exemple, la nau que es mostra a la <span class="figref"><a href="#figura u7-24"><span>figura</span></a></span> simula l’efecte dels propulsors fent augmentar i disminuir la flama.
</p>
<div class="iocfigure"><a name="figura u7-24"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

 Sprite d’un alien de tipus A del joc “IOC Invaders”

</figcaption><img src="../media/24-alien-sprite.png" alt="" /></figure>
</div><div class="iocimportant"><div class="ioccontent">
<p>
Un <strong><em>sprite</em></strong> és un mapa de bits bidimensional utilitzats per primera vegada a les consoles i ordenadors de 8 bits.
</p>
</div></div>
<p>
En jocs més avançats, cada personatge o objecte pot tenir associats múltiples <em>sprites</em>, de manera que pot haver-hi diferents animacions per a les accions que es poden portar a terme: atacar, caminar, córrer, saltar… I, per descomptat, tots els elements poden utilitzar-los: el personatge del jugador, enemics, bales, explosions, decoracions… Només cal fer una ullada als jocs d’ordinadors i videoconsoles de 8 i 16 bits (fins i tot de màquines recreatives) per veure’n les possibilitats.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Es pot trobar més informació sobre els <em>sprites</em> a l’enllaç següent: <a href="https://en.wikipedia.org/wiki/Sprite_(computer_graphics)" class="urlextern" title="https://en.wikipedia.org/wiki/Sprite_(computer_graphics)"  rel="nofollow">goo.gl/55RIoP</a>.
</p>
</div></div>
<p>
La gestió d’aquests elements és més complicada que en el cas dels fons perquè requereixen càlculs addicionals per determinar si s’han de reproduir infinitament i quant de temps s’ha de mostrar cada imatge que compon l’animació. 
</p>
<div class="iocnote"><div class="ioccontent">
<p>
Si un joc corre a 60 FPS, es mostrarà una imatge cada 16 mil·lisegons aproximadament.
</p>
</div></div>
<p>

<p>
A la <span class="figref"><a href="# figura u7-25"><span>figura</span></a></span> podeu veure el diagrama corresponent a un objecte <code>Sprite</code>, generat per classe <code>Sprite</code> del joc <em>IOC Invaders</em> i que correspon al codi següent:
</p>

</p>
<div class="iocfigure"><a name="figura u7-25"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML de la classe Sprite

</figcaption><img src="../media/daw_m06_u7_07_grafisme.png" alt="" /></figure>
</div>
<p>
<pre class="code java"><ol><li class="li1"><div class="de1">export class Sprite {</div></li><li class="li1"><div class="de1">    frameIndex = 0;</div></li><li class="li1"><div class="de1">    ticksPerFrame = 0;</div></li><li class="li1"><div class="de1">    numberOfFrames = 1;</div></li><li class="li1"><div class="de1">    image = null;</div></li><li class="li1"><div class="de1">    width = 0;</div></li><li class="li1"><div class="de1">    height = 0;</div></li><li class="li1"><div class="de1">    loop = true;</div></li><li class="li1"><div class="de1">    tickCount = 0;</div></li><li class="li1"><div class="de1">    position = {x: 0, y: 0};</div></li><li class="li1"><div class="de1">    size = {width: 0, height: 0};</div></li><li class="li1"><div class="de1">    isDone = false;</div></li><li class="li1"><div class="de1">    gameContext = null;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(gameContext, options) {</div></li><li class="li1"><div class="de1">        this.gameContext = gameContext;</div></li><li class="li1"><div class="de1">        this.frameIndex = 0;</div></li><li class="li1"><div class="de1">        this.ticksPerFrame = options.ticksPerFrame || 0;</div></li><li class="li1"><div class="de1">        this.numberOfFrames = options.numberOfFrames || 1;</div></li><li class="li1"><div class="de1">        this.image = options.image;</div></li><li class="li1"><div class="de1">        this.width = options.image.width;</div></li><li class="li1"><div class="de1">        this.height = options.image.height;</div></li><li class="li1"><div class="de1">        this.loop = options.loop === undefined ? true : options.loop;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.position = options.position || {x: 0, y: 0};</div></li><li class="li1"><div class="de1">        this.size = {width: this.width / this.numberOfFrames, height: this.height};</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update() {</div></li><li class="li1"><div class="de1">        this.tickCount++;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.tickCount &gt; this.ticksPerFrame) {</div></li><li class="li1"><div class="de1">            this.tickCount = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            if (this.frameIndex &lt; this.numberOfFrames - 1) {</div></li><li class="li1"><div class="de1">                this.frameIndex += 1;</div></li><li class="li1"><div class="de1">            } else {</div></li><li class="li1"><div class="de1">                this.isDone = !this.loop;</div></li><li class="li1"><div class="de1">                this.frameIndex = 0;</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    render() {</div></li><li class="li1"><div class="de1">        if (this.isDone) {</div></li><li class="li1"><div class="de1">            return;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.gameContext.drawImage(</div></li><li class="li1"><div class="de1">            this.image,</div></li><li class="li1"><div class="de1">            this.frameIndex * this.width / this.numberOfFrames,</div></li><li class="li1"><div class="de1">            0,</div></li><li class="li1"><div class="de1">            this.width / this.numberOfFrames,</div></li><li class="li1"><div class="de1">            this.height,</div></li><li class="li1"><div class="de1">            this.position.x,</div></li><li class="li1"><div class="de1">            this.position.y,</div></li><li class="li1"><div class="de1">            this.width / this.numberOfFrames,</div></li><li class="li1"><div class="de1">            this.height);</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</p>

<p>
Com es pot apreciar, la tasca principal d’aquesta classe és determinar si s’ha completat l’animació i si cal repetir-la i dibuixar la imatge que correspongui. Fixeu-vos que en el cas que una imatge contingui una animació, aquesta no es dibuixa completa sinó que només se’n dibuixa el fragment corresponent.
</p>

<p>
En aquest cas, per simplificar, s’ha considerat que totes les imatges que formen l’animació tenen la mateixa mida; així doncs, només cal saber quin és el <code>frame</code> intern que cal dibuixar i calcular-ne la posició dins de la imatge.
</p>

<p>
Al mètode  <code>update()</code> es comprova primer si aquest <em>sprite</em> ja ha estat actualitzat (aquesta propietat correspon al mòdul del joc) i, en cas contrari, s’afegeix a l’<em>array</em> abans de continuar amb l’actualització. Aquesta és una optimització que s’ha aplicat a aquest joc per evitar que s’actualitzin múltiples vegades per <em>frame</em> alguns elements.
</p>

<p>

<p>
Cal tenir en compte que en aquesta implementació no s’està aplicant el <code>deltaTime</code> i, per tant, les animacions seran més ràpides o més lentes segons el dispositiu en què s’executi.
</p>

</p>

</div>

<h4><a id="objectes_de_jocgameobject" >Objectes de joc: &#039;GameObject&#039;</a></h4>
<div class="level4">

<p>

<p>
Alguns motors de desenvolupament de jocs, com Unity, utilitzen una classe especial d’objectes anomenats <em>objectes de joc</em> (<em>game objects</em> en anglès). Aquests objectes són elements que poden ser representats a la pantalla i que han de mantenir-se actualitzats contínuament. Això s’aconsegueix invocant el seu mètode <code>update()</code> (entre d’altres) a cada iteració del bucle principal del joc i passant com argument el temps que ha passat des de la darrera representació
</p>

</p>

<p>
.
</p>

<p>
Per exemple, un objecte de tipus bala canviarà la seva posició, actualitzarà l’animació de l’<em>sprite</em> que el representa, comprovarà si ha impactat a un adversari i si ha sortit de la pantalla; un enemic, a més a més, determinarà si cal disparar de nou, i una explosió només actualitzarà l’animació fins que aquesta acabi i desaparegui.
</p>

<p>
Tot i que els objectes de tipus <code>Background</code> també es poden considerar objectes de joc (corresponents als objectes <code>GameObject</code> que podeu veure a la <span class="figref"><a href="#figura u7-26"><span>figura</span></a></span>), a <em>IOC Invaders</em> s’ha decidit diferenciar-los per generalitzar propietats comunes a: explosions, bales i naus.
</p>
<div class="iocfigure"><a name="figura u7-26"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML de la classe GameObject i les seves relacions

</figcaption><img src="../media/daw_m06_u7_08_grafisme.png" alt="" /></figure>
</div>
<p>
Vegeu a continuació la implementació de la classe <code>Constructor</code> del joc <em>IOC Invaders</em>:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">class GameObject {</div></li><li class="li1"><div class="de1">    alive = false;</div></li><li class="li1"><div class="de1">    type = null;</div></li><li class="li1"><div class="de1">    position = null;</div></li><li class="li1"><div class="de1">    sprite = null;</div></li><li class="li1"><div class="de1">    extra = {};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(options) {</div></li><li class="li1"><div class="de1">        // aqui no fem res amb les opcions</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    updateSprite() {</div></li><li class="li1"><div class="de1">        this.sprite.position = this.position;</div></li><li class="li1"><div class="de1">        this.sprite.update();</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    render() {</div></li><li class="li1"><div class="de1">        this.sprite.render()</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    start(data) {</div></li><li class="li1"><div class="de1">        console.error(&quot;Error: start. Aquest mètode no està implementat&quot;, this);</div></li><li class="li1"><div class="de1">        return this;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(deltaTime) {</div></li><li class="li1"><div class="de1">        console.error(&quot;Error: update. Aquest mètode no està implementat&quot;, this);</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    clear() {</div></li><li class="li1"><div class="de1">        console.error(&quot;Error: clear. Aquest mètode no està implementat&quot;, this);</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Cal destacar que <code>GameObject</code> s’ha de considerar una classe abstracta (tot i que a JavaScript no hi ha aquesta distinció). És a dir, no s’ha d’instanciar directament sinó que altres objectes l’utilitzen com a classe pare o superclasse, per aquesta raó no s’exporta del mòdul.
</p>

</p>

</div>

<h4><a id="tipus_especialitzats_de_gameobject_a_ioc_invaders" >Tipus especialitzats de &#039;GameObject&#039; a &quot;IOC Invaders&quot;</a></h4>
<div class="level4">

<p>

<p>
Per facilitar la reutilització del codi, s’ha creat una jerarquia d’objectes; d’aquesta manera l’estructura és molt més clara i s’evita la duplicació de codi.
</p>

</p>

<p>
Per una banda, s’han diferenciat les explosions d’altres elements del joc, ja que les característiques de les explosions són idèntiques a les de <code>GameObject</code> i es limita a implementar els mètodes <code>update()</code>, <code>start()</code> i <code>clear()</code> de la interfície <code>RepresentableObject</code>, tal com es mostra a la <span class="figref"><a href="#figura u7-27"><span>figura</span></a></span>. Podeu veure la implementació en el següent bloc codi:
</p>
<div class="iocfigure"><a name="figura u7-27"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML objecte de tipus Explosion i les seves relacions

</figcaption><img src="../media/daw_m06_u7_09_grafisme.png" alt="" /></figure>
</div>
<p>
<pre class="code java"><ol><li class="li1"><div class="de1">export class Explosion extends GameObject {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    start(data) {</div></li><li class="li1"><div class="de1">        this.alive = true;</div></li><li class="li1"><div class="de1">        this.type = data.type;</div></li><li class="li1"><div class="de1">        this.position = data.position;</div></li><li class="li1"><div class="de1">        this.sprite = assetManager.getSprite(data.sprite);</div></li><li class="li1"><div class="de1">        this.sprite.isDone = false;</div></li><li class="li1"><div class="de1">        assetManager.getSound(data.sound);</div></li><li class="li1"><div class="de1">        return this;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    clear() {</div></li><li class="li1"><div class="de1">        this.alive = false;</div></li><li class="li1"><div class="de1">        this.type = null;</div></li><li class="li1"><div class="de1">        this.position = {x: 0, y: 0};</div></li><li class="li1"><div class="de1">        this.sprite = null;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(deltaTime) {</div></li><li class="li1"><div class="de1">        if (this.sprite.isDone) {</div></li><li class="li1"><div class="de1">            return true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">        this.updateSprite();</div></li><li class="li1"><div class="de1">        this.render();</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Per altra banda, es troben els objectes que s’han de moure i, per consegüent, han de controlar-se si es troben fora de la pantalla o si han col·lidit. Per generalitzar les característiques comunes d’aquest tipus d’objectes a <em>IOC Invaders</em> s’ha afegit la classe <code>MovingGameObject</code> (veieu la <span class="figref"><a href="#figura u7-28"><span>figura</span></a></span>) amb el codi que podeu trobar a continuació:
</p>

</p>
<div class="iocfigure"><a name="figura u7-28"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML de la classe MovingGameObject i les seves relacions

</figcaption><img src="../media/daw_m06_u7_10_grafisme.png" alt="" /></figure>
</div>
<p>
<pre class="code java"><ol><li class="li1"><div class="de1">const MAX_TIME_OUTSIDE_BOUNDARIES = 180;// nombre de frames fora de la pantalla avans de esborrar-lo. a 60 FPS això equival a 3s</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">class MovingGameObject extends GameObject {</div></li><li class="li1"><div class="de1">    isDestroyed = false;</div></li><li class="li1"><div class="de1">    speed = null;</div></li><li class="li1"><div class="de1">    outsideBoundariesTime = 0;</div></li><li class="li1"><div class="de1">    gameWidth = 0;</div></li><li class="li1"><div class="de1">    gameHeight = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(options) {</div></li><li class="li1"><div class="de1">        super(options);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.gameWidth = options.gameWidth;</div></li><li class="li1"><div class="de1">        this.gameHeight = options.gameHeight;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    move(deltaTime) {</div></li><li class="li1"><div class="de1">        console.error(&quot;Error: move. Aquest mètode no està implementat&quot;);</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    isOutsideBoundaries() {</div></li><li class="li1"><div class="de1">        if (this.position.x &gt;= this.gameWidth</div></li><li class="li1"><div class="de1">            || this.position.x &lt;= -this.sprite.size.width</div></li><li class="li1"><div class="de1">            || this.position.y &gt; this.gameWidth</div></li><li class="li1"><div class="de1">            || this.position.y &lt; -this.sprite.size.height) {</div></li><li class="li1"><div class="de1">            this.outsideBoundariesTime++;</div></li><li class="li1"><div class="de1">        } else {</div></li><li class="li1"><div class="de1">            this.outsideBoundariesTime = 0;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        return this.outsideBoundariesTime &gt;= MAX_TIME_OUTSIDE_BOUNDARIES;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    isCollidingWith(gameObject) {</div></li><li class="li1"><div class="de1">        return (this.position.x &lt; gameObject.position.x + gameObject.sprite.size.width</div></li><li class="li1"><div class="de1">            &amp;&amp; this.position.x + this.sprite.size.width &gt; gameObject.position.x</div></li><li class="li1"><div class="de1">            &amp;&amp; this.position.y &lt; gameObject.position.y + gameObject.sprite.size.height</div></li><li class="li1"><div class="de1">            &amp;&amp; this.position.y + this.sprite.size.height &gt; gameObject.position.y);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</p>

<p>
Fixeu-vos que els objectes generats s’han de tractar com si fossin abstractes, ja que requereix la implementació de la funció <code>move()</code> a més a més dels mètodes <code>update()</code>, <code>start()</code> i <code>clear()</code> de la interfície <code>RepresentableGameObject</code>. Per aquest motiu la classe no s’exporta, només és utilitzada com a base per altres classes del mòdul.
</p>

<p>

<p>
Com es pot apreciar, les classes que heretin de <code>MovingGameObject</code> inclouen, a més del mètode per moure’s, els mètodes <code>isOutsideBoundaries()</code> i <code>isCollidingWith()</code> per comprovar si l’objecte del joc es troba dins dels límits de la pantalla o si ha col·lidit amb un altre objecte.
</p>

<p>
Tot i que les classes de JavaScript no admeten propietats constants, s’ha aprofitat que la classe es troba encapsulada en un mòdul i s’ha declarat la constant en aquest, fora de la classe, d’aquesta manera es pot utilitzar sense problemes.
</p>

</p>

<p>
La resta de classes segueixen el mateix sistema, només cal destacar que tant els enemics com els jugadors són herència de la mateixa classe (<code>SpaceShip</code>), amb la diferència que les naus enemigues disparen aleatòriament i la nau del jugador es controla amb el teclat. A la <span class="figref"><a href="#figura u7-29"><span>figura</span></a></span> podeu veure la jerarquia completa d’objectes representables. 
</p>

<p>

<p>
A continuació, també trobareu el codi de les classes <code>Shot</code>, <code>SpaceShip</code> i <code>Player</code>:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">export class Shot extends MovingGameObject {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    start(data) {</div></li><li class="li1"><div class="de1">        this.alive = true;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.type = data.type;</div></li><li class="li1"><div class="de1">        this.position = data.position;</div></li><li class="li1"><div class="de1">        this.sprite = assetManager.getSprite(data.sprite);</div></li><li class="li1"><div class="de1">        assetManager.getSound(data.sound);</div></li><li class="li1"><div class="de1">        this.speed = data.speed;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Dades i Funcions especifiques de cada tipus de enemic</div></li><li class="li1"><div class="de1">        this.extra = data.extra || {};</div></li><li class="li1"><div class="de1">        this.move = data.move.bind(this);</div></li><li class="li1"><div class="de1">        this.outsideBoundariesTime = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        return this;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    clear() {</div></li><li class="li1"><div class="de1">        this.isDestroyed = false;</div></li><li class="li1"><div class="de1">        this.alive = false;</div></li><li class="li1"><div class="de1">        this.outsideBoundariesTime = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.type = null;</div></li><li class="li1"><div class="de1">        this.position = {x: 0, y: 0};</div></li><li class="li1"><div class="de1">        this.sprite = null;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.speed = {x: 0, y: 0};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Dades i Funcions especifiques de cada tipus de enemic</div></li><li class="li1"><div class="de1">        this.extra = {};</div></li><li class="li1"><div class="de1">        this.move = null;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(deltaTime) {</div></li><li class="li1"><div class="de1">        if (this.isDestroyed) {</div></li><li class="li1"><div class="de1">            return true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.updateSprite();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.move(deltaTime);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.isOutsideBoundaries()) {</div></li><li class="li1"><div class="de1">            return true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.render();</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export class Spaceship extends MovingGameObject {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    bulletPool = null;</div></li><li class="li1"><div class="de1">    explosionPool = null;</div></li><li class="li1"><div class="de1">    cannon = null;</div></li><li class="li1"><div class="de1">    explosion = null;</div></li><li class="li1"><div class="de1">    speed = {x: 0, y: 0};</div></li><li class="li1"><div class="de1">    points = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(options) {</div></li><li class="li1"><div class="de1">        super(options);</div></li><li class="li1"><div class="de1">        this.bulletPool = options.pool.bullet;</div></li><li class="li1"><div class="de1">        this.explosionPool = options.pool.explosion;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    // @protected</div></li><li class="li1"><div class="de1">    fire() {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; this.cannon.length; i++) {</div></li><li class="li1"><div class="de1">            this.shoot(this.cannon[i]);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    // @protected</div></li><li class="li1"><div class="de1">    shoot(cannon) {</div></li><li class="li1"><div class="de1">        let origin;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (Math.random() &lt; cannon.fireRate / 100) {</div></li><li class="li1"><div class="de1">            origin = {x: this.position.x + cannon.position.x, y: this.position.y + cannon.position.y};</div></li><li class="li1"><div class="de1">            this.bulletPool.instantiate(cannon.bullet, origin, cannon.direction);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    start(data) {</div></li><li class="li1"><div class="de1">        this.alive = true;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.type = data.type;</div></li><li class="li1"><div class="de1">        this.position = data.position;</div></li><li class="li1"><div class="de1">        this.sprite = assetManager.getSprite(data.sprite);</div></li><li class="li1"><div class="de1">        this.cannon = data.cannon;</div></li><li class="li1"><div class="de1">        this.explosion = data.explosion;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.speed = data.speed;</div></li><li class="li1"><div class="de1">        this.points = data.points;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.outsideBoundariesTime = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Dades i Funcions especifiques de cada tipus de enemic</div></li><li class="li1"><div class="de1">        this.extra = data.extra || {};</div></li><li class="li1"><div class="de1">        if (data.move) {</div></li><li class="li1"><div class="de1">            this.move = data.move.bind(this);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        return this;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    clear() {</div></li><li class="li1"><div class="de1">        this.isDestroyed = false;</div></li><li class="li1"><div class="de1">        this.alive = false;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.type = null;</div></li><li class="li1"><div class="de1">        this.position = {x: 0, y: 0};</div></li><li class="li1"><div class="de1">        this.sprite = null;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.speed = {x: 0, y: 0};</div></li><li class="li1"><div class="de1">        this.points = 0;</div></li><li class="li1"><div class="de1">        this.cannon = null;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Dades i Funcions especifiques de cada tipus de enemic</div></li><li class="li1"><div class="de1">        this.extra = null;</div></li><li class="li1"><div class="de1">        this.move = null;</div></li><li class="li1"><div class="de1">        this.outsideBoundariesTime = 0;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(deltaTime) {</div></li><li class="li1"><div class="de1">        if (this.isDestroyed) {</div></li><li class="li1"><div class="de1">            this.explosionPool.instantiate(this.explosion, this.position);</div></li><li class="li1"><div class="de1">            return true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.updateSprite();</div></li><li class="li1"><div class="de1">        this.move(deltaTime);</div></li><li class="li1"><div class="de1">        this.fire();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.isOutsideBoundaries()) {</div></li><li class="li1"><div class="de1">            return true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.render();</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export class Player extends Spaceship {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(options) {</div></li><li class="li1"><div class="de1">        super(options);</div></li><li class="li1"><div class="de1">        this.start(getEntity('player', options.position, options.speed));</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    getInput(deltaTime) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (KEY_STATUS.ArrowLeft) {</div></li><li class="li1"><div class="de1">            this.position.x -= this.speed.x * deltaTime;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        } else if (KEY_STATUS.ArrowRight) {</div></li><li class="li1"><div class="de1">            this.position.x += this.speed.x * deltaTime;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (KEY_STATUS.ArrowUp) {</div></li><li class="li1"><div class="de1">            this.position.y -= this.speed.y * deltaTime;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        } else if (KEY_STATUS.ArrowDown) {</div></li><li class="li1"><div class="de1">            this.position.y += this.speed.y * deltaTime;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (KEY_STATUS.Space &amp;&amp; !this.isDestroyed) {</div></li><li class="li1"><div class="de1">            this.fire();</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // S'evita que surti de la pantalla</div></li><li class="li1"><div class="de1">        this.position.x = this.position.x.clamp(0, this.gameWidth - this.sprite.size.width);</div></li><li class="li1"><div class="de1">        this.position.y = this.position.y.clamp(0, this.gameHeight - this.sprite.size.height);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    updateCannon() {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; this.cannon.length; i++) {</div></li><li class="li1"><div class="de1">            if (this.cannon[i].lastShot === undefined) {</div></li><li class="li1"><div class="de1">                this.cannon[i].lastShot = this.cannon[i].fireRate + 1;</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">            this.cannon[i].lastShot++;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    shoot(cannon) {</div></li><li class="li1"><div class="de1">        let origin;</div></li><li class="li1"><div class="de1">        if (cannon.lastShot &gt; cannon.fireRate) {</div></li><li class="li1"><div class="de1">            cannon.lastShot = 0;</div></li><li class="li1"><div class="de1">            origin = {x: this.position.x + cannon.position.x, y: this.position.y + cannon.position.y};</div></li><li class="li1"><div class="de1">            this.bulletPool.instantiate(cannon.bullet, origin, cannon.direction);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(deltaTime) {</div></li><li class="li1"><div class="de1">        this.updateCannon();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Si ha sigut impactat, s'elimina. Aquí també es podria afegir la animació de la explosió</div></li><li class="li1"><div class="de1">        if (this.isDestroyed) {</div></li><li class="li1"><div class="de1">            this.explosionPool.instantiate(this.explosion, this.position);</div></li><li class="li1"><div class="de1">            return true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.getInput(deltaTime);</div></li><li class="li1"><div class="de1">        this.updateSprite();</div></li><li class="li1"><div class="de1">        this.render();</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Com podeu veure, aquestes classes inclouen la utilització d’objectes de classe <code>PoolGameObject</code> (<code>explosionPool</code> i <code>bulletPool</code>). 
</p>

</p>

<p>
Aquests objectes són un tipus especial de col·lecció que permet reduir la necessitat de crear objectes nous reutilitzant els que es troben al <em>pool</em> (conjunt d’objectes) en lloc de crear-ne de nous. Així, quan un objecte ja no és necessari (per exemple, una bala que surt de la pantalla o una nau que és destruïda), aquests objectes són marcats com a disponibles al <em>pool</em> i poden tornar a utilitzar-se quan calgui instanciar un nou objecte d’aquest tipus.
</p>

<p>
Fixeu-vos que la finalitat de cada objecte és molt clara tot i que aquesta jerarquia és força extensa: inclou classes abstractes i una interfície. A més a més, s’ha pogut evitar la duplicació de codi en fer les implementacions dels mètodes comuns a les classes pare o delegant-les a altres classes (per exemple, tot el comportament relatiu als <em>sprites</em> és gestionat per la classe <code>Sprite</code>).
</p>
<div class="iocfigure"><a name="figura u7-29"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML de la jerarquia completa de RepresentableObject

</figcaption><img src="../media/daw_m06_u7_11_grafisme.png" alt="" /></figure>
</div>
<p>
Cal destacar que quan a un diagrama apareix un mètode que ja es troba a una classe pare és perquè aquest mètode el sobreescriu (<em>override</em> en anglès). És a dir, quan s’invoca aquest mètode el codi executat serà el de la classe concreta on s’ha fet la invocació i no pas el de la classe pare.
</p>

</div>

<h3><a id="gestor_de_recursos" >Gestor de recursos</a></h3>
<div class="level3">

<p>
Habitualment, un joc requerirà utilitzar imatges, <em>sprites</em>, efectes de so, música… A aquests elements se’ls coneix en conjunt com a recursos. 
</p>

<p>

<p>
Com que aquests recursos poden ser requerits per moltes classes diferents és recomanable utilitzar una classe o mòdul per gestionar-los.
</p>

</p>

<p>
 Per exemple, un mateix efecte de so pot ser utilitzat per múltiples explosions al mateix temps i tots els enemics del mateix tipus faran servir el mateix <em>sprite</em>.
</p>

<p>
A JavaScript és especialment important fer-ho així, perquè s’han d’implementar mecanismes especials (com els gestors de descàrrega) per controlar quan s’han acabat de descarregar i inicialitzar tots els recursos, ja que la descàrrega es fa de manera asíncrona i l’execució del codi podria continuar abans d’haver descarregat totes les imatges per exemple.
</p>

<p>

<p>
A <em>IOC Invaders</em> la implementació del gestor de recursos (podeu veure el diagrama UML del mòdul <code>assetManager</code> a la <span class="figref"><a href="#figura u7-30"><span>figura</span></a></span>) inclou la gestió de descàrregues (només es controlen les imatges), la generació dels objectes necessaris, la funcionalitat d’obtenció de recursos i la reproducció d’àudio. Això s’ha fet així per simplificar el codi però és recomanable que cada classe o mòdul només tingui una responsabilitat.
</p>

</p>
<div class="iocfigure"><a name="figura u7-30"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML del mòdul assetManager (representant com a públiques les funcions exportades)

</figcaption><img src="../media/daw_m06_u7_12_grafisme.png" alt="" /></figure>
</div>
<p>

<p>
Com que en aquest mòdul s’han barrejat múltiples funcionalitats, a continuació podeu trobar un resum de les funcions i variables dividits segons la seva utilitat:
</p>

</p>

<p>

</p>
<ul>
<li class="level1"><div class="li"> Gestió de descàrregues:</div>
<ul>
<li class="level2"><div class="li"> <strong><code>queue</code></strong>: llista d’elements per descarregar o generar.</div>
</li>
<li class="level2"><div class="li"> <strong><code>successCount</code></strong> i <strong>errorCount</strong>: comptadors de recursos descarregats amb èxit o error.</div>
</li>
<li class="level2"><div class="li"> <strong><code>isDone</code></strong>: mètode que determina si ja s’ha finalitzat la descàrrega dels recursos.</div>
</li>
<li class="level2"><div class="li"> <strong><code>progressCallback</code></strong>: funció cridada per mostrar el progrés de la descàrrega.</div>
</li>
<li class="level2"><div class="li"> <strong><code>updateProgress</code></strong>: mètode encarregat d’actualitzar el progrés de la descàrrega.</div>
</li>
<li class="level2"><div class="li"> <strong><code>queuesAsset</code></strong>: mètode per afegir recursos a la llista de descàrrega.</div>
</li>
<li class="level2"><div class="li"> <strong><code>downloadAll</code></strong>: mètode per iniciar la descàrrega dels recursos i engegar la generació dels objectes.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Generació dels objectes:</div>
<ul>
<li class="level2"><div class="li"> <strong><code>cache<strong>: és la col·lecció d’objectes generats.
    * </strong></code>generateSprites<code><strong>: genera múltiples còpies de cada <em>sprite</em> per ser utilitzades com a <em>pool</em>.
    * </strong></code>generateSounds<code><strong>: genera múltiples còpies de cada efecte de so per generar un <em>pool</em> i poder reproduir-lo més d’una vegada simultàniament.
    * </strong></code>generateMusic<code><strong>: genera un element d’àudio per a cada objecte (només se’n necessita un en cada moment).
  * Servei de recursos:
    * </strong></code>getImage<code><strong>: retorna la imatge indicada.
    * </strong></code>getSprite<code><strong>: retorna el primer <em>sprite</em> lliure del tipus indicat al <em>pool</em>.
  * Reproducció d’àudio:
    * </strong></code>currentSong<code><strong>: identifica la música que es reprodueix en un moment concret.
    * </strong></code>getSound<code><strong>: reprodueix el primer so del tipus indicat que es trobi lliure al <em>pool</em> corresponent.
    * </strong></code>getMusic<code><strong>: reprodueix el fitxer de música indicat i el reinicia si ja estava reproduint-se.
    * </strong></code>resetMusic<code><strong>: atura la música i la reinicialitza.
    * </strong></code>fadeInAudio<code><strong>: abaixa el volum de tots els efectes de so a 0.
    * </strong>‘fadeOutAudio</code></strong>: restaura el volum de tots els efectes de so.</div>
</li>
<li class="level2"><div class="li"> <strong><code>timeIntervals</code></strong>: són els temporitzadors utilitzats pel sistema de baixada i restauració del volum dels sons actius.</div>
</li>
<li class="level2"><div class="li"> <strong><code>clearInterva</code></strong>: elimina els temporitzadors actius.</div>
</li>
</ul>
</li>
</ul>

<p>
Com que l’única raó per la qual es “demana” un recurs d’àudio és per reproduir-lo, a <em>IOC Invaders</em> s’ha decidit reproduir-los automàticament en lloc de retornar-los quan s’invoquen els mètodes <code>getSound()</code> i <code>getMusic()</code>.
</p>

<p>

<p>
A continuació podeu trobar el codi complet del mòdul <code>assetManager</code>:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">import {Sprite} from &quot;./gameObjects.js&quot;;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">let successCount = 0,</div></li><li class="li1"><div class="de1">    errorCount = 0,</div></li><li class="li1"><div class="de1">    currentTrack;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">const queue = {</div></li><li class="li1"><div class="de1">        images: [],</div></li><li class="li1"><div class="de1">        sprites: [],</div></li><li class="li1"><div class="de1">        sounds: [],</div></li><li class="li1"><div class="de1">        music: []</div></li><li class="li1"><div class="de1">    },</div></li><li class="li1"><div class="de1">    cache = {</div></li><li class="li1"><div class="de1">        images: {},</div></li><li class="li1"><div class="de1">        sprites: {},</div></li><li class="li1"><div class="de1">        sounds: {},</div></li><li class="li1"><div class="de1">        music: {}</div></li><li class="li1"><div class="de1">    },</div></li><li class="li1"><div class="de1">    timeIntervals = {},</div></li><li class="li1"><div class="de1">    subscribers = new Set();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function subscribe(func) {</div></li><li class="li1"><div class="de1">    subscribers.add(func);</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function updateProgress() {</div></li><li class="li1"><div class="de1">    for (const func of subscribers) {</div></li><li class="li1"><div class="de1">        func(successCount + errorCount, queue.images.length);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function generateSprites(gameContext) {</div></li><li class="li1"><div class="de1">    let pool, poolSize;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    for (let i = 0; i &lt; queue.sprites.length; i++) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        pool = [];</div></li><li class="li1"><div class="de1">        poolSize = 10;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        for (let j = 0; j &lt; poolSize; j++) {</div></li><li class="li1"><div class="de1">            pool.push(new Sprite(gameContext, {</div></li><li class="li1"><div class="de1">                    image: getImage(queue.sprites[i].id),</div></li><li class="li1"><div class="de1">                    numberOfFrames: queue.sprites[i].numberOfFrames,</div></li><li class="li1"><div class="de1">                    ticksPerFrame: queue.sprites[i].ticksPerFrame,</div></li><li class="li1"><div class="de1">                    loop: queue.sprites[i].loop === undefined ? true : queue.sprites[i].loop</div></li><li class="li1"><div class="de1">                }</div></li><li class="li1"><div class="de1">            ));</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        cache.sprites[queue.sprites[i].id] = pool;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function generateSounds() {</div></li><li class="li1"><div class="de1">    let pool, poolSize, sound;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    for (let i = 0; i &lt; queue.sounds.length; i++) {</div></li><li class="li1"><div class="de1">        pool = [];</div></li><li class="li1"><div class="de1">        poolSize = 10; // nombre màxim de sons identics que es reprodueixen al mateix temps</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        for (let j = 0; j &lt; poolSize; j++) {</div></li><li class="li1"><div class="de1">            sound = new Audio(queue.sounds[i].path);</div></li><li class="li1"><div class="de1">            sound.volume = queue.sounds[i].volume;</div></li><li class="li1"><div class="de1">            pool.push(sound);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        cache.sounds[queue.sounds[i].id] = {</div></li><li class="li1"><div class="de1">            currentSound: 0,</div></li><li class="li1"><div class="de1">            pool: pool,</div></li><li class="li1"><div class="de1">            volume: queue.sounds[i].volume,</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function isDone() {</div></li><li class="li1"><div class="de1">    return (queue.images.length === successCount + errorCount);</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function _fadeOutAudio() {</div></li><li class="li1"><div class="de1">    for (let id in cache.sounds) {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; cache.sounds[id].pool.length; i++) {</div></li><li class="li1"><div class="de1">            let sound = cache.sounds[id].pool[i];</div></li><li class="li1"><div class="de1">            sound.volume = 0;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function generateMusic() {</div></li><li class="li1"><div class="de1">    for (let i = 0; i &lt; queue.music.length; i++) {</div></li><li class="li1"><div class="de1">        let sound = new Audio(queue.music[i].path);</div></li><li class="li1"><div class="de1">        sound.volume = queue.music[i].volume;</div></li><li class="li1"><div class="de1">        sound.loop = queue.music[i].loop;</div></li><li class="li1"><div class="de1">        cache.music[queue.music[i].id] = sound;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function queueAsset(type, asset) {</div></li><li class="li1"><div class="de1">    queue[type].push(asset);</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function downloadAll(callback, gameContext, args) {</div></li><li class="li1"><div class="de1">    if (queue.images.length === 0) {</div></li><li class="li1"><div class="de1">        callback();</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    for (let i = 0; i &lt; queue.images.length; i++) {</div></li><li class="li1"><div class="de1">        let path = queue.images[i].path,</div></li><li class="li1"><div class="de1">            id = queue.images[i].id,</div></li><li class="li1"><div class="de1">            img = new Image();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        img.addEventListener(&quot;load&quot;, function () {</div></li><li class="li1"><div class="de1">            successCount += 1;</div></li><li class="li1"><div class="de1">            updateProgress();</div></li><li class="li1"><div class="de1">            if (isDone()) {</div></li><li class="li1"><div class="de1">                generateSprites(gameContext);</div></li><li class="li1"><div class="de1">                callback(args);</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">        }, false);</div></li><li class="li1"><div class="de1">        img.addEventListener(&quot;error&quot;, function () {</div></li><li class="li1"><div class="de1">            errorCount += 1;</div></li><li class="li1"><div class="de1">            updateProgress();</div></li><li class="li1"><div class="de1">            if (isDone()) {</div></li><li class="li1"><div class="de1">                generateSprites(gameContext);</div></li><li class="li1"><div class="de1">                callback(args);</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">        }, false);</div></li><li class="li1"><div class="de1">        img.src = path;</div></li><li class="li1"><div class="de1">        cache.images[id] = img;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    generateSounds();</div></li><li class="li1"><div class="de1">    generateMusic();</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function getImage(id) {</div></li><li class="li1"><div class="de1">    return cache.images[id];</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function getSprite(id) {</div></li><li class="li1"><div class="de1">    let pool = cache.sprites[id];</div></li><li class="li1"><div class="de1">    let sprite = pool[pool.length - 1];</div></li><li class="li1"><div class="de1">    pool.unshift(pool.pop());</div></li><li class="li1"><div class="de1">    return sprite;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function getSound(id) {</div></li><li class="li1"><div class="de1">    let sounds = cache.sounds[id];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (sounds.pool[sounds.currentSound].currentTime === 0</div></li><li class="li1"><div class="de1">        || sounds.pool[sounds.currentSound].ended) {</div></li><li class="li1"><div class="de1">        sounds.pool[sounds.currentSound].play();</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">    sounds.currentSound = (sounds.currentSound + 1) % sounds.pool.length;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function fadeOutAudio(timeBeforeFadeOut) {</div></li><li class="li1"><div class="de1">    clearIntervals();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (timeBeforeFadeOut) {</div></li><li class="li1"><div class="de1">        timeIntervals.fadeOutAudio = setTimeout(fadeOutAudio, timeBeforeFadeOut);</div></li><li class="li1"><div class="de1">    } else {</div></li><li class="li1"><div class="de1">        _fadeOutAudio();</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function fadeInAudio() {</div></li><li class="li1"><div class="de1">    clearIntervals();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    for (let id in cache.sounds) {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; cache.sounds[id].pool.length; i++) {</div></li><li class="li1"><div class="de1">            let sound = cache.sounds[id].pool[i];</div></li><li class="li1"><div class="de1">            sound.volume = cache.sounds[id].volume;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">function clearIntervals() {</div></li><li class="li1"><div class="de1">    clearInterval(timeIntervals.fadeOutAudio);</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function getMusic(id) {</div></li><li class="li1"><div class="de1">    resetMusic(currentTrack);</div></li><li class="li1"><div class="de1">    cache.music[id].play();</div></li><li class="li1"><div class="de1">    currentTrack = id;</div></li><li class="li1"><div class="de1">}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export function resetMusic(id) {</div></li><li class="li1"><div class="de1">    if (!id) {</div></li><li class="li1"><div class="de1">        return;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (!cache.music[id].ended) {</div></li><li class="li1"><div class="de1">        cache.music[id].pause();</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    if (cache.music[id].currentTime &gt; 0) {</div></li><li class="li1"><div class="de1">        cache.music[id].currentTime = 0;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</p>

<p>

</p>

<p>

<p>
Habitualment, quan es necessita centralitzar diferents funcionalitats en una mateixa classe (o mòdul en aquest cas) s’acostuma a aplicar el patró de disseny <em>façana</em> (<em>facade</em> en anglès). 
</p>

</p>

<p>
Aquest patró consisteix a crear una classe que exposa els mètodes públics necessaris però internament treballa amb múltiples classes diferents. D’aquesta manera el funcionament de la façana és transparent a l’usuari, com en aquest cas, que no ha de preocupar-se d’on prové realment un <em>sprite</em>, simplement invoca el mètode <code>getSprite()</code> de l<code>‘AssetManager</code> sense haver de saber-ne l’origen.
</p>

<p>
Cal destacar que aquest objecte utilitza un sistema de <em>pools</em> simplificat (es tracta d’un <em>array</em>), perquè no s’ha de controlar l’estat dels elements d’aquests <em>pools</em>.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar més informació sobre el patró de disseny façana a l’enllaç següent: <a href="https://ca.wikipedia.org/wiki/Facade" class="urlextern" title="https://ca.wikipedia.org/wiki/Facade"  rel="nofollow">goo.gl/JU6JRh</a>.
</p>
</div></div>
</div>

<h3><a id="optimitzacious_de_pools" >Optimització: ús de &#039;pools&#039;</a></h3>
<div class="level3">

<p>
Un dels objectius principals a l’hora de desenvolupar un joc és que el nombre de <em>frames</em> per segon sigui estable. Preferentment han de mantenir-se 60 <em>frames</em> per segon per aconseguir que el joc sigui fluid 
</p>

<p>

<p>
encara que a jocs de consola més antics i dispositius mòvils només es requereix mantenir 30 <em>frames</em> per segon
</p>

</p>

<p>
.
</p>

<p>
Cal tenir en compte que, a JavaScript, la destrucció dels objectes és gestionada pels navegadors, que de tant en tant inicien la recol·lecció de brossa per alliberar la memòria dels objectes que ja no s’estan fent servir. Això pot provocar caigudes crítiques en el nombre de <em>frames</em> per segon durant l’execució, i cal evitar-lo tant sí com no perquè durant l’execució del recol·lector de brossa l’aplicació pot quedar completament bloquejada.
</p>

<p>
Com que durant un joc en pocs minuts es poden crear un gran nombre d’objectes (per exemple les bales en un joc de trets), s’ha d’implementar un sistema que permeti reciclar aquests objectes. El més habitual és fer servir un <em>pool</em> (conjunt d’objectes).
</p>

<p>
Aquesta tècnica és força simple d’entendre i d’implementar. Consisteix a crear el màxim nombre d’objectes que s’hagin de mostrar en pantalla al mateix temps abans de començar el joc i emmagatzemar-los al <em>pool</em>. Llavors, en lloc de crear els objectes, s’agafen d’aquest <em>pool</em>, i quan no es necessiten es tornen a afegir al <em>pool</em>. Així es reciclen i no cal crear-ne més: això evita que es cridi el recol·lector de brossa sigui i que s’aturi l’execució del programa.
</p>

<p>
És a dir, si es requereix que a la pantalla hi hagi 500 bales actives es crearà un <em>pool</em> amb 500 bales. Quan calgui instanciar una bala, s’obté del <em>pool</em>, i una vegada surt de la pantalla o impacta en un adversari es retorna al <em>pool</em>.
</p>

<p>
Hi ha molts sistemes per determinar quin és el pròxim objecte a retornar, i depenent de les vostres necessitats podeu fer-ne servir un o altre. Per exemple, suposant que els objectes s’emmagatzemen en un <em>array</em> amb nom <code>pool</code>, es podria determinar de les maneres següents:
</p>
<ul>
<li class="level1"><div class="li"> Guardar en un comptador quin és el proper ítem a utilitzar (aquest és el sistema utilitzat al mètode <code>getSound()</code> de l<code>‘AssetManager</code>): <code>properIndex = (properIndex + 1) % pool.length</code>.</div>
</li>
<li class="level1"><div class="li"> Retornar sempre l’últim element i moure’l de l’última posició a la primera (aquest és el sistema utilitzat al mètode <code>getSprite()</code> de l<code>‘AssetManager</code> i l’objecte <code>GameObjectPool</code>), per exemple:</div>
</li>
</ul>

<p>

</p>
<pre class="code java"><ol><li class="li1"><div class="de1">function getElement() {</div></li><li class="li1"><div class="de1">  let element = pool[pool.length - 1];</div></li><li class="li1"><div class="de1">  pool.unshift(pool.pop());</div></li><li class="li1"><div class="de1">  return element;</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>
<ul>
<li class="level1"><div class="li"> Afegir una propietat a tots els objectes de tipus booleà <code>actiu</code>, canviar el valor a cert o fals (segons s’activi o es desactivi) i ordenar l’<em>array</em> segons aquesta propietat, de manera que tots els elements inactius es trobin al final de la llista, per exemple, i només calgui obtenir l’últim element, que sempre serà inactiu.</div>
</li>
<li class="level1"><div class="li"> Eliminar l’element de l’<em>array</em> (amb els mètodes <code>pop()</code>, <code>shift()</code> o <code>splice()</code> segons la posició) quan sigui actiu i tornar a afegir-lo a l’<em>array</em> quan es desactivi.</div>
</li>
</ul>

<p>

<p>
la classe <code>GameObject</code> que es troba al mòdul <code>gameObjectPool</code>
</p>

</p>

<p>
 del joc <em>IOC Invaders</em> combina dos sistemes (tots els mètodes pertanyen als <em>arrays</em>):
</p>
<ul>
<li class="level1"><div class="li"> En instanciar un objecte es mou de l’última posició (mètode <code>pop()</code>) a la primera (mètode <code>unsfhit()</code>).</div>
</li>
<li class="level1"><div class="li"> En desactivar un objecte s’elimina de la seva posició actual (mètode <code>splice()</code>) i s’afegeix al final de l’<em>array</em> (mètode <code>push()</code>).</div>
</li>
</ul>

<p>
El <code>GameObjectPool</code> permet netejar el <em>pool</em> (<code>clear()</code>), instanciar nous objectes (<code>instantiate()</code>) i actualitzar tots els <code>GameObjects</code> emmagatzemats (<code>update()</code>), com es pot veure a la <span class="figref"><a href="#figura u7-31"><span>figura</span></a></span>.
</p>
<div class="iocfigure"><a name="figura u7-31"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML objecte Pool

</figcaption><img src="../media/daw_m06_u7_13_grafisme.png" alt="" /></figure>
</div>
<p>
A continuació podeu trobar el codi de la classe <code>GameObjectPool</code> implementat a l’<em>IOC Invaders</em>:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">import {getEntity} from &quot;./entityRepository.js&quot;;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">export class GameObjectPool {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    size = 0;</div></li><li class="li1"><div class="de1">    pool = [];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(maxSize, generator, config) {</div></li><li class="li1"><div class="de1">        this.size = maxSize;</div></li><li class="li1"><div class="de1">        this.actives = maxSize;</div></li><li class="li1"><div class="de1">        this.pool = [];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; this.size; i++) {</div></li><li class="li1"><div class="de1">            this.pool[i] = new generator(config);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    disable(index) {</div></li><li class="li1"><div class="de1">        this.pool[index].clear();</div></li><li class="li1"><div class="de1">        this.pool.push((this.pool.splice(index, 1))[0]);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    instantiate(type, position, speed) {</div></li><li class="li1"><div class="de1">        let instance = this.pool[this.size - 1].start(getEntity(type, position, speed));</div></li><li class="li1"><div class="de1">        this.pool.unshift(this.pool.pop());</div></li><li class="li1"><div class="de1">        return instance;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(deltaTime) {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; this.size; i++) {</div></li><li class="li1"><div class="de1">            // Només dibuixem fins que trobem un objecte que no sigui viu</div></li><li class="li1"><div class="de1">            if (this.pool[i].alive) {</div></li><li class="li1"><div class="de1">                if (this.pool[i].update(deltaTime)) {</div></li><li class="li1"><div class="de1">                    // Si update ha retornat cert es que s'ha de desactivar</div></li><li class="li1"><div class="de1">                    this.disable(i);</div></li><li class="li1"><div class="de1">                }</div></li><li class="li1"><div class="de1">            } else {</div></li><li class="li1"><div class="de1">                this.actives = i;</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    clear() {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; this.size; i++) {</div></li><li class="li1"><div class="de1">            this.pool[i].alive = false;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">        this.actives = 0;</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</p>

<p>
Com es pot apreciar, el constructor rep com a paràmetres <code>maxSize</code> (mida del <em>pool</em>), <code>generator</code> (
</p>

<p>

<p>
constructor de la classe
</p>

</p>

<p>
) i <code>config</code> (dades de configuració per generar els objectes). És a dir, es pot passar com a generador la classe <code>Shot</code> per crear un <em>pool</em> de bales o la classe <code>Spaceship</code> per crear-ne un de naus enemigues.
</p>

<p>
La funció <code>clear()</code> permet netejar el <em>pool</em> quan es reinicia el joc o es passa de nivell, mentre que la funció <code>update()</code> és cridada des del bucle principal del joc a cada iteració i s’encarrega d’actualitzar cadascun dels elements del <em>pool</em>.
</p>

<p>
Fixeu-vos que en el cas de <code>update()</code> només es recorren els elements fins a trobar-ne un que no estigui actiu (corresponent a la propietat <code>alive</code>), ja que els elements es troben ordenats i no cal continuar amb el bucle.
</p>

</div>

<h3><a id="motor_del_jocgameengine" >Motor del joc: GameEngine</a></h3>
<div class="level3">

<p>
Quan es parla del <strong>motor del joc</strong> cal distingir entre el motor implementat concretament per a un joc (per exemple el motor del <em>IOC Invaders</em>), i els motors de joc genèrics utilitzats per desenvolupar jocs (com 
</p>

<p>

<p>
PlayCanvas o PhaserJS
</p>

</p>

<p>
). En aquesta secció ens referim als primers, la implementació de motors de joc propis.
</p>

<p>
El motor del joc és el component responsable de portar a terme les tasques genèriques del joc, com poden ser, entre d’altres, les següents:
</p>
<ul>
<li class="level1"><div class="li"> Inicialitzar el joc.</div>
</li>
<li class="level1"><div class="li"> Gestionar la detecció de col·lisions.</div>
</li>
<li class="level1"><div class="li"> Carregar les dades del joc.</div>
</li>
<li class="level1"><div class="li"> Gestionar els canvis de pantalles.</div>
</li>
<li class="level1"><div class="li"> Executar el bucle principal del joc.</div>
</li>
</ul>

<p>
L’execució del bucle principal és especialment important, perquè una vegada el joc estigui inicialitzat, aquest bucle es repetirà a cada <em>frame</em> i serà el responsable d’actualitzar tots els elements del joc.
</p>

<p>
Com es pot apreciar a la <span class="figref"><a href="#figura u7-32"><span>figura</span></a></span> el motor del joc <em>IOC Invaders</em> (<code>GameEngine</code>) es força complex, ja que inclou múltiples funcionalitats en una sola classe.
</p>
<div class="iocfigure"><a name="figura u7-32"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML de la classe GameEngine

</figcaption><img src="../media/daw_m06_u7_14_grafisme.png" alt="" /></figure>
</div>
<p>

<p>
Dintre del mòdul <code>gameEngine</code> trobem:
</p>
<ul>
<li class="level1"><div class="li"> GameState: un objecte que simula un enum per indicar l’estat del joc.</div>
</li>
<li class="level1"><div class="li"> FPS: una constant que determina la velocitat màxima a la qual s’ha d’executar el joc.</div>
</li>
<li class="level1"><div class="li"> UserInterface: classe responsable de gestionar la interfície de l’usuari.</div>
</li>
<li class="level1"><div class="li"> GameEngine (exportada): classe que conté la lògica del joc.</div>
</li>
</ul>

</p>

<p>

</p>

<p>
Tot i que a JavaScript les enumeracions no existeixen (<code>enums</code> en altres llenguatges), és possible emular-les amb estructures com aquesta.
</p>
<div class="iocnote"><div class="ioccontent">
<p>
Actualment JavaScript ofereix una funcionalitat similar als <code>enums</code> utilitzant <code>Symbols</code>(<a href="http://tiny.cc/nljauz" class="urlextern" title="http://tiny.cc/nljauz"  rel="nofollow">tiny.cc/nljauz</a>), però el seu ús és complicat.
</p>
</div></div>
<p>
En programació no es recomana mai fer servir <em>nombres màgics</em> al codi (valors literals sense explicacions o en múltiples llocs): per una banda, és difícil saber a què fan referència i, per l’altra, és possible que estiguin duplicats en diversos punts del codi i, llavors, si cal canviar-los, resulta complicat.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar més informació sobre els <em>enums</em> a l’enllaç següent: <a href="https://en.wikipedia.org/wiki/Enumerated_type" class="urlextern" title="https://en.wikipedia.org/wiki/Enumerated_type"  rel="nofollow">goo.gl/qnhKSC</a>.
</p>
</div></div>
<p>
Per resoldre aquest problema s’acostumen a fer servir constants o enumeracions. Quan els valors no estan relacionats entre ells és recomanable utilitzar constants (a <em>IOC Invaders</em> s’utilitza la constant <code>MAX_TIME_OUTSIDE_BOUNDARIES</code> i <code>FPS</code>, per exemple) però quan hi ha una relació entre ells és recomanable utilitzar una enumeració (<code>GameState</code> fa referència als possibles estatsdel joc):
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">const FPS = 60;</div></li><li class="li1"><div class="de1">const GameState = {</div></li><li class="li1"><div class="de1">    GAME_OVER: &quot;GameOver&quot;,</div></li><li class="li1"><div class="de1">    LOADING_NEXT_LEVEL: &quot;LoadingNextLevel&quot;,</div></li><li class="li1"><div class="de1">    RUNNING: &quot;Running&quot;</div></li><li class="li1"><div class="de1">};</div></li></ol></pre>

</p>

<p>
Utilitzant constants i enumeracions és molt fàcil fer el canvi dels valors, ja que només s’ha de fer en un punt. A més a més, la majoria d’entorns de desenvolupament habiliten l’autocompletar i el ressaltat d’errors, si no s’ha escrit correctament el nom, cosa que no passa quan es treballa amb nombres i cadenes de text. A més a més, el codi és més entenedor; per exemple: no aporta la mateixa informació <code>let a = 100;</code> (a què fa referència 100?, és molt?, és poc?, és correcte?) que <code>let a = MAX_SPEED;</code>, que genera molts menys dubtes.
</p>
<div class="iocnote"><div class="ioccontent">
<p>
Per convenció en alguns llenguatges s’acostuma a posar els noms de les constants en majúscules, però no és obligatorí.
</p>
</div></div>
</div>

<h4><a id="interficie_d_usuariuserinterface" >Interfície d&#039;usuari: UserInterface</a></h4>
<div class="level4">

<p>
La interfície d’usuari del joc és l’encarregada de mostrar informació a l’usuari i permet interactuar-hi mostrant un menú d’opcions per iniciar el joc o les puntuacions. També es consideren elements de la interfície els indicadors que es poden fer servir per mostrar els punts de vida d’un enemic o un ressaltat al voltant d’un tresor.
</p>

<p>

<p>
Per simplificar-ho, a <em>IOC Invaders</em> només es mostra la puntuació, la distància recorreguda al nivell, el comptador de <em>frames</em> per segon, un botó per iniciar el joc quan carrega la pàgina i un botó per reiniciar el joc quan acaba la partida. Com que es tracta d’un cas  simple, s’ha optat per encapsular la classe <code>UserInterface</code> (vegeu la <span class="figref"><a href="#figura u7-33"><span>figura</span></a></span>) al mòdul <code>gameEngine</code>, ja que només ha de ser accessible des de la classe <code>GameEngine</code>
</p>

</p>

<p>
.
</p>
<div class="iocfigure"><a name="figura u7-33"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Diagrama UML objecte UserInterface

</figcaption><img src="../media/daw_m06_u7_15_grafisme.png" alt="" /></figure>
</div>
<p>

<p>
A continuació podeu trobar un resum dels mètodes i la seva funció:
</p>
<ul>
<li class="level1"><div class="li"> <strong>update</strong>: actualitza la puntuació, la distància en pantalla i  els <em>frames</em> per segon.</div>
</li>
</ul>

</p>
<ul>
<li class="level1"><div class="li"> <strong>showMessage</strong> i <strong>hideMessage</strong>: mostra i amaga missatges respectivament, per exemple, en començar un nivell.</div>
</li>
<li class="level1"><div class="li"> <strong>showGameOver</strong> i <strong>hideGameOver</strong>: mostra i amaga el missatge de fi del joc (inclou el botó per tornar a començar mitjançant <acronym title="HyperText Markup Language">HTML</acronym>).</div>
</li>
<li class="level1"><div class="li"> <strong>transitionScreen</strong>, <strong>fadeIn</strong>, <strong>fadeOut</strong>: fan efectes per enfosquir i tornar a mostrar la pantalla.</div>
</li>
</ul>

<p>

<p>
El codi de la classe UserInterface és el següent:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">class UserInterface {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    scoreText = document.getElementById('score');</div></li><li class="li1"><div class="de1">    distanceText = document.getElementById('distance');</div></li><li class="li1"><div class="de1">    messageText = document.getElementById('messages');</div></li><li class="li1"><div class="de1">    fpsText = document.getElementById('fps');</div></li><li class="li1"><div class="de1">    canvas = null;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(canvas) {</div></li><li class="li1"><div class="de1">        this.canvas = canvas;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(score, distance, fps) {</div></li><li class="li1"><div class="de1">        this.scoreText.innerHTML = score;</div></li><li class="li1"><div class="de1">        this.distanceText.innerHTML = distance;</div></li><li class="li1"><div class="de1">        this.fpsText.innerHTML = fps;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    showMessage(message, duration) { // Temps en milisegons</div></li><li class="li1"><div class="de1">        this.messageText.innerHTML = message;</div></li><li class="li1"><div class="de1">        this.messageText.style.opacity = '1';</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        let context = this;</div></li><li class="li1"><div class="de1">        setTimeout(function () {</div></li><li class="li1"><div class="de1">            context.messageText.style.opacity = '0';</div></li><li class="li1"><div class="de1">        }, duration);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    hideMessage() {</div></li><li class="li1"><div class="de1">        this.messageText.style.opacity = '0';</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    showGameOver() {</div></li><li class="li1"><div class="de1">        document.getElementById('game-over').style.display = &quot;block&quot;;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    hideGameOver() {</div></li><li class="li1"><div class="de1">        document.getElementById('game-over').style.display = &quot;none&quot;;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    transitionScreen(callback) {</div></li><li class="li1"><div class="de1">        this.canvas.style.opacity = '0';</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        let context = this;</div></li><li class="li1"><div class="de1">        setTimeout(function () {</div></li><li class="li1"><div class="de1">            context.canvas.style.opacity = '1';</div></li><li class="li1"><div class="de1">            callback();</div></li><li class="li1"><div class="de1">        }, 3000); // la transicion dura 3s</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    fadeIn() {</div></li><li class="li1"><div class="de1">        this.canvas.style.opacity = '1';</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    fadeOut() {</div></li><li class="li1"><div class="de1">        this.canvas.style.opacity = '0';</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

</p>

</div>

<h4><a id="carrega_de_dades" >Càrrega de dades</a></h4>
<div class="level4">

<p>
Cal diferenciar entre la càrrega de dades i la càrrega de recursos. Normalment els recursos es corresponen amb elements d’<acronym title="HyperText Markup Language">HTML</acronym> (àudio, vídeo i imatges) i es poden controlar quan ha finalitzat la càrrega detectant l’<em>event</em> <code>load</code>, ja que es tracta d’elements. En canvi, les dades s’han de carregar realitzant peticions AJAX i processant-ne la resposta.
</p>

<p>
En cas que els fitxers amb les dades es trobin en un servidor diferent, s’ha de tenir en compte que aquest ha d’implementar mecanismes CORS o JSONP per evitar el bloqueig dels navegadors provocat per la política del mateix origen.
</p>

<p>
Al motor del joc de l’<em>IOC Invaders</em> s’utilitzen les següents funcions per portar a terme la càrrega de dades:
</p>
<ul>
<li class="level1"><div class="li"> <strong>loadData</strong>: realitza la petició AJAX i invoca la funció passada com a argument per processar les dades rebudes en format JSON.</div>
</li>
<li class="level1"><div class="li"> <strong>loadEntitiesData</strong>: carrega les dades de les entitats i les afegeix al repositori.</div>
</li>
<li class="level1"><div class="li"> <strong>loadLevelsData</strong>: carrega les dades del nivell i, en acabar, inicia el joc.</div>
</li>
<li class="level1"><div class="li"> <strong>init</strong> i <strong>loadAssets</strong>: el primer carrega les dades dels recursos i seguidament n’inicia la descàrrega mitjançant l’ <code>AssetsManager</code>.</div>
</li>
</ul>

<p>
Totes les dades del joc són en format JSON, cosa que facilita la tasca d’editar-los manualment o crear un editor per modificar-los.
</p>

<p>
A continuació podeu trobar l’estructura del fitxer de recursos (<code>asset-data.json</code>) que correspon al diagrama de la <span class="figref"><a href="#figura u7-34"><span>figura</span></a></span>:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">{</div></li><li class="li1"><div class="de1">  &quot;assets&quot;: {</div></li><li class="li1"><div class="de1">      &quot;images&quot;: [</div></li><li class="li1"><div class="de1">        {</div></li><li class="li1"><div class="de1">          &quot;id&quot;: &quot;identificador de la imatge&quot;,</div></li><li class="li1"><div class="de1">          &quot;path&quot;: &quot;ruta de la imatge&quot;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      ],</div></li><li class="li1"><div class="de1">      &quot;sprites&quot;: [</div></li><li class="li1"><div class="de1">        {</div></li><li class="li1"><div class="de1">          &quot;id&quot;: &quot;identificador del sprite&quot;,</div></li><li class="li1"><div class="de1">          &quot;numberOfFrames&quot;: &quot;nombre de frames que formen l'animació&quot;,</div></li><li class="li1"><div class="de1">          &quot;ticksPerFrame&quot;: &quot;nombre de frames que es mostren a la mateixa imatge abans de canviar a la següent&quot;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      ],</div></li><li class="li1"><div class="de1">      &quot;sounds&quot;: [</div></li><li class="li1"><div class="de1">        {</div></li><li class="li1"><div class="de1">          &quot;id&quot;: &quot;identificador de l'efecte de so&quot;,</div></li><li class="li1"><div class="de1">          &quot;path&quot;: &quot;ruta de l'efecte de so&quot;,</div></li><li class="li1"><div class="de1">          &quot;volume&quot;: &quot;tipus float. Volumen al qual s'ha de reproduir&quot;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      ],</div></li><li class="li1"><div class="de1">      &quot;music&quot;: [</div></li><li class="li1"><div class="de1">        {</div></li><li class="li1"><div class="de1">          &quot;id&quot;: &quot;identificador del fitxer de música&quot;,</div></li><li class="li1"><div class="de1">          &quot;path&quot;: &quot;ruta del fitxer de música&quot;,</div></li><li class="li1"><div class="de1">          &quot;loop&quot;: &quot;tipus booleà. Indica si s'ha de repetir indefinidament&quot;</div></li><li class="li1"><div class="de1">          &quot;volume&quot;: &quot;tipus float. volumen al que s'ha de reproduir&quot;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">      ]</div></li><li class="li1"><div class="de1">  }</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>
<div class="iocfigure"><a name="figura u7-34"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Estructura de dades de “asset-data.json”

</figcaption><img src="../media/daw_m06_u7_16_grafisme.png" alt="" /></figure>
</div>
<p>
L’estructura dels fitxers <code>levels-data.json</code> és més complicada perquè conté múltiples estructures niudes (nivell, fons, onades d’enemics i formacions), però a la <span class="figref"><a href="#figura u7-35"><span>figura</span></a></span> se’n pot veure clarament la composició.
</p>
<div class="iocfigure"><a name="figura u7-35"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Estructura de dades de “levels-data.json”

</figcaption><img src="../media/daw_m06_u7_17_grafisme.png" alt="" /></figure>
</div>
<p>
El fitxer <code>entity-data.json</code> també inclou estructures niades. En aquest cas el fitxer inclou la informació del jugador, dels diferents tipus d’enemics i el seu armament, i les bales i les explosions, com es pot apreciar a la <span class="figref"><a href="#figura u7-36"><span>figura</span></a></span>.
</p>
<div class="iocfigure"><a name="figura u7-36"></a><figure>
<figcaption><span class="figuretitle">Figura</span>

Estructura de dades de “entity-data.json”

</figcaption><img src="../media/daw_m06_u7_18_grafisme.png" alt="" /></figure>
</div>
<p>
Fixeu-vos que tot i que el més habitual és que cada nau només porti un canó, és possible afegir-hi qualsevol quantitat, ja que la propietat <code>cannon</code> és un <em>array</em>. Així, per exemple, la nau del jugador inclou dos canons col·locats a les posicions (35,5) i (35,45).
</p>

<p>
Com que la bala del jugador té una alçada de 14 píxels, l’alçada de la nau és de 64 píxels i l’origen de les coordenades (0,0) es troba a la cantonada superior esquerra. Per col·locar el segon canó simètric al primer s’ha de fer el càlcul següent: <code>64 - 14 - 5 = 45</code>. Per la distància horitzontal s’utilitza el mateix valor a tots dos canons.
</p>

</div>

<h4><a id="deteccio_de_col_lisions" >Detecció de col·lisions</a></h4>
<div class="level4">

<p>
La detecció de col·lisions s’ha de calcular a cada iteració del bucle principal. Les comprovacions seran més o menys costoses segons la forma dels elements per comprovar. Per exemple, les dues formes de detectar col·lisions més simples són:
</p>
<ul>
<li class="level1"><div class="li"> <strong>Forma circular</strong>: requereix calcular si la distància que hi ha entre el centre de tots dos cercles és més gran que la suma dels radis.</div>
</li>
<li class="level1"><div class="li"> <strong>Rectangles</strong>: cal comprovar si qualsevol de les cantonades del primer rectangle es troba dintre de l’àrea del segon.</div>
</li>
</ul>

<p>
En cas que es necessités més precisió en la detecció, es poden utilitzar múltiples cercles i rectangles per ajustar la forma utilitzada per fer els càlculs, però –com es pot intuir– el cost de realitzar-los es multiplica.
</p>
<div class="iocnote"><div class="ioccontent">
<p>
Els motors de joc de tercers permeten utilitzar formes més avançades en 2D i 3D per detectar col·lisions.
</p>
</div></div>
<p>
A <em>IOC Invaders</em> la detecció de col·lisions està dividida entre dos components i s’utilitza la detecció de col·lisions per rectangles. Per una banda, els objectes de tipus <code>MovingGameObject</code>, com les naus i les bales, implementen <code>isCollidingWith()</code>, que permet determinar si un objecte està col·lidint amb un altre. Per l’altra, en el motor del joc es troben els mètodes següents:
</p>
<ul>
<li class="level1"><div class="li"> <strong>detectCollisions</strong>: comprova totes les col·lisions possibles i marca com a destruïts els elements que hi hagin col·lidit.</div>
</li>
<li class="level1"><div class="li"> <strong>detectCollisionsPoolWithPool</strong>: detecta totes les col·lisions entre dos <em>pools</em> complets, per exemple el <em>pool</em> de bales del jugador amb el <em>pool</em> de naus enemigues.</div>
</li>
<li class="level1"><div class="li"> <strong>detectCollisionsPoolWithGameObject</strong>: detecta les col·lisions entre tots els objectes d’un <em>pool</em> amb un objecte concret, per exemple, el <em>pool</em> de bales enemigues amb el jugador.</div>
</li>
</ul>

</div>

<h3><a id="gestio_d_enemics_i_nivells" >Gestió d&#039;enemics i nivells</a></h3>
<div class="level3">

<p>
El motor del joc <em>IOC Invaders</em> també és el responsable d’instanciar els enemics a mesura que el jugador arriba als punts marcats (propietat <code>distance</code>). Els mètodes responsables de generar els enemics són els següents:
</p>
<ul>
<li class="level1"><div class="li"> <strong>updateWaves</strong>: comprova si s’ha arribat a la distància requerida per instanciar un nou grup d’enemics o s’ha arribat al final del nivell.</div>
</li>
<li class="level1"><div class="li"> <strong>spawner</strong>: instancia un nou enemic o una nova onada d’enemics.</div>
</li>
<li class="level1"><div class="li"> <strong>spawnEnemy</strong>: instancia un únic enemic.</div>
</li>
<li class="level1"><div class="li"> <strong>spawnFormation</strong>: instancia una onada d’enemics en formació. Segons el tipus de formació i les dades de l’onada, les naus es col·locaran en diferents posicions.</div>
</li>
</ul>

<p>
S’ha de tenir en compte que, per simplificar, aquesta funcionalitat s’ha afegit al <code>GameManager</code>, però el més adient seria crear un objecte de tipus <code>SpawnManager</code> que fos l’encarregat de gestionar la creació d’instàncies dels enemics.
</p>

<p>
Aquests enemics, en ser destruïts, augmenten la puntuació del jugador. La puntuació ha de ser gestionada pel <code>GameManager</code>, ja que a diferència d’altres elements, la puntuació ha de persistir durant tota la partida.
</p>

<p>
Quant a la gestió de nivells, a <em>IOC Invaders</em> s’utilitzen les propietats i els mètodes següents:
</p>
<ul>
<li class="level1"><div class="li"> <strong>currentLevel</strong>: indica el nivell actual.</div>
</li>
<li class="level1"><div class="li"> <strong>levels</strong>: informa sobre els nivells del joc.</div>
</li>
<li class="level1"><div class="li"> <strong>startLevel</strong>: inicia el nivell.</div>
</li>
<li class="level1"><div class="li"> <strong>setEndLevel</strong>: avança al següent nivell. És invocat quan s’arriba al final del nivell i no és visible cap enemic.</div>
</li>
</ul>

</div>

<h4><a id="inicialitzacio_i_bucle_principal_del_joc" >Inicialització i bucle principal del joc</a></h4>
<div class="level4">

<p>
La resta de mètodes del <code>GameEngine</code> s’encarreguen de gestionar el cicle de vida del joc. És a dir, la inicialització, la finalització i el bucle principal:
</p>
<ul>
<li class="level1"><div class="li"> <strong><code>start()</code></strong>: és invocat en iniciar-se el joc, posa en marxa el bucle principal (<code>update</code>).</div>
</li>
<li class="level1"><div class="li"> <strong><code>restart()</code></strong>: invocat tant quan s’inicia el joc com quan es reinicia.</div>
</li>
<li class="level1"><div class="li"> <strong><code>init()</code></strong>: inicia la càrrega de dades i seguidament invoca <code>initEnvironment()</code>.</div>
</li>
<li class="level1"><div class="li"> <strong><code>initEnvironment()</code></strong>: inicialitza els <em>pools</em> per les bales, les explosions i els enemics, estableix el context del canvas (<code>2D</code>) i inicia la càrrega de recursos.</div>
</li>
<li class="level1"><div class="li"> <strong><code>setGameOver()</code></strong>: atura el funcionament del joc i mostra el missatge de fi del joc.</div>
</li>
<li class="level1"><div class="li"> <strong><code>update()</code></strong>: executa el bucle principal del joc.</div>
</li>
</ul>

<p>
<ul>
<li class="level1"><div class="li"> <strong><code>isUpdateRequired()</code></strong>: comprova si és o no necessari refrescar els elements del joc, basant-se en el temps transcorregut des de la darrera actualització i el límit de <em>frames</em> per segon establerts.</div>
</li>
</ul>

</p>

<p>
Quan es treballa amb l’element <code>canvas</code> és fonamental invocar el mètode <code>window.requestAnimationFrame()</code>, ja que és l’encarregat de demanar al navegador que es cridi la funció passada com a argument abans de pintar la finestra.
</p>

<p>
Com es pot apreciar en el bucle principal de l’<em>IOC Invaders</em> (<code>update()</code>), la primera acció que es porta a terme és invocar <code>windows.requestAnimationFrame()</code> per tornar a ser cridat quan es torni a pintar la finestra.
</p>

<p>

<p>
Seguidament es comprova si és necessari actualitzar i si és així es calcula el <code>deltaTime</code>, que correspon al temps que ha passat des de la darrera actualització.
</p>

</p>

<p>
A continuació s’actualitzen les onades i es comprova si s’ha produït alguna col·lisió.
</p>

<p>
Cal destacar que s’utilitza una màquina d’estats molt simple per determinar què s’ha de fer a continuació:
</p>
<ul>
<li class="level1"><div class="li"> Si el jugador ha estat destruït i l’estat no és <code>GAME_OVER</code>, s’acaba el joc.</div>
</li>
<li class="level1"><div class="li"> Si no hi ha enemics vius, s’ha arribat al final del nivell i l’estat no és <code>GAME_OVER</code>, l’estat passa a <code>LOADING_NEXT_LEVEL</code> i s’inicia la transició cap al pròxim nivell.</div>
</li>
<li class="level1"><div class="li"> Si no s’ha acabat el nivell i no s’ha acabat el joc, s’actualitza el jugador (estat <code>RUNNING</code>).</div>
</li>
</ul>

<p>
Abans de finalitzar el bucle s’actualitza el <em>pool</em> d’explosions i finalment la interfície amb la nova distància i la puntuació.
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar més informació sobre les màquines d’estats finits a l’enllaç següent: <a href="https://ca.wikipedia.org/wiki/Aut%C3%B2mat_finit" class="urlextern" title="https://ca.wikipedia.org/wiki/Aut%C3%B2mat_finit"  rel="nofollow">goo.gl/t0j8OA</a>.
</p>
</div></div>
<p>
Fixeu-vos que principalment la tasca del bucle principal és cridar el mètode <code>update()</code> dels altres elements del joc i canviar d’estat. Si estructureu bé el vostre codi, la implementació del bucle principal és molt simple.
</p>

<p>
A continuació podeu trobar el codi de la classe <code>GameEngine</code>:
</p>

<p>
<pre class="code java"><ol><li class="li1"><div class="de1">export class GameEngine {</div></li><li class="li1"><div class="de1">    levels = {};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    currentLevel = 0;</div></li><li class="li1"><div class="de1">    levelEnded = false;</div></li><li class="li1"><div class="de1">    score = 0;</div></li><li class="li1"><div class="de1">    distance = 0; // Relativa al nivell actual</div></li><li class="li1"><div class="de1">    nextWave = null; // Relativa al nivell actual</div></li><li class="li1"><div class="de1">    enemyPool = null;</div></li><li class="li1"><div class="de1">    enemyShotPool = null;</div></li><li class="li1"><div class="de1">    playerShotPool = null;</div></li><li class="li1"><div class="de1">    explosionPool = null;</div></li><li class="li1"><div class="de1">    background = null;</div></li><li class="li1"><div class="de1">    player = null;</div></li><li class="li1"><div class="de1">    state = null;</div></li><li class="li1"><div class="de1">    canvas = null;</div></li><li class="li1"><div class="de1">    ui = null;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    // Gestió dels quadres per segon</div></li><li class="li1"><div class="de1">    fpsInterval = 0;</div></li><li class="li1"><div class="de1">    then = 0;</div></li><li class="li1"><div class="de1">    startTime = 0;</div></li><li class="li1"><div class="de1">    currentFPS = 0;</div></li><li class="li1"><div class="de1">    previousGameTime = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    constructor(config, canvas) {</div></li><li class="li1"><div class="de1">        this.config = config;</div></li><li class="li1"><div class="de1">        this.canvas = canvas;</div></li><li class="li1"><div class="de1">        this.ui = new UserInterface(canvas);</div></li><li class="li1"><div class="de1">        this.previousGameTime = 0;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    initEnvironment(data) {</div></li><li class="li1"><div class="de1">        this.gameContext = this.canvas.getContext(&quot;2d&quot;);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.explosionPool = new GameObjectPool(100, Explosion);</div></li><li class="li1"><div class="de1">        this.enemyShotPool = new GameObjectPool(500, Shot, {</div></li><li class="li1"><div class="de1">            gameWidth: this.canvas.width,</div></li><li class="li1"><div class="de1">            gameHeight: this.canvas.height</div></li><li class="li1"><div class="de1">        });</div></li><li class="li1"><div class="de1">        this.enemyPool = new GameObjectPool(100, Spaceship, {</div></li><li class="li1"><div class="de1">            pool: {</div></li><li class="li1"><div class="de1">                bullet: this.enemyShotPool,</div></li><li class="li1"><div class="de1">                explosion: this.explosionPool</div></li><li class="li1"><div class="de1">            },</div></li><li class="li1"><div class="de1">            gameWidth: this.canvas.width,</div></li><li class="li1"><div class="de1">            gameHeight: this.canvas.height</div></li><li class="li1"><div class="de1">        });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.playerShotPool = new GameObjectPool(100, Shot, {</div></li><li class="li1"><div class="de1">            gameWidth: this.canvas.width,</div></li><li class="li1"><div class="de1">            gameHeight: this.canvas.height</div></li><li class="li1"><div class="de1">        });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.loadAssets(data.assets);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    isUpdateRequired(gameTime) {</div></li><li class="li1"><div class="de1">        this.now = gameTime;</div></li><li class="li1"><div class="de1">        let elapsed = this.now - this.then;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Si ha passat suficient temps dibuixem el següent quadre</div></li><li class="li1"><div class="de1">        if (elapsed &gt;= this.fpsInterval) {</div></li><li class="li1"><div class="de1">            this.then = this.now - (elapsed % this.fpsInterval);</div></li><li class="li1"><div class="de1">            let sinceStart = this.now - this.startTime;</div></li><li class="li1"><div class="de1">            this.currentFPS = Math.round(1000 / (sinceStart / ++this.frameCount));</div></li><li class="li1"><div class="de1">            return true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        return false;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    update(gameTime) {</div></li><li class="li1"><div class="de1">        window.requestAnimationFrame(this.update.bind(this));</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Comprovem si ha passat suficient temps entre actualitzacions per limitar el nombre de</div></li><li class="li1"><div class="de1">        // quadres per segon</div></li><li class="li1"><div class="de1">        if (!this.isUpdateRequired(gameTime)) {</div></li><li class="li1"><div class="de1">            return;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // Diferencia de temps entre quadres en ms</div></li><li class="li1"><div class="de1">        let deltaTime = (gameTime - this.previousGameTime)/1000;</div></li><li class="li1"><div class="de1">        this.previousGameTime = gameTime;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.updateWaves();</div></li><li class="li1"><div class="de1">        this.detectCollisions();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.background.update(deltaTime);</div></li><li class="li1"><div class="de1">        this.enemyPool.update(deltaTime);</div></li><li class="li1"><div class="de1">        this.enemyShotPool.update(deltaTime);</div></li><li class="li1"><div class="de1">        this.playerShotPool.update(deltaTime);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.player.isDestroyed &amp;&amp; this.state !== GameState.GAME_OVER) {</div></li><li class="li1"><div class="de1">            this.setGameOver();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        } else if (this.enemyPool.actives === 0 &amp;&amp; this.levelEnded &amp;&amp; this.state !== GameState.GAME_OVER</div></li><li class="li1"><div class="de1">            &amp;&amp; this.state !== GameState.LOADING_NEXT_LEVEL) {</div></li><li class="li1"><div class="de1">            this.ui.transitionScreen(this.setEndLevel.bind(this))</div></li><li class="li1"><div class="de1">            this.state = GameState.LOADING_NEXT_LEVEL;</div></li><li class="li1"><div class="de1">        } else if (this.state !== GameState.GAME_OVER) {</div></li><li class="li1"><div class="de1">            this.player.update(deltaTime);</div></li><li class="li1"><div class="de1">            this.distance++;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.explosionPool.update(deltaTime);</div></li><li class="li1"><div class="de1">        this.ui.update(this.score, this.distance, this.currentFPS);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    detectCollisions() {</div></li><li class="li1"><div class="de1">        let impactInfo,</div></li><li class="li1"><div class="de1">            i;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // bala del jugador amb enemic</div></li><li class="li1"><div class="de1">        impactInfo = this.detectCollisionsPoolWithPool(this.playerShotPool, this.enemyPool);</div></li><li class="li1"><div class="de1">        for (i = 0; i &lt; impactInfo.length; i++) {</div></li><li class="li1"><div class="de1">            impactInfo[i].source.isDestroyed = true;</div></li><li class="li1"><div class="de1">            impactInfo[i].target.isDestroyed = true;</div></li><li class="li1"><div class="de1">            this.score += impactInfo[i].target.points;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // bala del enemic amb jugador</div></li><li class="li1"><div class="de1">        impactInfo = this.detectCollisionsPoolWithGameObject(this.enemyShotPool, this.player);</div></li><li class="li1"><div class="de1">        for (i = 0; i &lt; impactInfo.length; i++) {</div></li><li class="li1"><div class="de1">            impactInfo[i].source.isDestroyed = true;</div></li><li class="li1"><div class="de1">            impactInfo[i].target.isDestroyed = true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        // enemic amb jugador</div></li><li class="li1"><div class="de1">        impactInfo = this.detectCollisionsPoolWithGameObject(this.enemyPool, this.player);</div></li><li class="li1"><div class="de1">        for (i = 0; i &lt; impactInfo.length; i++) {</div></li><li class="li1"><div class="de1">            impactInfo[i].source.isDestroyed = true;</div></li><li class="li1"><div class="de1">            impactInfo[i].target.isDestroyed = true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    detectCollisionsPoolWithPool(poolA, poolB) {</div></li><li class="li1"><div class="de1">        let i = 0,</div></li><li class="li1"><div class="de1">            j = 0,</div></li><li class="li1"><div class="de1">            impacts = [];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        while (poolA.pool[i] &amp;&amp; poolA.pool[i].alive) {</div></li><li class="li1"><div class="de1">            while (poolB.pool[j] &amp;&amp; poolB.pool[j].alive) {</div></li><li class="li1"><div class="de1">                if (poolA.pool[i].isCollidingWith(poolB.pool[j])) {</div></li><li class="li1"><div class="de1">                    impacts.push({</div></li><li class="li1"><div class="de1">                        source: poolA.pool[i],</div></li><li class="li1"><div class="de1">                        target: poolB.pool[j]</div></li><li class="li1"><div class="de1">                    });</div></li><li class="li1"><div class="de1">                }</div></li><li class="li1"><div class="de1">                j++;</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">            j = 0;</div></li><li class="li1"><div class="de1">            i++;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        return impacts;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    detectCollisionsPoolWithGameObject(pool, gameObject) {</div></li><li class="li1"><div class="de1">        let i = 0,</div></li><li class="li1"><div class="de1">            impacts = [];</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        while (pool.pool[i] &amp;&amp; pool.pool[i].alive) {</div></li><li class="li1"><div class="de1">            if (pool.pool[i].isCollidingWith(gameObject)) {</div></li><li class="li1"><div class="de1">                impacts.push({</div></li><li class="li1"><div class="de1">                    source: pool.pool[i],</div></li><li class="li1"><div class="de1">                    target: gameObject</div></li><li class="li1"><div class="de1">                });</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">            i++;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        return impacts;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    updateWaves() {</div></li><li class="li1"><div class="de1">        let waves = this.levels[this.currentLevel].waves,</div></li><li class="li1"><div class="de1">            currentWave;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.nextWave &lt; waves.length &amp;&amp; this.distance &gt;= waves[this.nextWave].distance) {</div></li><li class="li1"><div class="de1">            currentWave = waves[this.nextWave];</div></li><li class="li1"><div class="de1">            this.spawner(currentWave.spawns);</div></li><li class="li1"><div class="de1">            this.nextWave++;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.distance &gt; this.levels[this.currentLevel].end) {</div></li><li class="li1"><div class="de1">            this.levelEnded = true;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    spawner(spawns) {</div></li><li class="li1"><div class="de1">        for (let i = 0; i &lt; spawns.length; i++) {</div></li><li class="li1"><div class="de1">            if (!spawns[i].formation) {</div></li><li class="li1"><div class="de1">                this.spawnEnemy(spawns[i]);</div></li><li class="li1"><div class="de1">            } else {</div></li><li class="li1"><div class="de1">                this.spawnFormation(spawns[i]);</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    spawnEnemy(enemy) {</div></li><li class="li1"><div class="de1">        this.enemyPool.instantiate(enemy.type, enemy.position, enemy.speed);</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    spawnFormation(wave) {</div></li><li class="li1"><div class="de1">        let i, j,</div></li><li class="li1"><div class="de1">            originPosition,</div></li><li class="li1"><div class="de1">            spacer,</div></li><li class="li1"><div class="de1">            nextColumn,</div></li><li class="li1"><div class="de1">            currentPosition,</div></li><li class="li1"><div class="de1">            side;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        switch (wave.formation.type) {</div></li><li class="li1"><div class="de1">            case &quot;columns&quot;:</div></li><li class="li1"><div class="de1">                originPosition = {x: wave.position.x, y: wave.position.y};</div></li><li class="li1"><div class="de1">                spacer = wave.formation.spacer;</div></li><li class="li1"><div class="de1">                nextColumn = originPosition.y + wave.formation.column_height;</div></li><li class="li1"><div class="de1">                currentPosition = {x: wave.position.x, y: wave.position.y};</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                for (i = 0; i &lt; wave.formation.amount; i++) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                    this.enemyPool.instantiate(wave.type, {</div></li><li class="li1"><div class="de1">                        x: currentPosition.x,</div></li><li class="li1"><div class="de1">                        y: currentPosition.y</div></li><li class="li1"><div class="de1">                    }, wave.speed);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                    currentPosition.y += spacer;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                    if (currentPosition.y &gt;= nextColumn) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                        currentPosition.x += spacer;</div></li><li class="li1"><div class="de1">                        currentPosition.y = originPosition.y;</div></li><li class="li1"><div class="de1">                    }</div></li><li class="li1"><div class="de1">                }</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case &quot;grid&quot;:</div></li><li class="li1"><div class="de1">                originPosition = {x: wave.position.x, y: wave.position.y};</div></li><li class="li1"><div class="de1">                spacer = wave.formation.spacer;</div></li><li class="li1"><div class="de1">                side = Math.round(Math.sqrt(wave.formation.amount));</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                for (i = 0; i &lt; side; i++) {</div></li><li class="li1"><div class="de1">                    for (j = 0; j &lt; side; j++) {</div></li><li class="li1"><div class="de1">                        this.enemyPool.instantiate(wave.type, {</div></li><li class="li1"><div class="de1">                            x: originPosition.x + (spacer * i),</div></li><li class="li1"><div class="de1">                            y: originPosition.y + (spacer * j)</div></li><li class="li1"><div class="de1">                        }, wave.speed);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                    }</div></li><li class="li1"><div class="de1">                }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case &quot;row&quot;:</div></li><li class="li1"><div class="de1">                originPosition = {x: wave.position.x, y: wave.position.y};</div></li><li class="li1"><div class="de1">                spacer = wave.formation.spacer;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                for (i = 0; i &lt; wave.formation.amount; i++) {</div></li><li class="li1"><div class="de1">                    this.enemyPool.instantiate(wave.type, {</div></li><li class="li1"><div class="de1">                        x: originPosition.x + (spacer * i),</div></li><li class="li1"><div class="de1">                        y: originPosition.y</div></li><li class="li1"><div class="de1">                    }, wave.speed);</div></li><li class="li1"><div class="de1">                }</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            case &quot;column&quot;:</div></li><li class="li1"><div class="de1">                originPosition = {x: wave.position.x, y: wave.position.y};</div></li><li class="li1"><div class="de1">                spacer = wave.formation.spacer;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                for (i = 0; i &lt; wave.formation.amount; i++) {</div></li><li class="li1"><div class="de1">                    this.enemyPool.instantiate(wave.type, {</div></li><li class="li1"><div class="de1">                        x: originPosition.x,</div></li><li class="li1"><div class="de1">                        y: originPosition.y + (spacer * i)</div></li><li class="li1"><div class="de1">                    }, wave.speed);</div></li><li class="li1"><div class="de1">                }</div></li><li class="li1"><div class="de1">                break;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">            default:</div></li><li class="li1"><div class="de1">                console.log(&quot;Error, no es reconeix el tipus de formació&quot;);</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    setEndLevel() {</div></li><li class="li1"><div class="de1">        this.currentLevel++;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        if (this.currentLevel &gt;= this.levels.length) {</div></li><li class="li1"><div class="de1">            this.currentLevel = 0;</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.enemyPool.clear();</div></li><li class="li1"><div class="de1">        this.explosionPool.clear();</div></li><li class="li1"><div class="de1">        this.enemyShotPool.clear();</div></li><li class="li1"><div class="de1">        this.playerShotPool.clear();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.startLevel(this.currentLevel);</div></li><li class="li1"><div class="de1">        this.state = GameState.RUNNING;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    setGameOver() {</div></li><li class="li1"><div class="de1">        this.player.update();</div></li><li class="li1"><div class="de1">        this.state = GameState.GAME_OVER;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.ui.hideMessage();</div></li><li class="li1"><div class="de1">        this.ui.showGameOver();</div></li><li class="li1"><div class="de1">        this.ui.fadeOut();</div></li><li class="li1"><div class="de1">        assetManager.fadeOutAudio(2000); // Donem temps per que es produeixi la explosió</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        setTimeout(function () {</div></li><li class="li1"><div class="de1">            assetManager.getMusic(&quot;game-over&quot;);</div></li><li class="li1"><div class="de1">        }, 2000);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    init() {</div></li><li class="li1"><div class="de1">        this.loadData(this.config.asset_data_url, this.initEnvironment.bind(this));</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    loadData(url, callback) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        fetch(url)</div></li><li class="li1"><div class="de1">            .then(response =&gt; response.json())</div></li><li class="li1"><div class="de1">            .then(data =&gt; callback(data))</div></li><li class="li1"><div class="de1">            .catch(function (err) {</div></li><li class="li1"><div class="de1">                console.log(&quot;Something went wrong!&quot;, err);</div></li><li class="li1"><div class="de1">            });</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    loadAssets(assets) {</div></li><li class="li1"><div class="de1">        for (let type in assets) {</div></li><li class="li1"><div class="de1">            for (let i = 0; i &lt; assets[type].length; i++) {</div></li><li class="li1"><div class="de1">                assetManager.queueAsset(type, assets[type][i]);</div></li><li class="li1"><div class="de1">            }</div></li><li class="li1"><div class="de1">        }</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        assetManager.downloadAll(this.loadEntititesData.bind(this), this.gameContext);</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    loadEntititesData() {</div></li><li class="li1"><div class="de1">        let context = this;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.loadData(this.config.entity_data_url, function (data) {</div></li><li class="li1"><div class="de1">            addEntity(data);</div></li><li class="li1"><div class="de1">            context.loadLevelsData();</div></li><li class="li1"><div class="de1">        })</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    loadLevelsData() {</div></li><li class="li1"><div class="de1">        let context = this;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.loadData(this.config.levels_data_url, function (data) {</div></li><li class="li1"><div class="de1">            context.levels = data.levels;</div></li><li class="li1"><div class="de1">            context.start();</div></li><li class="li1"><div class="de1">        });</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    start() {</div></li><li class="li1"><div class="de1">        this.background = new Background(this.gameContext);</div></li><li class="li1"><div class="de1">        this.restart();</div></li><li class="li1"><div class="de1">        this.fpsInterval = 1000 / FPS;</div></li><li class="li1"><div class="de1">        this.then = window.performance.now();</div></li><li class="li1"><div class="de1">        this.startTime = this.then;</div></li><li class="li1"><div class="de1">        this.frameCount = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.update();</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    startLevel(level) {</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        let message = `${this.levels[level].name}&lt;p&gt;&lt;span&gt;${this.levels[level].description}&lt;/span&gt;&lt;/p&gt;`;</div></li><li class="li1"><div class="de1">        this.ui.showMessage(message, 3000);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.background.start(this.levels[level].background);</div></li><li class="li1"><div class="de1">        assetManager.getMusic(this.levels[this.currentLevel].music);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.levelEnded = false;</div></li><li class="li1"><div class="de1">        this.nextWave = 0;</div></li><li class="li1"><div class="de1">        this.distance = 0;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.player.position = {x: 10, y: 256};</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">    restart() {</div></li><li class="li1"><div class="de1">        this.ui.hideGameOver();</div></li><li class="li1"><div class="de1">        assetManager.fadeInAudio();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.player = new Player(</div></li><li class="li1"><div class="de1">            {</div></li><li class="li1"><div class="de1">                pool: {</div></li><li class="li1"><div class="de1">                    bullet: this.playerShotPool,</div></li><li class="li1"><div class="de1">                    explosion: this.explosionPool</div></li><li class="li1"><div class="de1">                },</div></li><li class="li1"><div class="de1">                position: {x: 10, y: 256},</div></li><li class="li1"><div class="de1">                speed: {x: 240, y: 240},</div></li><li class="li1"><div class="de1">                gameWidth: this.canvas.width,</div></li><li class="li1"><div class="de1">                gameHeight: this.canvas.height</div></li><li class="li1"><div class="de1">            });</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.currentLevel = 0;</div></li><li class="li1"><div class="de1">        this.score = 0;</div></li><li class="li1"><div class="de1">        this.state = GameState.RUNNING;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.enemyPool.clear();</div></li><li class="li1"><div class="de1">        this.explosionPool.clear();</div></li><li class="li1"><div class="de1">        this.enemyShotPool.clear();</div></li><li class="li1"><div class="de1">        this.playerShotPool.clear();</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        assetManager.resetMusic(this.levels[this.currentLevel].music);</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">        this.ui.fadeIn();</div></li><li class="li1"><div class="de1">        this.startLevel(this.currentLevel);</div></li><li class="li1"><div class="de1">    };</div></li><li class="li1"><div class="de1">}</div></li></ol></pre>

<p>
Recordeu que podeu trobar el codi complet del joc <em>IOC Invaders</em> a l’enllaç següent: <a href="https://github.com/XavierGaro/ioc-invaders" class="urlextern" title="https://github.com/XavierGaro/ioc-invaders"  rel="nofollow">github.com/XavierGaro/ioc-invaders</a> i provar el seu funcionament a <a href="https://xaviergaro.github.io/ioc-invaders" class="urlextern" title="https://xaviergaro.github.io/ioc-invaders"  rel="nofollow">xaviergaro.github.io/ioc-invaders/</a>.
</p>

</p>

</div>

<h3><a id="codi_d_alt_rendimentwebassembly_wasm" >Codi d&#039;alt rendiment: WebAssembly (wasm)</a></h3>
<div class="level3">

<p>

<p>
Cal recordar que JavaScript és un llenguatge interpretat, per aquest motiu el seu rendiment és molt baix i en alguns casos pot fer inviable la implementació d’alguns projectes com jocs en 3D i aplicacions de realitat virtual.
</p>

<p>
La solució en aquests casos és utilitzar WebAssembly (també conegut com wasm), un nou tipus de codi semblant a l’assemblador, que s’executa al navegador amb un rendiment gairebé natiu i permet utilitzar els llenguatges C/C++ a la web (compilant aquests a WebAssembly).
</p>
<div class="iocreference"><div class="ioccontent">
<p>
Podeu trobar més informació sobre WebAssembly als enllaços següents: <a href="https://tiny.cc/n8kauz" class="urlextern" title="https://tiny.cc/n8kauz"  rel="nofollow">https://tiny.cc/n8kauz</a> i <a href="https://webassembly.org/" class="urlextern" title="https://webassembly.org/"  rel="nofollow">webassembly.org</a>.
</p>
</div></div>
<p>
En el camp dels videojocs trobem que motors com Unity utilitza aquesta aproximació per desplegar els seus jocs (<a href="http://tiny.cc/x8kauz" class="urlextern" title="http://tiny.cc/x8kauz"  rel="nofollow">tiny.cc/x8kauz</a>), compilant el codi generat en C i C++ a WebAssembly que després pot ser executat al navegador.
</p>

<p>
Tot i que el codi de WebAssembly pot ser executat en tots els navegadors moderns, l’especificació del llenguatge encara no és definitiva (i tal com passa amb assemblador, no és fàcil de treballar amb ella), així que és imprescindible utilitzar un compilador extern com <strong>emscripten</strong> (<a href="https://emscripten.org" class="urlextern" title="https://emscripten.org"  rel="nofollow">emscripten.org</a>) per compilar aquests programes desenvolupats en C/C++ a WebAssembly.
</p>

<p>
Per altra banda, el codi de WebAssembly no s’incrusta a la pàgina com el de JavaScript ni es carrega com a mòduls; cal carregar-lo des de JavaScript utilitzant una petició AJAX i llavors instanciar-lo:
</p>
<pre class="code java"><ol><li class="li1"><div class="de1">WebAssembly.instantiateStreaming(fetch('simple.wasm'), importObject)</div></li><li class="li1"><div class="de1">  .then(results =&gt; {</div></li><li class="li1"><div class="de1">    // Fer alguna cosa amb el resultat!</div></li><li class="li1"><div class="de1">  });</div></li></ol></pre>

<p>
S’ha de tenir en compte que WebAssembly treballa conjuntament amb JavaScript, així que és possible crear aplicacions que utilitzin tots dos tipus de codi. Per exemple, a <em>IOC-Invaders</em> es podria implementar un motor de físiques que controles les col·lisions en C++, compilar-lo a WebAssembly i utilitzar-lo des de JavaScript per obtenir un rendiment molt superior, ja que s’ha d’executar a cada <em>frame</em>.
</p>
<div class="iocnote"><div class="ioccontent">
<p>
L’extensió dels fitxers en WebAssembly és <code>.wasm</code>.
</p>
</div></div>
<p>
Com es pot intuir, WebAssembly obre la porta a moltes possibilitats al desenvolupament web perquè és molt potent, però utilitzar-lo no és trivial, ja que s’han de conèixer altres llenguatges com C, C++ o C#, utilitzar eines externes de compilació, gestionar la càrrega d’aquest nou codi i integrar-lo amb les vostres aplicacions en JavaScript.
</p>

</p>

</div>

	 </article>
     <div class="pnpage">
      <div class="left-corner"></div>
      <div id="prevpage">Anar a la p&agrave;gina anterior:<br /><a href="../../../WebContent/u7/referencies.html">Referències</a></div>
      <div id="nextpage">Anar a la p&agrave;gina seg&uuml;ent:<br /><a href="../../../WebContent/u7/a1/activitats.html">Activitats</a></div>
      <div class="right-corner"></div>
     </div>
    </div>
    <footer class="footer">
      <div><small>Aquest document està subjecte a una llicència oberta de Creative Commons, es reserva el dret de reconeixement de l'autoria, d'exigir que no se'n faci cap mena d'ús comercial. Si altereu o transformeu aquesta obra, o en genereu obres derivades, només podeu distribuir l'obra generada amb una llicència idèntica a aquesta.</small></div>
    </footer>
 </div>
 <div id="back_preview" class="hidden"></div>
 <div id="preview" class="hidden">
  <div class="prevcontent"></div>
 </div>
 <div id="help-tooltips">
  <div id="help-toc" class="hidden tooltip"><span>Taula de continguts:</span> Ofereix una vista general de l&#39;estructura del m&ograve;dul, que us facilitar&agrave; la navegaci&oacute; a trav&eacute;s dels seus continguts.<span class="arrow-left"></span></div> 
  <div id="help-settings" class="hidden tooltip"><span>Opcions de format:</span> Permet configurar el format de lectura a partir de les vostres prefer&egrave;ncies, modificant la mida de la lletra, el color del fons, l&#39;amplada de la p&agrave;gina o l&#39;ocultaci&oacute; dels continguts complementaris, entre d&#39;altres.<span class="arrow-left"></span></div>
  <div id="help-printer" class="hidden tooltip"><span>Imprimir:</span>  Envia el contingut seleccionat a la impressora.<span class="arrow-left"></span></div>
  <div id="help-favorites" class="hidden tooltip"><span>Prefereits:</span> Permet desar aquelles parts del contingut a les que us interessi accedir en un moment posterior; us permetr&agrave; anar creant un repositori personalitzat de les seccions que considereu m&eacute;s rellevants. Un cop l&#39;hageu començat a fer servir se us mostrar&agrave; a sota un comptador que us informar&agrave; del nombre de preferits que s&#39;hagin emmagatzemat fins al moment.<span class="arrow-left"></span></div>
  <div id="help-favcounter" class="hidden tooltip"><span>Comptador i llistat de preferits:</span> Indica el nombre de preferits que s&#39;han desat fins el moment; clicant damunt seu accedireu al llistat de preferits, i a trav&eacute;s d&#39;aquest podreu accedir directament als continguts que hageu emmagatzemat.<span class="arrow-left"></span></div>
  <div id="help-help_icon" class="hidden tooltip"><span>Ajuda:</span> Aquesta opci&oacute; activa la informaci&oacute; de les funcionalitats del web tot situant el punter del ratol&iacute; al damunt dels diferents &iacute;tems.<span class="arrow-left"></span></div>
  <div id="help-sidebar-hide" class="hidden tooltip"><span>Mostrar/Ocultar barra lateral:</span>  Deshabilita la barra d&#39;opcions, permetent la seva recuperaci&oacute; quan es desitgi.<span class="arrow-left"></span></div>
  <div id="help-search" class="hidden tooltip"><span>Cerca:</span>  Introdu&iuml;u les paraules clau sobre aquells conceptes que desitgeu localitzar en els continguts del m&ograve;dul. Tamb&eacute; podeu excloure un terme de la cerca tot afegint-hi el signe &#8220;-&#8221; al davant.<span class="arrow-top"></span></div>
  <div id="help-header" class="hidden tooltip"><span>Cap&ccedil;alera:</span>  Indica l&#39;apartat o secci&oacute; que es mostra en pantalla. Tingueu present que les capçaleres de segon, tercer i quart nivell tamb&eacute; es poden desar com a marcadors.<span class="arrow-left"></span></div>
</div> 
</body>
</html>
